{
  "generatedAt": "2025-09-13T11:36:52.107Z",
  "root": "soili",
  "counts": {
    "files": 64,
    "bytes": 469555,
    "skipped": 0
  },
  "config": {
    "include": [
      "src/**/*",
      "app/**/*",
      "packages/**/*",
      "supabase/functions/**/*",
      "supabase/migrations/**/*.sql",
      "supabase/**/*.sql",
      "supabase/seed.sql",
      "supabase/types/**/*"
    ],
    "exclude": [
      "**/node_modules/**",
      ".next/**",
      "dist/**",
      "build/**",
      "out/**",
      ".git/**",
      ".vercel/**",
      "coverage/**",
      "**/*.map",
      "**/*.min.*",
      "**/*.lock",
      "**/*.png",
      "**/*.jpg",
      "**/*.jpeg",
      "**/*.gif",
      "**/*.webp",
      "**/*.svg",
      "**/*.ico",
      "**/*.pdf",
      "**/*.zip",
      "supabase/.branches/**",
      "supabase/.temp/**",
      "supabase/config.toml",
      "scripts/**"
    ],
    "redact": [
      "(?i)\\b(api[_-]?key|secret|token|password)\\b\\s*[:=]\\s*['\\\"][^'\\\"]+['\\\"]",
      "(?m)^(RESEND|SUPABASE|VAPID|STRIPE|GOOGLE|AWS|OPENAI)_[A-Z0-9_]+\\s*=\\s*.+$",
      "\\b[A-Za-z0-9_-]{48,}\\b"
    ],
    "maxPreviewBytes": 250000,
    "chunkBytes": 64000,
    "maxFileBytes": 3000000,
    "formatDump": false,
    "repoRawBase": "https://raw.githubusercontent.com/<owner>/<repo>/<commit>"
  },
  "files": [
    {
      "path": "src/app/ClientLayout.tsx",
      "size": 3723,
      "sha256": "a13f63b5ee8b93b1095438bea51f7e18e7b454ed83e34cca47f8fde76ba830ec",
      "lang": "tsx",
      "lines": 142,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/ClientLayout.tsx",
      "chunks": [
        {
          "i": 0,
          "text": "\"use client\";\n\nimport { useEffect, useState, useCallback } from \"react\";\nimport { supabase } from \"@/lib/supaBaseClient\";\nimport EmployeeDashboard from \"@/app/components/EmployeeDashboard\";\nimport AdminView from \"@/app/components/AdminView\";\nimport Login from \"@/app/components/Login\";\nimport ServiceWorkerRegister from \"./ServiceWorkerRegister\";\nimport { Loader } from \"lucide-react\";\nimport { Employee } from \"@/app/types\";\n\nfunction EmployeeDashboardWrapper() {\n  const [currentEmployee, setCurrentEmployee] = useState<Employee | null>(null);\n  const [allEmployees, setAllEmployees] = useState<Employee[]>([]);\n  const [loading, setLoading] = useState(true);\n\n  useEffect(() => {\n    const loadData = async () => {\n      const {\n        data: { user },\n      } = await supabase.auth.getUser();\n      if (!user) {\n        setLoading(false);\n        return;\n      }\n\n      // 1. Kokeile hakea auth_user_id:llä\n      let { data: employee } = await supabase\n        .from(\"employees\")\n        .select(\"*\")\n        .eq(\"auth_user_id\", user.id)\n        .maybeSingle();\n\n      // 2. Jos ei löydy → fallback emaililla\n      if (!employee) {\n        const { data: employeeByEmail } = await supabase\n          .from(\"employees\")\n          .select(\"*\")\n          .eq(\"email\", user.email)\n          .maybeSingle();\n        employee = employeeByEmail;\n      }\n\n      setCurrentEmployee(employee as Employee);\n\n      const { data: all } = await supabase.from(\"employees\").select(\"*\");\n      setAllEmployees(all as Employee[]);\n\n      setLoading(false);\n\n      // Poista Magic Link -hash URL:ista\n      if (\n        typeof window !== \"undefined\" &&\n        window.location.hash.includes(\"access_token\")\n      ) {\n        window.history.replaceState(null, \"\", window.location.pathname);\n      }\n    };\n    loadData();\n  }, []);\n\n  const handleSwitchToAdmin = useCallback(() => {\n    window.location.href = \"/admin\";\n  }, []);\n\n  if (loading || !currentEmployee) {\n    return (\n      <div className=\"flex h-screen w-full items-center justify-center\">\n        <Loader className=\"animate-spin w-8 h-8 text-primary\" />\n      </div>\n    );\n  }\n\n  return (\n    <EmployeeDashboard\n      currentEmployee={currentEmployee}\n      allEmployees={allEmployees}\n      onSwitchToAdmin={handleSwitchToAdmin}\n    />\n  );\n}\n\nexport default function ClientLayout({ children }: { children: React.ReactNode }) {\n  const [role, setRole] = useState<\"admin\" | \"employee\" | null>(null);\n  const [loading, setLoading] = useState(true);\n\n  useEffect(() => {\n    const loadUser = async () => {\n      const {\n        data: { user },\n      } = await supabase.auth.getUser();\n      if (!user) {\n        setRole(null);\n        setLoading(false);\n        return;\n      }\n\n      // 1. Hae auth_user_id:llä\n      let { data: profile } = await supabase\n        .from(\"employees\")\n        .select(\"role\")\n        .eq(\"auth_user_id\", user.id)\n        .maybeSingle();\n\n      // 2. Jos ei löydy → fallback emaililla\n      if (!profile) {\n        const { data: profileByEmail } = await supabase\n          .from(\"employees\")\n          .select(\"role\")\n          .eq(\"email\", user.email)\n          .maybeSingle();\n        profile = profileByEmail;\n      }\n\n      setRole(profile?.role ?? null);\n      setLoading(false);\n    };\n    loadUser();\n  }, []);\n\n  if (loading) {\n    return (\n      <div className=\"flex h-screen w-full items-center justify-center\">\n        <Loader className=\"animate-spin w-8 h-8 text-primary\" />\n      </div>\n    );\n  }\n\n  return (\n    <>\n      {role === \"admin\" ? (\n        <AdminView />\n      ) : role === \"employee\" ? (\n        <EmployeeDashboardWrapper />\n      ) : (\n        <Login />\n      )}\n      <ServiceWorkerRegister />\n    </>\n  );\n}\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 141
        }
      ]
    },
    {
      "path": "src/app/ServiceWorkerRegister.tsx",
      "size": 484,
      "sha256": "631fcf19ef166715c1aed3a81c53a16a19c326ea125dd1d4eaa7d9f1c1d09b91",
      "lang": "tsx",
      "lines": 20,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/ServiceWorkerRegister.tsx",
      "chunks": [
        {
          "i": 0,
          "text": "\"use client\";\n\nimport { useEffect } from \"react\";\n\nexport default function ServiceWorkerRegister() {\n  useEffect(() => {\n    if (!(\"serviceWorker\" in navigator)) return;\n    const onLoad = () => {\n      navigator.serviceWorker.register(\"/sw.js\").catch((e) => {\n        // älä kaada UI:ta\n        console.error(\"[sw register]\", e);\n      });\n    };\n    window.addEventListener(\"load\", onLoad);\n    return () => window.removeEventListener(\"load\", onLoad);\n  }, []);\n\n  return null;\n}\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 19
        }
      ]
    },
    {
      "path": "src/app/globals.css",
      "size": 5653,
      "sha256": "45ad32c69d21d05c8e114bb7dcee571ed26789588c71258172a932bb0b2849b5",
      "lang": "css",
      "lines": 191,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/globals.css",
      "chunks": [
        {
          "i": 0,
          "text": "@import \"tailwindcss\";\n\n@custom-variant dark (&:is(.dark *));\n\n:root {\n  --font-size: 14px;\n  --background: #ffffff;\n  --foreground: oklch(0.145 0 0);\n  --card: #ffffff;\n  --card-foreground: oklch(0.145 0 0);\n  --popover: oklch(1 0 0);\n  --popover-foreground: oklch(0.145 0 0);\n  --primary: #030213;\n  --primary-foreground: oklch(1 0 0);\n  --secondary: oklch(0.95 0.0058 264.53);\n  --secondary-foreground: #030213;\n  --muted: #ececf0;\n  --muted-foreground: #717182;\n  --accent: #e9ebef;\n  --accent-foreground: #030213;\n  --destructive: #d4183d;\n  --destructive-foreground: #ffffff;\n  --border: rgba(0, 0, 0, 0.1);\n  --input: transparent;\n  --input-background: #f3f3f5;\n  --switch-background: #cbced4;\n  --font-weight-medium: 500;\n  --font-weight-normal: 400;\n  --ring: oklch(0.708 0 0);\n  --chart-1: oklch(0.646 0.222 41.116);\n  --chart-2: oklch(0.6 0.118 184.704);\n  --chart-3: oklch(0.398 0.07 227.392);\n  --chart-4: oklch(0.828 0.189 84.429);\n  --chart-5: oklch(0.769 0.188 70.08);\n  --radius: 0.625rem;\n  --sidebar: oklch(0.985 0 0);\n  --sidebar-foreground: oklch(0.145 0 0);\n  --sidebar-primary: #030213;\n  --sidebar-primary-foreground: oklch(0.985 0 0);\n  --sidebar-accent: oklch(0.97 0 0);\n  --sidebar-accent-foreground: oklch(0.205 0 0);\n  --sidebar-border: oklch(0.922 0 0);\n  --sidebar-ring: oklch(0.708 0 0);\n}\n\n.dark {\n  --background: oklch(0.145 0 0);\n  --foreground: oklch(0.985 0 0);\n  --card: oklch(0.145 0 0);\n  --card-foreground: oklch(0.985 0 0);\n  --popover: oklch(0.145 0 0);\n  --popover-foreground: oklch(0.985 0 0);\n  --primary: oklch(0.985 0 0);\n  --primary-foreground: oklch(0.205 0 0);\n  --secondary: oklch(0.269 0 0);\n  --secondary-foreground: oklch(0.985 0 0);\n  --muted: oklch(0.269 0 0);\n  --muted-foreground: oklch(0.708 0 0);\n  --accent: oklch(0.269 0 0);\n  --accent-foreground: oklch(0.985 0 0);\n  --destructive: oklch(0.396 0.141 25.723);\n  --destructive-foreground: oklch(0.637 0.237 25.331);\n  --border: oklch(0.269 0 0);\n  --input: oklch(0.269 0 0);\n  --ring: oklch(0.439 0 0);\n  --font-weight-medium: 500;\n  --font-weight-normal: 400;\n  --chart-1: oklch(0.488 0.243 264.376);\n  --chart-2: oklch(0.696 0.17 162.48);\n  --chart-3: oklch(0.769 0.188 70.08);\n  --chart-4: oklch(0.627 0.265 303.9);\n  --chart-5: oklch(0.645 0.246 16.439);\n  --sidebar: oklch(0.205 0 0);\n  --sidebar-foreground: oklch(0.985 0 0);\n  --sidebar-primary: oklch(0.488 0.243 264.376);\n  --sidebar-primary-foreground: oklch(0.985 0 0);\n  --sidebar-accent: oklch(0.269 0 0);\n  --sidebar-accent-foreground: oklch(0.985 0 0);\n  --sidebar-border: oklch(0.269 0 0);\n  --sidebar-ring: oklch(0.439 0 0);\n}\n\n@theme inline {\n  --color-background: var(--background);\n  --color-foreground: var(--foreground);\n  --color-card: var(--card);\n  --color-card-foreground: var(--card-foreground);\n  --color-popover: var(--popover);\n  --color-popover-foreground: var(--popover-foreground);\n  --color-primary: var(--primary);\n  --color-primary-foreground: var(--primary-foreground);\n  --color-secondary: var(--secondary);\n  --color-secondary-foreground: var(--secondary-foreground);\n  --color-muted: var(--muted);\n  --color-muted-foreground: var(--muted-foreground);\n  --color-accent: var(--accent);\n  --color-accent-foreground: var(--accent-foreground);\n  --color-destructive: var(--destructive);\n  --color-destructive-foreground: var(--destructive-foreground);\n  --color-border: var(--border);\n  --color-input: var(--input);\n  --color-input-background: var(--input-background);\n  --color-switch-background: var(--switch-background);\n  --color-ring: var(--ring);\n  --color-chart-1: var(--chart-1);\n  --color-chart-2: var(--chart-2);\n  --color-chart-3: var(--chart-3);\n  --color-chart-4: var(--chart-4);\n  --color-chart-5: var(--chart-5);\n  --radius-sm: calc(var(--radius) - 4px);\n  --radius-md: calc(var(--radius) - 2px);\n  --radius-lg: var(--radius);\n  --radius-xl: calc(var(--radius) + 4px);\n  --color-sidebar: var(--sidebar);\n  --color-sidebar-foreground: var(--sidebar-foreground);\n  --color-sidebar-primary: var(--sidebar-primary);\n  --color-sidebar-primary-foreground: var(--sidebar-primary-foreground);\n  --color-sidebar-accent: var(--sidebar-accent);\n  --color-sidebar-accent-foreground: var(--sidebar-accent-foreground);\n  --color-sidebar-border: var(--sidebar-border);\n  --color-sidebar-ring: var(--sidebar-ring);\n}\n\n@layer base {\n  * {\n    @apply border-border outline-ring/50;\n  }\n\n  body {\n    @apply bg-background text-foreground;\n  }\n}\n\n/**\n * Base typography. This is not applied to elements which have an ancestor with a Tailwind text class.\n */\n@layer base {\n  :where(:not(:has([class*=\" text-\"]), :not(:has([class^=\"text-\"])))) {\n    h1 {\n      font-size: var(--text-2xl);\n      font-weight: var(--font-weight-medium);\n      line-height: 1.5;\n    }\n\n    h2 {\n      font-size: var(--text-xl);\n      font-weight: var(--font-weight-medium);\n      line-height: 1.5;\n    }\n\n    h3 {\n      font-size: var(--text-lg);\n      font-weight: var(--font-weight-medium);\n      line-height: 1.5;\n    }\n\n    h4 {\n      font-size: var(--text-base);\n      font-weight: var(--font-weight-medium);\n      line-height: 1.5;\n    }\n\n    p {\n      font-size: var(--text-base);\n      font-weight: var(--font-weight-normal);\n      line-height: 1.5;\n    }\n\n    label {\n      font-size: var(--text-base);\n      font-weight: var(--font-weight-medium);\n      line-height: 1.5;\n    }\n\n    button {\n      font-size: var(--text-base);\n      font-weight: var(--font-weight-medium);\n      line-height: 1.5;\n    }\n\n    input {\n      font-size: var(--text-base);\n      font-weight: var(--font-weight-normal);\n      line-height: 1.5;\n    }\n  }\n}\n\nhtml {\n  font-size: var(--font-size);\n}",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 191
        }
      ]
    },
    {
      "path": "src/app/layout.tsx",
      "size": 1451,
      "sha256": "154e80bb5c1519c4f6fcd71b3ca54cd04b4ac3e310851bf8bca10bd02663b777",
      "lang": "tsx",
      "lines": 51,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/layout.tsx",
      "chunks": [
        {
          "i": 0,
          "text": "import type { Metadata } from \"next\";\nimport Script from \"next/script\";\nimport { Geist, Geist_Mono } from \"next/font/google\";\nimport \"./globals.css\";\nimport ClientLayout from \"./ClientLayout\";\nimport * as React from \"react\";\n\nconst geistSans = Geist({\n  variable: \"--font-geist-sans\",\n  subsets: [\"latin\"],\n});\n\nconst geistMono = Geist_Mono({\n  variable: \"--font-geist-mono\",\n  subsets: [\"latin\"],\n});\n\nexport const metadata: Metadata = {\n  title: \"Soili\",\n  description: \"Työvuorohallinta\",\n};\n\nexport default function RootLayout({\n  children,\n}: Readonly<{\n  children: React.ReactNode;\n}>) {\n  return (\n    <html lang=\"fi\" suppressHydrationWarning>\n      <head>\n        <Script id=\"theme-init\" strategy=\"beforeInteractive\">\n          {`(function () {\n            try {\n              var key = 'soili-theme';\n              var mode = localStorage.getItem(key) || 'system';\n              var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;\n              var effective = mode === 'system' ? (prefersDark ? 'dark' : 'light') : mode;\n              var c = document.documentElement.classList;\n              c.remove('light','dark');\n              c.add(effective);\n            } catch (_) {}\n          })();`}\n        </Script>\n      </head>\n      <body className={`${geistSans.variable} ${geistMono.variable} antialiased`}>\n          <ClientLayout>{children}</ClientLayout>\n      </body>\n    </html>\n  );\n}\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 50
        }
      ]
    },
    {
      "path": "src/app/page.tsx",
      "size": 2103,
      "sha256": "ccf841094cfe6f6b79aedad1cd0083cc2215bef1296f87f6792682ef2029111e",
      "lang": "tsx",
      "lines": 60,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/page.tsx",
      "chunks": [
        {
          "i": 0,
          "text": "\"use client\";\n\nimport React, { useState } from 'react';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from './components/ui/tabs';\nimport { Toaster } from './components/ui/sonner';\nimport Toolbar from './components/Toolbar';\nimport ScheduleTable from './components/ScheduleTable';\nimport AbsenceControlPanel from './components/AbsenceControlPanel';\nimport EmployeeList from './components/EmployeeList';\nimport { Calendar, Users, Clock } from 'lucide-react';\n\n\nexport default function App() {\n  const [activeTab, setActiveTab] = useState('schedule');\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      {/* Toast notifications */}\n      <Toaster position=\"top-right\" />\n      \n      <div className=\"container mx-auto p-6 space-y-6\">\n        {/* Toolbar - always visible */}\n        <Toolbar />\n        \n        {/* Main Navigation */}\n        <Tabs value={activeTab} onValueChange={setActiveTab} className=\"w-full\">\n          <TabsList className=\"grid w-full grid-cols-3 lg:w-[400px] mx-auto\">\n            <TabsTrigger value=\"schedule\" className=\"flex items-center gap-2\">\n              <Calendar className=\"w-4 h-4\" />\n              Vuorotaulukko\n            </TabsTrigger>\n            <TabsTrigger value=\"employees\" className=\"flex items-center gap-2\">\n              <Users className=\"w-4 h-4\" />\n              Työntekijät\n            </TabsTrigger>\n            <TabsTrigger value=\"absences\" className=\"flex items-center gap-2\">\n              <Clock className=\"w-4 h-4\" />\n              Poissaolot\n            </TabsTrigger>\n          </TabsList>\n\n          {/* Schedule Table Tab */}\n          <TabsContent value=\"schedule\" className=\"space-y-6\">\n            <ScheduleTable />\n          </TabsContent>\n\n          {/* Employee Management Tab */}\n          <TabsContent value=\"employees\" className=\"space-y-6\">\n            <EmployeeList />\n          </TabsContent>\n\n          {/* Absence Control Panel Tab */}\n          <TabsContent value=\"absences\" className=\"space-y-6\">\n            <AbsenceControlPanel />\n          </TabsContent>\n        </Tabs>\n      </div>\n    </div>\n  );\n}",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 60
        }
      ]
    },
    {
      "path": "src/lib/dateUtils.ts",
      "size": 984,
      "sha256": "ac4a55bccc8a3540a4052f3d652aff2dee2421aff36bd6f223f1d94c49370067",
      "lang": "typescript",
      "lines": 30,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/lib/dateUtils.ts",
      "chunks": [
        {
          "i": 0,
          "text": "// dateutils.ts\nexport type WeekStartDay = \"monday\" | \"sunday\";\n\n// Paikallinen keskiyö -> YYYY-MM-DD ilman UTC-heittelyä\nexport function toLocalISO(date: Date) {\n  const d = new Date(date);\n  d.setHours(0, 0, 0, 0);\n  const yyyy = d.getFullYear();\n  const mm = String(d.getMonth() + 1).padStart(2, \"0\");\n  const dd = String(d.getDate()).padStart(2, \"0\");\n  return `${yyyy}-${mm}-${dd}`;\n}\n\nexport function addDaysLocalISO(iso: string, add: number) {\n  const [y, m, da] = iso.split(\"-\").map(Number);\n  const d = new Date(y, m - 1, da); // paikallinen\n  d.setDate(d.getDate() + add);\n  return toLocalISO(d);\n}\n\nexport function alignToWeekStart(iso: string, weekStart: WeekStartDay) {\n  const [y, m, da] = iso.split(\"-\").map(Number);\n  const d = new Date(y, m - 1, da); // paikallinen\n  const day = d.getDay(); // 0 = su, 1 = ma\n  const startIndex = weekStart === \"monday\" ? 1 : 0;\n  const diff = (day - startIndex + 7) % 7;\n  d.setDate(d.getDate() - diff);\n  return toLocalISO(d);\n}\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 29
        }
      ]
    },
    {
      "path": "src/lib/insertEmailQueue.ts",
      "size": 635,
      "sha256": "389641d8017039a855d8d4a8a708492ea5d035547fc1f38a3fce01412c40f9b6",
      "lang": "typescript",
      "lines": 29,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/lib/insertEmailQueue.ts",
      "chunks": [
        {
          "i": 0,
          "text": "import { supabase } from \"@/lib/supaBaseClient\";\n\ntype EmailJob = {\n  to: string | string[];\n  subject: string;\n  text: string;\n};\n\n/**\n * Lisää sähköpostin jonoon. \n * TÄTÄ käytetään sendEmail:n sijasta frontissa / notify.ts:ssä.\n */\nexport async function insertEmailQueue(job: EmailJob) {\n  const recipients = Array.isArray(job.to) ? job.to : [job.to];\n\n  const { error } = await supabase.from(\"email_queue\").insert(\n    recipients.map((r) => ({\n      recipient: r,\n      subject: job.subject,\n      body: job.text,\n    }))\n  );\n\n  if (error) {\n    console.error(\"[insertEmailQueue] failed\", error);\n    throw error;\n  }\n}\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 28
        }
      ]
    },
    {
      "path": "src/lib/logger.ts",
      "size": 1787,
      "sha256": "19453d233af796139d2026b5b90c9f503f3c9c693fd78eb9d5329e4c13dd01e4",
      "lang": "typescript",
      "lines": 66,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/lib/logger.ts",
      "chunks": [
        {
          "i": 0,
          "text": "/* Timanttinen virhe-normalisointi: EI enää console.error({}) -roskaa */\ntype NormalizedError = {\n  name: string\n  message: string\n  stack?: string\n  status?: number\n  cause?: unknown\n  extra?: Record<string, unknown>\n};\n\nfunction isResponseLike(x: unknown): x is Response & { url?: string } {\n  return typeof x === \"object\" && x !== null && \"status\" in x && \"ok\" in x;\n}\n\nexport function normalizeError(err: unknown): NormalizedError {\n  if (isResponseLike(err)) {\n    return {\n      name: \"HTTPError\",\n      message: `HTTP ${err.status} ${err.statusText ?? \"\"}`.trim(),\n      status: err.status,\n      extra: err instanceof Response ? { url: err.url } : undefined,\n    };\n  }\n\n  if (err instanceof Error) {\n    const { cause } = err as { cause?: unknown };\n    return {\n      name: err.name || \"Error\",\n      message: err.message || \"Unknown error\",\n      stack: err.stack,\n      cause,\n    };\n  }\n\n  if (typeof err === \"object\" && err !== null) {\n    const obj = err as Record<string, unknown>;\n    const name =\n      typeof obj.name === \"string\" ? obj.name : \"UnknownObjectError\";\n    const message =\n      typeof obj.message === \"string\"\n        ? obj.message\n        : JSON.stringify(obj);\n    return { name, message, extra: obj };\n  }\n\n  if (typeof err === \"string\") {\n    return { name: \"StringError\", message: err };\n  }\n\n  return { name: \"Unknown\", message: String(err) };\n}\n\nexport function logError(context: string, err: unknown) {\n  const n = normalizeError(err);\n  console.error(`[${context}] ${n.name}: ${n.message}`, {\n    status: n.status,\n    cause: n.cause,\n    extra: n.extra,\n    stack: n.stack,\n  });\n}\n\nexport function logInfo(context: string, data?: unknown) {\n  if (data === undefined) console.info(`[${context}]`);\n  else console.info(`[${context}]`, data);\n}",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 66
        }
      ]
    },
    {
      "path": "src/lib/pushClient.ts",
      "size": 1652,
      "sha256": "590f9a9f65af6842bcc271abe6ceef5e9eb756d19848c0eaed7dbab87bc5bf3a",
      "lang": "typescript",
      "lines": 51,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/lib/pushClient.ts",
      "chunks": [
        {
          "i": 0,
          "text": "// src/lib/pushClient.ts\nimport { supabase } from \"@/lib/supaBaseClient\";\n\nconst PUBLIC_VAPID = process.env.NEXT_PUBLIC_VAPID_PUBLIC_KEY || \"\";\n\nfunction urlBase64ToUint8Array(base64String: string) {\n  const padding = \"=\".repeat((4 - (base64String.length % 4)) % 4);\n  const base64 = (base64String + padding).replace(/-/g, \"+\").replace(/_/g, \"/\");\n  const raw = atob(base64);\n  const output = new Uint8Array(raw.length);\n  for (let i = 0; i < raw.length; ++i) output[i] = raw.charCodeAt(i);\n  return output;\n}\n\nexport async function ensureServiceWorker() {\n  if (!(\"serviceWorker\" in navigator)) throw new Error(\"Service Worker ei tuettu\");\n  const reg = await navigator.serviceWorker.register(\"/sw.js\");\n  await navigator.serviceWorker.ready;\n  return reg;\n}\n\nexport async function requestPermissionAndSubscribe(): Promise<boolean> {\n  if (!PUBLIC_VAPID) { console.error(\"NEXT_PUBLIC_VAPID_PUBLIC_KEY puuttuu\"); return false; }\n\n  const perm = await Notification.requestPermission();\n  if (perm !== \"granted\") return false;\n\n  const reg = await ensureServiceWorker();\n  const sub = await reg.pushManager.subscribe({\n    userVisibleOnly: true,\n    applicationServerKey: urlBase64ToUint8Array(PUBLIC_VAPID),\n  });\n\n  // talleta supabaseen\nconst json: PushSubscriptionJSON = sub.toJSON();\nconst endpoint: string = json.endpoint!;\nconst p256dh: string | undefined = json.keys?.p256dh;\nconst auth: string | undefined = json.keys?.auth;\n\nconst { error } = await supabase\n  .from(\"push_subscriptions\")\n  .upsert({ endpoint, p256dh, auth, is_active: true }, { onConflict: \"endpoint\" });\n\nif (error) {\n  console.error(error);\n  return false;\n}\nreturn true;\n\n}\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 50
        }
      ]
    },
    {
      "path": "src/lib/sendEmail.ts",
      "size": 766,
      "sha256": "6654a59ca7f63a22cc15f465e693f9145c6b4db3b3aeea7f3767000012ef69c4",
      "lang": "typescript",
      "lines": 32,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/lib/sendEmail.ts",
      "chunks": [
        {
          "i": 0,
          "text": "export type SendEmailPayload = {\n  to: string | string[];\n  subject: string;\n  text?: string;\n  html?: string;\n  replyTo?: string;\n};\n\nlet lastCall = 0;\n\nexport async function sendEmail(payload: SendEmailPayload) {\n  // Throttlaus: max 2 kutsua / sekunti Resendiin\n  const now = Date.now();\n  const diff = now - lastCall;\n  if (diff < 1000) {\n    await new Promise((res) => setTimeout(res, 600 - diff));\n  }\n  lastCall = Date.now();\n\n  const res = await fetch(\"/api/sendEmail\", {\n    method: \"POST\",\n    headers: { \"Content-Type\": \"application/json\" },\n    body: JSON.stringify(payload),\n  });\n\n  const data = await res.json().catch(() => ({}));\n  if (!res.ok) {\n    throw new Error(`Email send failed (${res.status}) ${JSON.stringify(data)}`);\n  }\n  return data;\n}\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 31
        }
      ]
    },
    {
      "path": "src/lib/settingsDb.ts",
      "size": 2630,
      "sha256": "77806229a96c16119e442badefeb3ffc2b186b0f5b143c93fd7f0959e5018d92",
      "lang": "typescript",
      "lines": 70,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/lib/settingsDb.ts",
      "chunks": [
        {
          "i": 0,
          "text": "// src/lib/settingsDb.ts\nimport type { Settings } from \"@/lib/settingsSchema\";\n\n\n function resolveFunctionsBase(): string {\n   const direct = process.env.NEXT_PUBLIC_SUPABASE_FUNCTIONS_URL?.trim();\n   if (direct) return direct.replace(/\\/+$/, \"\");\n   const supaUrl = process.env.NEXT_PUBLIC_SUPABASE_URL?.trim();\n   if (!supaUrl) throw new Error(\"Missing NEXT_PUBLIC_SUPABASE_URL\");\n   if (supaUrl.includes(\"localhost\") || supaUrl.includes(\"127.0.0.1\")) {\n     if (typeof window !== \"undefined\") {\n       const h = window.location.hostname;\n       if (h && h !== \"localhost\" && h !== \"127.0.0.1\") {\n         return `http://${h}:54321/functions/v1`;\n       }\n     }\n     return \"http://127.0.0.1:54321/functions/v1\";\n   }\n   return supaUrl.replace(\".supabase.co\", \".functions.supabase.co\");\n }\n const FN_URL = `${resolveFunctionsBase()}/app_settings`;\n\n async function getAuthToken(): Promise<string | undefined> {\n   // Next.js clientissä: hae token supabasen kautta\n   try {\n     const { createClient } = await import(\"@supabase/supabase-js\");\n     const supabase = createClient(\n       process.env.NEXT_PUBLIC_SUPABASE_URL!,\n       process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\n     );\n     const { data: { session } } = await supabase.auth.getSession();\n     return session?.access_token;\n   } catch {\n     return undefined;\n   }\n }\n\nexport async function saveNotificationSettingsToDb(notifs: Settings[\"notifications\"]) {\n  if (typeof window !== \"undefined\") console.log(\"[app_settings] FN_URL:\", FN_URL);\n   const token = await getAuthToken();\n   const anon = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n   const res = await fetch(FN_URL, {\n     method: \"PUT\",\n     mode: \"cors\",\n     headers: {\n       \"content-type\": \"application/json\",\n       ...(token || anon ? { Authorization: `Bearer ${token ?? anon}` } : {}),\n     },\n     body: JSON.stringify({ notifications: notifs }),\n   });\n   if (!res.ok) {\n     const j = await res.json().catch(() => ({}));\n     throw new Error(j?.error ?? `Failed to save settings (${res.status})`);\n   }\n}\n export async function loadNotificationSettingsFromDb():\n   Promise<Settings[\"notifications\"]> {\n   const token = await getAuthToken();\n   const anon = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n   const res = await fetch(FN_URL, {\n     method: \"GET\",\n     headers: { ...(token || anon ? { Authorization: `Bearer ${token ?? anon}` } : {}) },\n   });\n   if (!res.ok) {\n     const j = await res.json().catch(() => ({}));\n     throw new Error(j?.error ?? `Failed to load settings (${res.status})`);\n   }\n   const j = await res.json();\n   return j.notifications as Settings[\"notifications\"];\n }",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 70
        }
      ]
    },
    {
      "path": "src/lib/settingsSchema.ts",
      "size": 4055,
      "sha256": "931574dd080047f934133cee1a9649615f5c1a364db5e4d091cfe81414a31f1d",
      "lang": "typescript",
      "lines": 137,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/lib/settingsSchema.ts",
      "chunks": [
        {
          "i": 0,
          "text": "// lib/settingsSchema.ts\nimport { z } from \"zod\";\n\nexport const themeValues = [\"light\", \"dark\", \"system\"] as const;\nexport type Theme = typeof themeValues[number];\n\nexport const languageValues = [\"fi\", \"en\", \"sv\"] as const;\nexport type Language = typeof languageValues[number];\n\nexport const weekStartValues = [\"monday\", \"sunday\"] as const;\nexport type WeekStartDay = typeof weekStartValues[number];\n\nexport const timeFormatValues = [\"24h\", \"12h\"] as const;\nexport type TimeFormat = typeof timeFormatValues[number];\n\nexport const dateFormatValues = [\"dd.mm.yyyy\", \"mm/dd/yyyy\", \"yyyy-mm-dd\"] as const;\nexport type DateFormat = typeof dateFormatValues[number];\n\nexport type TimePeriod = 7 | 10 | 14 | 30;\n\nexport const GeneralSettingsSchema = z.object({\n  theme: z.enum(themeValues),\n  language: z.enum(languageValues),\n  weekStartDay: z.enum(weekStartValues),\n  timeFormat: z.enum(timeFormatValues),\n  dateFormat: z.enum(dateFormatValues),\n  defaultTimePeriod: z.union([z.literal(7), z.literal(10), z.literal(14), z.literal(30)]),\n  workingHours: z.object({\n    start: z.string().regex(/^\\d{2}:\\d{2}$/),\n    end: z.string().regex(/^\\d{2}:\\d{2}$/),\n    breakDuration: z.number().int().min(0).max(240),\n  }),\n  autoSave: z.boolean(),\n  autoSaveInterval: z.number().int().min(10).max(300),\n});\n\nexport const AutoGenSettingsSchema = z.object({\n  defaultMinutes: z.number().int().min(1).max(720),\n  distributeEvenly: z.boolean(),\n  respectWorkingHours: z.boolean(),\n  skipWeekends: z.boolean(),\n  skipHolidays: z.boolean(),\n  maxConsecutiveDays: z.number().int().min(1).max(14),\n  minRestMinutes: z.number().int().min(60).max(1440),\n});\n\nexport const ExportSettingsSchema = z.object({\n  companyName: z.string().max(120),\n  includeNames: z.boolean(),\n  includeEmails: z.boolean(),\n  includeDepartments: z.boolean(),\n  includeInactiveEmployees: z.boolean(),\n  includeEmptyShifts: z.boolean(),\n  includeHourTotals: z.boolean(),\n});\n\nexport const NotificationSettingsSchema = z.object({\n  emailNotifications: z.boolean(),\n  adminNotificationEmails: z.array(z.string().email()).max(50).default([]),\n  absenceRequests: z.boolean(),\n  scheduleChanges: z.boolean(),\n  employeeUpdates: z.boolean(),\n  systemUpdates: z.boolean(),\n  dailyDigest: z.boolean(),\n  digestTime: z.string().regex(/^\\d{2}:\\d{2}$/),\n});\n\nexport const SystemSettingsSchema = z.object({\n  version: z.string(),\n  lastBackup: z.string().nullable().optional(),\n  maintenanceMode: z.boolean(),\n  debugMode: z.boolean(),\n  maxEmployees: z.number().int().min(1).max(1000),\n  dataRetentionDays: z.number().int().min(30).max(3650),\n});\n\nexport const SettingsSchema = z.object({\n  general: GeneralSettingsSchema,\n  autoGeneration: AutoGenSettingsSchema,\n  export: ExportSettingsSchema,\n  notifications: NotificationSettingsSchema,\n  system: SystemSettingsSchema,\n});\n\nexport type Settings = z.infer<typeof SettingsSchema>;\n\n// Oletukset\nexport const DEFAULT_SETTINGS: Settings = {\n  general: {\n    theme: \"light\",\n    language: \"fi\",\n    weekStartDay: \"monday\",\n    timeFormat: \"24h\",\n    dateFormat: \"dd.mm.yyyy\",\n    defaultTimePeriod: 30,\n    workingHours: { start: \"08:00\", end: \"17:00\", breakDuration: 30 },\n    autoSave: true,\n    autoSaveInterval: 60,\n  },\n  autoGeneration: {\n    defaultMinutes: 480,\n    distributeEvenly: false,\n    respectWorkingHours: true,\n    skipWeekends: true,\n    skipHolidays: false,\n    maxConsecutiveDays: 5,\n    minRestMinutes: 660,\n  },\n  export: {\n    companyName: \"Yritys Oy\",\n    includeNames: true,\n    includeEmails: false,\n    includeDepartments: true,\n    includeInactiveEmployees: false,\n    includeEmptyShifts: true,\n    includeHourTotals: true,\n  },\n  notifications: {\n    emailNotifications: true,\n    absenceRequests: true,\n    adminNotificationEmails: [],\n    scheduleChanges: true,\n    employeeUpdates: false,\n    systemUpdates: false,\n    dailyDigest: false,\n    digestTime: \"08:00\",\n  },\n  system: {\n    version: \"1.0.0\",\n    lastBackup: null,\n    maintenanceMode: false,\n    debugMode: false,\n    maxEmployees: 100,\n    dataRetentionDays: 365,\n  },\n};\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 136
        }
      ]
    },
    {
      "path": "src/lib/supaBaseClient.ts",
      "size": 311,
      "sha256": "d5c5639a567f47abfef3e833d7e6c9963b74214b04d8c805890df4eb9bd76096",
      "lang": "typescript",
      "lines": 5,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/lib/supaBaseClient.ts",
      "chunks": [
        {
          "i": 0,
          "text": "import { createClientComponentClient } from \"@supabase/auth-helpers-nextjs\";\n\n// App Router: yksi selain-client kaikille client-komponenteille.\n// Tämä käyttää auth-helpersin cookie-sessiota, jolloin middleware ja API-reitit näkevät saman sessionin.\nexport const supabase = createClientComponentClient();",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 5
        }
      ]
    },
    {
      "path": "src/lib/theme.ts",
      "size": 703,
      "sha256": "353d0508a52528960c4a3f52d96e6595b0cf166c0952c2e5cde2a61ef41604b4",
      "lang": "typescript",
      "lines": 21,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/lib/theme.ts",
      "chunks": [
        {
          "i": 0,
          "text": "// src/lib/theme.ts\nexport type ThemeMode = \"light\" | \"dark\" | \"system\";\n\n/**\n * Asettaa dokumentin teeman: light/dark tai järjestelmän mukaan.\n * Ei heitä virheitä – toimii myös SSR:ssa guardien ansiosta.\n */\nexport function applyTheme(mode: ThemeMode) {\n  if (typeof window === \"undefined\" || typeof document === \"undefined\") return;\n  try {\n    localStorage.setItem(\"soili-theme\", mode);\n  } catch {\n    // ignore storage errors\n  }\n  const prefersDark = window.matchMedia?.(\"(prefers-color-scheme: dark)\")?.matches ?? false;\n  const eff = mode === \"system\" ? (prefersDark ? \"dark\" : \"light\") : mode;\n  const c = document.documentElement.classList;\n  c.remove(\"light\",\"dark\");\n  c.add(eff);\n}\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 20
        }
      ]
    },
    {
      "path": "src/lib/timeUtils.ts",
      "size": 185,
      "sha256": "318fbb780303db65d0a58a924af0eedad322f64c49133ba93cffd3600c098281",
      "lang": "typescript",
      "lines": 7,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/lib/timeUtils.ts",
      "chunks": [
        {
          "i": 0,
          "text": "// src/lib/timeUtils.ts\nexport function formatMinutes(total: number): string {\n  const h = Math.floor(total / 60);\n  const m = total % 60;\n  return m === 0 ? `${h}h` : `${h}h ${m}m`;\n}\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 6
        }
      ]
    },
    {
      "path": "src/store/useScheduleStore.ts",
      "size": 10774,
      "sha256": "a69064ff7ec1874fb5074a2665a4edc9947e3c8f2e015368d092b2ebc533098c",
      "lang": "typescript",
      "lines": 400,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/store/useScheduleStore.ts",
      "chunks": [
        {
          "i": 0,
          "text": "// src/store/useScheduleStore.ts\n\"use client\";\n\nimport { create } from \"zustand\";\nimport { devtools } from \"zustand/middleware\";\nimport { toast } from \"sonner\";\nimport { supabase } from \"@/lib/supaBaseClient\";\nimport { persist, createJSONStorage } from \"zustand/middleware\";\n\n\n\n// KÄYTÄ YHTÄ TOTUUTTA: ota tyypit yhdestä paikasta\nimport type { Employee, DateInfo } from \"@/app/types\";\n\n// Sama DateCell kuin muualla\nexport type DateCell = DateInfo & { iso: string };\n\n// Yhden solun persistomuoto\nexport type ShiftRow = {\n  employee_id: string;\n  work_date: string; // YYYY-MM-DD\n  type: \"normal\" | \"locked\" | \"absent\" | \"holiday\";\n  minutes: number | null; // tallennetaan aina kokonaisminuuteissa (esim. 255 = 4h15m)\n};\n// Suodattimien tyyppi\nexport type Filters = {\n  departments: string[];\n  showActive: boolean;\n  showInactive: boolean;\n  searchTerm: string;\n};\n\n// Sisäinen muutos, jota kerätään saveAll:lle\ntype PendingChange = {\n  employee_id: string;\n  work_date: string;\n  minutes: number | null; // null => poista, >0 => upsert \"normal\"\n};\n\n\ntype State = {\n\n  // Hydratoitu perusdata\n  employees: Employee[];\n  dates: DateCell[];\n  \n\n  // Vuorot mapattuna\n  shiftsMap: Record<string, ShiftRow>;\n\n  // Muutokset jotka pitää tallentaa\n  pending: Record<string, PendingChange>;\n\n  // Undo/redo pino\n  undoStack: PendingChange[];\n  redoStack: PendingChange[];\n\n  // UI-signaalit\n  dirty: boolean;\n\n  // Filtterit\n  filters: Filters;\n  setFilters: (patch: Partial<Filters>) => void;\n  resetFilters: () => void;\n\n  startDateISO: string;\n  days: 7 | 10 | 14 | 30;\n\n  setRange: (startISO: string, days: State[\"days\"]) => void;\n  setStartDate: (startDateISO: string) => void;\n  shiftRange: (deltaDays: number) => void;\n  hasHydrated: boolean;\n  _setHydrated: (v: boolean) => void;\n  saving: boolean;  // <-- tämä\n\n  // Toiminnot\n  hydrate: (payload: {\n    employees: Employee[];\n    dates: DateCell[];\n    shifts: ShiftRow[];\n  }) => void;\n\n  applyCellChange: (p: { employee_id: string; work_date: string; minutes: number | null }) => void;\n\n  saveAll: () => Promise<void>;\n  publishStatus: \"idle\" | \"pending\" | \"sent\" | \"canceled\";\n  publishShifts: () => Promise<void>;\n  unpublishShifts: () => Promise<void>;\n\n  undo: () => void;\n  redo: () => void;\n};\n\nfunction keyOf(empId: string, iso: string) {\n  return `${empId}|${iso}`;\n}\n\n// Normalisoi päivämäärä aina YYYY-MM-DD muotoon\nfunction normalizeDate(dateStr: string) {\n  if (!dateStr) return dateStr;\n  return dateStr.slice(0, 10);\n}\n\nfunction todayLocalISO() {\n  const d = new Date();\n  d.setHours(0, 0, 0, 0);\n  const yyyy = d.getFullYear();\n  const mm = String(d.getMonth() + 1).padStart(2, \"0\");\n  const dd = String(d.getDate()).padStart(2, \"0\");\n  return `${yyyy}-${mm}-${dd}`;\n}\n\nexport const useScheduleStore = create<State>()(\n  persist(\n  devtools((set, get) => ({\n    publishStatus: \"idle\",\n    employees: [],\n    dates: [],\n    shiftsMap: {},\n    pending: {},\n    undoStack: [],\n    redoStack: [],\n    dirty: false,\n    saving: false,\n    hasHydrated: false,\n    _setHydrated: (v) => set({ hasHydrated: v }),\n    \n     // ---Filtterit (init + setterit juureen)---\n     filters: { departments: [], showActive: false, showInactive: false, searchTerm: \"\" },\n     setFilters: (partial) =>\n       set((state) => ({ filters: { ...state.filters, ...partial } })),\n     resetFilters: () =>\n       set({ filters: { departments: [], showActive: false, showInactive: false, searchTerm: \"\" } }),\n\nstartDateISO: todayLocalISO(),\ndays: 10 as State[\"days\"],\n\n    hydrate: ({ employees, dates, shifts }) => {\n      // Rakennetaan map shifteistä\n      const map: Record<string, ShiftRow> = {};\n      for (const s of shifts) {\n        map[keyOf(s.employee_id, s.work_date)] = {\n          ...s,\n          minutes: s.minutes, // null pysyy nullina\n          // Varmista että type on unionista (tai normal jos tuntematon)\n          type:\n            s.type === \"normal\" ||\n            s.type === \"locked\" ||\n            s.type === \"absent\" ||\n            s.type === \"holiday\"\n              ? s.type\n              : \"normal\",\n        };\n      }\n      set({\n        employees,\n        dates,\n        shiftsMap: map,\n        pending: {},\n        undoStack: [],\n        redoStack: [],\n        dirty: false,\n      });\n    },\n\napplyCellChange: ({ employee_id, work_date, minutes }) => {\n  const m = typeof minutes === \"number\" ? minutes : null;\n  const dateISO = normalizeDate(work_date);\n  const k = keyOf(employee_id, dateISO);\n  const { shiftsMap, pending, undoStack } = get();\n\n  const prev = shiftsMap[k];\n  const nextMap = { ...shiftsMap };\n  const nextPending = { ...pending };\n\nif (minutes === null || minutes <= 0) {\n  delete nextMap[k]; \n  nextPending[k] = { employee_id, work_date: dateISO, minutes: null }; // merkkaa poisto pendingiin\n} else {\n  nextMap[k] = {\n    employee_id,\n    work_date: dateISO,\n    type: \"normal\",\n    minutes,\n  };\n  nextPending[k] = { employee_id, work_date: dateISO, minutes };\n}\n\n\n  set({\n    shiftsMap: nextMap,\n    pending: nextPending,\n    undoStack: [...undoStack, { employee_id, work_date, minutes: prev?.minutes ?? 0 }],\n    redoStack: [],\n    dirty: true,\n  });\n},\n\n\n\nsetRange: (startISO, days) => set({ startDateISO: startISO, days }),\nsetStartDate: (startDateISO: string) => set({ startDateISO }),\nshiftRange: (deltaDays: number) => {\n  const { startDateISO, days } = get();\n  const d = new Date(startDateISO + \"T00:00:00Z\");\n  d.setUTCDate(d.getUTCDate() + deltaDays);\n  set({ startDateISO: d.toISOString().slice(0, 10), days });\n},\n\nsaveAll: async () => {\n  if (get().saving) {\n    console.log(\"SaveAll already running\");\n    return;\n  }\n\n  set({ saving: true });\n\n  try {\n    while (true) {\n      const { pending } = get();\n      const changes = Object.entries(pending);\n      if (!changes.length) break;\n\n      const upserts: ShiftRow[] = [];\n      const deletes: { employee_id: string; work_date: string }[] = [];\n\n      // kerätään tämän batchin rivit\n      const batchKeys: string[] = [];\n\n      for (const [key, c] of changes) {\n        batchKeys.push(key);\n\n        const dateISO = new Date(normalizeDate(c.work_date))\n          .toISOString()\n          .slice(0, 10);\n\n        if (c.minutes === null || c.minutes <= 0) {\n          deletes.push({ employee_id: c.employee_id, work_date: dateISO });\n        } else {\n          upserts.push({\n            employee_id: c.employee_id,\n            work_date: dateISO,\n            type: \"normal\",\n            minutes: c.minutes,\n          });\n        }\n      }\n\n      console.log(\"SAVEALL BULK DEBUG\", { deletes, upserts });\n\n      const { error } = await supabase.rpc(\"save_shifts_bulk\", {\n        _deletes: deletes,\n        _upserts: upserts,\n      });\n      if (error) throw error;\n\n      // ✅ poista käsitellyt rivit pendingistä\n      set((state) => {\n        const nextPending = { ...state.pending };\n        for (const k of batchKeys) {\n          delete nextPending[k];\n        }\n        return { pending: nextPending, dirty: Object.keys(nextPending).length > 0 };\n      });\n    }\n\n    toast.success(\"Tallennettu\");\n  } catch (e) {\n    console.error(\"saveAll error:\", e);\n    toast.error(\"Tallennus epäonnistui\");\n  } finally {\n    set({ saving: false });\n  }\n},\n\n\n\n\npublishShifts: async () => {\n  try {\n    await get().saveAll();\n\n    const { startDateISO, days } = get();\n    const endDate = new Date(startDateISO);\n    endDate.setDate(endDate.getDate() + days - 1);\n    const endISO = endDate.toISOString().slice(0, 10);\n\n    const { error } = await supabase.rpc(\"publish_shifts_instant\", {\n      _start_date: startDateISO,\n      _end_date: endISO,\n    });\n    if (error) throw error;\n\n    set({ publishStatus: \"sent\" });\n    toast.success(\"Vuorot julkaistu ja lähetetty heti!\");\n  } catch (e) {\n    console.error(\"publishShifts error:\", e);\n    toast.error(\"Julkaisu epäonnistui\");\n  }\n},\n\n\n\n    undo: () => {\n      const { undoStack, shiftsMap, pending, redoStack } = get();\n      if (!undoStack.length) return;\n      const last = undoStack[undoStack.length - 1];\n\n      const k = keyOf(last.employee_id, last.work_date);\n      const current = shiftsMap[k]; // mitä on nyt UI:ssa\n\n      // Palauta entinen tuntimäärä\n      const nextMap = { ...shiftsMap };\n        if (last.minutes === null || last.minutes <= 0) {\n        delete nextMap[k];\n      } else {\n        nextMap[k] = {\n          employee_id: last.employee_id,\n          work_date: last.work_date,\n          type: \"normal\",\n          minutes: last.minutes,\n        };\n      }\n\n      // Päivitä pending vastaamaan undo-tilaa\n      const nextPending = { ...pending, [k]: { employee_id: last.employee_id, work_date: last.work_date, minutes: last.minutes } };\n\n      // Siirrä nykyinen tila redo-pinon itemiksi\n      const redoItem: PendingChange = {\n        employee_id: last.employee_id,\n        work_date: last.work_date,\n        minutes: current?.minutes ?? null,\n      };\n\n      set({\n        shiftsMap: nextMap,\n        pending: nextPending,\n        undoStack: undoStack.slice(0, -1),\n        redoStack: [...redoStack, redoItem],\n        dirty: true,\n      });\n    },\n\n    redo: () => {\n      const { redoStack, shiftsMap, pending, undoStack } = get();\n      if (!redoStack.length) return;\n      const next = redoStack[redoStack.length - 1];\n\n      const k = keyOf(next.employee_id, next.work_date);\n      const prev = shiftsMap[k];\n\n      const nextMap = { ...shiftsMap };\n      if (next.minutes === null || next.minutes <= 0) {\n        delete nextMap[k];\n      } else {\n        nextMap[k] = {\n          employee_id: next.employee_id,\n          work_date: next.work_date,\n          type: \"normal\",\n          minutes: next.minutes,\n        };\n      }\n\n      const nextPending = { ...pending, [k]: { ...next } };\n\n      set({\n        shiftsMap: nextMap,\n        pending: nextPending,\n        redoStack: redoStack.slice(0, -1),\n        undoStack: [...undoStack, { employee_id: next.employee_id, work_date: next.work_date, minutes: prev?.minutes ?? 0 }],\n        dirty: true,\n      });\n    },\n  })),\n    {\n      name: \"schedule-ui\", // avain localStorageen\n      version: 1,\n      storage:\n        typeof window !== \"undefined\"\n          ? createJSONStorage(() => localStorage)\n          : undefined,\n      // persistoi vain nämä (ei esim. shiftsMap tms.)\n      partialize: (state) => ({\n        startDateISO: state.startDateISO,\n        days: state.days,\n      }),\n      // Kun persist-hydraus valmistuu -> merkitse valmiiksi\n      onRehydrateStorage: () => (_state, error) => {\n        if (error) {\n          console.error(\"schedule-ui rehydrate failed\", error);\n          return;\n        }\n        // Ei 'set' scope:ssa -> kutsu action store-instanssin kautta\n        _state?._setHydrated?.(true);\n      },\n  }\n  )\n);\n\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 399
        }
      ]
    },
    {
      "path": "src/store/useSettingsStore.ts",
      "size": 6866,
      "sha256": "294dc83e38274572455d1850345f9353dccf732e12b7b0fedbc586d2b416199c",
      "lang": "typescript",
      "lines": 240,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/store/useSettingsStore.ts",
      "chunks": [
        {
          "i": 0,
          "text": "// stores/useSettingsStore.ts\nimport { create } from \"zustand\";\nimport { persist, subscribeWithSelector } from \"zustand/middleware\";\nimport {\n  Settings,\n  SettingsSchema,\n  DEFAULT_SETTINGS,\n  Theme,\n} from \"@/lib/settingsSchema\";\n\ntype State = {\n  settings: Settings;\n\n  setAll: (s: Settings) => void;\n  reset: () => void;\n\n  updateGeneral: <K extends keyof Settings[\"general\"]>(\n    key: K,\n    value: Settings[\"general\"][K]\n  ) => void;\n\n  updateAutoGen: <K extends keyof Settings[\"autoGeneration\"]>(\n    key: K,\n    value: Settings[\"autoGeneration\"][K]\n  ) => void;\n\n  updateExport: <K extends keyof Settings[\"export\"]>(\n    key: K,\n    value: Settings[\"export\"][K]\n  ) => void;\n\n  updateNotifications: <K extends keyof Settings[\"notifications\"]>(\n    key: K,\n    value: Settings[\"notifications\"][K]\n  ) => void;\n\n  updateSystem: <K extends keyof Settings[\"system\"]>(\n    key: K,\n    value: Settings[\"system\"][K]\n  ) => void;\n\n  importFromJson: (raw: unknown) =>\n    | { ok: true }\n    | { ok: false; error: string };\n\n  exportToFile: () => void;\n  hasHydrated: boolean;\n  _setHydrated: (v: boolean) => void;\n};\n\n// ✅ OIKEA KOKOONPANO: persist(subscribeWithSelector(config), options)\nexport const useSettingsStore = create<State>()(\n  persist(\n    subscribeWithSelector<State>((set, get) => ({\n      settings: DEFAULT_SETTINGS,\n\n      setAll: (s) => set({ settings: s }),\n      reset: () => set({ settings: DEFAULT_SETTINGS }),\n\n      updateGeneral: (key, value) =>\n        set((st) => ({\n          settings: {\n            ...st.settings,\n            general: { ...st.settings.general, [key]: value },\n          },\n        })),\n\n      updateAutoGen: (key, value) =>\n        set((st) => ({\n          settings: {\n            ...st.settings,\n            autoGeneration: {\n              ...st.settings.autoGeneration,\n              [key]: value,\n            },\n          },\n        })),\n\n      updateExport: (key, value) =>\n        set((st) => ({\n          settings: {\n            ...st.settings,\n            export: { ...st.settings.export, [key]: value },\n          },\n        })),\n\n      updateNotifications: (key, value) =>\n        set((st) => ({\n          settings: {\n            ...st.settings,\n            notifications: {\n              ...st.settings.notifications,\n              [key]: value,\n            },\n          },\n        })),\n\n      updateSystem: (key, value) =>\n        set((st) => ({\n          settings: {\n            ...st.settings,\n            system: { ...st.settings.system, [key]: value },\n          },\n        })),\n\n      importFromJson: (raw) => {\n        let data: unknown = raw;\n        if (typeof raw === \"string\") {\n          try {\n            data = JSON.parse(raw);\n          } catch {\n            return {\n              ok: false as const,\n              error: \"Virheellinen JSON: ei voitu jäsentää.\",\n            };\n          }\n        }\n\n        const parsed = SettingsSchema.safeParse(data);\n        if (!parsed.success) {\n          const msg = parsed.error.issues\n            .map((i) => `${i.path.join(\".\") || \"(root)\"}: ${i.message}`)\n            .join(\"; \");\n          return { ok: false as const, error: msg };\n        }\n\n        set({ settings: parsed.data });\n        return { ok: true as const };\n      },\n\n      exportToFile: () => {\n        const data = JSON.stringify(get().settings, null, 2);\n        const blob = new Blob([data], { type: \"application/json\" });\n        const url = URL.createObjectURL(blob);\n        const a = document.createElement(\"a\");\n        a.href = url;\n        a.download = \"soili-settings.json\";\n        document.body.appendChild(a);\n        a.click();\n        a.remove();\n        URL.revokeObjectURL(url);\n      },\n\n      hasHydrated: false,\n      _setHydrated: (v) => set({ hasHydrated: v }),\n\n    })),\n    {\n      name: \"soili-settings-v2\",\n          version: 2,\nmigrate: (persisted: unknown): State => {\n  try {\n    // jos dataa ei ole → palauta default state\n    if (!persisted || typeof persisted !== \"object\") {\n      return { settings: DEFAULT_SETTINGS, hasHydrated: false, _setHydrated: () => {}, setAll: () => {}, reset: () => {}, updateGeneral: () => {}, updateAutoGen: () => {}, updateExport: () => {}, updateNotifications: () => {}, updateSystem: () => {}, importFromJson: () => ({ ok: false, error: \"not implemented\" }), exportToFile: () => {} } as State;\n    }\n\n    const st = persisted as State;\n    if (!st?.settings) {\n      return { ...st, settings: DEFAULT_SETTINGS };\n    }\n\n    const prevNotifs: Partial<Settings[\"notifications\"]> | undefined =\n      st.settings.notifications;\n\n    const nextNotifs: Settings[\"notifications\"] = {\n      ...prevNotifs,\n      adminNotificationEmails: Array.isArray(\n        prevNotifs?.adminNotificationEmails\n      )\n        ? prevNotifs!.adminNotificationEmails!\n        : [],\n      emailNotifications:\n        prevNotifs?.emailNotifications ?? DEFAULT_SETTINGS.notifications.emailNotifications,\n      absenceRequests:\n        prevNotifs?.absenceRequests ?? DEFAULT_SETTINGS.notifications.absenceRequests,\n      scheduleChanges:\n        prevNotifs?.scheduleChanges ?? DEFAULT_SETTINGS.notifications.scheduleChanges,\n      employeeUpdates:\n        prevNotifs?.employeeUpdates ?? DEFAULT_SETTINGS.notifications.employeeUpdates,\n      systemUpdates:\n        prevNotifs?.systemUpdates ?? DEFAULT_SETTINGS.notifications.systemUpdates,\n      dailyDigest:\n        prevNotifs?.dailyDigest ?? DEFAULT_SETTINGS.notifications.dailyDigest,\n      digestTime:\n        prevNotifs?.digestTime ?? DEFAULT_SETTINGS.notifications.digestTime,\n    };\n\n    return {\n      ...st,\n      settings: {\n        ...st.settings,\n        notifications: nextNotifs,\n      },\n    };\n  } catch {\n    // fallback jos jotain hajoaa → default state\n    return { settings: DEFAULT_SETTINGS } as State;\n  }\n},\n\n\n      onRehydrateStorage: () => (_state, error) => {\n        if (error) {\n          console.error(\"settings-store rehydrate failed\", error);\n          return;\n        }\n        _state?._setHydrated?.(true);\n      },\n    }\n  )\n);\n\n// (valinnainen) teema- ja push-sivuvaikutukset:\nif (typeof window !== \"undefined\") {\n  const applyTheme = (theme: Theme) => {\n    const root = document.documentElement;\n    const prefersDark =\n      window.matchMedia?.(\"(prefers-color-scheme: dark)\").matches;\n    const eff = theme === \"system\" ? (prefersDark ? \"dark\" : \"light\") : theme;\n    root.classList.remove(\"light\", \"dark\");\n    root.classList.add(eff);\n  };\n\n  applyTheme(useSettingsStore.getState().settings.general.theme);\n\n  useSettingsStore.subscribe(\n    (s) => s.settings.general.theme,\n    (theme) => applyTheme(theme)\n  );\n}\n\n// Apukoukku jos haluat kytkeä autosaven muualle\nexport function useAutoSaveConfig() {\n  return useSettingsStore((s) => ({\n    enabled: s.settings.general.autoSave,\n    intervalSec: s.settings.general.autoSaveInterval,\n  }));\n}\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 239
        }
      ]
    },
    {
      "path": "src/app/components/AbsenceControlPanel.tsx",
      "size": 14050,
      "sha256": "279c206a2bfa1ca624d56e66db07d7d9e208e4cd2520d17c1a5a5d59c7c37bc0",
      "lang": "tsx",
      "lines": 361,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/AbsenceControlPanel.tsx",
      "chunks": [
        {
          "i": 0,
          "text": "\"use client\";\n\nimport React, { useEffect, useState } from 'react';\nimport { Card, CardContent, CardHeader, CardTitle } from './ui/card';\nimport { Button } from './ui/button';\nimport { Badge } from './ui/badge';\nimport { Avatar, AvatarFallback } from './ui/avatar';\nimport { Textarea } from './ui/textarea';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from './ui/dialog';\nimport { \n  Clock, \n  CheckCircle, \n  XCircle, \n  Calendar,\n  MessageSquare,\n  User,\n  AlertTriangle\n} from 'lucide-react';\nimport { AbsenceRequest } from '../types';\nimport { toast } from 'sonner';\nimport { supabase } from '@/lib/supaBaseClient';\nimport { notifyAbsenceDecision } from '@/features/absences/notify';\nimport { useSettingsStore } from \"@/store/useSettingsStore\";\n\n\nconst AbsenceControlPanel = () => {\n  const [requests, setRequests] = useState<AbsenceRequest[]>([]);\n  const [adminResponse, setAdminResponse] = useState('');\n\n  const emailEnabled =\n  useSettingsStore((s) => s.settings?.notifications?.emailNotifications ?? true);\n\n  // --- FETCH FROM SUPABASE ---\n  useEffect(() => {\n    const fetchAbsences = async () => {\nconst { data, error } = await supabase\n  .from('time_off_requests')\n  .select(`\n    id,\n    employee_id,\n    start_date,\n    end_date,\n    reason,\n    message,\n    status,\n    submitted_at,\n    employees:employees!time_off_requests_employee_id_fkey ( name )\n  `)\n  .order('submitted_at', { ascending: false });\n\nif (error) {\n  console.error(error);\n  toast.error('Poissaolojen haku epäonnistui');\n  return;\n}\n\ntype AbsenceRow = {\n  id: string;\n  employee_id: string;\n  start_date: string;\n  end_date: string | null;\n  reason: string | null;\n  message: string | null;\n  status: 'pending' | 'approved' | 'declined';\n  submitted_at: string;\n  employees?: { name: string }[] | { name: string } | null;\n};\n\nconst mapped: AbsenceRequest[] = (data as AbsenceRow[]).map((r) => {\n  const employeeName = Array.isArray(r.employees)\n    ? r.employees[0]?.name\n    : r.employees?.name;\n\n  return {\n    id: r.id,\n    employeeId: r.employee_id,\n    employeeName: employeeName ?? 'Tuntematon',\n    startDate: r.start_date,\n    endDate: r.end_date ?? '',\n    reason: r.reason ?? '',\n    status: r.status,\n    submittedAt: r.submitted_at,\n    message: r.message ?? '',\n  };\n});\n\n\n      setRequests(mapped);\n      \n    };\n\n    fetchAbsences();\n  }, []);\n\n  // --- STATUS HELPERS (UI) ---\n  const getStatusBadge = (status: AbsenceRequest['status']) => {\n    switch (status) {\n      case 'pending':\n        return <Badge variant=\"outline\" className=\"bg-amber-50 text-amber-700 border-amber-300\"><Clock className=\"w-3 h-3 mr-1\" />Odottaa</Badge>;\n      case 'approved':\n        return <Badge variant=\"outline\" className=\"bg-green-50 text-green-700 border-green-300\"><CheckCircle className=\"w-3 h-3 mr-1\" />Hyväksytty</Badge>;\n      case 'declined':\n        return <Badge variant=\"outline\" className=\"bg-red-50 text-red-700 border-red-300\"><XCircle className=\"w-3 h-3 mr-1\" />Hylätty</Badge>;\n    }\n  };\n\n  // --- SUPABASE UPDATES ---\nconst handleApprove = async (requestId: string) => {\n  // Optimistinen päivitys\n  setRequests(prev => prev.map(r => r.id === requestId ? { ...r, status: 'approved' } : r));\n\n  const target = requests.find(r => r.id === requestId);\n  const { error } = await supabase.from('time_off_requests').update({ status: 'approved' }).eq('id', requestId);\n  if (error) {\n    console.error('[ABSENCE APPROVE ERROR]', error.code, error.message, error.details);\n    // revert\n    setRequests(prev => prev.map(r => r.id === requestId ? { ...r, status: 'pending' } : r));\n    toast.error('Hyväksyntä epäonnistui');\n    return;\n  }\n  // Lähetä sähköposti + loki notify.ts:n kautta (ei kaadeta hyväksyntää, jos maili epäonnistuu)\n  if (emailEnabled && target) {\n    try {\n      await notifyAbsenceDecision({\n        employeeIds: [target.employeeId],\n        status: \"approved\",\n        startDate: target.startDate,\n        endDate: target.endDate || null,\n        adminMessage: adminResponse?.trim() || undefined,\n      });\n    } catch (e) {\n      console.error(\"[EMAIL APPROVE ERROR]\", e);\n      toast.error(\"Sähköpostin lähetys epäonnistui (hyväksyntä tallessa).\");\n    }\n  }\n  toast.success('Poissaolopyyntö hyväksytty');\n};\n\n\nconst handleDecline = async (requestId: string) => {\n  setRequests(prev => prev.map(r => r.id === requestId ? { ...r, status: 'declined' } : r));\n\n  const target = requests.find(r => r.id === requestId);\n  const { error } = await supabase.from('time_off_requests').update({ status: 'declined' }).eq('id', requestId);\n  if (error) {\n    console.error('[ABSENCE DECLINE ERROR]', error.code, error.message, error.details);\n    setRequests(prev => prev.map(r => r.id === requestId ? { ...r, status: 'pending' } : r));\n    toast.error('Hylkäys epäonnistui');\n    return;\n  }\n\n  if (emailEnabled && target) {\n    try {\n      await notifyAbsenceDecision({\n        employeeIds: [target.employeeId],\n        status: \"declined\",\n        startDate: target.startDate,\n        endDate: target.endDate || null,\n        adminMessage: adminResponse?.trim() || undefined,\n      });\n    } catch (e) {\n      console.error(\"[EMAIL DECLINE ERROR]\", e);\n      toast.error(\"Sähköpostin lähetys epäonnistui (hylkäys tallessa).\");\n    }\n  }\n  toast.success('Poissaolopyyntö hylätty');\n};\n\n\n  // --- DERIVED LISTS (UI pysyy samana) ---\n  const pendingRequests = requests.filter(req => req.status === 'pending');\n  const processedRequests = requests.filter(req => req.status !== 'pending');\n\n  const formatDate = (dateString: string) => {\n    if (!dateString) return '';\n    return new Date(dateString).toLocaleDateString('fi-FI', {\n      day: 'numeric',\n      month: 'numeric',\n      year: 'numeric'\n    });\n  };\n\n  const formatDateTime = (dateString: string) => {\n    if (!dateString) return '';\n    return new Date(dateString).toLocaleDateString('fi-FI', {\n      day: 'numeric',\n      month: 'numeric',\n      hour: '2-digit',\n      minute: '2-digit'\n    });\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Pending Requests */}\n      <Card className=\"shadow-lg border-0 bg-gradient-to-r from-background to-secondary/20\">\n        <CardHeader className=\"pb-4\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center space-x-3\">\n              <AlertTriangle className=\"w-6 h-6 text-amber-500\" />\n              <CardTitle className=\"text-xl text-primary\">Odottavat poissaolopyynnöt</CardTitle>\n            </div>\n            <Badge variant=\"secondary\" className=\"px-3 py-1\">\n              {pendingRequests.length} pyyntöä\n            </Badge>\n          </div>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          {pendingRequests.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              <Calendar className=\"w-12 h-12 mx-auto mb-4 opacity-50\" />\n              <p>Ei odottavia poissaolopyyntöjä</p>\n            </div>\n          ) : (\n            pendingRequests.map((request) => (\n              <div key={request.id} className=\"border border-border rounded-lg p-4 bg-background hover:shadow-md transition-shadow\">\n                <div className=\"flex items-start justify-between\">\n                  <div className=\"flex items-start space-x-3 flex-1\">\n                    <Avatar className=\"w-10 h-10\">\n                      <AvatarFallback className=\"bg-primary text-primary-foreground\">\n                        {request.employeeName?.split(' ').map(n => n[0]).join('')}\n                      </AvatarFallback>\n                    </Avatar>\n                    <div className=\"flex-1\">\n                      <div className=\"flex items-center gap-2 mb-2\">\n                        <h4 className=\"font-medium\">{request.employeeName}</h4>\n                        {getStatusBadge(request.status)}\n                      </div>\n                      <div className=\"space-y-1 text-sm text-muted-foreground\">\n                        <div className=\"flex items-center gap-2\">\n                          <Calendar className=\"w-4 h-4\" />\n                          <span>\n                            {formatDate(request.startDate)} \n                            {request.startDate !== request.endDate && ` - ${formatDate(request.endDate)}`}\n                          </span>\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                          <User className=\"w-4 h-4\" />\n                          <span>Syy: {request.reason}</span>\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                          <Clock className=\"w-4 h-4\" />\n                          <span>Jätetty: {formatDateTime(request.submittedAt || '')}</span>\n                        </div>\n                      </div>\n                      {request.message && (\n                        <div className=\"mt-3 p-3 bg-muted/50 rounded-md\">\n                          <div className=\"flex items-start gap-2\">\n                            <MessageSquare className=\"w-4 h-4 mt-0.5 text-muted-foreground\" />\n                            <p className=\"text-sm\">{request.message}</p>\n                          </div>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                  <div className=\"flex items-center gap-2 ml-4\">\n                    <Dialog>\n                      <DialogTrigger asChild>\n                        <div\n                          className=\"inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 px-3 cursor-pointer\"\n                        >\n                          <MessageSquare className=\"w-4 h-4 mr-2\" />\n                          Vastaa\n                        </div>\n                      </DialogTrigger>\n                      <DialogContent>\n                        <DialogHeader>\n                          <DialogTitle>Vastaa poissaolopyyntöön</DialogTitle>\n                        </DialogHeader>\n                        <div className=\"space-y-4\">\n                          <div className=\"space-y-2\">\n                            <label className=\"text-sm font-medium\">Viesti työntekijälle:</label>\n                            <Textarea \n                              value={adminResponse}\n                              onChange={(e) => setAdminResponse(e.target.value)}\n                              placeholder=\"Kirjoita viesti...\"\n                              className=\"min-h-[100px]\"\n                            />\n                          </div>\n                          <div className=\"flex gap-2\">\n                            <Button \n                              onClick={() => {\n                                handleApprove(request.id);\n                                setAdminResponse('');\n                              }}\n                              className=\"flex-1\"\n                            >\n                              <CheckCircle className=\"w-4 h-4 mr-2\" />\n                              Hyväksy\n                            </Button>\n                            <Button \n                              variant=\"destructive\"\n                              onClick={() => {\n                                handleDecline(request.id);\n                                setAdminResponse('');\n                              }}\n                              className=\"flex-1\"\n                            >\n                              <XCircle className=\"w-4 h-4 mr-2\" />\n                              Hylkää\n                            </Button>\n                          </div>\n                        </div>\n                      </DialogContent>\n                    </Dialog>\n                    <Button \n                      size=\"sm\"\n                      onClick={() => handleApprove(request.id)}\n                      className=\"bg-green-600 hover:bg-green-700\"\n                    >\n                      <CheckCircle className=\"w-4 h-4\" />\n                    </Button>\n                    <Button \n                      variant=\"destructive\"\n                      size=\"sm\"\n                      onClick={() => handleDecline(request.id)}\n                    >\n                      <XCircle className=\"w-4 h-4\" />\n                    </Button>\n                  </div>\n                </div>\n              </div>\n            ))\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Processed Requests */}\n      <Card className=\"shadow-md\">\n        <CardHeader className=\"pb-4\">\n          <CardTitle className=\"text-lg\">Käsitellyt pyynnöt</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-3\">\n            {processedRequests.map((request) => (\n              <div key={request.id} className=\"flex items-center justify-between p-3 border border-border rounded-md bg-muted/30\">\n                <div className=\"flex items-center space-x-3\">\n                  <Avatar className=\"w-8 h-8\">\n                    <AvatarFallback className=\"text-xs\">\n                      {request.employeeName?.split(' ').map(n => n[0]).join('')}\n                    </AvatarFallback>\n                  </Avatar>\n                  <div>\n                    <p className=\"font-medium text-sm\">{request.employeeName}</p>\n                    <p className=\"text-xs text-muted-foreground\">\n                      {formatDate(request.startDate)} - {request.reason}\n                    </p>\n                  </div>\n                </div>\n                {getStatusBadge(request.status)}\n              </div>\n            ))}\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n\nexport default AbsenceControlPanel;\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 360
        }
      ]
    },
    {
      "path": "src/app/components/AdminView.tsx",
      "size": 1196,
      "sha256": "db942d88c5b6a35fdf4743ff348fb0681452ceda7dff125f8088f8d7aaf45c7e",
      "lang": "tsx",
      "lines": 40,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/AdminView.tsx",
      "chunks": [
        {
          "i": 0,
          "text": "\"use client\";\n\nimport Toolbar from \"@/app/components/Toolbar\";\nimport AbsenceControlPanel from \"@/app/components/AbsenceControlPanel\";\nimport ScheduleTable from \"@/app/components/ScheduleTable\";\nimport EmployeeList from \"@/app/components/EmployeeList\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/app/components/ui/tabs\";\n\nexport default function AdminView() {\n  return (\n    <div className=\"max-w-7xl mx-auto py-10\">\n      {/* Toolbar */}\n      <div className=\"mb-6\">\n        <Toolbar />\n      </div>\n\n      {/* Tabs */}\n      <Tabs defaultValue=\"schedule\" className=\"w-full\">\n        <TabsList className=\"grid w-full grid-cols-3 max-w-md mx-auto mb-6\">\n          <TabsTrigger value=\"schedule\">Vuorot</TabsTrigger>\n          <TabsTrigger value=\"employees\">Työntekijät</TabsTrigger>\n          <TabsTrigger value=\"absences\">Poissaolot</TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"schedule\">\n          <ScheduleTable />\n        </TabsContent>\n\n        <TabsContent value=\"employees\">\n         <EmployeeList />\n        </TabsContent>\n\n        <TabsContent value=\"absences\">\n          <AbsenceControlPanel />\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 39
        }
      ]
    },
    {
      "path": "src/app/components/EmployeeDashboard.tsx",
      "size": 20279,
      "sha256": "db71432dda67feda68b3dc7e0a12e3d5aa41806e58f1712ef2e49db1146324ce",
      "lang": "tsx",
      "lines": 549,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/EmployeeDashboard.tsx",
      "chunks": [
        {
          "i": 0,
          "text": "\"use client\";\n\nimport React, { useState, useEffect } from 'react';\nimport { supabase } from '@/lib/supaBaseClient';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from './ui/tabs';\nimport { Card, CardContent, CardHeader, CardTitle } from './ui/card';\nimport { Badge } from './ui/badge';\nimport { Button } from './ui/button';\nimport { Avatar, AvatarFallback } from './ui/avatar';\nimport { \n  Calendar, \n  Clock, \n  FileText, \n  Bell, \n  ArrowLeftRight,\n  CheckCircle,\n  AlertCircle,\n  Home\n} from 'lucide-react';\nimport { Employee, EmployeeTimeOffRequest, ShiftChangeRequest, EmployeeNotification, ShiftType } from '../types';\nimport EmployeeScheduleView from './EmployeeScheduleView';\nimport TimeOffRequestForm from './TimeOffRequestForm';\nimport ShiftChangeRequestForm from './ShiftChangeRequestForm';\nimport EmployeeNotificationCenter from './EmployeeNotificationCenter';\nimport EmployeeScheduleControls from './EmployeeScheduleControls';\nimport { formatMinutes } from \"@/lib/timeUtils\";\n\n\ntype TimeOffRow = {\n  id: string;\n  employee_id: string;\n  employee?: { name: string }[];\n  target?: { name: string }[];\n  start_date: string;\n  end_date: string;\n  reason?: string | null;\n  message?: string | null;\n  status: \"pending\" | \"approved\" | \"declined\";\n  submitted_at: string;\n};\n\ntype ShiftChangeRow = {\n  id: string;\n  employee_id: string;\n  employee?: { name: string }[];   // korjattu: array\n  target_employee_id?: string;\n  target?: { name: string }[];     // korjattu: array\n  current_shift_date: string;\n  requested_shift_date: string;\n  reason?: string | null;\n  message?: string | null;\n  status: \"pending\" | \"approved\" | \"declined\";\n  submitted_at: string;\n};\n\n\n\ninterface EmployeeDashboardProps {\n  currentEmployee: Employee;\n  allEmployees: Employee[];\n  onSwitchToAdmin: () => void;\n}\n\nconst EmployeeDashboard: React.FC<EmployeeDashboardProps> = ({\n  currentEmployee,\n  allEmployees,\n  onSwitchToAdmin\n}) => {\n  const [activeTab, setActiveTab] = useState('schedule');\n  const [days, setDays] = useState<7 | 14 | 30>(7);\n\n\n  const [timeOffRequests, setTimeOffRequests] = useState<EmployeeTimeOffRequest[]>([]);\n  useEffect(() => {\n    const fetchRequests = async () => {\n      const { data, error } = await supabase\n        .from(\"absences\")\n        .select(`\n          id,\n          employee_id,\n          start_date,\n          end_date,\n          reason,\n          message,\n          status,\n          submitted_at,\n          employees!absences_employee_id_fkey ( name )\n        `)\n        .eq(\"employee_id\", currentEmployee.id)\n        .order(\"submitted_at\", { ascending: false });\n\n      if (!error && data) {\n        setTimeOffRequests(\n          data.map((r: TimeOffRow) => ({\n            id: r.id,\n            employeeId: r.employee_id,\n            employeeName: r.employee?.[0]?.name ?? currentEmployee.name,\n            targetEmployeeName: r.target?.[0]?.name ?? undefined,\n            startDate: r.start_date,\n            endDate: r.end_date,\n            reason: r.reason ?? '',\n            message: r.message ?? undefined,\n            status: r.status,\n            submittedAt: r.submitted_at,\n          }))\n        );\n      }\n\n    };\n    fetchRequests();\n  }, [currentEmployee.id, currentEmployee.name]);\n\n  const [shiftChangeRequests, setShiftChangeRequests] = useState<ShiftChangeRequest[]>(() => []);\n\n  useEffect(() => {\n    const fetchShiftChanges = async () => {\n      const { data, error } = await supabase\n        .from(\"shift_change_requests\")\n        .select(`\n          id,\n          employee_id,\n          target_employee_id,\n          current_shift_date,\n          requested_shift_date,\n          reason,\n          message,\n          status,\n          submitted_at,\n          employee:employees!shift_change_requests_employee_id_fkey ( name ),\n          target:employees!shift_change_requests_target_employee_id_fkey ( name )\n        `)\n        .eq(\"employee_id\", currentEmployee.id)\n        .order(\"submitted_at\", { ascending: false });\n\n      if (!error && data) {\nsetShiftChangeRequests(\n  data.map((r: ShiftChangeRow) => ({\n    id: r.id,\n    employeeId: r.employee_id,\n    employeeName: r.employee?.[0]?.name ?? currentEmployee.name,\n    targetEmployeeId: r.target_employee_id ?? undefined,\n    targetEmployeeName: r.target?.[0]?.name ?? undefined,\n    currentDate: r.current_shift_date,\n    requestedDate: r.requested_shift_date,\n    reason: r.reason ?? \"\",\n    message: r.message ?? undefined,\n    status: r.status,\n    submittedAt: r.submitted_at,\n    currentShift: { type: \"normal\", hours: 0 } as ShiftType,\n    requestedShift: { type: \"normal\", hours: 0 } as ShiftType,\n  }))\n);\n\n      }\n    };\n    fetchShiftChanges();\n  }, [currentEmployee.id, currentEmployee.name]);\n\n  const [notifications, setNotifications] = useState<EmployeeNotification[]>(() => []);\n\n  useEffect(() => {\n    const fetchNotifications = async () => {\n      const { data, error } = await supabase\n        .from(\"employee_notifications\")\n        .select(\"*\")\n        .eq(\"employee_id\", currentEmployee.id)\n        .order(\"created_at\", { ascending: false });\n      if (!error && data) setNotifications(data);\n    };\n    fetchNotifications();\n  }, [currentEmployee.id]);\n\n\n  const unreadNotifications = notifications.filter(n => !n.isRead).length;\n\n\n const totalHoursThisWeek = (currentEmployee.shifts ?? [])\n   .slice(0, 7)\n   .reduce((total, shift) => total + (shift.minutes || 0), 0);\n\n\n  const formatDate = (dateString: string) => {\n    return new Date(dateString).toLocaleDateString('fi-FI', {\n      day: 'numeric',\n      month: 'numeric',\n      year: 'numeric'\n    });\n  };\n\n  const getStatusBadge = (status: 'pending' | 'approved' | 'declined') => {\n    switch (status) {\n      case 'pending':\n        return <Badge variant=\"outline\" className=\"bg-amber-50 text-amber-700 border-amber-300\"><Clock className=\"w-3 h-3 mr-1\" />Odottaa</Badge>;\n      case 'approved':\n        return <Badge variant=\"outline\" className=\"bg-green-50 text-green-700 border-green-300\"><CheckCircle className=\"w-3 h-3 mr-1\" />Hyväksytty</Badge>;\n      case 'declined':\n        return <Badge variant=\"outline\" className=\"bg-red-50 text-red-700 border-red-300\"><AlertCircle className=\"w-3 h-3 mr-1\" />Hylätty</Badge>;\n    }\n  };\n\n  const addTimeOffRequest = async (\n    request: Omit<EmployeeTimeOffRequest, \"id\" | \"employeeId\" | \"submittedAt\" | \"status\">\n  ) => {\n    const { data, error } = await supabase\n      .from(\"absences\")\n      .insert([{\n        employee_id: currentEmployee.id,\n        start_date: request.startDate,\n        end_date: request.endDate,\n        reason: request.reason,\n        message: request.message,\n      }])\n      .select()\n      .single();\n\n    if (!error && data) {\n      setTimeOffRequests(prev => [\n        {\n          id: data.id,\n          employeeId: data.employee_id,\n          employeeName: currentEmployee.name,\n          startDate: data.start_date,\n          endDate: data.end_date,\n          reason: data.reason,\n          message: data.message,\n          status: data.status,\n          submittedAt: data.submitted_at,\n        },\n        ...prev,\n      ]);\n    }\n  };\n\n  const addShiftChangeRequest = async (\n    request: Omit<ShiftChangeRequest, \"id\" | \"employeeId\" | \"employeeName\" | \"submittedAt\" | \"status\">\n  ) => {\n    const { data, error } = await supabase\n      .from(\"shift_change_requests\")\n      .insert([{\n        employee_id: currentEmployee.id,\n        target_employee_id: request.targetEmployeeId,\n        current_shift_date: request.currentDate,\n        requested_shift_date: request.requestedDate,\n        reason: request.reason,\n        message: request.message\n      }])\n      .select(`\n        id,\n        employee_id,\n        target_employee_id,\n        current_shift_date,\n        requested_shift_date,\n        reason,\n        message,\n        status,\n        submitted_at,\n        employee:employees!shift_change_requests_employee_id_fkey ( name ),\n        target:employees!shift_change_requests_target_employee_id_fkey ( name )\n      `)\n      .single();\n\n    if (!error && data) {\n      setShiftChangeRequests(prev => [\n        {\n          id: data.id,\n          employeeId: data.employee_id,\n          employeeName: data.employee?.[0]?.name ?? currentEmployee.name,\n          targetEmployeeName: data.target?.[0]?.name ?? undefined,\n          currentDate: data.current_shift_date,\n          requestedDate: data.requested_shift_date,\n          reason: data.reason ?? '',\n          message: data.message ?? undefined,\n          status: data.status,\n          submittedAt: data.submitted_at,\n          currentShift: { type: 'normal', hours: 0 },\n          requestedShift: { type: 'normal', hours: 0 }\n        },\n        ...prev,\n      ]);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <div className=\"container mx-auto p-6 space-y-6\">\n        {/* Header */}\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center space-x-4\">\n            <Avatar className=\"w-12 h-12\">\n              <AvatarFallback className=\"bg-primary text-primary-foreground\">\n                {currentEmployee.name.split(' ').map(n => n[0]).join('')}\n              </AvatarFallback>\n            </Avatar>\n            <div>\n              <h1 className=\"text-2xl font-semibold\">Tervetuloa, {currentEmployee.name.split(' ')[0]}!</h1>\n              <p className=\"text-muted-foreground\">{currentEmployee.department} • {currentEmployee.email}</p>\n            </div>\n          </div>\n          <div className=\"flex items-center gap-3\">\n            {unreadNotifications > 0 && (\n              <div className=\"relative\">\n                <Bell className=\"w-5 h-5 text-primary\" />\n                <Badge \n                  variant=\"destructive\" \n                  className=\"absolute -top-2 -right-2 h-5 w-5 text-xs flex items-center justify-center p-0 min-w-[20px]\"\n                >\n                  {unreadNotifications}\n                </Badge>\n              </div>\n            )}\n            <Button\n              variant=\"outline\"\n              onClick={onSwitchToAdmin}\n              className=\"flex items-center gap-2\"\n            >\n              <Home className=\"w-4 h-4\" />\n              Admin-paneeli\n            </Button>\n          </div>\n        </div>\n\n        {/* Quick Stats */}\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n          <Card>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center space-x-3\">\n                <div className=\"p-2 bg-primary/10 rounded-lg\">\n                  <Calendar className=\"w-5 h-5 text-primary\" />\n                </div>\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Tämän viikon tunnit</p>\n                  <p className=\"text-xl font-semibold\">{totalHoursThisWeek}h</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n          \n          <Card>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center space-x-3\">\n                <div className=\"p-2 bg-amber-100 rounded-lg\">\n                  <Clock className=\"w-5 h-5 text-amber-600\" />\n                </div>\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Odottavat pyynnöt</p>\n                  <p className=\"text-xl font-semibold\">\n                    {timeOffRequests.filter(r => r.status === 'pending').length + \n                     shiftChangeRequests.filter(r => r.status === 'pending').length}\n                  </p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center space-x-3\">\n                <div className=\"p-2 bg-green-100 rounded-lg\">\n                  <CheckCircle className=\"w-5 h-5 text-green-600\" />\n                </div>\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Hyväksytyt pyynnöt</p>\n                  <p className=\"text-xl font-semibold\">\n                    {timeOffRequests.filter(r => r.status === 'approved').length + \n                     shiftChangeRequests.filter(r => r.status === 'approved').length}\n                  </p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center space-x-3\">\n                <div className=\"p-2 bg-blue-100 rounded-lg\">\n                  <Bell className=\"w-5 h-5 text-blue-600\" />\n                </div>\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Lukemattomat ilmoitukset</p>\n                  <p className=\"text-xl font-semibold\">{unreadNotifications}</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Main Navigation */}\n        <Tabs value={activeTab} onValueChange={setActiveTab} className=\"w-full\">\n          <TabsList className=\"grid w-full grid-cols-4 lg:w-[500px] mx-auto\">\n            <TabsTrigger value=\"schedule\" className=\"flex items-center gap-2\">\n              <Calendar className=\"w-4 h-4\" />\n              Työajat\n            </TabsTrigger>\n            <TabsTrigger value=\"time-off\" className=\"flex items-center gap-2\">\n              <Clock className=\"w-4 h-4\" />\n              Poissaolot\n            </TabsTrigger>\n            <TabsTrigger value=\"shift-change\" className=\"flex items-center gap-2\">\n              <ArrowLeftRight className=\"w-4 h-4\" />\n              Vuoronvaihdot\n            </TabsTrigger>\n            <TabsTrigger value=\"notifications\" className=\"flex items-center gap-2\">\n              <Bell className=\"w-4 h-4\" />\n              Ilmoitukset\n              {unreadNotifications > 0 && (\n                <Badge variant=\"destructive\" className=\"ml-1 h-5 w-5 text-xs flex items-center justify-center p-0\">\n                  {unreadNotifications}\n                </Badge>\n              )}\n            </TabsTrigger>\n          </TabsList>\n\n          {/* Schedule View Tab */}\n          <TabsContent value=\"schedule\" className=\"space-y-6\">\n            <Card className=\"shadow-md\">\n              <CardHeader className=\"flex items-center justify-between\">\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Calendar className=\"w-5 h-5\" />\n                  Työvuorot\n                </CardTitle>\n                <EmployeeScheduleControls days={days} setDays={setDays} />\n              </CardHeader>\n              <CardContent>\n                <EmployeeScheduleView \n                  currentEmployee={currentEmployee}\n                  allEmployees={allEmployees}\n                  settings={{ general: { weekStartDay: \"monday\", dateFormat: \"dd.mm.yyyy\" } }}\n                  timePeriod={days}\n                />\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          {/* Time Off Requests Tab */}\n          <TabsContent value=\"time-off\" className=\"space-y-6\">\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n              <TimeOffRequestForm onSubmit={addTimeOffRequest} />\n              \n              <Card className=\"shadow-md\">\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <FileText className=\"w-5 h-5\" />\n                    Omat poissaolopyynnöt\n                  </CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-3\">\n                  {timeOffRequests.length === 0 ? (\n                    <p className=\"text-center text-muted-foreground py-8\">Ei poissaolopyyntöjä</p>\n                  ) : (\n                    timeOffRequests.map((request) => (\n                      <div key={request.id} className=\"border border-border rounded-lg p-4\">\n                        <div className=\"flex items-center justify-between mb-3\">\n                          <div className=\"flex items-center gap-2\">\n                            <h4 className=\"font-medium\">{request.reason}</h4>\n                            {getStatusBadge(request.status)}\n                          </div>\n                        </div>\n                        <div className=\"space-y-1 text-sm text-muted-foreground\">\n                          <p><Calendar className=\"w-4 h-4 inline mr-2\" />\n                            {formatDate(request.startDate)} - {formatDate(request.endDate)}\n                          </p>\n                          <p><Clock className=\"w-4 h-4 inline mr-2\" />\n                            Jätetty: {new Date(request.submittedAt).toLocaleDateString('fi-FI')}\n                          </p>\n                        </div>\n                        {request.message && (\n                          <div className=\"mt-3 p-2 bg-muted/50 rounded text-sm\">\n                            {request.message}\n                          </div>\n                        )}\n                      </div>\n                    ))\n                  )}\n                </CardContent>\n              </Card>\n            </div>\n          </TabsContent>\n\n          {/* Shift Change Requests Tab */}\n          <TabsContent value=\"shift-change\" className=\"space-y-6\">\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n              <ShiftChangeRequestForm \n                currentEmployee={currentEmployee}\n                allEmployees={allEmployees}\n                onSubmit={addShiftChangeRequest} \n              />\n              \n              <Card className=\"shadow-md\">\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <ArrowLeftRight className=\"w-5 h-5\" />\n                    Omat vuoronvaihtopyynnöt\n                  </CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-3\">\n                  {shiftChangeRequests.length === 0 ? (\n                    <p className=\"text-center text-muted-foreground py-8\">Ei vuoronvaihtopyyntöjä</p>\n                  ) : (\n                    shiftChangeRequests.map((request) => (\n                      <div key={request.id} className=\"border border-border rounded-lg p-4\">\n                        <div className=\"flex items-center justify-between mb-3\">\n                          <div className=\"flex items-center gap-2\">\n                            <h4 className=\"font-medium\">{request.reason}</h4>\n                            {getStatusBadge(request.status)}\n                          </div>\n                        </div>\n                        <div className=\"space-y-1 text-sm text-muted-foreground\">\n                          <p><Calendar className=\"w-4 h-4 inline mr-2\" />\n                            {formatDate(request.currentDate)} → {formatDate(request.requestedDate)}\n                          </p>\n                          <p><Clock className=\"w-4 h-4 inline mr-2\" />\n                            {request.requestedShift?.minutes ? formatMinutes(request.requestedShift.minutes) : 'Vapaa'}\n                          </p>\n                        </div>\n                        {request.message && (\n                          <div className=\"mt-3 p-2 bg-muted/50 rounded text-sm\">\n                            {request.message}\n                          </div>\n                        )}\n                      </div>\n                    ))\n                  )}\n                </CardContent>\n              </Card>\n            </div>\n          </TabsContent>\n\n          {/* Notifications Tab */}\n          <TabsContent value=\"notifications\" className=\"space-y-6\">\n            <EmployeeNotificationCenter\n              notifications={notifications}\n              onMarkAsRead={(id) => setNotifications(prev => \n                prev.map(n => n.id === id ? { ...n, isRead: true } : n)\n              )}\n              onMarkAllAsRead={() => setNotifications(prev => \n                prev.map(n => ({ ...n, isRead: true }))\n              )}\n              onDelete={(id) => setNotifications(prev => \n                prev.filter(n => n.id !== id)\n              )}\n            />\n          </TabsContent>\n        </Tabs>\n      </div>\n    </div>\n  );\n};\n\nexport default EmployeeDashboard;",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 549
        }
      ]
    },
    {
      "path": "src/app/components/EmployeeList.tsx",
      "size": 22862,
      "sha256": "fb3642e3434caba6422decb0b5ed434ed09ab139d9268da1248276ce4215753a",
      "lang": "tsx",
      "lines": 646,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/EmployeeList.tsx",
      "chunks": [
        {
          "i": 0,
          "text": "\"use client\";\n\nimport React, { useEffect, useMemo, useState } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"./ui/card\";\nimport { Button } from \"./ui/button\";\nimport { Input } from \"./ui/input\";\nimport { Badge } from \"./ui/badge\";\nimport { Avatar, AvatarFallback } from \"./ui/avatar\";\nimport { Switch } from \"./ui/switch\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger, DialogDescription } from \"./ui/dialog\";\nimport { Label } from \"./ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"./ui/select\";\nimport {\n  Users,\n  Plus,\n  Edit3,\n  Trash2,\n  Search,\n  UserCheck,\n  UserX,\n  Mail,\n  Building,\n} from \"lucide-react\";\nimport { toast } from \"sonner\";\nimport { supabase } from \"@/lib/supaBaseClient\";\n\n// Sama tyyppi kuin sulla (shifts jätetään tyhjäksi tässä vaiheessa)\ntype Employee = {\n  id: string;\n  name: string;\n  email: string;\n  department: string;\n  isActive: boolean;\n  shifts: Array<unknown>;\n};\n\nconst EmployeeList = () => {\n  const [employees, setEmployees] = useState<Employee[]>([]);\n  const [loading, setLoading] = useState(true);\n\n  // Hakusuodatus\n  const [searchTerm, setSearchTerm] = useState(\"\");\n\n  const [customDepartment, setCustomDepartment] = useState(\"\");\n  const [editCustomDepartment, setEditCustomDepartment] = useState(\"\");\n\n  const [creatingNewDept, setCreatingNewDept] = useState(false);\n  const [editCreatingNewDept, setEditCreatingNewDept] = useState(false);\n\n  // Edit/Add dialogit\n  const [selectedEmployee, setSelectedEmployee] = useState<Employee | null>(null);\n  const [isAddDialogOpen, setIsAddDialogOpen] = useState(false);\n  const [adding, setAdding] = useState(false);\n  const [newEmployee, setNewEmployee] = useState({\n    name: \"\",\n    email: \"\",\n    department: \"\",\n    isActive: true,\n  });\n\n  // 1) HAKU DB:stä\n  useEffect(() => {\n    (async () => {\n      setLoading(true);\n      const { data, error } = await supabase\n        .from(\"employees\")\n        .select(\"id, name, email, department, is_active, created_at\")\n        .order(\"created_at\", { ascending: true });\n\n      if (error) {\n        console.error(error);\n        toast.error(\"Työntekijöiden haku epäonnistui\");\n      } else {\n        // Mapataan snake_case -> camelCase\n\n          type EmployeeRow = {\n          id: string;\n          name: string;\n          email: string;\n          department: string;\n          is_active: boolean;\n          created_at: string; // tai Date, jos haluat käsitellä sitä\n          };\n\n          const mapped: Employee[] = (data ?? []).map((row: EmployeeRow) => ({\n          id: row.id,\n          name: row.name,\n          email: row.email,\n          department: row.department,\n          isActive: !!row.is_active,\n          shifts: [], // ei vielä käytössä\n        }));\n        setEmployees(mapped);\n      }\n      setLoading(false);\n    })();\n  }, []);\n\n\n\n// 2) LISÄYS\nasync function handleAddEmployee() {\n  const name = newEmployee.name.trim();\n  const email = newEmployee.email.trim();\n  const dep = (newEmployee.department ?? \"\").trim();\n\n  if (!name || !email || !dep) {\n    toast.error(\"Täytä kaikki pakolliset kentät\");\n    return;\n  }\n  if (dep.toLowerCase() === \"uusi osasto\") {\n    toast.error(\"Kirjoita osaston nimi.\");\n    return;\n  }\n\n  try {\n    setAdding(true);\n\n    // HAE TOKEN\n    const { data: s } = await supabase.auth.getSession();\n    const token = s.session?.access_token;\n\n    const res = await fetch(\"/api/employees\", {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        ...(token ? { Authorization: `Bearer ${token}` } : {}),\n      },\n      body: JSON.stringify({ name, email, department: dep, isActive: newEmployee.isActive }),\n    });\n    const json = await res.json();\n    if (!res.ok) throw new Error(json?.error ?? \"Virhe työntekijän lisäämisessä\");\n\n    const added: Employee = {\n      id: json.employee.id,\n      name: json.employee.name,\n      email: json.employee.email,\n      department: json.employee.department,\n      isActive: !!json.employee.is_active,\n      shifts: [],\n    };\n\n    setEmployees(prev => [...prev, added]);\n    setNewEmployee({ name: \"\", email: \"\", department: \"\", isActive: true });\n    setIsAddDialogOpen(false);\n    toast.success(`${added.name} lisätty ja salasanan asettamislinkki lähetetty osoitteeseen ${added.email}`);\n  } catch (e: any) {\n    console.error(e);\n    toast.error(e?.message ?? \"Työntekijän lisääminen epäonnistui\");\n  } finally {\n    setAdding(false);\n  }\n}\n\n  // 3) POISTO\n  async function handleDeleteEmployee(employeeId: string) {\n    const target = employees.find((e) => e.id === employeeId);\n    const { error } = await supabase.from(\"employees\").delete().eq(\"id\", employeeId);\n    if (error) {\n      console.error(error);\n      toast.error(\"Poisto epäonnistui\");\n      return;\n    }\n    setEmployees((prev) => prev.filter((e) => e.id !== employeeId));\n    toast.success(`${target?.name ?? \"Työntekijä\"} poistettu`);\n  }\n\n  // 4) AKTIIVINEN/EPÄAKTIIVINEN toggle\n  async function handleToggleActive(employeeId: string) {\n    const current = employees.find((e) => e.id === employeeId);\n    if (!current) return;\n\n    const nextActive = !current.isActive;\n    // Optimistic update\n    setEmployees((prev) =>\n      prev.map((e) => (e.id === employeeId ? { ...e, isActive: nextActive } : e))\n    );\n\n    const { error } = await supabase\n      .from(\"employees\")\n      .update({ is_active: nextActive })\n      .eq(\"id\", employeeId);\n\n    if (error) {\n      console.error(error);\n      // Revertoi jos meni pieleen\n      setEmployees((prev) =>\n        prev.map((e) => (e.id === employeeId ? { ...e, isActive: !nextActive } : e))\n      );\n      toast.error(\"Tilan muutos epäonnistui\");\n      return;\n    }\n\n    toast.success(`${current.name} ${nextActive ? \"aktivoitu\" : \"deaktivoitu\"}`);\n  }\n\n  // 5) EDIT / UPDATE\n  function handleEditEmployee(employee: Employee) {\n    setSelectedEmployee(employee);\n  }\n\n\n// ... existing code ...\n\nasync function handleUpdateEmployee() {\n  if (!selectedEmployee) return;\n\n  try {\n    // HAE TOKEN\n    const { data: s } = await supabase.auth.getSession();\n    const token = s.session?.access_token;\n\n    const res = await fetch(`/api/employees/${selectedEmployee.id}`, {\n      method: \"PUT\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        ...(token ? { Authorization: `Bearer ${token}` } : {}),\n      },\n      body: JSON.stringify({\n        name: selectedEmployee.name,\n        email: selectedEmployee.email,\n        department: selectedEmployee.department,\n        isActive: selectedEmployee.isActive,\n      }),\n    });\n    const json = await res.json();\n    if (!res.ok) throw new Error(json?.error ?? \"Päivitys epäonnistui\");\n\n    setEmployees(prev => prev.map(e =>\n      e.id === selectedEmployee.id\n        ? {\n            ...e,\n            name: json.employee.name,\n            email: json.employee.email,\n            department: json.employee.department,\n            isActive: !!json.employee.is_active,\n          }\n        : e\n    ));\n    setSelectedEmployee(null);\n\n    if (json.emailChanged) {\n      toast.success(\"Tiedot päivitetty. Uusi salasana-linkki lähetetty uuteen sähköpostiin.\");\n    } else {\n      toast.success(\"Työntekijätiedot päivitetty\");\n    }\n  } catch (e: any) {\n    console.error(e);\n    toast.error(e?.message ?? \"Päivitys epäonnistui\");\n  }\n}\n\n  // Johdetut arvot (kuten ennen)\n  const filteredEmployees = useMemo(() => {\n    const q = searchTerm.toLowerCase();\n    return employees.filter(\n      (e) =>\n        e.name.toLowerCase().includes(q) ||\n        e.email.toLowerCase().includes(q) ||\n        e.department.toLowerCase().includes(q)\n    );\n  }, [employees, searchTerm]);\n\n  const activeEmployees = employees.filter((e) => e.isActive).length;\nconst departments = useMemo(\n  () =>\n    [...new Set(\n      employees\n        .map(e => (e.department ?? \"\").trim())\n        .filter(v => v && v.toLowerCase() !== \"uusi osasto\")\n    )].sort((a, b) => a.localeCompare(b, \"fi\")),\n  [employees]\n);\n\n\n  // —— UI alla: pidetään sun alkuperäinen rakenne ——\n  return (\n    <div className=\"space-y-6\">\n      <Card className=\"shadow-lg border-0 bg-gradient-to-r from-background to-secondary/20\">\n        <CardHeader className=\"pb-4\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center space-x-3\">\n              <Users className=\"w-6 h-6 text-primary\" />\n              <CardTitle className=\"text-xl text-primary\">Työntekijähallinta</CardTitle>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <Badge variant=\"secondary\" className=\"px-3 py-1\">\n                <UserCheck className=\"w-4 h-4 mr-2\" />\n                {activeEmployees} aktiivista\n              </Badge>\n\n              <Dialog open={isAddDialogOpen} onOpenChange={setIsAddDialogOpen}>\n                <DialogTrigger asChild>\n                  <div\n                    className=\"inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2 cursor-pointer\"\n                    onClick={() => setIsAddDialogOpen(true)}\n                  >\n                    <Plus className=\"w-4 h-4 mr-2\" />\n                    Lisää työntekijä\n                  </div>\n                </DialogTrigger>\n                <DialogContent>\n                  <DialogHeader>\n                    <DialogTitle>Lisää uusi työntekijä</DialogTitle>\n                    <DialogDescription>Syötä työntekijän perustiedot ja lähetä salasana-linkki.</DialogDescription>\n                  </DialogHeader>\n                  <div className=\"space-y-4\">\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"name\">Nimi *</Label>\n                      <Input\n                        id=\"name\"\n                        value={newEmployee.name}\n                        onChange={(e) =>\n                          setNewEmployee((p) => ({ ...p, name: e.target.value }))\n                        }\n                        placeholder=\"Etunimi Sukunimi\"\n                      />\n                    </div>\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"email\">Sähköposti *</Label>\n                      <Input\n                        id=\"email\"\n                        type=\"email\"\n                        value={newEmployee.email}\n                        onChange={(e) =>\n                          setNewEmployee((p) => ({ ...p, email: e.target.value }))\n                        }\n                        placeholder=\"etunimi.sukunimi@company.com\"\n                      />\n                    </div>\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"department\">Osasto *</Label>\n                      <Select\n  value={\n    creatingNewDept\n      ? \"NEW_DEPT\"\n      : (newEmployee.department || \"\")\n  }\n  onValueChange={(value) => {\n    if (value === \"NEW_DEPT\") {\n      setCreatingNewDept(true);\n      setCustomDepartment(\"\");\n      setNewEmployee(p => ({ ...p, department: \"\" })); // puhdas aloitus\n    } else {\n      setCreatingNewDept(false);\n      setCustomDepartment(\"\");\n      setNewEmployee(p => ({ ...p, department: value }));\n    }\n  }}\n>\n  <SelectTrigger>\n    <SelectValue placeholder=\"Valitse osasto\" />\n  </SelectTrigger>\n  <SelectContent>\n    {departments.map((dept) => (\n      <SelectItem key={dept} value={dept}>{dept}</SelectItem>\n    ))}\n    <SelectItem value=\"NEW_DEPT\">+ Uusi osasto…</SelectItem>\n  </SelectContent>\n</Select>\n\n{creatingNewDept && (\n  <Input\n    placeholder=\"Kirjoita uusi osasto…\"\n    className=\"mt-2\"\n    value={customDepartment}\n    onChange={(e) => {\n      const v = e.target.value;\n      setCustomDepartment(v);\n      setNewEmployee(p => ({ ...p, department: v })); // päivitetään arvo, mutta ei piiloteta inputtia\n    }}\n  />\n)}\n\n\n\n                    </div>\n                    <div className=\"flex items-center space-x-2\">\n                      <Switch\n                        id=\"active\"\n                        checked={newEmployee.isActive}\n                        onCheckedChange={(checked) =>\n                          setNewEmployee((p) => ({ ...p, isActive: checked }))\n                        }\n                      />\n                      <Label htmlFor=\"active\">Aktiivinen työntekijä</Label>\n                    </div>\n                    <div className=\"flex gap-2 pt-4\">\n                      <Button onClick={handleAddEmployee} className=\"flex-1\" disabled={adding}>\n                        {adding ? \"Lisätään…\" : \"Lisää työntekijä\"}\n                      </Button>\n                      <Button\n                        variant=\"outline\"\n                        onClick={() => setIsAddDialogOpen(false)}\n                        className=\"flex-1\"\n                      >\n                        Peruuta\n                      </Button>\n                    </div>\n                  </div>\n                </DialogContent>\n              </Dialog>\n            </div>\n          </div>\n        </CardHeader>\n\n        <CardContent className=\"space-y-4\">\n          {/* Search */}\n          <div className=\"relative\">\n            <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4\" />\n            <Input\n              placeholder=\"Hae työntekijöitä nimellä, sähköpostilla tai osastolla...\"\n              value={searchTerm}\n              onChange={(e) => setSearchTerm(e.target.value)}\n              className=\"pl-10\"\n            />\n          </div>\n\n          {/* Employee List */}\n          <div className=\"space-y-3\">\n            {loading ? (\n              <div className=\"text-center py-8 text-muted-foreground\">Ladataan…</div>\n            ) : (\n              filteredEmployees.map((employee) => (\n                <div\n                  key={employee.id}\n                  className=\"border border-border rounded-lg p-4 bg-background hover:shadow-md transition-shadow\"\n                >\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"flex items-center space-x-3\">\n                      <Avatar className=\"w-12 h-12\">\n                        <AvatarFallback\n                          className={`${\n                            employee.isActive\n                              ? \"bg-primary text-primary-foreground\"\n                              : \"bg-muted text-muted-foreground\"\n                          }`}\n                        >\n                          {employee.name\n                            .split(\" \")\n                            .map((n) => n[0])\n                            .join(\"\")}\n                        </AvatarFallback>\n                      </Avatar>\n                      <div className=\"flex-1\">\n                        <div className=\"flex items-center gap-2 mb-1\">\n                          <h4 className=\"font-medium\">{employee.name}</h4>\n                          {employee.isActive ? (\n                            <Badge\n                              variant=\"outline\"\n                              className=\"bg-green-50 text-green-700 border-green-300\"\n                            >\n                              <UserCheck className=\"w-3 h-3 mr-1\" />\n                              Aktiivinen\n                            </Badge>\n                          ) : (\n                            <Badge\n                              variant=\"outline\"\n                              className=\"bg-gray-50 text-gray-700 border-gray-300\"\n                            >\n                              <UserX className=\"w-3 h-3 mr-1\" />\n                              Ei-aktiivinen\n                            </Badge>\n                          )}\n                        </div>\n                        <div className=\"space-y-1 text-sm text-muted-foreground\">\n                          <div className=\"flex items-center gap-2\">\n                            <Mail className=\"w-4 h-4\" />\n                            <span>{employee.email}</span>\n                          </div>\n                          <div className=\"flex items-center gap-2\">\n                            <Building className=\"w-4 h-4\" />\n                            <span>{employee.department}</span>\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <div className=\"flex items-center space-x-2\">\n                        <Label htmlFor={`toggle-${employee.id}`} className=\"text-sm text-muted-foreground\">\n                          Aktiivinen\n                        </Label>\n                        <Switch\n                          id={`toggle-${employee.id}`}\n                          checked={employee.isActive}\n                          onCheckedChange={() => handleToggleActive(employee.id)}\n                        />\n                      </div>\n                      <Button variant=\"ghost\" size=\"sm\" onClick={() => handleEditEmployee(employee)}>\n                        <Edit3 className=\"w-4 h-4\" />\n                      </Button>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => handleDeleteEmployee(employee.id)}\n                        className=\"text-destructive hover:text-destructive\"\n                      >\n                        <Trash2 className=\"w-4 h-4\" />\n                      </Button>\n                    </div>\n                  </div>\n                </div>\n              ))\n            )}\n          </div>\n\n          {!loading && filteredEmployees.length === 0 && (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              <Users className=\"w-12 h-12 mx-auto mb-4 opacity-50\" />\n              <p>Ei työntekijöitä hakukriteereillä</p>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Edit Employee Dialog */}\n      <Dialog open={!!selectedEmployee} onOpenChange={() => setSelectedEmployee(null)}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Muokkaa työntekijää</DialogTitle>\n            <DialogDescription>Päivitä työntekijän tiedot ja tallenna.</DialogDescription>\n          </DialogHeader>\n          {selectedEmployee && (\n            <div className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-name\">Nimi</Label>\n                <Input\n                  id=\"edit-name\"\n                  value={selectedEmployee.name}\n                  onChange={(e) =>\n                    setSelectedEmployee((p) => (p ? { ...p, name: e.target.value } : p))\n                  }\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-email\">Sähköposti</Label>\n                <Input\n                  id=\"edit-email\"\n                  type=\"email\"\n                  value={selectedEmployee.email}\n                  onChange={(e) =>\n                    setSelectedEmployee((p) => (p ? { ...p, email: e.target.value } : p))\n                  }\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-department\">Osasto</Label>\n\n<Select\n  value={\n    editCreatingNewDept\n      ? \"NEW_DEPT\"\n      : (selectedEmployee?.department || \"\")\n  }\n  onValueChange={(value) => {\n    if (!selectedEmployee) return;\n    if (value === \"NEW_DEPT\") {\n      setEditCreatingNewDept(true);\n      setEditCustomDepartment(\"\");\n      setSelectedEmployee(p => p ? { ...p, department: \"\" } : p);\n    } else {\n      setEditCreatingNewDept(false);\n      setEditCustomDepartment(\"\");\n      setSelectedEmployee(p => p ? { ...p, department: value } : p);\n    }\n  }}\n>\n  <SelectTrigger>\n    <SelectValue placeholder=\"Valitse osasto\" />\n  </SelectTrigger>\n  <SelectContent>\n    {departments.map((dept) => (\n      <SelectItem key={dept} value={dept}>{dept}</SelectItem>\n    ))}\n    <SelectItem value=\"NEW_DEPT\">+ Uusi osasto…</SelectItem>\n  </SelectContent>\n</Select>\n\n{editCreatingNewDept && (\n  <Input\n    placeholder=\"Kirjoita uusi osasto…\"\n    className=\"mt-2\"\n    value={editCustomDepartment}\n    onChange={(e) => {\n      const v = e.target.value;\n      setEditCustomDepartment(v);\n      setSelectedEmployee(p => p ? { ...p, department: v } : p);\n    }}\n  />\n)}\n\n\n              </div>\n              <div className=\"flex items-center space-x-2\">\n                <Switch\n                  id=\"edit-active\"\n                  checked={selectedEmployee.isActive}\n                  onCheckedChange={(checked) =>\n                    setSelectedEmployee((p) => (p ? { ...p, isActive: checked } : p))\n                  }\n                />\n                <Label htmlFor=\"edit-active\">Aktiivinen työntekijä</Label>\n              </div>\n              <div className=\"flex gap-2 pt-4\">\n                <Button onClick={handleUpdateEmployee} className=\"flex-1\">\n                  Tallenna muutokset\n                </Button>\n                <Button variant=\"outline\" onClick={() => setSelectedEmployee(null)} className=\"flex-1\">\n                  Peruuta\n                </Button>\n              </div>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n\n      {/* Department Statistics */}\n      <Card className=\"shadow-md\">\n        <CardHeader>\n          <CardTitle className=\"text-lg\">Osastotilastot</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n            {useMemo(() => {\n              const depts = [...new Set(employees.map((e) => e.department))];\n              return depts.map((department) => {\n                const deptEmployees = employees.filter((e) => e.department === department);\n                const activeDeptEmployees = deptEmployees.filter((e) => e.isActive);\n                return (\n                  <div key={department} className=\"text-center p-3 border border-border rounded-lg\">\n                    <h4 className=\"font-medium mb-2\">{department}</h4>\n                    <div className=\"text-2xl font-bold text-primary\">{activeDeptEmployees.length}</div>\n                    <div className=\"text-xs text-muted-foreground\">{deptEmployees.length} yhteensä</div>\n                  </div>\n                );\n              });\n            }, [employees])}\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n\nexport default EmployeeList;\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 645
        }
      ]
    },
    {
      "path": "src/app/components/EmployeeNotificationCenter.tsx",
      "size": 11400,
      "sha256": "77b64ff6c5a67cc697b32a0826f52afaab86faf24c06211a87ba11a69c4a9b9c",
      "lang": "tsx",
      "lines": 289,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/EmployeeNotificationCenter.tsx",
      "chunks": [
        {
          "i": 0,
          "text": "\"use client\";\n\nimport React from 'react';\nimport { Card, CardContent, CardHeader, CardTitle } from './ui/card';\nimport { Button } from './ui/button';\nimport { Badge } from './ui/badge';\nimport { ScrollArea } from './ui/scroll-area';\nimport { \n  Bell, \n  CheckCircle, \n  XCircle, \n  Calendar,\n  ClockIcon,\n  Info,\n  AlertTriangle,\n  Check,\n  CheckCheck,\n  Trash2,\n  BellRing\n} from 'lucide-react';\nimport { EmployeeNotification } from '../types';\n\ninterface EmployeeNotificationCenterProps {\n  notifications: EmployeeNotification[];\n  onMarkAsRead: (notificationId: string) => void;\n  onMarkAllAsRead: () => void;\n  onDelete: (notificationId: string) => void;\n}\n\nconst EmployeeNotificationCenter: React.FC<EmployeeNotificationCenterProps> = ({\n  notifications,\n  onMarkAsRead,\n  onMarkAllAsRead,\n  onDelete\n}) => {\n  const getNotificationIcon = (type: EmployeeNotification['type']) => {\n    switch (type) {\n      case 'absence_approved':\n        return <CheckCircle className=\"w-4 h-4 text-green-600\" />;\n      case 'absence_declined':\n        return <XCircle className=\"w-4 h-4 text-red-600\" />;\n      case 'shift_approved':\n        return <CheckCircle className=\"w-4 h-4 text-green-600\" />;\n      case 'shift_declined':\n        return <XCircle className=\"w-4 h-4 text-red-600\" />;\n      case 'schedule_published':\n        return <Calendar className=\"w-4 h-4 text-blue-600\" />;\n      case 'schedule_updated':\n        return <Calendar className=\"w-4 h-4 text-amber-600\" />;\n      case 'reminder':\n        return <ClockIcon className=\"w-4 h-4 text-purple-600\" />;\n      case 'system':\n        return <Info className=\"w-4 h-4 text-gray-600\" />;\n      default:\n        return <Bell className=\"w-4 h-4 text-muted-foreground\" />;\n    }\n  };\n\n  const getPriorityColor = (priority: EmployeeNotification['priority']) => {\n    switch (priority) {\n      case 'high':\n        return 'border-l-red-500 bg-red-50/50';\n      case 'medium':\n        return 'border-l-amber-500 bg-amber-50/50';\n      case 'low':\n        return 'border-l-blue-500 bg-blue-50/50';\n      default:\n        return 'border-l-gray-500 bg-gray-50/50';\n    }\n  };\n\n  const formatNotificationTime = (timestamp: string) => {\n    const date = new Date(timestamp);\n    const now = new Date();\n    const diff = now.getTime() - date.getTime();\n    const minutes = Math.floor(diff / 60000);\n    const hours = Math.floor(minutes / 60);\n    const days = Math.floor(hours / 24);\n\n    if (days > 0) return `${days}pv sitten`;\n    if (hours > 0) return `${hours}h sitten`;\n    if (minutes > 0) return `${minutes}min sitten`;\n    return 'Juuri nyt';\n  };\n\n  const sortedNotifications = notifications.sort((a, b) => {\n    // Sort by read status first (unread first), then by timestamp (newest first)\n    if (a.isRead !== b.isRead) {\n      return a.isRead ? 1 : -1;\n    }\n    return new Date(b.created_at).getTime() - new Date(a.created_at).getTime();\n  });\n\n  const unreadCount = notifications.filter(n => !n.isRead).length;\n\n  return (\n    <div className=\"space-y-6\">\n      <Card className=\"shadow-lg border-0 bg-gradient-to-r from-background to-secondary/20\">\n        <CardHeader className=\"pb-4\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center space-x-3\">\n              <BellRing className=\"w-6 h-6 text-primary\" />\n              <CardTitle className=\"text-xl text-primary\">Ilmoitukset</CardTitle>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <Badge variant=\"secondary\" className=\"px-3 py-1\">\n                {unreadCount} lukematonta\n              </Badge>\n              {unreadCount > 0 && (\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={onMarkAllAsRead}\n                >\n                  <CheckCheck className=\"w-4 h-4 mr-2\" />\n                  Merkitse kaikki luetuiksi\n                </Button>\n              )}\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent>\n          <ScrollArea className=\"h-[500px]\">\n            {sortedNotifications.length === 0 ? (\n              <div className=\"text-center py-12 text-muted-foreground\">\n                <Bell className=\"w-16 h-16 mx-auto mb-4 opacity-30\" />\n                <h3 className=\"text-lg font-medium mb-2\">Ei ilmoituksia</h3>\n                <p>Kaikki ilmoitukset näkyvät täällä.</p>\n              </div>\n            ) : (\n              <div className=\"space-y-3\">\n                {sortedNotifications.map((notification) => (\n                  <div\n                    key={notification.id}\n                    className={`\n                      p-4 rounded-lg border-l-4 cursor-pointer transition-all hover:shadow-md\n                      ${getPriorityColor(notification.priority)}\n                      ${!notification.isRead ? 'bg-accent/30 shadow-sm' : 'opacity-75'}\n                    `}\n                  >\n                    <div className=\"flex items-start justify-between gap-3\">\n                      <div className=\"flex items-start gap-3 flex-1 min-w-0\">\n                        <div className=\"flex-shrink-0 mt-0.5\">\n                          {getNotificationIcon(notification.type)}\n                        </div>\n                        <div className=\"flex-1 min-w-0\">\n                          <div className=\"flex items-center gap-2 mb-1\">\n                            <h4 className=\"font-medium text-sm truncate\">\n                              {notification.title}\n                            </h4>\n                            {!notification.isRead && (\n                              <div className=\"w-2 h-2 bg-primary rounded-full flex-shrink-0\" />\n                            )}\n                          </div>\n                          <p className=\"text-sm text-muted-foreground mb-2 line-clamp-2\">\n                            {notification.message}\n                          </p>\n                          <div className=\"flex items-center justify-between\">\n                            <span className=\"text-xs text-muted-foreground\">\n                              {formatNotificationTime(notification.created_at)}\n                            </span>\n                            <div className=\"flex items-center gap-1\">\n                              {notification.priority === 'high' && (\n                                <Badge variant=\"destructive\" className=\"text-xs\">\n                                  <AlertTriangle className=\"w-3 h-3 mr-1\" />\n                                  Tärkeä\n                                </Badge>\n                              )}\n                              {notification.priority === 'medium' && (\n                                <Badge variant=\"outline\" className=\"text-xs bg-amber-50 text-amber-700 border-amber-300\">\n                                  Keskitärkeä\n                                </Badge>\n                              )}\n                            </div>\n                          </div>\n                        </div>\n                      </div>\n                      <div className=\"flex items-center gap-1 flex-shrink-0\">\n                        {!notification.isRead && (\n                          <Button\n                            variant=\"ghost\"\n                            size=\"sm\"\n                            onClick={(e) => {\n                              e.stopPropagation();\n                              onMarkAsRead(notification.id);\n                            }}\n                            className=\"h-8 w-8 p-0 hover:bg-primary/20\"\n                          >\n                            <Check className=\"w-3 h-3\" />\n                          </Button>\n                        )}\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          onClick={(e) => {\n                            e.stopPropagation();\n                            onDelete(notification.id);\n                          }}\n                          className=\"h-8 w-8 p-0 hover:bg-destructive/20 text-muted-foreground hover:text-destructive\"\n                        >\n                          <Trash2 className=\"w-3 h-3\" />\n                        </Button>\n                      </div>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            )}\n          </ScrollArea>\n        </CardContent>\n      </Card>\n\n      {/* Notification Categories */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center space-x-3\">\n              <div className=\"p-2 bg-green-100 rounded-lg\">\n                <CheckCircle className=\"w-5 h-5 text-green-600\" />\n              </div>\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Hyväksytyt</p>\n                <p className=\"text-xl font-semibold\">\n                  {notifications.filter(n => n.type === 'absence_approved' || n.type === 'shift_approved').length}\n                </p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center space-x-3\">\n              <div className=\"p-2 bg-blue-100 rounded-lg\">\n                <Calendar className=\"w-5 h-5 text-blue-600\" />\n              </div>\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Aikataulut</p>\n                <p className=\"text-xl font-semibold\">\n                  {notifications.filter(n => n.type === 'schedule_published' || n.type === 'schedule_updated').length}\n                </p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center space-x-3\">\n              <div className=\"p-2 bg-purple-100 rounded-lg\">\n                <ClockIcon className=\"w-5 h-5 text-purple-600\" />\n              </div>\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Muistutukset</p>\n                <p className=\"text-xl font-semibold\">\n                  {notifications.filter(n => n.type === 'reminder').length}\n                </p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center space-x-3\">\n              <div className=\"p-2 bg-gray-100 rounded-lg\">\n                <Info className=\"w-5 h-5 text-gray-600\" />\n              </div>\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Järjestelmä</p>\n                <p className=\"text-xl font-semibold\">\n                  {notifications.filter(n => n.type === 'system').length}\n                </p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Help Text */}\n      <div className=\"text-center text-xs text-muted-foreground bg-muted/30 p-3 rounded-lg\">\n        💡 Tärkeät ilmoitukset on merkitty punaisella. Voit merkitä ilmoituksia luetuiksi klikkaamalla ✓-painiketta.\n        Saat uusia ilmoituksia poissaolopyynnöistä, vuoronvaihdoista ja aikataulupäivityksistä.\n      </div>\n    </div>\n  );\n};\n\nexport default EmployeeNotificationCenter;",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 289
        }
      ]
    },
    {
      "path": "src/app/components/EmployeeScheduleControls.tsx",
      "size": 1064,
      "sha256": "1ae1feef62ccfeb84db538a2ace1358f5708f4bcb9e6f9fd2ebab2a81cc5d919",
      "lang": "tsx",
      "lines": 36,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/EmployeeScheduleControls.tsx",
      "chunks": [
        {
          "i": 0,
          "text": "\"use client\";\n\nimport { Button } from \"./ui/button\";\nimport { Popover, PopoverTrigger, PopoverContent } from \"./ui/popover\";\nimport { Calendar as CalIcon } from \"lucide-react\";\n\ninterface EmployeeScheduleControlsProps {\n  days: 7 | 14 | 30;\n  setDays: React.Dispatch<React.SetStateAction<7 | 14 | 30>>;\n}\n\nexport default function EmployeeScheduleControls({ days, setDays }: EmployeeScheduleControlsProps) {\n  return (\n    <Popover>\n      <PopoverTrigger asChild>\n        <Button variant=\"outline\" className=\"flex items-center gap-2\">\n          <CalIcon className=\"w-4 h-4\" />\n          {days} päivää\n        </Button>\n      </PopoverTrigger>\n      <PopoverContent className=\"w-48 space-y-2\">\n        {[7, 14, 30].map((option) => (\n          <Button\n            key={option}\n            variant={days === option ? \"default\" : \"outline\"}\n            className=\"w-full justify-start\"\n            onClick={() => setDays(option as 7 | 14 | 30)}\n          >\n            {option} päivää\n          </Button>\n        ))}\n      </PopoverContent>\n    </Popover>\n  );\n}\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 35
        }
      ]
    },
    {
      "path": "src/app/components/EmployeeScheduleView.tsx",
      "size": 17478,
      "sha256": "474c1958276c945ded1d4e0519746fda73c61f8307ff286fc476883eef6c1e70",
      "lang": "tsx",
      "lines": 441,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/EmployeeScheduleView.tsx",
      "chunks": [
        {
          "i": 0,
          "text": "\"use client\";\n\nimport React, { useState, useEffect } from 'react';\nimport { supabase } from '@/lib/supaBaseClient';\nimport { Card, CardContent, CardHeader, CardTitle } from './ui/card';\nimport { Badge } from './ui/badge';\nimport { Switch } from './ui/switch';\nimport { Label } from './ui/label';\nimport { Calendar, Clock, Users, Eye, EyeOff, AlertCircle, Lock, Plane } from 'lucide-react';\nimport { Employee, ShiftType, DateInfo, TimePeriod, AppSettings } from '../types';\nimport { formatMinutes } from \"@/lib/timeUtils\";\n\n\n\ntype ShiftRow = {\n  id: string;\n  employee_id: string;\n  work_date: string;\n  minutes: number;\n  type: 'normal' | 'locked' | 'absent' | 'holiday' | 'empty';\n  is_locked: boolean;\n  published: boolean;\n};\n\n\ninterface EmployeeScheduleViewProps {\n  currentEmployee: Employee;\n  allEmployees: Employee[];\n  timePeriod: TimePeriod;\n  settings: AppSettings;\n}\n\n\ntype EmployeeWithMappedShifts = Omit<Employee, \"shifts\"> & {\n  shifts: Record<string, ShiftType>;\n};\n\nconst EmployeeScheduleView: React.FC<EmployeeScheduleViewProps> = ({\n  currentEmployee,\n  allEmployees,\n  timePeriod,\n  settings\n}) => {\n  const [showAllEmployees, setShowAllEmployees] = useState(false);\n\n  const [employeeShifts, setEmployeeShifts] = useState<Record<string, Record<string, ShiftType>>>({});\n\nuseEffect(() => {\n  const fetchShifts = async () => {\n    const employeeIds = showAllEmployees\n      ? allEmployees.filter(e => e.isActive).map(e => e.id)\n      : [currentEmployee.id];\n\nconst { data, error } = await supabase\n  .from(\"shifts\")\n  .select(\"employee_id, work_date, minutes, type, is_locked, published\") // julkaisu mukana\n  .gte(\"work_date\", dates[0].fullDate.toISOString().slice(0, 10))\n  .lte(\"work_date\", dates[timePeriod - 1].fullDate.toISOString().slice(0, 10))\n  .eq(\"published\", true);\n\n\n      if (!error && data) {\n        const grouped: Record<string, Record<string, ShiftType>> = {};\n        data.forEach((shift) => {\nconst type: ShiftType[\"type\"] =\n  shift.type === \"normal\"\n    ? \"normal\"\n    : shift.type === \"vacation\"\n    ? \"holiday\" // mappaa lomaan\n    : shift.type === \"sick\"\n    ? \"absent\"  // mappaa poissaoloon\n    : \"empty\";\n\n\n          if (!grouped[shift.employee_id]) grouped[shift.employee_id] = {};\n          grouped[shift.employee_id][shift.work_date] = {\n            type,\n            minutes: shift.minutes,\n          };\n        });\n        setEmployeeShifts(grouped);\n      }\n  };\n\n  fetchShifts();\n}, [showAllEmployees, currentEmployee.id, allEmployees]);\n\n\n  // Generate dates based on time period and settings\n  const generateDates = (period: TimePeriod): DateInfo[] => {\n    const dates: DateInfo[] = [];\n    const today = new Date();\n    const startDate = new Date(today);\n    \n    // Adjust for week start day setting\n    const dayOfWeek = startDate.getDay();\n    let daysToStart: number;\n    \n    const startDaySetting = settings?.general?.weekStartDay ?? 'monday';\n    if (startDaySetting === 'monday') {\n      daysToStart = dayOfWeek === 0 ? 6 : dayOfWeek - 1;\n    } else {\n      daysToStart = dayOfWeek;\n    }\n\n    const dayNames = startDaySetting === 'monday'\n      ? ['MA', 'TI', 'KE', 'TO', 'PE', 'LA', 'SU']\n      : ['SU', 'MA', 'TI', 'KE', 'TO', 'PE', 'LA'];\n\n    for (let i = 0; i < period; i++) {\n      const date = new Date(startDate);\n      date.setDate(startDate.getDate() + i);\n      \n      const dayIndex = settings.general.weekStartDay === 'monday' \n        ? (date.getDay() + 6) % 7\n        : date.getDay();\n        \n      const dayName = dayNames[dayIndex];\n      \n      let dateStr: string;\n      const day = date.getDate();\n      const month = date.getMonth() + 1;\n      \n      const formatSetting = settings?.general?.dateFormat ?? 'dd.mm.yyyy';\n      switch (formatSetting) {\n        case 'mm/dd/yyyy':\n          dateStr = `${month}/${day}`;\n          break;\n        case 'yyyy-mm-dd':\n          dateStr = `${month}-${day}`;\n          break;\n        case 'dd.mm.yyyy':\n        default:\n          dateStr = `${day}.${month}`;\n          break;\n      }\n      \n      dates.push({\n        day: dayName,\n        date: dateStr,\n        fullDate: new Date(date)\n      });\n    }\n\n    return dates;\n  };\n\n  const dates = generateDates(timePeriod);\n\n\n  // Filter employees to show\n  const displayEmployees = showAllEmployees ? allEmployees : [currentEmployee];\nconst employeesWithShifts: EmployeeWithMappedShifts[] = displayEmployees.map((emp) => ({\n  ...emp,\n  shifts: employeeShifts[emp.id] || {},\n}));\n\n  const getShiftDisplay = (shift: ShiftType, isCurrentEmployee: boolean = false) => {\n    const baseStyle = '';\n\n    \n    switch (shift.type) {\n      case 'normal':\n        return { \n          content: shift.minutes ? formatMinutes(shift.minutes) : \"\", \n          color: `bg-primary text-primary-foreground ${baseStyle}`, \n          icon: <Clock className=\"w-3 h-3\" /> \n        };\n      case 'locked':\n        return { \n          content: shift.minutes ? formatMinutes(shift.minutes) : \"\", \n          color: `bg-amber-500 text-white ${baseStyle}`, \n          icon: <Lock className=\"w-3 h-3\" /> \n        };\n      case 'absent':\n        return { \n          content: 'P', \n          color: `bg-destructive text-destructive-foreground ${baseStyle}`, \n          icon: <AlertCircle className=\"w-3 h-3\" /> \n        };\n      case 'holiday':\n        return { \n          content: 'L', \n          color: `bg-blue-500 text-white ${baseStyle}`, \n          icon: <Plane className=\"w-3 h-3\" /> \n        };\n      default:\n        return { \n          content: '', \n          color: `bg-muted ${baseStyle}`, \n          icon: null \n        };\n    }\n  };\n\n const getTotalMinutes = (shifts: Record<string, ShiftType>) => {\n   return Object.values(shifts).reduce((total, shift) => {\n     return total + (shift.minutes || 0);\n   }, 0);\n };\n\n const currentEmployeeTotalMinutes = getTotalMinutes(employeeShifts[currentEmployee.id] || {});\n  const gridCols = `grid-cols-${Math.min(7 + 1, 12)}`;\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header Card */}\n      <Card className=\"shadow-lg border-0 bg-gradient-to-r from-background to-secondary/20\">\n        <CardHeader className=\"pb-4\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center space-x-3\">\n              <Calendar className=\"w-6 h-6 text-primary\" />\n              <CardTitle className=\"text-xl text-primary\">\n                Työvuorot (7 päivää)\n              </CardTitle>\n            </div>\n            <div className=\"flex items-center gap-4\">\n              <Badge variant=\"secondary\" className=\"px-3 py-1\">\n                <Clock className=\"w-4 h-4 mr-2\" />\n                Omat tunnit: {formatMinutes(currentEmployeeTotalMinutes)}\n              </Badge>\n              <div className=\"flex items-center space-x-2\">\n                <Switch\n                  id=\"show-all\"\n                  checked={showAllEmployees}\n                  onCheckedChange={setShowAllEmployees}\n                />\n                <Label htmlFor=\"show-all\" className=\"text-sm flex items-center gap-2\">\n                  {showAllEmployees ? <Eye className=\"w-4 h-4\" /> : <EyeOff className=\"w-4 h-4\" />}\n                  {showAllEmployees ? 'Näytä vain omat' : 'Näytä kaikki'}\n                </Label>\n              </div>\n            </div>\n          </div>\n          {showAllEmployees && (\n            <div className=\"text-sm text-muted-foreground bg-blue-50 px-3 py-2 rounded-md mt-2\">\n              <Users className=\"w-4 h-4 inline mr-2\" />\n              Näytetään kaikkien työntekijöiden vuorot. Omat vuorosi on korostettu.\n            </div>\n          )}\n        </CardHeader>\n        <CardContent className=\"p-0\">\n          <div className=\"overflow-x-auto\">\n            <div className=\"min-w-full\">\n              {/* Header */}\n              <div className=\"bg-muted/50 border-b\">\n                <div className={`grid gap-px ${gridCols}`} style={{ gridTemplateColumns: `200px repeat(${timePeriod}, 1fr)` }}>\n                  <div className=\"p-4 bg-background\">\n                    <span className=\"text-sm font-medium text-muted-foreground\">Työntekijä</span>\n                  </div>\n                  {dates.map((date, index) => {\n                    const isToday = date.fullDate.toDateString() === new Date().toDateString();\n                    return (\n                      <div key={index} className={`p-3 bg-background text-center min-w-[80px] ${isToday ? 'bg-primary/10' : ''}`}>\n                        <div className={`text-xs font-medium ${isToday ? 'text-primary' : 'text-muted-foreground'}`}>\n                          {date.day}\n                        </div>\n                        <div className={`text-sm font-semibold mt-1 ${isToday ? 'text-primary' : ''}`}>\n                          {date.date}\n                        </div>\n                        {isToday && (\n                          <div className=\"text-xs text-primary font-medium\">Tänään</div>\n                        )}\n                      </div>\n                    );\n                  })}\n                </div>\n              </div>\n\n              {/* Employee Rows */}\n              <div className=\"divide-y divide-border\">\n                {employeesWithShifts.map((employee) => {\n                  const isCurrentEmployee = employee.id === currentEmployee.id;\n                  return (\n                    <div \n                      key={employee.id} \n                      className={`grid gap-px ${gridCols} transition-colors ${\n                      isCurrentEmployee ? 'bg-primary/5' : ''\n                      } hover:bg-accent/30`} \n                      style={{ gridTemplateColumns: `200px repeat(${timePeriod}, 1fr)` }}\n                    >\n                      <div className=\"p-4 bg-background flex items-center justify-between\">\n                        <div>\n                          <div className=\"flex items-center gap-2\">\n                            <span className={`font-medium ${isCurrentEmployee ? 'text-primary' : ''}`}>\n                              {employee.name}\n                              {isCurrentEmployee && ' (Sinä)'}\n                            </span>\n                          </div>\n                          <div className=\"text-xs text-muted-foreground\">{employee.department}</div>\n                        </div>\n<Badge variant=\"outline\" className=\"text-xs\">\n  {formatMinutes(getTotalMinutes(employee.shifts))}\n</Badge>\n\n                      </div>\n                      {dates.map((d, dayIndex) => {\n                        const dateKey = d.fullDate.toISOString().slice(0, 10);\n                        const shift = employee.shifts[dateKey] || { type: \"empty\", minutes: 0 };\n                        const shiftDisplay = getShiftDisplay(shift, isCurrentEmployee);\n                        const isToday = d.fullDate.toDateString() === new Date().toDateString();\n\n                        return (\n                          <div\n                            key={dayIndex}\n                            className={`\n                              h-16 p-2 m-0 rounded-none border-0 \n                              flex items-center justify-center min-w-[80px]\n                              ${shiftDisplay.color}\n                              transition-all duration-200\n                            `}\n                            title={`${employee.name} - ${d.day} ${d.date}${shift.type === 'normal' ? ` (${formatMinutes(shift.minutes ?? 0)})` : shift.type === 'empty' ? ' - Vapaa' : ''}`}\n\n                          >\n                            <div className=\"flex flex-col items-center space-y-1\">\n                              {shiftDisplay.icon}\n                              {shiftDisplay.content && (\n                                <span className=\"text-xs font-medium\">{shiftDisplay.content}</span>\n                              )}\n                            </div>\n                          </div>\n                        );\n                      })}\n                    </div>\n                  );\n                })}\n              </div>\n\n              {/* Summary Row for all employees view */}\n              {showAllEmployees && (\n                <div className=\"bg-accent/50 border-t-2 border-primary/20\">\n                  <div className={`grid gap-px ${gridCols}`} style={{ gridTemplateColumns: `200px repeat(${timePeriod}, 1fr)` }}>\n                    <div className=\"p-4 bg-background\">\n                      <div className=\"flex items-center space-x-2\">\n                        <Users className=\"w-4 h-4 text-muted-foreground\" />\n                        <span className=\"font-medium text-sm\">Yhteensä ({employeesWithShifts.length} työntekijää)</span>\n                      </div>\n                    </div>\n                    {dates.map((_, dayIndex) => {\n                      const dateKey = dates[dayIndex].fullDate.toISOString().slice(0, 10);\n                      const dayTotal = employeesWithShifts.reduce((total, employee) => {\n                        const shift = employee.shifts[dateKey];\n                        return total + (shift?.minutes || 0);\n                      }, 0);\n\n                      const countEmployees = employeesWithShifts.filter(emp => emp.shifts[dateKey]?.type !== 'empty').length;\n\n                      return (\n                        <div key={dayIndex} className=\"p-3 bg-background text-center min-w-[80px]\">\n                          <div className=\"text-sm font-semibold text-primary\">{formatMinutes(dayTotal)}</div>\n                          <div className=\"text-xs text-muted-foreground\">\n                            {countEmployees} henkilöä\n                          </div>\n                        </div>\n                      );\n                    })}\n                  </div>\n                </div>\n              )}\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Current Week Summary */}\n      <Card className=\"shadow-md\">\n        <CardHeader>\n          <CardTitle className=\"text-lg\">Viikon yhteenveto</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n            <div className=\"text-center p-4 border border-border rounded-lg bg-primary/5\">\n              <div className=\"text-2xl font-bold text-primary\">{formatMinutes(currentEmployeeTotalMinutes)}</div>\n              <div className=\"text-sm text-muted-foreground\">Omat tunnit yhteensä</div>\n            </div>\n            <div className=\"text-center p-4 border border-border rounded-lg\">\n              <div className=\"text-2xl font-bold\">\n                {(currentEmployee.shifts ?? []).filter(s => s.type !== 'empty').length}\n              </div>\n              <div className=\"text-sm text-muted-foreground\">Työvuoroja</div>\n            </div>\n            <div className=\"text-center p-4 border border-border rounded-lg\">\n              <div className=\"text-2xl font-bold\">\n                {7 - ((currentEmployee.shifts ?? []).filter(s => s.type !== 'empty').length)}\n              </div>\n              <div className=\"text-sm text-muted-foreground\">Vapaapäiviä</div>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Legend */}\n      <Card className=\"shadow-md\">\n        <CardContent className=\"p-4\">\n          <div className=\"flex flex-wrap gap-4 items-center justify-center\">\n            <div className=\"flex items-center space-x-2\">\n              <div className=\"w-4 h-4 bg-primary rounded-sm flex items-center justify-center\">\n                <Clock className=\"w-2.5 h-2.5 text-primary-foreground\" />\n              </div>\n              <span className=\"text-sm\">Normaali vuoro</span>\n            </div>\n            <div className=\"flex items-center space-x-2\">\n              <div className=\"w-4 h-4 bg-amber-500 rounded-sm flex items-center justify-center\">\n                <Lock className=\"w-2.5 h-2.5 text-white\" />\n              </div>\n              <span className=\"text-sm\">Lukittu vuoro</span>\n            </div>\n            <div className=\"flex items-center space-x-2\">\n              <div className=\"w-4 h-4 bg-destructive rounded-sm flex items-center justify-center\">\n                <AlertCircle className=\"w-2.5 h-2.5 text-destructive-foreground\" />\n              </div>\n              <span className=\"text-sm\">Poissaolo</span>\n            </div>\n            <div className=\"flex items-center space-x-2\">\n              <div className=\"w-4 h-4 bg-blue-500 rounded-sm flex items-center justify-center\">\n                <Plane className=\"w-2.5 h-2.5 text-white\" />\n              </div>\n              <span className=\"text-sm\">Loma</span>\n            </div>\n            {!showAllEmployees && (\n              <div className=\"flex items-center space-x-2 border-l border-border pl-4 ml-2\">\n                <div className=\"w-4 h-4 bg-primary rounded-sm ring-2 ring-primary ring-offset-2\"></div>\n                <span className=\"text-sm\">Omat vuorosi korostettu</span>\n              </div>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Footer Note */}\n      <div className=\"text-center text-xs text-muted-foreground bg-muted/30 p-3 rounded-lg\">\n        {showAllEmployees \n          ? 'Omat vuorosi on korostettu. Voit piilottaa muiden työntekijöiden vuorot kytkimellä.'\n          : 'Voit nähdä kaikkien työntekijöiden vuorot kytkemällä \"Näytä kaikki\" -vaihtoehdon päälle.'\n        }\n      </div>\n    </div>\n  );\n};\n\nexport default EmployeeScheduleView;",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 441
        }
      ]
    },
    {
      "path": "src/app/components/Login.tsx",
      "size": 6002,
      "sha256": "11efe512df8958780ba612e0b58f99ca860d49e3e1d33368f06cb92db279b6f7",
      "lang": "tsx",
      "lines": 172,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/Login.tsx",
      "chunks": [
        {
          "i": 0,
          "text": " \"use client\";\n\nimport { useState, useMemo } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport { createClientComponentClient } from \"@supabase/auth-helpers-nextjs\";\nimport { Input } from \"@/app/components/ui/input\";\nimport { Button } from \"@/app/components/ui/button\";\nimport { toast } from \"sonner\";\n\nexport default function Login() {\n  const router = useRouter();\n  const supabase = createClientComponentClient();\n  const [mode, setMode] = useState<\"magic\" | \"password\">(\"password\");\n  const [email, setEmail] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n\n  const [loadingMagic, setLoadingMagic] = useState(false);\n  const [loadingPwd, setLoadingPwd] = useState(false);\n  const [sendingReset, setSendingReset] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n\n  const origin = typeof window !== \"undefined\" ? window.location.origin : \"\";\n\n  const emailValid = useMemo(() => /\\S+@\\S+\\.\\S+/.test(email), [email]);\n  const canMagic = emailValid && !loadingMagic && !sendingReset;\n  const canPwd = emailValid && password.length >= 8 && !loadingPwd;\n  async function handleMagicLink(e: React.FormEvent) {\n    e.preventDefault();\n    if (!canMagic) return;\n    setError(null);\n    setLoadingMagic(true);\n    try {\n      const { error } = await supabase.auth.signInWithOtp({\n        email,\n        options: {\n          emailRedirectTo: origin ? `${origin}/` : undefined,\n        },\n      });\n      if (error) throw error;\n      toast.success(\"Kirjautumislinkki lähetetty sähköpostiisi.\");\n    } catch (err: any) {\n      console.error(err);\n      setError(err?.message ?? \"Linkin lähetys epäonnistui.\");\n      toast.error(\"Linkin lähetys epäonnistui\");\n    } finally {\n      setLoadingMagic(false);\n    }\n  }\n\n  async function handlePasswordLogin(e: React.FormEvent) {\n    e.preventDefault();\n    if (!canPwd) return;\n    setError(null);\n    setLoadingPwd(true);\n    try {\n    const { error } = await supabase.auth.signInWithPassword({ email, password });\n      if (error) throw error;\n      toast.success(\"Kirjautuminen onnistui\");\n      router.push(\"/\");\n    } catch (err: any) {\n      console.error(err);\n      setError(err?.message ?? \"Kirjautuminen epäonnistui.\");\n      toast.error(\"Kirjautuminen epäonnistui\");\n    } finally {\n      setLoadingPwd(false);\n    }\n  }\n\n  async function handleSendRecovery() {\n    if (!emailValid || sendingReset) return;\n    setError(null);\n    setSendingReset(true);\n    try {\n      const { error } = await supabase.auth.resetPasswordForEmail(email, {\n        redirectTo: origin ? `${origin}/set-password` : undefined,\n      });\n      if (error) throw error;\n      toast.success(\"Salasanan palautuslinkki lähetetty sähköpostiisi.\");\n    } catch (err: any) {\n      console.error(err);\n      setError(err?.message ?? \"Palautuslinkin lähetys epäonnistui.\");\n      toast.error(\"Palautuslinkin lähetys epäonnistui\");\n    } finally {\n      setSendingReset(false);\n    }\n  }\n  return (\n    <div className=\"flex min-h-screen items-center justify-center bg-gray-50 p-4\">\n      <div className=\"bg-white p-8 rounded-2xl shadow-md w-full max-w-md space-y-4\">\n        <h1 className=\"text-2xl font-bold text-center\">Kirjaudu sisään</h1>\n        <div className=\"flex justify-center gap-2\">\n          <Button\n            type=\"button\"\n            variant={mode === \"password\" ? \"default\" : \"outline\"}\n            onClick={() => setMode(\"password\")}\n          >\n            Salasana\n          </Button>\n          <Button\n            type=\"button\"\n            variant={mode === \"magic\" ? \"default\" : \"outline\"}\n            onClick={() => setMode(\"magic\")}\n          >\n            Magic link\n          </Button>\n        </div>\n\n        {error && (\n          <div className=\"rounded bg-red-100 p-2 text-sm text-red-700\">{error}</div>\n        )}\n\n        {mode === \"magic\" ? (\n          <form onSubmit={handleMagicLink} className=\"space-y-3\">\n            <div>\n              <label className=\"block text-sm font-medium mb-1\">Sähköposti</label>\n              <Input\n                type=\"email\"\n                value={email}\n                onChange={(e) => setEmail(e.target.value)}\n                placeholder=\"sähköposti@esimerkki.com\"\n                required\n              />\n    </div>\n            <Button type=\"submit\" className=\"w-full\" disabled={!canMagic}>\n              {loadingMagic ? \"Lähetetään…\" : \"Lähetä linkki\"}\n            </Button>\n          </form>\n        ) : (\n          <form onSubmit={handlePasswordLogin} className=\"space-y-3\">\n            <div>\n              <label className=\"block text-sm font-medium mb-1\">Sähköposti</label>\n              <Input\n                type=\"email\"\n                value={email}\n                onChange={(e) => setEmail(e.target.value)}\n                placeholder=\"sähköposti@esimerkki.com\"\n                required\n              />\n            </div>\n            <div>\n              <label className=\"block text-sm font-medium mb-1\">Salasana</label>\n              <Input\n                type=\"password\"\n                value={password}\n                onChange={(e) => setPassword(e.target.value)}\n                placeholder=\"Vähintään 8 merkkiä\"\n                minLength={8}\n                required\n              />\n            </div>\n            <Button type=\"submit\" className=\"w-full\" disabled={!canPwd}>\n              {loadingPwd ? \"Kirjaudutaan…\" : \"Kirjaudu sisään\"}\n            </Button>\n\n            <div className=\"text-center text-sm\">\n              Unohtunut salasana?{\" \"}\n              <button\n                type=\"button\"\n                onClick={handleSendRecovery}\n                className=\"underline text-blue-700 disabled:opacity-50\"\n                disabled={!emailValid || sendingReset}\n                title=\"Syötä ensin sähköpostiosoite\"\n              >\n                Lähetä palautuslinkki\n              </button>\n            </div>\n          </form>\n        )}\n      </div>\n    </div>\n  );\n}",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 172
        }
      ]
    },
    {
      "path": "src/app/components/ScheduleTable.tsx",
      "size": 21219,
      "sha256": "7f21f316a79761f70a8ebce9f322dc98e2bc94b7058fdf89e7cd2d017f790413",
      "lang": "tsx",
      "lines": 632,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/ScheduleTable.tsx",
      "chunks": [
        {
          "i": 0,
          "text": "\"use client\";\n\nimport React, { useEffect, useMemo, useState } from \"react\";\nimport { Badge } from \"./ui/badge\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"./ui/card\";\nimport { Calendar, Clock, Users, AlertCircle, Lock, Plane, Plus, Filter } from \"lucide-react\";\nimport { ShiftType, Employee, DateInfo } from \"../types\";\nimport { supabase } from \"@/lib/supaBaseClient\";\nimport { toast } from \"sonner\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"./ui/popover\";\nimport { Button } from \"./ui/button\";\nimport { Input } from \"./ui/input\";\nimport { useScheduleStore } from \"@/store/useScheduleStore\";\nimport { useSettingsStore } from \"@/store/useSettingsStore\";\nimport { alignToWeekStart } from \"@/lib/dateUtils\";\nimport { logError, logInfo } from \"@/lib/logger\";\n\n\ntype DateCell = DateInfo & { iso: string };\n\n        type EmployeeRow = {\n          id: string;\n          name: string;\n          email: string;\n          department: string;\n          is_active: boolean;\n        };\n\n        type AbsenceRow = {\n  employee_id: string;\n  start_date: string;\n  end_date: string | null;\n  reason: string | null;\n  status: \"pending\" | \"approved\" | \"declined\";\n};\n\n\n\ninterface ScheduleTableProps {\n  employees?: Employee[]; // säilytetään signatuuri\n}\n\n\nfunction addDaysISO(iso: string, add: number) {\n  // \"T00:00:00\" poistaa aikavyöhykkeen heiton\n  const d = new Date(iso + \"T00:00:00Z\");\n  d.setUTCDate(d.getUTCDate() + add);\n  return d.toISOString().slice(0, 10);\n}\n\nfunction fiWeekdayShort(d: Date) {\n  // su-to klo 0 locale -> FI näyttää ma, ti, ke...\n  return d\n    .toLocaleDateString(\"fi-FI\", { weekday: \"short\" })\n    .replace(\".\", \"\")\n    .toUpperCase()\n    .slice(0, 2);\n}\n\n function fiDayMonth(d: Date) {\n   const day = d.getDate();\n   const month = d.getMonth() + 1;\n   return `${day}.${month}`;\n }\n\n// 🆕 FI-normalisointi (lowercase + diakriittien poisto)\nfunction normalizeFi(s: string) {\n  return (s || \"\")\n    .toLowerCase()\n    .normalize(\"NFD\")\n    .replace(/[\\u0300-\\u036f]/g, \"\");\n}\n\n const DEFAULT_FILTERS = {\n  departments: [] as string[],\n  showActive: false,\n  showInactive: false,\n  searchTerm: \"\",\n}\n\n\nconst ScheduleTable: React.FC<ScheduleTableProps> = () => {\n\nconst startISO = useScheduleStore((s) => s.startDateISO);\nconst days = useScheduleStore((s) => s.days);\nconst weekStartDay = useSettingsStore((s) => s.settings.general.weekStartDay);\n\nconst alignedStart = useMemo(\n  () => alignToWeekStart(startISO, weekStartDay),\n  [startISO, weekStartDay]\n);\n\n\n\nconst shiftsMap = useScheduleStore((s) => s.shiftsMap) ?? {};\nconst filters = useScheduleStore((s) => s.filters) ?? DEFAULT_FILTERS;\n\n//tila-filtteri on aktiivinen, jos vain toinen on päällä\nconst stateFilterActive = filters.showActive !== filters.showInactive;\n\nconst employees = useScheduleStore(s => s.employees);\nconst filteredEmployees = useMemo(() => {\n  const term = normalizeFi((filters.searchTerm ?? \"\").trim());\n  return employees.filter((emp) => {\n    // department\n    if (filters.departments.length > 0 && !filters.departments.includes(emp.department)) {\n      return false;\n    }\n    // active/inactive XOR\n    if (stateFilterActive) {\n      if (filters.showActive && !emp.isActive) return false;\n      if (filters.showInactive && emp.isActive) return false;\n    }\n    // search (nimi + email + osasto)\n    if (term.length > 0) {\n      const hay =\n        normalizeFi(emp.name) +\n        \" \" +\n        normalizeFi(emp.email) +\n        \" \" +\n        normalizeFi(emp.department);\n      if (!hay.includes(term)) return false;\n    }\n    return true;\n  });\n}, [employees, filters, stateFilterActive]);\n  \n  const [loading, setLoading] = useState(true);\n  const [selectedCell, setSelectedCell] = useState<{ employee: string; day: number } | null>(null);\n  const [openPopover, setOpenPopover] = useState<string | null>(null);\n\n\n\n\n  // Päivärivi tuotetaan ISO:sta -> näyttää täsmälleen sun UI:n kaltaisen otsikon\nconst dates: DateCell[] = useMemo(() => {\n  return Array.from({ length: days }).map((_, i): DateCell => {\n    const iso = addDaysISO(alignedStart, i);\n    const d = new Date(iso + \"T00:00:00Z\");\n    return { \n      day: fiWeekdayShort(d), \n      date: fiDayMonth(d), \n      iso,\n      fullDate: d // 👈 tämä puuttui\n    };\n  });\n}, [alignedStart, days]);\n\n  // Alignaa heti mountissa ja aina kun viikon aloituspäivä muuttuu,\n  // jotta näkymä on johdonmukainen myös ilman Toolbarin efektiä.\n\n\n  // Vuorot mapattuna: key = `${employee_id}|${work_date}`\n  \n\n// 1) Hae työntekijät + 2) hae vuorot valitulle jaksolle\nuseEffect(() => {\n  (async () => {\n    try {\n      setLoading(true);\n      // Employees\n      const { data: empData, error: empErr } = await supabase\n        .from(\"employees\")\n        .select(\"id, name, email, department, is_active, created_at\")\n        .order(\"created_at\", { ascending: true });\n      if (empErr) throw empErr;\n\n      const mappedEmp: Employee[] = (empData ?? []).map((row: EmployeeRow) => ({\n        id: row.id,\n        name: row.name,\n        email: row.email,\n        department: row.department,\n        isActive: !!row.is_active,\n        shifts: [] as ShiftType[],\n      }));\n\n      const { data: s, error: sErr } = await supabase\n        .from(\"shifts\")\n        .select(\"employee_id, work_date, type, minutes\")\n        .gte(\"work_date\", dates[0].iso)\n        .lte(\"work_date\", dates[dates.length - 1].iso)\n        .in(\"employee_id\", mappedEmp.map((e) => e.id));\n      if (sErr) throw sErr;\n\n      useScheduleStore.getState().hydrate({\n        employees: mappedEmp,\n        dates,\n        shifts: (s ?? []).map((r) => ({\n          employee_id: r.employee_id,\n          work_date: r.work_date,\n          type: r.type as \"normal\" | \"locked\" | \"absent\" | \"holiday\",\n          minutes: r.minutes ?? 0,\n        })),\n      });\n\n      const { data: abs, error: absErr } = await supabase\n        .from(\"absences\")\n        .select(\"employee_id, start_date, end_date, reason, status\")\n        .eq(\"status\", \"approved\")\n        .in(\"employee_id\", mappedEmp.map((e) => e.id));\n      if (absErr) throw absErr;\n\n      const absMap: Record<string, { type: \"absent\" | \"holiday\"; reason: string }> = {};\n      (abs ?? []).forEach((a: AbsenceRow) => {\n        const start = new Date(a.start_date);\n        const end = a.end_date ? new Date(a.end_date) : start;\n        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {\n          const iso = d.toISOString().slice(0, 10);\n          absMap[`${a.employee_id}|${iso}`] = {\n            type: a.reason?.toLowerCase() === \"holiday\" ? \"holiday\" : \"absent\",\n            reason: a.reason ?? \"\",\n          };\n        }\n      });\n      setAbsencesMap(absMap);\n      logInfo(\"ScheduleTable initial fetch OK\");\n    } catch (e) {\n      logError(\"ScheduleTable initial fetch FAILED\", e);\n      toast.error(\"Tietojen haku epäonnistui\");\n    } finally {\n      setLoading(false);\n    }\n  })();\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n}, [startISO, days]);\n\n\n\nconst [absencesMap, setAbsencesMap] = useState<Record<string, { type: \"absent\" | \"holiday\"; reason: string }>>({});\n\n  // Lue solun vuoro mapista\nfunction getShift(empId: string, dayIndex: number): ShiftType {\n  const iso = dates[dayIndex].iso;\n  const key = `${empId}|${iso}`;\n  const row = shiftsMap[key];\n  if (!row) return { type: \"empty\" };                 // UI-fallback\n  if (row.type === \"normal\" || row.type === \"locked\") {\n    return { type: row.type, minutes: row.minutes ?? 0 };\n  }\n  return { type: row.type }; // absent/holiday\n}\n\n  // Yhteensä tunnit / työntekijä\n  const getTotalHours = (employee: Employee) =>\n    dates.reduce((sum, _, i) => {\n      const s = getShift(employee.id, i);\n      return sum + (s.minutes || 0);\n    }, 0);\n\n    function formatMinutes(total: number) {\n    if (!total) return \"0h\";\n    const h = Math.floor(total / 60);\n    const m = total % 60;\n    return m === 0 ? `${h}h` : `${h}h ${m}m`;\n  }\n\n  // Klikkaus: toggle empty <-> normal(8h), upsert DB:hen\n// ScheduleTable.tsx\n\nconst applyCellChange = useScheduleStore(s => s.applyCellChange);\n\nfunction handleCellClick(employeeId: string, dayIndex: number, minutes: number | null) {\n  const iso = dates[dayIndex].iso;\n  applyCellChange({\n    employee_id: employeeId,\n    work_date: iso,\n    minutes,\n  });\n  setSelectedCell({ employee: employeeId, day: dayIndex });\n}\n // Custom input state\n const [customHours, setCustomHours] = useState<number>(0);\n const [customMinutes, setCustomMinutes] = useState<number>(0);\n\n function handleCustomHourSubmit(empId: string, dayIndex: number) {\n   const total = (customHours ?? 0) * 60 + (customMinutes ?? 0);\n   if (total > 0) {\n     handleCellClick(empId, dayIndex, total);\n     setCustomHours(0);\n     setCustomMinutes(0);\n   }\n }\n\n\n\n  // UI-helper solun ulkoasuun\n  const getShiftDisplay = (shift: ShiftType) => {\n    switch (shift.type) {\n      case \"normal\":\n        return { content: formatMinutes(shift.minutes ?? 0), color: \"bg-primary text-primary-foreground\", icon: <Clock className=\"w-3 h-3\" /> };\n      case \"locked\":\n        return { content: formatMinutes(shift.minutes ?? 0), color: \"bg-amber-500 text-white\", icon: <Lock className=\"w-3 h-3\" /> };\n      case \"absent\":\n        return { content: \"A\", color: \"bg-destructive text-destructive-foreground\", icon: <AlertCircle className=\"w-3 h-3\" /> };\n      case \"holiday\":\n        return { content: \"H\", color: \"bg-blue-500 text-white\", icon: <Plane className=\"w-3 h-3\" /> };\n      default:\n        return { content: \"\", color: \"bg-muted hover:bg-accent\", icon: <Plus className=\"w-3 h-3 opacity-0 group-hover:opacity-50\" /> };\n    }\n  };\n\n  if (loading) {\n    return <div className=\"text-center py-8 text-muted-foreground\">Ladataan…</div>;\n  }\n\n  return (\n  <div className=\"w-full space-y-6\">\n    <Card className=\"shadow-lg border-0 bg-gradient-to-r from-background to-secondary/20\">\n      <CardHeader className=\"pb-4\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center space-x-3\">\n            <Calendar className=\"w-6 h-6 text-primary\" />\n            <CardTitle className=\"text-2xl text-primary\">Vuorot</CardTitle>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Badge variant=\"secondary\" className=\"px-3 py-1\">\n            <Users className=\"w-4 h-4 mr-2\" />\n            {filteredEmployees.length} työntekijää\n            </Badge>\n            {(filters.departments.length > 0 || stateFilterActive) && (\n              <Badge variant=\"outline\" className=\"px-3 py-1\">\n                <Filter className=\"w-3 h-3 mr-1\" />\n                Suodatettu\n              </Badge>\n              )}\n              </div>\n          </div>\n\n      </CardHeader>\n  {(filters.departments.length > 0 || stateFilterActive || (filters.searchTerm ?? \"\").trim()) && (\n    <div className=\"px-6 pb-2\">\n      <div className=\"text-sm text-muted-foreground bg-accent/40 px-3 py-2 rounded-md inline-flex items-center gap-3 flex-wrap\">\n        <Filter className=\"w-4 h-4\" />\n        <div className=\"flex flex-wrap gap-x-3 gap-y-1\">\n          {stateFilterActive && (\n            <span>{filters.showActive ? \"Vain aktiiviset työntekijät\" : \"Vain ei-aktiiviset työntekijät\"}</span>\n          )}\n          {filters.departments.length > 0 && (\n            <span>Osastot: {filters.departments.join(\", \")}</span>\n          )}\n          {(filters.searchTerm ?? \"\").trim() && (\n            <span>Haku: “{filters.searchTerm.trim()}”</span>\n            )}\n        </div>\n      </div>\n    </div>\n  )}\n\n\n      <CardContent className=\"p-0\">\n        <div className=\"overflow-x-auto\">\n          <div className=\"min-w-full\">\n            {/* Header */}\n            <div className=\"bg-muted/50 border-b\">\n              <div\n              className=\"grid gap-px\"\n              style={{ gridTemplateColumns: `minmax(200px,280px) repeat(${days}, minmax(96px, 1fr))` }}\n              >\n                <div className=\"p-4 bg-background\">\n                  <span className=\"text-sm font-medium text-muted-foreground\">Työntekijä</span>\n                </div>\n                {dates.map((date, index) => (\n                  <div key={index} className=\"p-3 bg-background text-center\">\n                    <div className=\"text-xs font-medium text-muted-foreground\">{date.day}</div>\n                    <div className=\"text-sm font-semibold mt-1\">{date.date}</div>\n                  </div>\n                ))}\n              </div>\n            </div>\n\n            {/* Employee Rows */}\n              <div className=\"divide-y divide-border\">\n              {filteredEmployees.length === 0 ? (\n                <div className=\"p-12 text-center text-muted-foreground\">\n                  <Filter className=\"w-12 h-12 mx-auto mb-4 opacity-50\" />\n                  <p>Ei työntekijöitä näytettäväksi nykyisillä suodattimilla</p>\n                  <p className=\"text-sm mt-1\">Muuta suodattimia nähdäksesi työntekijöitä</p>\n                </div>\n              ) : filteredEmployees.map((employee) => (\n\n                <div\n                  key={employee.id}\n                  className=\"grid gap-px hover:bg-accent/30 transition-colors\"\n                  style={{ gridTemplateColumns: `minmax(200px,280px) repeat(${days}, minmax(96px, 1fr))` }}\n                >\n                  <div className=\"p-4 bg-background flex items-center justify-between\">\n                    <div>\n                      <div className=\"flex items-center gap-2\">\n                        <span className=\"font-medium\">{employee.name}</span>\n                        {!employee.isActive && (\n                          <Badge variant=\"destructive\" className=\"text-xs\">Ei-aktiivinen</Badge>\n                        )}\n                      </div>\n                      <div className=\"text-xs text-muted-foreground\">{employee.department}</div>\n                    </div>\n                    <Badge variant=\"outline\" className=\"text-xs\">\n                      {formatMinutes(getTotalHours(employee))}\n                    </Badge>\n                  </div>\n\n{dates.map((_, dayIndex) => {\n  const shift = getShift(employee.id, dayIndex);\n  const shiftDisplay = getShiftDisplay(shift);\n  const isSelected =\n    selectedCell?.employee === employee.id && selectedCell?.day === dayIndex;\n\n  const key = `${employee.id}|${dates[dayIndex].iso}`;\n  const absence = absencesMap[key];\n\n  return (\n    <Popover\n  key={dayIndex}\n  open={openPopover === `${employee.id}-${dayIndex}`}\n  onOpenChange={(o) =>\n    setOpenPopover(o ? `${employee.id}-${dayIndex}` : null)\n  }\n>\n<PopoverTrigger asChild>\n  <div\n    className={`\n      h-16 p-2 m-0 rounded-none border-0 group\n      flex items-center justify-center\n      ${isSelected ? \"ring-2 ring-ring ring-offset-2\" : \"\"}\n      transition-all duration-200 hover:scale-105 hover:shadow-md\n      ${\n        absence\n          ? absence.type === \"holiday\"\n            ? \"bg-blue-100 cursor-not-allowed\"\n            : \"bg-red-100 cursor-not-allowed\"\n          : shiftDisplay.color + \" cursor-pointer\"\n      }\n    `}\n    onDoubleClick={() => {\n      if (!absence) {\n        handleCellClick(employee.id, dayIndex, null); // poisto selkeästi\n      }\n    }}\n  >\n    <div className=\"flex flex-col items-center space-y-1\">\n      {absence ? (\n        <>\n          <span\n            className={`text-xs font-medium ${\n              absence.type === \"holiday\" ? \"text-blue-600\" : \"text-red-600\"\n            }`}\n          >\n            {absence.type === \"holiday\" ? \"L\" : \"A\"}\n          </span>\n          <span className=\"text-[10px]\">\n            {absence.type === \"holiday\" ? \"Loma\" : \"Poissaolo\"}\n          </span>\n        </>\n      ) : (\n        <>\n          {shiftDisplay.icon}\n          {shiftDisplay.content && (\n            <span className=\"text-xs font-medium\">\n              {shiftDisplay.content}\n            </span>\n          )}\n        </>\n      )}\n    </div>\n  </div>\n</PopoverTrigger>\n\n\n  {/* Näytä PopoverContent vain jos ei ole absence */}\n{!absence && (\n  <PopoverContent className=\"w-64 p-3 space-y-3\" side=\"bottom\" align=\"center\">\n    <div className=\"text-sm font-medium text-center\">\n      {employee.name} – {dates[dayIndex].day} {dates[dayIndex].date}\n    </div>\n\n    {/* Pikavalinnat */}\n    <div className=\"grid grid-cols-2 gap-2\">\n      {[4, 6, 8].map((h) => (\n        <Button\n          key={h}\n          variant=\"outline\"\n          size=\"sm\"\n          onClick={() => {\n            handleCellClick(employee.id, dayIndex, h * 60);\n            setOpenPopover(null);\n          }}\n          className=\"justify-center\"\n        >\n          {h}h\n        </Button>\n      ))}\n    </div>\n\n    {/* Custom Hours + Minutes */}\n    <div className=\"space-y-2\">\n      <div className=\"grid grid-cols-2 gap-2\">\n        <Input\n          type=\"number\"\n          min=\"0\"\n          max=\"24\"\n          placeholder=\"0\"\n          value={customHours}\n          onChange={(e) => setCustomHours(Number(e.target.value))}\n          className=\"h-8 text-sm\"\n        />\n        <Input\n          type=\"number\"\n          min=\"0\"\n          max=\"59\"\n          step=\"15\"\n          placeholder=\"0\"\n          value={customMinutes}\n          onChange={(e) => setCustomMinutes(Number(e.target.value))}\n          className=\"h-8 text-sm\"\n        />\n      </div>\n      <Button\n        size=\"sm\"\n        className=\"w-full h-8\"\n        onClick={() => {\n          const total = (customHours ?? 0) * 60 + (customMinutes ?? 0);\n          if (total > 0) {\n            handleCellClick(employee.id, dayIndex, total);\n            setOpenPopover(null);\n          }\n        }}\n        disabled={(customHours ?? 0) + (customMinutes ?? 0) === 0}\n      >\n        Aseta aika\n      </Button>\n    </div>\n\n    {/* Poista vuoro */}\n    <div className=\"flex justify-center\">\n      <Button\n        variant=\"destructive\"\n        size=\"sm\"\n        onClick={() => {\n          handleCellClick(employee.id, dayIndex, null);\n          setOpenPopover(null);\n        }}\n      >\n        Poista vuoro\n      </Button>\n    </div>\n  </PopoverContent>\n)}\n\n</Popover>\n\n  );\n})}\n\n                </div>\n              ))}\n            </div>\n\n            {/* Summary Row */}\n            <div className=\"bg-accent/50 border-t-2 border-primary/20\">\n              <div\n              className=\"grid gap-px\"\n              style={{ gridTemplateColumns: `minmax(200px,280px) repeat(${days}, minmax(96px, 1fr))` }}\n              >\n\n                <div className=\"p-4 bg-background\">\n                  <div className=\"flex items-center space-x-2\">\n                    <Users className=\"w-4 h-4 text-muted-foreground\" />\n                    <span className=\"font-medium text-sm\">\n                      Yhteensä ({filteredEmployees.length} työntekijää)\n                    </span>\n                  </div>\n                </div>\n                {dates.map((_, dayIndex) => {\n                  const dayTotal = filteredEmployees.reduce((total, emp) => {\n                    const s = getShift(emp.id, dayIndex);\n                    return total + (s?.minutes || 0);\n                  }, 0);\n\n                  const filledCount = filteredEmployees.filter(\n                    (emp) => getShift(emp.id, dayIndex)?.type !== \"empty\"\n                  ).length;\n\n                  return (\n                    <div key={dayIndex} className=\"p-3 bg-background text-center\">\n                      <div className=\"text-sm font-semibold text-primary\">{formatMinutes(dayTotal)}</div>\n                      <div className=\"text-xs text-muted-foreground\">{filledCount} henkilöä</div>\n                    </div>\n                  );\n                })}\n              </div>\n            </div>\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n\n    {/* Legend */}\n    <Card className=\"shadow-md\">\n      <CardContent className=\"p-4\">\n        <div className=\"flex flex-wrap gap-4 items-center justify-center\">\n          <div className=\"flex items-center space-x-2\">\n            <div className=\"w-4 h-4 bg-primary rounded-sm flex items-center justify-center\">\n              <Clock className=\"w-2.5 h-2.5 text-primary-foreground\" />\n            </div>\n            <span className=\"text-sm\">Normaali vuoro</span>\n          </div>\n          <div className=\"flex items-center space-x-2\">\n            <div className=\"w-4 h-4 bg-amber-500 rounded-sm flex items-center justify-center\">\n              <Lock className=\"w-2.5 h-2.5 text-white\" />\n            </div>\n            <span className=\"text-sm\">Lukittu vuoro</span>\n          </div>\n          <div className=\"flex items-center space-x-2\">\n            <div className=\"w-4 h-4 bg-destructive rounded-sm flex items-center justify-center\">\n              <AlertCircle className=\"w-2.5 h-2.5 text-destructive-foreground\" />\n            </div>\n            <span className=\"text-sm\">Poissaolo</span>\n          </div>\n          <div className=\"flex items-center space-x-2\">\n            <div className=\"w-4 h-4 bg-blue-500 rounded-sm flex items-center justify-center\">\n              <Plane className=\"w-2.5 h-2.5 text-white\" />\n            </div>\n            <span className=\"text-sm\">Loma</span>\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  </div>\n);\n}\n\nexport default ScheduleTable;\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 631
        }
      ]
    },
    {
      "path": "src/app/components/SettingsDialog.tsx",
      "size": 20629,
      "sha256": "7b3ffa388425870ed8df5b916bf4bed88939aee7919ddd3302ef586d191b233f",
      "lang": "tsx",
      "lines": 473,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/SettingsDialog.tsx",
      "chunks": [
        {
          "i": 0,
          "text": "// components/SettingsDialog.tsx\n\"use client\";\n\nimport { useState } from \"react\";\nimport { toast } from \"sonner\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"./ui/popover\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"./ui/tabs\";\nimport { ScrollArea } from \"./ui/scroll-area\";\nimport { Separator } from \"./ui/separator\";\nimport { Button } from \"./ui/button\";\nimport { Switch } from \"./ui/switch\";\nimport { Slider } from \"./ui/slider\";\nimport { Label } from \"./ui/label\";\nimport { Input } from \"./ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"./ui/select\";\nimport {\n  Settings as SettingsIcon, Download, Upload, RotateCcw, Paintbrush, Zap, FileSpreadsheet,\n  Bell, Shield, Sun, Moon, Monitor, Globe, HardDrive, Database, Trash2\n} from \"lucide-react\";\n\n import { useSettingsStore } from \"@/store/useSettingsStore\";\n import { saveNotificationSettingsToDb } from \"@/lib/settingsDb\";\n import { applyTheme } from \"@/lib/theme\";\n import { formatMinutes } from \"@/lib/timeUtils\";\nimport type {\n  Theme, Language, WeekStartDay, DateFormat\n} from \"@/lib/settingsSchema\";\n\nexport default function SettingsDialog() {\n  const [isOpen, setIsOpen] = useState(false);\n\n  const settings = useSettingsStore((s) => s.settings);\n  const updateGeneralSettings = useSettingsStore((s) => s.updateGeneral);\n  const updateAutoGenerationSettings = useSettingsStore((s) => s.updateAutoGen);\n  const updateExportSettings = useSettingsStore((s) => s.updateExport);\n  const updateNotificationSettings = useSettingsStore((s) => s.updateNotifications);\n  const updateSystemSettings = useSettingsStore((s) => s.updateSystem);\n  const resetSettings = useSettingsStore((s) => s.reset);\n  const importFromJson = useSettingsStore((s) => s.importFromJson);\n  const exportToFile = useSettingsStore((s) => s.exportToFile);\n\n  const handleExportSettings = () => exportToFile();\n\n  const handleImportSettings = () => {\n    const input = document.createElement(\"input\");\n    input.type = \"file\";\n    input.accept = \"application/json\";\n    input.onchange = async () => {\n      if (!input.files?.[0]) return;\n      try {\n        const text = await input.files[0].text();\n        const json = JSON.parse(text);\n        const res = importFromJson(json);\n        if (!res.ok) {\n          toast.error(`Virhe tiedostossa: ${res.error}`);\n          return;\n        }\n        toast.success(\"Asetukset tuotu\");\n      } catch {\n        toast.error(\"Tiedoston luku epäonnistui\");\n      }\n    };\n    input.click();\n  };\n\n  const handleResetSettings = () => {\n    resetSettings();\n    toast.success(\"Asetukset palautettu oletuksiin\");\n  };\n\n  return (\n    <Popover open={isOpen} onOpenChange={setIsOpen}>\n      <PopoverTrigger asChild>\n        <div\n          className=\"inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-9 w-9 cursor-pointer\"\n          onClick={() => setIsOpen(!isOpen)}\n          aria-label=\"Asetukset\"\n        >\n          <SettingsIcon className=\"w-4 h-4\" />\n        </div>\n      </PopoverTrigger>\n\n      <PopoverContent className=\"w-[680px] p-0\" align=\"end\" sideOffset={5}>\n        {/* Header */}\n        <div className=\"p-4 border-b border-border\">\n          <div className=\"flex items-center justify-between\">\n            <h3 className=\"font-medium\">Asetukset</h3>\n            <div className=\"flex items-center gap-2\">\n              <Button variant=\"ghost\" size=\"sm\" onClick={handleExportSettings} className=\"h-6 px-2 text-xs\">\n                <Download className=\"w-3 h-3 mr-1\" /> Vie\n              </Button>\n              <Button variant=\"ghost\" size=\"sm\" onClick={handleImportSettings} className=\"h-6 px-2 text-xs\">\n                <Upload className=\"w-3 h-3 mr-1\" /> Tuo\n              </Button>\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={handleResetSettings}\n                className=\"h-6 px-2 text-xs text-destructive hover:text-destructive\"\n              >\n                <RotateCcw className=\"w-3 h-3 mr-1\" /> Palauta\n              </Button>\n            </div>\n          </div>\n        </div>\n\n        {/* Body */}\n        <ScrollArea className=\"max-h-[600px]\">\n          <Tabs defaultValue=\"general\" className=\"w-full\">\n            <TabsList className=\"grid w-full grid-cols-5 p-1 m-2\">\n              <TabsTrigger value=\"general\" className=\"text-xs\">\n                <Paintbrush className=\"w-3 h-3 mr-1\" /> Yleiset\n              </TabsTrigger>\n              <TabsTrigger value=\"auto-generation\" className=\"text-xs\">\n                <Zap className=\"w-3 h-3 mr-1\" /> Auto-gen\n              </TabsTrigger>\n              <TabsTrigger value=\"export\" className=\"text-xs\">\n                <FileSpreadsheet className=\"w-3 h-3 mr-1\" /> Vienti\n              </TabsTrigger>\n              <TabsTrigger value=\"notifications\" className=\"text-xs\">\n                <Bell className=\"w-3 h-3 mr-1\" /> Ilmoitukset\n              </TabsTrigger>\n              <TabsTrigger value=\"system\" className=\"text-xs\">\n                <Shield className=\"w-3 h-3 mr-1\" /> Järjestelmä\n              </TabsTrigger>\n            </TabsList>\n\n            {/* Yleiset */}\n            <TabsContent value=\"general\" className=\"p-4 space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label className=\"text-sm font-medium\">Teema</Label>\n                   <Select\n                 value={settings.general.theme}\n                 onValueChange={(v: Theme) => {\n                  updateGeneralSettings(\"theme\", v);\n                  applyTheme(v);\n                  }}\n                 >\n\n                    <SelectTrigger className=\"h-8\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"light\"><div className=\"flex items-center gap-2\"><Sun className=\"w-3 h-3\" />Vaalea</div></SelectItem>\n                      <SelectItem value=\"dark\"><div className=\"flex items-center gap-2\"><Moon className=\"w-3 h-3\" />Tumma</div></SelectItem>\n                      <SelectItem value=\"system\"><div className=\"flex items-center gap-2\"><Monitor className=\"w-3 h-3\" />Järjestelmä</div></SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label className=\"text-sm font-medium\">Kieli</Label>\n                  <Select\n                    value={settings.general.language}\n                    onValueChange={(v: Language) => updateGeneralSettings(\"language\", v)}\n                  >\n                    <SelectTrigger className=\"h-8\"><SelectValue /></SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"fi\"><div className=\"flex items-center gap-2\"><Globe className=\"w-3 h-3\" />Suomi</div></SelectItem>\n                      <SelectItem value=\"en\"><div className=\"flex items-center gap-2\"><Globe className=\"w-3 h-3\" />English</div></SelectItem>\n                      <SelectItem value=\"sv\"><div className=\"flex items-center gap-2\"><Globe className=\"w-3 h-3\" />Svenska</div></SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label className=\"text-sm font-medium\">Viikon alkupäivä</Label>\n                  <Select\n                    value={settings.general.weekStartDay}\n                    onValueChange={(v: WeekStartDay) => updateGeneralSettings(\"weekStartDay\", v)}\n                  >\n                    <SelectTrigger className=\"h-8\"><SelectValue /></SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"monday\">Maanantai</SelectItem>\n                      <SelectItem value=\"sunday\">Sunnuntai</SelectItem>\n                    </SelectContent>\n                  </Select>\n\n                </div>\n              {/* Coming soon */}\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label className=\"text-sm font-medium\">Päivämäärämuoto</Label>\n                  <Select\n                    value={settings.general.dateFormat}\n                    onValueChange={(v: DateFormat) => updateGeneralSettings(\"dateFormat\", v)}\n                  >\n                    <SelectTrigger className=\"h-8\"><SelectValue /></SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"dd.mm.yyyy\">PP.KK.VVVV</SelectItem>\n                      <SelectItem value=\"mm/dd/yyyy\">KK/PP/VVVV</SelectItem>\n                      <SelectItem value=\"yyyy-mm-dd\">VVVV-KK-PP</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n            {/* Oletusaikajakso poistettu MVP:stä */}\n              </div>\n\n\n            </TabsContent>\n\n            {/* Auto-gen */}\n            <TabsContent value=\"auto-generation\" className=\"p-4 space-y-4\">\n              <div className=\"space-y-2\">\n                <Label className=\"text-sm font-medium\">\n                  Oletuskesto: {formatMinutes(settings.autoGeneration.defaultMinutes)}\n                </Label>\n                <Slider\n                  value={[settings.autoGeneration.defaultMinutes]}\n                  onValueChange={([v]) => updateAutoGenerationSettings(\"defaultMinutes\", v)}\n                  min={1}\n                  max={720}\n                  step={15}\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  Automaattisesti luodut vuorot käyttävät tätä oletuskestoa (minuutteina)\n                </p>\n              </div>\n\n              <Separator />\n\n              {([\n                [\"Jaa vuorot tasaisesti\", \"Jakaa vuorot mahdollisimman tasaisesti\", \"distributeEvenly\"],\n                [\"Noudata työaikoja\", \"Luo vuoroja vain työaikojen sisällä\", \"respectWorkingHours\"],\n                [\"Ohita viikonloput\", \"Älä luo vuoroja lauantaille ja sunnuntaille\", \"skipWeekends\"],\n                [\"Ohita pyhäpäivät\", \"Älä luo vuoroja merkityille pyhäpäiville\", \"skipHolidays\"],\n              ] as const).map(([title, subtitle, key]) => (\n                <div className=\"flex items-center justify-between\" key={key}>\n                  <div>\n                    <Label className=\"text-sm font-medium\">{title}</Label>\n                    <p className=\"text-xs text-muted-foreground\">{subtitle}</p>\n                  </div>\n                  <Switch\n                    checked={settings.autoGeneration[key]}\n                    onCheckedChange={(c) => updateAutoGenerationSettings(key, c)}\n                  />\n                </div>\n              ))}\n\n            </TabsContent>\n\n            {/* Vienti */}\n            <TabsContent value=\"export\" className=\"p-4 space-y-4\">\n              <div className=\"space-y-2\">\n                <Label className=\"text-sm font-medium\">Yrityksen nimi</Label>\n                <Input\n                  value={settings.export.companyName}\n                  onChange={(e) => updateExportSettings(\"companyName\", e.target.value)}\n                  placeholder=\"Yritys Oy\"\n                  className=\"h-8\"\n                />\n              </div>\n\n              <Separator />\n\n              <div className=\"space-y-2\">\n                <Label className=\"text-sm font-medium\">Sisällytä Excel-vientiin</Label>\n                {([\n                  [\"Työntekijöiden nimet\", \"includeNames\"],\n                  [\"Sähköpostiosoitteet\", \"includeEmails\"],\n                  [\"Osastotiedot\", \"includeDepartments\"],\n                  [\"Ei-aktiiviset työntekijät\", \"includeInactiveEmployees\"],\n                  [\"Tyhjät vuorot\", \"includeEmptyShifts\"],\n                  [\"Tuntisummat\", \"includeHourTotals\"],\n                ] as const).map(([label, key]) => (\n                  <div className=\"flex items-center justify-between\" key={key}>\n                    <Label className=\"text-sm\">{label}</Label>\n                    <Switch\n                      checked={settings.export[key]}\n                      onCheckedChange={(c) => updateExportSettings(key, c)}\n                    />\n                  </div>\n                ))}\n              </div>\n            </TabsContent>\n\n            {/* Ilmoitukset */}\n            <TabsContent value=\"notifications\" className=\"p-4 space-y-4\">\n              <div className=\"space-y-3\">\n                <div className=\"flex items-center justify-between\">\n                  <Label className=\"text-sm font-medium\">Sähköposti-ilmoitukset</Label>\n                  <Switch\n                    checked={settings.notifications.emailNotifications}\n                    onCheckedChange={(c) => updateNotificationSettings(\"emailNotifications\", c)}\n                  />\n                </div>\n                <div className=\"space-y-2 pl-1\">\n                  <Label className=\"text-sm font-medium\">Admin-sähköpostit</Label>\n                  <Input\n                    placeholder=\"esim. admin@firma.fi, toinen@firma.fi\"\n                    value={(settings.notifications.adminNotificationEmails ?? []).join(\", \")}\n                    onChange={(e) => {\n                      const emails = e.currentTarget.value\n                        .split(\",\")\n                        .map((s) => s.trim())\n                        .filter(Boolean);\n                      updateNotificationSettings(\"adminNotificationEmails\", emails);\n                    }}\n                    className=\"h-8\"\n                  />\n                  {(!settings.notifications.adminNotificationEmails ||\n                    settings.notifications.adminNotificationEmails.length === 0) && (\n                    <p className=\"text-xs text-amber-600\">\n                      Vinkki: lisää vähintään yksi osoite, muuten ilmoitusta ei lähetetä.\n                    </p>\n                  )}\n                </div>\n              </div>\n              <Separator />\n\n\n\n              <div className=\"space-y-2\">\n                <Label className=\"text-sm font-medium\">Ilmoitussisältö</Label>\n                {([\n                  [\"Poissaolopyynnöt\", \"absenceRequests\"],\n                  [\"Vuoromuutokset\", \"scheduleChanges\"],\n                  [\"Työntekijämuutokset\", \"employeeUpdates\"],\n                  [\"Järjestelmäpäivitykset\", \"systemUpdates\"],\n                ] as const).map(([label, key]) => (\n                  <div className=\"flex items-center justify-between\" key={key}>\n                    <Label className=\"text-sm\">{label}</Label>\n                    <Switch\n                      checked={settings.notifications[key]}\n                      onCheckedChange={(c) => updateNotificationSettings(key, c)}\n                    />\n                  </div>\n                ))}\n              </div>\n\n              <Separator />\n\n              <div className=\"space-y-3\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <Label className=\"text-sm font-medium\">Päivittäinen yhteenveto</Label>\n                    <p className=\"text-xs text-muted-foreground\">Lähetä päivittäin yhteenveto</p>\n                  </div>\n                  <Switch\n                    checked={settings.notifications.dailyDigest}\n                    onCheckedChange={(c) => updateNotificationSettings(\"dailyDigest\", c)}\n                  />\n                </div>\n\n                {settings.notifications.dailyDigest && (\n                  <div className=\"space-y-2\">\n                    <Label className=\"text-sm\">Lähetysaika</Label>\n                    <Input\n                      type=\"time\"\n                      value={settings.notifications.digestTime}\n                      onChange={(e) => updateNotificationSettings(\"digestTime\", e.target.value)}\n                      className=\"h-8 w-32\"\n                    />\n                  </div>\n                )}\n              </div>\n            </TabsContent>\n\n            {/* Järjestelmä */}\n            <TabsContent value=\"system\" className=\"p-4 space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">Versio:</span>\n                  <span>{settings.system.version}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">Viimeisin varmuuskopio:</span>\n                  <span>{settings.system.lastBackup || \"Ei koskaan\"}</span>\n                </div>\n              </div>\n\n              <Separator />\n\n              {([\n                [\"Huoltotila\", \"Estä muiden käyttäjien pääsy\", \"maintenanceMode\"],\n                [\"Debug-tila\", \"Näytä kehittäjätiedot\", \"debugMode\"],\n              ] as const).map(([title, sub, key]) => (\n                <div className=\"flex items-center justify-between\" key={key}>\n                  <div>\n                    <Label className=\"text-sm font-medium\">{title}</Label>\n                    <p className=\"text-xs text-muted-foreground\">{sub}</p>\n                  </div>\n                  <Switch\n                    checked={settings.system[key]}\n                    onCheckedChange={(c) => updateSystemSettings(key, c)}\n                  />\n                </div>\n              ))}\n\n              <Separator />\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label className=\"text-sm font-medium\">Max työntekijöitä</Label>\n                  <Input\n                    type=\"number\"\n                    min={1}\n                    max={1000}\n                    value={settings.system.maxEmployees}\n                    onChange={(e) => updateSystemSettings(\"maxEmployees\", Number(e.target.value) || 100)}\n                    className=\"h-8\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label className=\"text-sm font-medium\">Datan säilytysaika (pv)</Label>\n                  <Input\n                    type=\"number\"\n                    min={30}\n                    max={3650}\n                    value={settings.system.dataRetentionDays}\n                    onChange={(e) => updateSystemSettings(\"dataRetentionDays\", Number(e.target.value) || 365)}\n                    className=\"h-8\"\n                  />\n                </div>\n              </div>\n\n              <Separator />\n\n              <div className=\"grid grid-cols-2 gap-2\">\n                <Button variant=\"outline\" size=\"sm\" className=\"justify-start\">\n                  <HardDrive className=\"w-3 h-3 mr-2\" /> Luo varmuuskopio\n                </Button>\n                <Button variant=\"outline\" size=\"sm\" className=\"justify-start\">\n                  <Database className=\"w-3 h-3 mr-2\" /> Puhdista välimuisti\n                </Button>\n                <Button variant=\"outline\" size=\"sm\" className=\"justify-start\">\n                  <Download className=\"w-3 h-3 mr-2\" /> Lataa lokit\n                </Button>\n                <Button variant=\"outline\" size=\"sm\" className=\"justify-start text-destructive hover:text-destructive\">\n                  <Trash2 className=\"w-3 h-3 mr-2\" /> Tyhjennä data\n                </Button>\n              </div>\n            </TabsContent>\n          </Tabs>\n        </ScrollArea>\n\n{/* Footer */}\n<div className=\"p-4 border-t border-border\">\n  <div className=\"flex justify-between items-center\">\n    <p className=\"text-xs text-muted-foreground\">\n      Asetukset tallennetaan automaattisesti\n    </p>\n    <Button\n      size=\"sm\"\n      onClick={async () => {\n        try {\n          await saveNotificationSettingsToDb(\n            useSettingsStore.getState().settings.notifications\n          );\n          toast.success(\"Asetukset tallennettu\");\n        } catch (e: unknown) {\n          const msg = e instanceof Error ? e.message : String(e);\n          console.error(\"[app_settings upsert failed]\", msg);\n          toast.error(`Asetusten tallennus DB:hen epäonnistui: ${msg}`);\n        } finally {\n          setIsOpen(false);\n        }\n      }}\n    >\n      Valmis\n    </Button>\n  </div>\n</div>\n      </PopoverContent>\n    </Popover>\n  );\n}\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 472
        }
      ]
    },
    {
      "path": "src/app/components/ShiftChangeRequestForm.tsx",
      "size": 15128,
      "sha256": "71dc2c29463fa5bb03f1fbc23f65e6902c4fcd13390db9a12461540653e7d13e",
      "lang": "tsx",
      "lines": 389,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/ShiftChangeRequestForm.tsx",
      "chunks": [
        {
          "i": 0,
          "text": "\"use client\";\n\nimport React, { useState } from 'react';\nimport { Card, CardContent, CardHeader, CardTitle } from './ui/card';\nimport { Button } from './ui/button';\nimport { Input } from './ui/input';\nimport { Label } from './ui/label';\nimport { Textarea } from './ui/textarea';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from './ui/select';\nimport { Badge } from './ui/badge';\nimport { ArrowLeftRight, Clock, Send, AlertCircle, User } from 'lucide-react';\nimport { Employee, ShiftChangeRequest, ShiftType } from '../types';\nimport { toast } from 'sonner';\n\ninterface ShiftChangeRequestFormProps {\n  currentEmployee: Employee;\n  allEmployees: Employee[];\n    onSubmit: (\n    request: Omit<\n      ShiftChangeRequest,\n      \"id\" | \"employeeId\" | \"submittedAt\" | \"status\"\n    >\n  ) => void;\n}\n\nconst ShiftChangeRequestForm: React.FC<ShiftChangeRequestFormProps> = ({ \n  currentEmployee, \n  allEmployees, \n  onSubmit \n}) => {\n  const [formData, setFormData] = useState({\n    currentDate: '',\n    requestedDate: '',\n    requestedHours: '',\n    requestType: 'change', // 'change' or 'swap'\n    targetEmployeeId: '',\n    reason: '',\n    message: ''\n  });\n\n  const [errors, setErrors] = useState<Record<string, string>>({});\n\n  // Get current employee's shifts for the selected date\n  const getCurrentShift = (date: string): ShiftType | null => {\n    if (!date) return null;\n    \n    // This is a simplified calculation - in real app you'd properly calculate the shift for the date\n    const today = new Date();\n    const selectedDate = new Date(date);\n    const dayDiff = Math.floor((selectedDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));\n    \n    if (dayDiff >= 0 && dayDiff < currentEmployee.shifts.length) {\n      return currentEmployee.shifts[dayDiff];\n    }\n    \n    return null;\n  };\n\n  const currentShift = getCurrentShift(formData.currentDate);\n\n  const validateForm = () => {\n    const newErrors: Record<string, string> = {};\n\n    if (!formData.currentDate) {\n      newErrors.currentDate = 'Nykyinen päivämäärä on pakollinen';\n    }\n\n    if (!formData.requestedDate) {\n      newErrors.requestedDate = 'Haluttu päivämäärä on pakollinen';\n    }\n\n    if (formData.currentDate && formData.requestedDate) {\n      if (formData.currentDate === formData.requestedDate) {\n        newErrors.requestedDate = 'Haluttu päivämäärä ei voi olla sama kuin nykyinen';\n      }\n\n      const current = new Date(formData.currentDate);\n      if (current < new Date()) {\n        newErrors.currentDate = 'Nykyinen päivämäärä ei voi olla menneisyydessä';\n      }\n    }\n\n    if (!currentShift || currentShift.type === 'empty') {\n      newErrors.currentDate = 'Valitulla päivämäärällä ei ole vuoroa vaihdettavaksi';\n    }\n\n    if (formData.requestType === 'change' && !formData.requestedHours) {\n      newErrors.requestedHours = 'Anna haluttu tuntimäärä';\n    }\n\n    if (formData.requestType === 'swap' && !formData.targetEmployeeId) {\n      newErrors.targetEmployeeId = 'Valitse työntekijä jonka kanssa vaihtaa';\n    }\n\n    if (!formData.reason) {\n      newErrors.reason = 'Syy on pakollinen';\n    }\n\n    setErrors(newErrors);\n    return Object.keys(newErrors).length === 0;\n  };\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!validateForm()) {\n      toast.error('Tarkista lomakkeen tiedot');\n      return;\n    }\n\n    if (!currentShift) {\n      toast.error('Virhe vuoron hakemisessa');\n      return;\n    }\n\n    let requestedShift: ShiftType | undefined = undefined;\n    let targetEmployeeId: string | undefined = undefined;\n    let targetEmployeeName: string | undefined = undefined;\n\n    if (formData.requestType === 'change') {\n      requestedShift = {\n        type: 'normal',\n        hours: parseFloat(formData.requestedHours)\n      };\n    } else if (formData.requestType === 'swap') {\n      targetEmployeeId = formData.targetEmployeeId;\n      const targetEmployee = allEmployees.find(emp => emp.id === formData.targetEmployeeId);\n      targetEmployeeName = targetEmployee?.name;\n      // In a swap, the requested shift would be what the target employee has on the requested date\n      requestedShift = { type: 'normal', hours: currentShift.hours }; // Simplified\n    }\n\n    onSubmit({\n      currentDate: formData.currentDate,\n      requestedDate: formData.requestedDate,\n      currentShift,\n      requestedShift,\n      reason: formData.reason,\n      message: formData.message || undefined,\n      targetEmployeeId,\n      targetEmployeeName,\n      employeeName: currentEmployee.name\n    });\n\n    // Reset form\n    setFormData({\n      currentDate: '',\n      requestedDate: '',\n      requestedHours: '',\n      requestType: 'change',\n      targetEmployeeId: '',\n      reason: '',\n      message: ''\n    });\n\n    setErrors({});\n    toast.success('Vuoronvaihtopyyntö lähetetty onnistuneesti!');\n  };\n\n  const reasonOptions = [\n    'Henkilökohtainen asia',\n    'Lääkäriaika',\n    'Perhesyy',\n    'Opiskelut',\n    'Toinen työsuhde',\n    'Kuljetuksellinen syy',\n    'Muu syy'\n  ];\n\n  const otherEmployees = allEmployees.filter(emp => emp.id !== currentEmployee.id && emp.isActive);\n\n  return (\n    <Card className=\"shadow-lg border-0 bg-gradient-to-r from-background to-secondary/20\">\n      <CardHeader className=\"pb-4\">\n        <div className=\"flex items-center space-x-3\">\n          <ArrowLeftRight className=\"w-6 h-6 text-primary\" />\n          <CardTitle className=\"text-xl text-primary\">Vuoronvaihtopyyntö</CardTitle>\n        </div>\n      </CardHeader>\n      <CardContent>\n        <form onSubmit={handleSubmit} className=\"space-y-4\">\n          {/* Request Type Selection */}\n          <div className=\"space-y-3\">\n            <Label>Pyynnön tyyppi</Label>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n              <div\n                className={`\n                  p-3 border-2 rounded-lg cursor-pointer transition-all\n                  ${formData.requestType === 'change' ? 'border-primary bg-primary/5' : 'border-border hover:border-accent-foreground'}\n                `}\n                onClick={() => setFormData(prev => ({ ...prev, requestType: 'change', targetEmployeeId: '' }))}\n              >\n                <div className=\"flex items-center gap-2 mb-2\">\n                  <Clock className=\"w-4 h-4 text-primary\" />\n                  <span className=\"font-medium\">Vuoron muutos</span>\n                </div>\n                <p className=\"text-sm text-muted-foreground\">Muuta oman vuorosi tuntimäärää tai ajankohtaa</p>\n              </div>\n              \n              <div\n                className={`\n                  p-3 border-2 rounded-lg cursor-pointer transition-all\n                  ${formData.requestType === 'swap' ? 'border-primary bg-primary/5' : 'border-border hover:border-accent-foreground'}\n                `}\n                onClick={() => setFormData(prev => ({ ...prev, requestType: 'swap', requestedHours: '' }))}\n              >\n                <div className=\"flex items-center gap-2 mb-2\">\n                  <User className=\"w-4 h-4 text-primary\" />\n                  <span className=\"font-medium\">Vuoron vaihto</span>\n                </div>\n                <p className=\"text-sm text-muted-foreground\">Vaihda vuoro toisen työntekijän kanssa</p>\n              </div>\n            </div>\n          </div>\n\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"currentDate\">Nykyinen vuoro *</Label>\n              <Input\n                id=\"currentDate\"\n                type=\"date\"\n                value={formData.currentDate}\n                onChange={(e) => setFormData(prev => ({ ...prev, currentDate: e.target.value }))}\n                className={errors.currentDate ? 'border-destructive' : ''}\n                min={new Date().toISOString().split('T')[0]}\n              />\n              {errors.currentDate && (\n                <div className=\"flex items-center gap-1 text-sm text-destructive\">\n                  <AlertCircle className=\"w-4 h-4\" />\n                  {errors.currentDate}\n                </div>\n              )}\n              {currentShift && currentShift.type !== 'empty' && (\n                <div className=\"text-sm text-muted-foreground bg-accent/50 p-2 rounded\">\n                  <Clock className=\"w-4 h-4 inline mr-2\" />\n                  Nykyinen vuoro: {currentShift.hours}h\n                </div>\n              )}\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"requestedDate\">Haluttu päivämäärä *</Label>\n              <Input\n                id=\"requestedDate\"\n                type=\"date\"\n                value={formData.requestedDate}\n                onChange={(e) => setFormData(prev => ({ ...prev, requestedDate: e.target.value }))}\n                className={errors.requestedDate ? 'border-destructive' : ''}\n                min={new Date().toISOString().split('T')[0]}\n              />\n              {errors.requestedDate && (\n                <div className=\"flex items-center gap-1 text-sm text-destructive\">\n                  <AlertCircle className=\"w-4 h-4\" />\n                  {errors.requestedDate}\n                </div>\n              )}\n            </div>\n          </div>\n\n          {/* Change-specific fields */}\n          {formData.requestType === 'change' && (\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"requestedHours\">Haluttu tuntimäärä *</Label>\n              <Select \n                value={formData.requestedHours} \n                onValueChange={(value) => setFormData(prev => ({ ...prev, requestedHours: value }))}\n              >\n                <SelectTrigger className={errors.requestedHours ? 'border-destructive' : ''}>\n                  <SelectValue placeholder=\"Valitse tuntimäärä\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"0\">0h (Vapaapäivä)</SelectItem>\n                  <SelectItem value=\"4\">4h</SelectItem>\n                  <SelectItem value=\"6\">6h</SelectItem>\n                  <SelectItem value=\"7.5\">7.5h</SelectItem>\n                  <SelectItem value=\"8\">8h</SelectItem>\n                  <SelectItem value=\"10\">10h</SelectItem>\n                  <SelectItem value=\"12\">12h</SelectItem>\n                </SelectContent>\n              </Select>\n              {errors.requestedHours && (\n                <div className=\"flex items-center gap-1 text-sm text-destructive\">\n                  <AlertCircle className=\"w-4 h-4\" />\n                  {errors.requestedHours}\n                </div>\n              )}\n            </div>\n          )}\n\n          {/* Swap-specific fields */}\n          {formData.requestType === 'swap' && (\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"targetEmployee\">Vaihda työntekijän kanssa *</Label>\n              <Select \n                value={formData.targetEmployeeId} \n                onValueChange={(value) => setFormData(prev => ({ ...prev, targetEmployeeId: value }))}\n              >\n                <SelectTrigger className={errors.targetEmployeeId ? 'border-destructive' : ''}>\n                  <SelectValue placeholder=\"Valitse työntekijä\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {otherEmployees.map((employee) => (\n                    <SelectItem key={employee.id} value={employee.id}>\n                      <div className=\"flex items-center gap-2\">\n                        <span>{employee.name}</span>\n                        <Badge variant=\"outline\" className=\"text-xs\">{employee.department}</Badge>\n                      </div>\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n              {errors.targetEmployeeId && (\n                <div className=\"flex items-center gap-1 text-sm text-destructive\">\n                  <AlertCircle className=\"w-4 h-4\" />\n                  {errors.targetEmployeeId}\n                </div>\n              )}\n              {formData.targetEmployeeId && (\n                <div className=\"text-sm text-muted-foreground bg-blue-50 p-2 rounded border border-blue-200\">\n                  <ArrowLeftRight className=\"w-4 h-4 inline mr-2 text-blue-600\" />\n                  Pyydät vaihtamaan vuoroasi {allEmployees.find(emp => emp.id === formData.targetEmployeeId)?.name} kanssa\n                </div>\n              )}\n            </div>\n          )}\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"reason\">Syy *</Label>\n            <Select value={formData.reason} onValueChange={(value) => setFormData(prev => ({ ...prev, reason: value }))}>\n              <SelectTrigger className={errors.reason ? 'border-destructive' : ''}>\n                <SelectValue placeholder=\"Valitse syy vuoronvaihdolle\" />\n              </SelectTrigger>\n              <SelectContent>\n                {reasonOptions.map((reason) => (\n                  <SelectItem key={reason} value={reason}>{reason}</SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n            {errors.reason && (\n              <div className=\"flex items-center gap-1 text-sm text-destructive\">\n                <AlertCircle className=\"w-4 h-4\" />\n                {errors.reason}\n              </div>\n            )}\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"message\">Lisätiedot (valinnainen)</Label>\n            <Textarea\n              id=\"message\"\n              placeholder=\"Kerro tarkemmat tiedot vuoronvaihdosta...\"\n              value={formData.message}\n              onChange={(e) => setFormData(prev => ({ ...prev, message: e.target.value }))}\n              className=\"min-h-[100px]\"\n            />\n          </div>\n\n          <div className=\"bg-amber-50 border border-amber-200 rounded-lg p-3\">\n            <div className=\"flex items-start gap-2 text-amber-800\">\n              <AlertCircle className=\"w-4 h-4 mt-0.5 flex-shrink-0\" />\n              <div className=\"text-sm\">\n                <p className=\"font-medium mb-1\">Huomioitavaa:</p>\n                <ul className=\"list-disc list-inside space-y-1 text-xs\">\n                  <li>Vuoronvaihtopyynnöt tulee jättää hyvissä ajoin</li>\n                  <li>Esimies hyväksyy tai hylkää pyynnön</li>\n                  {formData.requestType === 'swap' && (\n                    <li>Toisen työntekijän tulee myös hyväksyä vaihto</li>\n                  )}\n                  <li>Muista tarkistaa ettei vuoronvaihto aiheuta ylitöitä</li>\n                </ul>\n              </div>\n            </div>\n          </div>\n\n          <Button \n            type=\"submit\" \n            className=\"w-full\" \n            disabled={!formData.currentDate || !formData.requestedDate || !formData.reason || (!currentShift || currentShift.type === 'empty')}\n          >\n            <Send className=\"w-4 h-4 mr-2\" />\n            Lähetä vuoronvaihtopyyntö\n          </Button>\n        </form>\n      </CardContent>\n    </Card>\n  );\n};\n\nexport default ShiftChangeRequestForm;",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 389
        }
      ]
    },
    {
      "path": "src/app/components/TimeOffRequestForm.tsx",
      "size": 8530,
      "sha256": "3e5302741270add2463664255d34f88fc2921e6d0747bc2cd89550650f97a46f",
      "lang": "tsx",
      "lines": 246,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/TimeOffRequestForm.tsx",
      "chunks": [
        {
          "i": 0,
          "text": "\"use client\";\n\nimport React, { useState } from 'react';\nimport { Card, CardContent, CardHeader, CardTitle } from './ui/card';\nimport { Button } from './ui/button';\nimport { Input } from './ui/input';\nimport { Label } from './ui/label';\nimport { Textarea } from './ui/textarea';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from './ui/select';\nimport { Calendar, Clock, Send, AlertCircle } from 'lucide-react';\nimport { EmployeeTimeOffRequest } from '../types';\nimport { toast } from 'sonner';\nimport { supabase } from \"@/lib/supaBaseClient\";\n\n\nconst TimeOffRequestForm: React.FC = () => {\n  const [formData, setFormData] = useState({\n    startDate: '',\n    endDate: '',\n    reason: '',\n    message: ''\n  });\n\n  const [errors, setErrors] = useState<Record<string, string>>({});\n\n  const reasonOptions = [\n    'Henkilökohtainen asia',\n    'Sairausloma',\n    'Lääkäriaika',\n    'Vuosiloma',\n    'Vanhempainvapaa',\n    'Perhevapaa',\n    'Opintovapaa',\n    'Muu syy'\n  ];\n\n  const validateForm = () => {\n    const newErrors: Record<string, string> = {};\n\n    if (!formData.startDate) {\n      newErrors.startDate = 'Alkupäivämäärä on pakollinen';\n    }\n\n    if (!formData.endDate) {\n      newErrors.endDate = 'Loppupäivämäärä on pakollinen';\n    }\n\n    if (formData.startDate && formData.endDate) {\n      const start = new Date(formData.startDate);\n      const end = new Date(formData.endDate);\n      \n      if (start > end) {\n        newErrors.endDate = 'Loppupäivämäärä ei voi olla ennen alkupäivämäärää';\n      }\n\n      if (start < new Date()) {\n        newErrors.startDate = 'Alkupäivämäärä ei voi olla menneisyydessä';\n      }\n    }\n\n    if (!formData.reason) {\n      newErrors.reason = 'Syy on pakollinen';\n    }\n\n    setErrors(newErrors);\n    return Object.keys(newErrors).length === 0;\n  };\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n\n    if (!validateForm()) {\n      toast.error('Tarkista lomakkeen tiedot');\n      return;\n    }\n\n    try {\n      const { data: { session } } = await supabase.auth.getSession();\n      if (!session) {\n        toast.error(\"Et ole kirjautunut sisään\");\n        return;\n      }\n\n      const res = await fetch(\"/api/timeoff\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          \"Authorization\": `Bearer ${session.access_token}`,\n        },\n        body: JSON.stringify({\n          startDate: formData.startDate,\n          endDate: formData.endDate,\n          reason: formData.reason,\n          message: formData.message || undefined,\n        }),\n      });\n\n     const json = await res.json();\n      if (!res.ok) throw new Error(json.error || \"Virhe tallennuksessa\");\n\n      toast.success(\"Poissaolopyyntö lähetetty onnistuneesti!\");\n      setFormData({ startDate: \"\", endDate: \"\", reason: \"\", message: \"\" });\n      setErrors({});\n    } catch (err: any) {\n      toast.error(err.message || \"Virhe poissaolopyynnön lähetyksessä\");\n    }\n  };\n\n  const calculateDays = () => {\n    if (!formData.startDate || !formData.endDate) return 0;\n    \n    const start = new Date(formData.startDate);\n    const end = new Date(formData.endDate);\n    \n    if (start > end) return 0;\n    \n    const diffTime = Math.abs(end.getTime() - start.getTime());\n    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;\n    \n    return diffDays;\n  };\n\n  const dayCount = calculateDays();\n\n  return (\n    <Card className=\"shadow-lg border-0 bg-gradient-to-r from-background to-secondary/20\">\n      <CardHeader className=\"pb-4\">\n        <div className=\"flex items-center space-x-3\">\n          <Calendar className=\"w-6 h-6 text-primary\" />\n          <CardTitle className=\"text-xl text-primary\">Uusi poissaolopyyntö</CardTitle>\n        </div>\n      </CardHeader>\n      <CardContent>\n        <form onSubmit={handleSubmit} className=\"space-y-4\">\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"startDate\">Alkupäivämäärä *</Label>\n              <Input\n                id=\"startDate\"\n                type=\"date\"\n                value={formData.startDate}\n                onChange={(e) => setFormData(prev => ({ ...prev, startDate: e.target.value }))}\n                className={errors.startDate ? 'border-destructive' : ''}\n                min={new Date().toISOString().split('T')[0]}\n              />\n              {errors.startDate && (\n                <div className=\"flex items-center gap-1 text-sm text-destructive\">\n                  <AlertCircle className=\"w-4 h-4\" />\n                  {errors.startDate}\n                </div>\n              )}\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"endDate\">Loppupäivämäärä *</Label>\n              <Input\n                id=\"endDate\"\n                type=\"date\"\n                value={formData.endDate}\n                onChange={(e) => setFormData(prev => ({ ...prev, endDate: e.target.value }))}\n                className={errors.endDate ? 'border-destructive' : ''}\n                min={formData.startDate || new Date().toISOString().split('T')[0]}\n              />\n              {errors.endDate && (\n                <div className=\"flex items-center gap-1 text-sm text-destructive\">\n                  <AlertCircle className=\"w-4 h-4\" />\n                  {errors.endDate}\n                </div>\n              )}\n            </div>\n          </div>\n\n          {dayCount > 0 && (\n            <div className=\"bg-blue-50 border border-blue-200 rounded-lg p-3\">\n              <div className=\"flex items-center gap-2 text-blue-700\">\n                <Clock className=\"w-4 h-4\" />\n                <span className=\"font-medium\">\n                  Poissaolon kesto: {dayCount} {dayCount === 1 ? 'päivä' : 'päivää'}\n                </span>\n              </div>\n            </div>\n          )}\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"reason\">Syy *</Label>\n            <Select value={formData.reason} onValueChange={(value) => setFormData(prev => ({ ...prev, reason: value }))}>\n              <SelectTrigger className={errors.reason ? 'border-destructive' : ''}>\n                <SelectValue placeholder=\"Valitse poissaolon syy\" />\n              </SelectTrigger>\n              <SelectContent>\n                {reasonOptions.map((reason) => (\n                  <SelectItem key={reason} value={reason}>{reason}</SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n            {errors.reason && (\n              <div className=\"flex items-center gap-1 text-sm text-destructive\">\n                <AlertCircle className=\"w-4 h-4\" />\n                {errors.reason}\n              </div>\n            )}\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"message\">Lisätiedot (valinnainen)</Label>\n            <Textarea\n              id=\"message\"\n              placeholder=\"Kerro tarkemmat tiedot poissaolosta...\"\n              value={formData.message}\n              onChange={(e) => setFormData(prev => ({ ...prev, message: e.target.value }))}\n              className=\"min-h-[100px]\"\n            />\n            <div className=\"text-xs text-muted-foreground\">\n              Voit antaa lisätietoja poissaolosta, esimerkiksi lääkärintodistuksesta tai kiireellisyydestä.\n            </div>\n          </div>\n\n          <div className=\"bg-amber-50 border border-amber-200 rounded-lg p-3\">\n            <div className=\"flex items-start gap-2 text-amber-800\">\n              <AlertCircle className=\"w-4 h-4 mt-0.5 flex-shrink-0\" />\n              <div className=\"text-sm\">\n                <p className=\"font-medium mb-1\">Muista:</p>\n                <ul className=\"list-disc list-inside space-y-1 text-xs\">\n                  <li>Pyyntö tulee jättää mahdollisimman aikaisin</li>\n                  <li>Sairauspoissaoloista tarvitaan lääkärintodistus yli 3 päivän poissaoloissa</li>\n                  <li>Esimies hyväksyy tai hylkää pyynnön</li>\n                </ul>\n              </div>\n            </div>\n          </div>\n\n          <Button \n            type=\"submit\" \n            className=\"w-full\" \n            disabled={!formData.startDate || !formData.endDate || !formData.reason}\n          >\n            <Send className=\"w-4 h-4 mr-2\" />\n            Lähetä poissaolopyyntö\n          </Button>\n        </form>\n      </CardContent>\n    </Card>\n  );\n};\n\nexport default TimeOffRequestForm;",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 246
        }
      ]
    },
    {
      "path": "src/app/components/Toolbar.tsx",
      "size": 32726,
      "sha256": "257368dea495a3ef494a0c92d8a9dbadaf7b4d284cede350ebee43f700486b41",
      "lang": "tsx",
      "lines": 957,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/Toolbar.tsx",
      "chunks": [
        {
          "i": 0,
          "text": "\"use client\";\n\nimport { useScheduleStore } from \"@/store/useScheduleStore\";\nimport React, { useMemo, useRef, useState, useEffect } from \"react\";\nimport { Button } from \"./ui/button\";\nimport { Card, CardContent } from \"./ui/card\";\nimport { Checkbox } from \"./ui/checkbox\";\nimport { Badge } from \"./ui/badge\";\nimport { Separator } from \"./ui/separator\";\nimport NotificationsPopover from \"./ui/NotificationsPopover\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"./ui/popover\";\nimport SettingsDialog from \"./SettingsDialog\";\nimport { useSettingsStore } from \"@/store/useSettingsStore\";\nimport { formatMinutes } from \"@/lib/timeUtils\";\nimport {\n  Upload,\n  RefreshCw,\n  Calendar as CalIcon,\n  FileSpreadsheet,\n  FileText,\n  Wand2,\n  Undo,\n  Redo,\n  Filter,\n  Search,\n  Check,\n  ChevronDown,\n  X,\n  Building,\n  Users\n} from \"lucide-react\";\nimport { toast } from \"sonner\";\nimport { supabase } from \"@/lib/supaBaseClient\";\nimport { addDaysLocalISO } from \"@/lib/dateUtils\";\n\n\n// ——— Valikoiva, tyypitetty poiminta hashydrate-funktiolle ilman anyä ———\ntype HashydrateFn = (() => void) | undefined;\nconst selectHashydrate = <T extends object>(s: T): HashydrateFn =>\n  (s as unknown as { hashydrate?: () => void }).hashydrate;\n\n\n\n\nfunction formatTime(d = new Date()) {\n  return d.toLocaleTimeString(\"fi-FI\", { hour: \"2-digit\", minute: \"2-digit\" });\n}\n\n\n  function getISOWeek(dateIso: string) {\n  const d = new Date(dateIso + \"T00:00:00\");\n  // ISO week algorithm\n  const dayNum = (d.getUTCDay() + 6) % 7;\n  d.setUTCDate(d.getUTCDate() - dayNum + 3);\n  const firstThursday = new Date(Date.UTC(d.getUTCFullYear(), 0, 4));\n  const week =\n    1 +\n    Math.round(\n      ((d.getTime() - firstThursday.getTime()) / 86400000 - 3 + ((firstThursday.getUTCDay() + 6) % 7)) /\n        7\n    );\n  return week;\n}\n\n\ntype EmpRow = {\n  id: string;\n  name: string;\n  email: string;\n  department: string;\n  is_active: boolean;\n};\n\ntype ShiftRow = {\n  employee_id: string;\n  work_date: string;\n  type: \"normal\" | \"locked\" | \"absent\" | \"holiday\";\n  minutes: number | null;\n};\n\nconst Toolbar = () => {\n\n  const [isClient, setIsClient] = useState(false);\n  useEffect(() => { setIsClient(true); }, []);\n  \n\n  const START_ISO = useScheduleStore((s) => s.startDateISO);\n  const DAYS = useScheduleStore((s) => s.days);\n\n\n   const defaultMinutes = useSettingsStore((s) => s.settings.autoGeneration.defaultMinutes);\n   const hashydrateSettings = useSettingsStore(selectHashydrate);\n   const hashydrateSchedule = useScheduleStore(selectHashydrate);\n\n  useEffect(() => {\n    // Aja heti mountissa ja aina hashin vaihtuessa.\n    // Järjestys: ensin asetukset -> sitten aikataulu.\n    const run = () => {\n      try { hashydrateSettings?.(); } catch {}\n      try { hashydrateSchedule?.(); } catch {}\n    };\n    run();\n    window.addEventListener(\"hashchange\", run);\n    return () => window.removeEventListener(\"hashchange\", run);\n  }, [hashydrateSettings, hashydrateSchedule]);\n\n\n\n  const range = useMemo(\n  () => Array.from({ length: DAYS }, (_, i) => addDaysLocalISO(START_ISO, i)),\n  [START_ISO, DAYS]\n);\n\n\n\nconst undo = useScheduleStore((s) => s.undo);\nconst redo = useScheduleStore((s) => s.redo);\nconst canUndo = useScheduleStore((s) => s.undoStack.length > 0);\nconst canRedo = useScheduleStore((s) => s.redoStack.length > 0);\n\nconst saveAll = useScheduleStore((s) => s.saveAll);\nconst dirty = useScheduleStore((s) => s.dirty);\n\n// Julkaise vuorot\nconst handlePublish = async () => {\n  console.log(\"Klikattu Julkaise\");\n  await useScheduleStore.getState().publishShifts();\n};\n\n// Automaattinen tallennus debounce-logiikalla\nuseEffect(() => {\n  if (!dirty) return;\n  const timeout = setTimeout(() => {\n    saveAll().then(() => {\n      setLastSavedAt(formatTime());\n    });\n  }, 800); // debounce 800ms\n  return () => clearTimeout(timeout);\n}, [dirty, saveAll]);\n\n  const [isGenerating, setIsGenerating] = useState(false);\n  const [lastSavedAt, setLastSavedAt] = useState<string | null>(null);\n  const [empCount, setEmpCount] = useState<number | null>(null);\n\n  const fileInputRef = useRef<HTMLInputElement>(null);\n\n  // ————— data hakuja joita export/healthcheck/auto-gen käyttää —————\n  // Yleinen hakufunktio: includeInactive=true -> ei suodateta is_active:lla\n  async function fetchEmployees(includeInactive: boolean): Promise<EmpRow[]> {\n    let q = supabase\n      .from(\"employees\")\n      .select(\"id, name, email, department, is_active\")\n      .order(\"created_at\", { ascending: true });\n    if (!includeInactive) q = q.eq(\"is_active\", true);\n    const { data, error } = await q;\n    if (error) throw error;\n    const rows = (data ?? []) as EmpRow[];\n    setEmpCount(rows.length);\n    return rows;\n  }\n  // Säilytetään vanha signatuuri muulle koodille (auto-gen, import, PDF…)\n async function fetchActiveEmployees(): Promise<EmpRow[]> {\n    return fetchEmployees(false);\n  }\n\n  async function fetchShiftsByRange(empIds?: string[]): Promise<ShiftRow[]> {\n    const start = range[0];\n    const end = range[range.length - 1];\n    let q = supabase\n      .from(\"shifts\")\n      .select(\"employee_id, work_date, type, minutes\")\n      .gte(\"work_date\", start)\n      .lte(\"work_date\", end);\n\n    if (empIds && empIds.length) q = q.in(\"employee_id\", empIds);\n\n    const { data, error } = await q;\n    if (error) throw error;\n    return (data ?? []) as ShiftRow[];\n  }\n\n  type AbsenceRow = {\n  employee_id: string;\n  start_date: string;             // YYYY-MM-DD\n  end_date: string | null;        // voi olla null → käytä start_datea\n  status: \"pending\" | \"approved\" | \"declined\";\n};\n\nasync function fetchAbsencesByRange(empIds: string[]): Promise<AbsenceRow[]> {\n  const { data, error } = await supabase\n    .from(\"absences\")\n    .select(\"employee_id, start_date, end_date, status\")\n    .in(\"employee_id\", empIds)\n    .neq(\"status\", \"declined\"); // vain pending/approved blokkaa\n\n  if (error) throw error;\n  const rows = (data ?? []) as AbsenceRow[];\n\n  // Pidä vain poissaolot, jotka osuvat johonkin RANGE-päivään\n  return rows.filter((r) => {\n    const s = r.start_date;\n    const e = r.end_date ?? s;\n    return range.some((day) => day >= s && day <= e);\n  });\n}\n\n\n  // ————— ACTIONS —————\n\n  // 1) Auto-generointi — täyttää puuttuvat vuorot 8h normaaliksi, jos ei poissaoloa\n  const handleAutoGenerate = async () => {\n    setIsGenerating(true);\n    try {\n      toast.info(\"Aloitetaan automaattinen vuorojen generointi…\");\n\n      const employees = await fetchActiveEmployees();\n      if (!employees.length) {\n        toast.info(\"Ei aktiivisia työntekijöitä.\");\n        return;\n      }\n      const empIds = employees.map((e) => e.id);\n      const [existing, absences] = await Promise.all([\n        fetchShiftsByRange(empIds),\n        fetchAbsencesByRange(empIds),\n      ]);\n\n      // Map helpot tarkistukset\n      const existingSet = new Set(existing.map((s) => `${s.employee_id}|${s.work_date}`));\n      const absenceMap = new Map<string, { s: string; e: string }[]>();\n      absences.forEach((a: { employee_id: string; start_date: string; end_date?: string | null }) => {\n        const arr = absenceMap.get(a.employee_id) ?? [];\n        arr.push({ s: a.start_date, e: a.end_date ?? a.start_date });\n        absenceMap.set(a.employee_id, arr);\n      });\n\n      const batch: ShiftRow[] = [];\n      for (const emp of employees) {\n        for (const d of range) {\n          const key = `${emp.id}|${d}`;\n          if (existingSet.has(key)) continue; // älä koske olemassaolevaan\n\n          // jos poissaolo kattaa päivän, skippaa\n          const ranges = absenceMap.get(emp.id) ?? [];\n          const blocked = ranges.some((r) => d >= r.s && d <= r.e);\n          if (blocked) continue;\n\n          batch.push({\n            employee_id: emp.id,\n            work_date: d,\n            type: \"normal\",\n            minutes: defaultMinutes,\n          });\n        }\n      }\n\n      if (!batch.length) {\n        toast.info(\"Ei täytettäviä tyhjiä soluja tälle jaksolle.\");\n        return;\n      }\n\n      const { error } = await supabase\n        .from(\"shifts\")\n        .upsert(batch, { onConflict: \"employee_id,work_date\" });\n\n      if (error) throw error;\n\n      setLastSavedAt(formatTime());\n      toast.success(`Generoitu ${batch.length} vuoroa.`);\n      // Kirjaa ilmoitus\nawait supabase.from(\"notifications\").insert({\n  type: \"shift_auto\",\n  title: \"Vuorot generoitu\",\n  message: `Generoitu ${batch.length} vuoroa jaksolle ${range[0]} – ${range[range.length - 1]}.`\n});\n   } catch (e) {\n  console.error(e);\n  toast.error(\"Generointi epäonnistui\");\n} finally {\n      setIsGenerating(false);\n    }\n  };\n\n\n  // 3) Export CSV (Excel avaa suoraan)\n  const exportSettings = useSettingsStore((s) => s.settings.export);\n\n\n  const handleExportExcel = async () => {\n    try {\n      // Hae työntekijät asetuksen mukaan (mukaan myös ei-aktiiviset tarvittaessa)\n      const employees = await fetchEmployees(!!exportSettings.includeInactiveEmployees);\n      const empIds = employees.map((e) => e.id);\n      const shifts = await fetchShiftsByRange(empIds);\n      const byId = new Map(employees.map((e) => [e.id, e]));\n\n      // Dynaaminen header asetusten mukaan\n      const header: string[] = [];\n      if (exportSettings.includeNames) header.push(\"employee_name\");\n      if (exportSettings.includeEmails) header.push(\"employee_email\");\n      if (exportSettings.includeDepartments) header.push(\"department\");\n      header.push(\"work_date\", \"type\", \"minutes\");\n\n      // Nopeaan lookupiin\n      const shiftMap = new Map<string, ShiftRow>(); // empId|date -> shift\n      shifts.forEach((s) => shiftMap.set(`${s.employee_id}|${s.work_date}`, s));\n\n      // Apuri: muodosta yksi rivi\n      const makeRow = (emp: EmpRow, date: string, s?: ShiftRow): (string | number)[] => {\n        const row: (string | number)[] = [];\n        if (exportSettings.includeNames) row.push(emp?.name ?? \"\");\n        if (exportSettings.includeEmails) row.push(emp?.email ?? \"\");\n        if (exportSettings.includeDepartments) row.push(emp?.department ?? \"\");\n        row.push(date, s?.type ?? \"\", s?.minutes ? formatMinutes(s.minutes) : \"0h\");\n        return row;\n      };\n\n      // Rivit: includeEmptyShifts = jokaisesta päivästä rivi, muuten vain olemassa olevat\n      const rows: (string | number)[][] = [];\n      if (exportSettings.includeEmptyShifts) {\n        for (const emp of employees) {\n          for (const d of range) {\n            rows.push(makeRow(emp, d, shiftMap.get(`${emp.id}|${d}`)));\n          }\n        }\n      } else {\n        shifts\n          .sort((a, b) => (a.work_date < b.work_date ? -1 : a.work_date > b.work_date ? 1 : 0))\n          .forEach((s) => rows.push(makeRow(byId.get(s.employee_id)!, s.work_date, s)));\n      }\n\n      let csv = [header, ...rows]\n        .map((r) => r.map((v) => `\"${String(v).replace(/\"/g, '\"\"')}\"`).join(\",\"))\n        .join(\"\\n\");\n\n        // Lisätty: tuntisummat loppuun, jos asetus päällä\n      if (exportSettings.includeHourTotals) {\n        const totals = new Map<string, number>(); // empId -> total hours\n        for (const emp of employees) totals.set(emp.id, 0);\n        for (const s of shifts) totals.set(s.employee_id, (totals.get(s.employee_id) ?? 0) + (s.minutes ?? 0));\n        const totalsRows = Array.from(totals.entries()).map(([empId, sum]) => {\n          const emp = byId.get(empId)!;\n          const label =\n            exportSettings.includeNames ? emp.name :\n            exportSettings.includeEmails ? emp.email : emp.id;\n          return [label, formatMinutes(sum)];\n        });\n        const totalsCsv =\n          \"\\\\n\\\\n\" +\n          [\"employee\", \"total_minutes\"].join(\",\") +\n          \"\\\\n\" +\n          totalsRows.map((r) => r.map((v) => `\\\\\"${String(v).replace(/\\\\\\\"/g, '\\\"\\\"')}\\\"`).join(\",\")).join(\"\\\\n\");\n        csv += totalsCsv;\n      }\n\n      const blob = new Blob([csv], { type: \"text/csv;charset=utf-8\" });\n      const url = URL.createObjectURL(blob);\n      const a = document.createElement(\"a\");\n      a.href = url;\n        // Tiedostonimeen yrityksen nimi\n      const company = (exportSettings.companyName || \"vuorot\")\n        .replace(/[^\\p{L}\\p{N}_-]+/gu, \"_\")\n        .replace(/_{2,}/g, \"_\")\n        .replace(/^_|_$/g, \"\");\n      a.download = `${company}_${range[0]}_${range[range.length - 1]}.csv`;\n      a.click();\n      URL.revokeObjectURL(url);\n      toast.success(\"CSV ladattu\");\n    } catch (e) {\n      console.error(e);\n      toast.error(\"CSV-vienti epäonnistui\");\n    }\n  };\n\n  // 4) Export PDF (MVP: tulostusystävällinen näkymä -> print)\n  const handleExportPDF = async () => {\n    try {\n      const employees = await fetchActiveEmployees();\n      const shifts = await fetchShiftsByRange(employees.map((e) => e.id));\n      const byId = new Map(employees.map((e) => [e.id, e]));\n\n      const win = window.open(\"\", \"_blank\", \"width=1024,height=768\");\n      if (!win) {\n        toast.error(\"Ponnahdusikkuna estetty\");\n        return;\n      }\n      const style = `\n        <style>\n          body { font-family: ui-sans-serif, system-ui, -apple-system; padding: 24px; }\n          h1,h2 { margin: 0 0 8px; }\n          table { width: 100%; border-collapse: collapse; font-size: 12px; }\n          th, td { border: 1px solid #ddd; padding: 6px 8px; text-align: left; }\n          th { background: #f3f4f6; }\n          .muted { color: #6b7280; font-size: 12px; margin-bottom: 12px; }\n        </style>`;\n      const header = `<h1>Vuorolistat</h1>\n        <div class=\"muted\">${range[0]} – ${range[range.length - 1]} • ${employees.length} työntekijää</div>`;\n\n      const rowsHtml = shifts\n        .sort((a, b) =>\n          a.employee_id === b.employee_id\n            ? a.work_date.localeCompare(b.work_date)\n            : a.employee_id.localeCompare(b.employee_id)\n        )\n        .map((s) => {\n          const e = byId.get(s.employee_id)!;\n          return `<tr>\n            <td>${e?.name ?? \"\"}</td>\n            <td>${e?.email ?? \"\"}</td>\n            <td>${e?.department ?? \"\"}</td>\n            <td>${s.work_date}</td>\n            <td>${s.type}</td>\n            <td>${s.minutes ?? 0}</td>\n          </tr>`;\n        })\n        .join(\"\");\n\n      win.document.write(`\n        <!doctype html><html><head><meta charset=\"utf-8\" />\n        <title>Vuorot</title>${style}</head><body>\n          ${header}\n          <table>\n            <thead><tr>\n              <th>Nimi</th><th>Sähköposti</th><th>Osasto</th>\n              <th>Pvm</th><th>Tyyppi</th><th>Kesto</th>\n            </tr></thead>\n            <tbody>${rowsHtml}</tbody>\n          </table>\n          <script>window.print();</script>\n        </body></html>\n      `);\n      win.document.close();\n    } catch (e) {\n      console.error(e);\n      toast.error(\"PDF-vienti epäonnistui\");\n    }\n  };\n\n // 5) Import CSV (email,work_date,minutes)\n  const handleImport = () => fileInputRef.current?.click();\n\n  const onImportFile = async (file: File) => {\n    try {\n      const text = await file.text();\n      // Odotettu header: email,work_date,hours\n      const lines = text\n        .split(/\\r?\\n/)\n        .map((l) => l.trim())\n        .filter(Boolean);\n      if (!lines.length) {\n        toast.error(\"Tyhjä tiedosto\");\n        return;\n      }\n\n      const header = lines[0].split(\",\").map((s) => s.trim().toLowerCase());\n      const emailIdx = header.indexOf(\"email\");\n      const dateIdx = header.indexOf(\"work_date\");\n      const minutesIdx = header.indexOf(\"minutes\");\n      if (emailIdx === -1 || dateIdx === -1 || minutesIdx === -1) {\n        toast.error('Odotettu header: \"email,work_date,minutes\"');\n        return;\n      }\n\n      const employees = await fetchActiveEmployees();\n      const byEmail = new Map(employees.map((e) => [e.email.toLowerCase(), e]));\n\n      const bad: string[] = [];\n      const batch: ShiftRow[] = [];\n      for (let i = 1; i < lines.length; i++) {\n        const cols = lines[i].split(\",\").map((s) => s.trim().replace(/^\"|\"$/g, \"\"));\n        if (cols.length < 3) continue;\n        const email = cols[emailIdx].toLowerCase();\n        const d = cols[dateIdx];\n        const raw = cols[minutesIdx];\n        let mins = 0;\n        if (/^\\\\d+$/.test(raw)) {\n          mins = parseInt(raw, 10);\n        } else {\n          const match = raw.match(/(?:(\\\\d+)h)?\\\\s*(?:(\\\\d+)m)?/);\n          if (match) {\n            const h = parseInt(match[1] ?? \"0\", 10);\n            const m = parseInt(match[2] ?? \"0\", 10);\n            mins = h * 60 + m;\n          }\n        }\n        if (!email || !d || isNaN(mins)) continue;\n        const emp = byEmail.get(email);\n        if (!emp) {\n          bad.push(lines[i]);\n          continue;\n        }\n        batch.push({\n          employee_id: emp.id,\n          work_date: d,\n          type: \"normal\",\n          minutes: mins,\n        });\n      }\n\n      if (!batch.length) {\n        toast.error(\"Ei kelvollisia rivejä importissa\");\n        return;\n      }\n\n      const { error } = await supabase\n        .from(\"shifts\")\n        .upsert(batch, { onConflict: \"employee_id,work_date\" });\n      if (error) throw error;\n\n      setLastSavedAt(formatTime());\n      if (bad.length) {\n        toast.warning(\n          `Import OK (${batch.length} riviä). ${bad.length} riviä jäi väliin tuntemattoman emailin takia.`\n        );\n      } else {\n        toast.success(`Import OK (${batch.length} riviä).`);\n      }\n    } catch (e) {\n      console.error(e);\n      toast.error(\"Import epäonnistui\");\n    } finally {\n      if (fileInputRef.current) fileInputRef.current.value = \"\";\n    }\n  };\n\n  // ————— UI —————\n  const weekNo = useMemo(() => getISOWeek(START_ISO), [START_ISO]);\n  const year = useMemo(() => new Date(START_ISO + \"T00:00:00\").getFullYear(), [START_ISO]);\n\n  return (\n    <Card className=\"shadow-md border-0 bg-gradient-to-r from-background to-secondary/10\">\n      <CardContent className=\"p-4\">\n        <div className=\"flex flex-wrap items-center gap-3 justify-between\">\n          {/* Left Section - Main Actions */}\n          <div className=\"flex items-center gap-2\">\n            <Button\n              onClick={handleAutoGenerate}\n              disabled={isGenerating}\n              className=\"bg-primary hover:bg-primary/90\"\n            >\n              {isGenerating ? (\n                <RefreshCw className=\"w-4 h-4 mr-2 animate-spin\" />\n              ) : (\n                <Wand2 className=\"w-4 h-4 mr-2\" />\n              )}\n              {isGenerating ? \"Generoidaan...\" : \"Auto-generointi\"}\n            </Button>\n\n            <Separator orientation=\"vertical\" className=\"h-8\" />\n\n <Button\n   variant=\"outline\"\n   onClick={handlePublish}\n   className=\"border-emerald-500 text-emerald-700\"\n >\n   <Check className=\"w-4 h-4 mr-2\" />\n   Julkaise vuorot\n </Button>\n\n\n\n<div className=\"flex items-center gap-1\">\n  <Button variant=\"ghost\" size=\"sm\" onClick={undo} disabled={!canUndo}>\n    <Undo className=\"w-4 h-4\" />\n  </Button>\n  <Button variant=\"ghost\" size=\"sm\" onClick={redo} disabled={!canRedo}>\n    <Redo className=\"w-4 h-4\" />\n  </Button>\n</div>\n          </div>\n\n    {/* Center Section - View Options */}\n<div className=\"flex items-center gap-2\">\n  <SearchPopover />  {/* 🆕 oikea haku */}\n  <FilterPopover />\n  {/* Aikajakson valitsin */}\n  <PeriodSelector />\n</div>\n\n\n\n          {/* Right Section - Export/Import */}\n          <div className=\"flex items-center gap-2\">\n            <input\n              ref={fileInputRef}\n              type=\"file\"\n              accept=\".csv,text/csv\"\n              className=\"hidden\"\n              onChange={(e) => {\n                const f = e.target.files?.[0];\n                if (f) onImportFile(f);\n              }}\n            />\n            <Button variant=\"outline\" onClick={handleImport}>\n              <Upload className=\"w-4 h-4 mr-2\" />\n              Tuo\n            </Button>\n\n            <div className=\"flex items-center gap-1\">\n              <Button variant=\"outline\" size=\"sm\" onClick={handleExportExcel}>\n                <FileSpreadsheet className=\"w-4 h-4 mr-2\" />\n                Excel\n              </Button>\n              <Button variant=\"outline\" size=\"sm\" onClick={handleExportPDF}>\n                <FileText className=\"w-4 h-4 mr-2\" />\n                PDF\n              </Button>\n            </div>\n\n            <Separator orientation=\"vertical\" className=\"h-8\" />\n            <NotificationsPopover />\n\n\n          <SettingsDialog />\n          </div>\n        </div>\n\n        {/* Status Bar */}\n        <div className=\"flex items-center justify-between mt-3 pt-3 border-t border-border/50\">\n          <div className=\"flex flex-wrap items-center gap-2 text-sm text-muted-foreground\">\n            <span>\n              Viimeksi tallennettu: {lastSavedAt ? lastSavedAt : \"—\"}\n            </span>\n            <span>•</span>\n            <span>{empCount ?? \"…\"} työntekijää</span>\n            <span>•</span>\n            <span>\n              Viikko {weekNo}/{year}\n            </span>\n            <span>•</span>\n            <span>\n              Jakso: {isClient && range.length > 0 ? `${range[0]} – ${range[range.length - 1]}` : \"—\"}\n            </span>\n          </div>\n          \n        </div>\n      </CardContent>\n    </Card>\n  );\n};\n\n// === PeriodSelector ===\ntype PeriodValue = 7 | 10 | 14 | 30;\ntype PeriodItem = { value: PeriodValue; label: string; description: string };\n\nconst PERIODS: PeriodItem[] = [\n  { value: 7,  label: \"7 päivää\",  description: \"Viikkonäkymä\" },\n  { value: 10, label: \"10 päivää\", description: \"Laajennettu\" },\n  { value: 14, label: \"14 päivää\", description: \"Kaksiviikkoinen\" },\n  { value: 30, label: \"30 päivää\", description: \"Kuukausinäkymä\" },\n];\n\nfunction PeriodSelector() {\n  const days = useScheduleStore((s) => s.days);\n  const startISO = useScheduleStore((s) => s.startDateISO);\n  const setRange = useScheduleStore((s) => s.setRange);\n\n\n  const current = PERIODS.find((p) => p.value === days) ?? PERIODS[1];\n\n  return (\n    <Popover>\n      <PopoverTrigger asChild>\n        <Button variant=\"ghost\" size=\"sm\" className=\"h-9 px-3 min-w-[160px] justify-start\">\n          <span className=\"inline-flex items-center gap-2\">\n            <CalIcon className=\"w-4 h-4\" />\n            <span>{current.label}</span>\n            <ChevronDown className=\"w-3 h-3\" />\n          </span>\n        </Button>\n      </PopoverTrigger>\n      <PopoverContent className=\"w-72 p-2\" align=\"center\">\n        <div className=\"px-2 py-1.5 text-sm font-medium text-muted-foreground\">\n          Valitse aikajakso\n        </div>\n        <div className=\"space-y-1\" role=\"menu\" aria-label=\"Aikajakso\">\n          {PERIODS.map((option) => {\n            const active = days === option.value;\n            return (\n              <button\n                key={option.value}\n                role=\"menuitemradio\"\n                aria-checked={active}\n                onClick={() => {\n  setRange(startISO, option.value); // ei alignointia täällä\n}}\n                className={`w-full flex items-center justify-between p-2 rounded-md text-left hover:bg-accent ${\n                  active ? \"bg-accent\" : \"\"\n                }`}\n              >\n                <div className=\"flex flex-col\">\n                  <span className=\"text-sm font-medium\">{option.label}</span>\n                  <span className=\"text-xs text-muted-foreground\">{option.description}</span>\n                </div>\n                <div className=\"flex items-center\">\n                  {active && <Check className=\"w-4 h-4 text-primary\" />}\n                </div>\n              </button>\n            );\n          })}\n        </div>\n      </PopoverContent>\n    </Popover>\n  );\n}\n\n\n\n\nconst DEFAULT_FILTERS = {\n  departments: [] as string[],\n  showActive: false,\n  showInactive: false,\n  searchTerm: \"\", \n  };\n\nfunction FilterPopover() {\n  const [isOpen, setIsOpen] = useState(false);\n  const filters = useScheduleStore((s) => s.filters) ?? DEFAULT_FILTERS;\n  const setFilters = useScheduleStore((s) => s.setFilters) ?? (() => {});\n  const resetFilters = useScheduleStore((s) => s.resetFilters) ?? (() => {});\n\n const employeesFromStore = useScheduleStore((s) => s.employees);\nconst employees = useMemo(() => employeesFromStore ?? [], [employeesFromStore]);\n\nconst employeeDepartments = useMemo(\n  () => employees.map((e) => e.department),\n  [employees]\n);\n\nconst availableDepartments = useMemo(\n  () => Array.from(new Set(employeeDepartments)).filter(Boolean) as string[],\n  [employeeDepartments]\n);\n\n\n  // 2) Tila-suodatus on aktiivinen vain jos vain toinen toggle on päällä (XOR)\n  const stateFilterActive = filters.showActive !== filters.showInactive;\n\n  // 3) Badge: 1 piste osastofiltteristä (jos valittuja), 1 piste tila-XOR:sta\n  const activeFilterCount =\n    (filters.departments.length > 0 ? 1 : 0) +\n    (stateFilterActive ? 1 : 0);\n\n  const handleDepartmentToggle = (dept: string) => {\n    const exists = filters.departments.includes(dept);\n    setFilters({\n      departments: exists\n        ? filters.departments.filter((d) => d !== dept)\n        : [...filters.departments, dept],\n    });\n  };\n\n  const handleActiveToggle = () => setFilters({ showActive: !filters.showActive });\n  const handleInactiveToggle = () => setFilters({ showInactive: !filters.showInactive });\n\n  const handleClearFilters = () => {\n    resetFilters();\n    setIsOpen(false); // 4) UX: tyhjennä -> sulje\n  };\n\n  return (\n    <Popover open={isOpen} onOpenChange={setIsOpen}>\n      <PopoverTrigger asChild>\n        <div\n          className={`\n            inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium\n            ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2\n            focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none\n            disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-9 px-3 cursor-pointer\n            ${activeFilterCount > 0 ? \"bg-primary text-primary-foreground hover:bg-primary/90\" : \"\"}\n          `}\n        >\n          <Filter className=\"w-4 h-4 mr-2\" />\n          Suodatin\n          {activeFilterCount > 0 && (\n            <Badge variant=\"secondary\" className=\"ml-2 bg-white text-primary text-xs\">\n              {activeFilterCount}\n            </Badge>\n          )}\n        </div>\n      </PopoverTrigger>\n\n      <PopoverContent className=\"w-80 p-4\" align=\"center\">\n        <div className=\"space-y-4\">\n          {/* Header */}\n          <div className=\"flex items-center justify-between\">\n            <h3 className=\"font-medium\">Suodattimet</h3>\n            {(filters.departments.length > 0 || stateFilterActive) && (\n              <Button variant=\"ghost\" size=\"sm\" onClick={handleClearFilters} className=\"h-6 px-2 text-xs\">\n                <X className=\"w-3 h-3 mr-1\" />\n                Tyhjennä\n              </Button>\n            )}\n          </div>\n\n          <Separator />\n\n          {/* Department Filters */}\n          <div className=\"space-y-3\">\n            <div className=\"flex items-center gap-2\">\n              <Building className=\"w-4 h-4 text-muted-foreground\" />\n              <span className=\"font-medium text-sm\">Osastot</span>\n            </div>\n            <div className=\"space-y-2 pl-6\">\n              {availableDepartments.map((department) => (\n                <div key={department} className=\"flex items-center space-x-2\">\n                  <Checkbox\n                    id={`dept-${department}`}\n                    checked={filters.departments.includes(department)}\n                    onCheckedChange={() => handleDepartmentToggle(department)}\n                  />\n                  <label htmlFor={`dept-${department}`} className=\"text-sm cursor-pointer\">\n                    {department}\n                  </label>\n                </div>\n              ))}\n            </div>\n          </div>\n\n          <Separator />\n\n          {/* Employee Status Filters */}\n          <div className=\"space-y-3\">\n            <div className=\"flex items-center gap-2\">\n              <Users className=\"w-4 h-4 text-muted-foreground\" />\n              <span className=\"font-medium text-sm\">Työntekijöiden tila</span>\n            </div>\n            <div className=\"space-y-2 pl-6\">\n              <div className=\"flex items-center space-x-2\">\n                <Checkbox id=\"show-active\" checked={filters.showActive} onCheckedChange={handleActiveToggle} />\n                <label htmlFor=\"show-active\" className=\"text-sm cursor-pointer\">\n                  Näytä aktiiviset työntekijät\n                </label>\n              </div>\n              <div className=\"flex items-center space-x-2\">\n                <Checkbox id=\"show-inactive\" checked={filters.showInactive} onCheckedChange={handleInactiveToggle} />\n                <label htmlFor=\"show-inactive\" className=\"text-sm cursor-pointer\">\n                  Näytä ei-aktiiviset työntekijät\n                </label>\n              </div>\n            </div>\n          </div>\n\n          {/* Filter Summary */}\n          {(filters.departments.length > 0 || stateFilterActive) && (\n            <>\n              <Separator />\n              <div className=\"text-xs text-muted-foreground\">\n                {filters.departments.length > 0 && <div>Osastot: {filters.departments.join(\", \")}</div>}\n                {stateFilterActive && (\n                  <div>Tila: {filters.showActive ? \"Vain aktiiviset\" : \"Vain ei-aktiiviset\"}</div>\n                )}\n              </div>\n            </>\n          )}\n        </div>\n      </PopoverContent>\n    </Popover>\n  );\n}\n\n\n\nexport default Toolbar;\n\n\nfunction SearchPopover() {\n  const filters = useScheduleStore((s) => s.filters) ?? DEFAULT_FILTERS;\n  const setFilters = useScheduleStore((s) => s.setFilters);\n\n  const [open, setOpen] = useState(false);\n  const [localTerm, setLocalTerm] = useState(filters.searchTerm ?? \"\");\n  const debTimer = React.useRef<number | null>(null);\n\n  const handleSearchChange = (val: string) => {\n    setLocalTerm(val);\n    if (debTimer.current) window.clearTimeout(debTimer.current);\n    debTimer.current = window.setTimeout(() => {\n      setFilters({ searchTerm: val });\n    }, 200);\n  };\n\n  const clear = () => {\n    setLocalTerm(\"\");\n    setFilters({ searchTerm: \"\" });\n  };\n\nReact.useEffect(() => {\n  if (!open) return;\n  const onKey = (e: KeyboardEvent) => {\n    if (e.key === \"Escape\") {\n      setLocalTerm(\"\");\n      setFilters({ searchTerm: \"\" });\n    }\n  };\n  window.addEventListener(\"keydown\", onKey);\n  return () => window.removeEventListener(\"keydown\", onKey);\n}, [open, setFilters]);\n\n  const isActive = (filters.searchTerm ?? \"\").trim().length > 0;\n\n  return (\n      <Popover\n      open={open}\n      onOpenChange={(next) => {\n        setOpen(next);\n        if (next) setLocalTerm(filters.searchTerm ?? \"\");\n      }}\n    >\n      <PopoverTrigger asChild>\n        <Button variant={isActive ? \"default\" : \"ghost\"} size=\"sm\" className=\"h-9\">\n          <Search className=\"w-4 h-4 mr-2\" />\n          Haku\n        </Button>\n      </PopoverTrigger>\n      <PopoverContent className=\"w-96 p-4\" align=\"center\">\n        <div className=\"space-y-3\">\n          <div className=\"text-base font-semibold\">Haku</div>\n          <div className=\"text-sm text-muted-foreground\">Etsi työntekijöitä</div>\n          <div className=\"relative\">\n           <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground w-4 h-4\" />\n           <input\n              className=\"w-full h-9 rounded-md border border-input bg-background px-3 pl-10 pr-10 text-sm outline-none focus:ring-2 focus:ring-ring\"\n              placeholder=\"Hae nimellä, sähköpostilla tai osastolla...\"\n              value={localTerm}\n              onChange={(e) => handleSearchChange(e.target.value)}\n              autoFocus\n            />\n            {localTerm && (\n              <button\n                type=\"button\"\n                aria-label=\"Tyhjennä haku\"\n                className=\"absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground\"\n                onClick={clear}\n              >\n                <X className=\"w-4 h-4\" />\n              </button>\n            )}\n          </div>\n          <div className=\"text-xs text-muted-foreground\">\n            Haku toimii reaaliajassa ja etsii nimestä, sähköpostista ja osastosta\n          </div>\n          {isActive && (\n            <>\n              <Separator />\n              <div className=\"text-xs text-muted-foreground bg-accent/50 p-2 rounded-md\">\n                <Search className=\"w-3 h-3 inline mr-1\" />\n                Hakutermi: “{filters.searchTerm}”\n                <div className=\"mt-1\">Näytetään työntekijät jotka vastaavat hakua</div>\n              </div>\n            </>\n          )}\n        </div>\n      </PopoverContent>\n    </Popover>\n  );\n}",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 957
        }
      ]
    },
    {
      "path": "src/app/set-password/page.tsx",
      "size": 6067,
      "sha256": "a24826a53a69f85abf0bb00f5d7f78115d90f9c262bae1a826d67cfee49a6863",
      "lang": "tsx",
      "lines": 192,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/set-password/page.tsx",
      "chunks": [
        {
          "i": 0,
          "text": "\"use client\";\n\nimport { useEffect, useMemo, useState } from \"react\";\nimport { useSearchParams, useRouter } from \"next/navigation\";\nimport { supabase } from \"@/lib/supaBaseClient\";\nimport { Input } from \"@/app/components/ui/input\";\nimport { Button } from \"@/app/components/ui/button\";\n\nexport default function SetPassword() {\n  const searchParams = useSearchParams();\n  const router = useRouter();\n\n  const [authReady, setAuthReady] = useState(false);\n  const [hasSession, setHasSession] = useState(false);\n\n  const [password, setPassword] = useState(\"\");\n  const [confirm, setConfirm] = useState(\"\");\n  const [loading, setLoading] = useState(false);\n  const [exchanging, setExchanging] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [success, setSuccess] = useState(false);\n\n  // Recovery-linkki tuo ?code=... (ei token)\n  const code = useMemo(() => searchParams.get(\"code\"), [searchParams]);\n\n  useEffect(() => {\n    let mounted = true;\n    (async () => {\n      setExchanging(true);\n      setError(null);\n      try {\n        // 1) Onko sessio jo valmiina?\n        const { data: s0 } = await supabase.auth.getSession();\n        if (s0.session) {\n          if (!mounted) return;\n          setHasSession(true);\n          setAuthReady(true);\n          return;\n        }\n\n        // 2) ?code=... (recovery-linkin code-muoto)\n        if (code) {\n          const { error: exErr } = await supabase.auth.exchangeCodeForSession(code);\n          if (exErr) throw exErr;\n          const { data: s1 } = await supabase.auth.getSession();\n          if (!mounted) return;\n          setHasSession(Boolean(s1.session));\n          setAuthReady(true);\n          return;\n        }\n\n        // 3) Fallback: URL-hash sisältää access_token/refresh_token\n        if (typeof window !== \"undefined\" && window.location.hash) {\n          const hash = new URLSearchParams(window.location.hash.slice(1));\n          const access_token = hash.get(\"access_token\");\n          const refresh_token = hash.get(\"refresh_token\");\n          if (access_token && refresh_token) {\n            const { error: setErr } = await supabase.auth.setSession({\n              access_token,\n              refresh_token,\n            });\n            if (setErr) throw setErr;\n\n            // Siivoa hash pois URL:ista\n            try {\n              window.history.replaceState({}, \"\", window.location.pathname);\n            } catch (_) {}\n\n            const { data: s2 } = await supabase.auth.getSession();\n            if (!mounted) return;\n            setHasSession(Boolean(s2.session));\n            setAuthReady(true);\n            return;\n          }\n        }\n\n        // 4) Ei sessiota eikä codea/hashia → virhetila\n        if (!mounted) return;\n        setHasSession(false);\n        setAuthReady(true);\n        setError(\"Linkki puuttuu tai on vanhentunut. Pyydä uusi linkki.\");\n      } catch (e: any) {\n        if (!mounted) return;\n        console.error(\"[set-password] exchange failed\", e);\n        setHasSession(false);\n        setAuthReady(true);\n        setError(e?.message ?? \"Kirjautumislinkin vahvistus epäonnistui.\");\n      } finally {\n        if (mounted) setExchanging(false);\n      }\n    })();\n    return () => {\n      mounted = false;\n    };\n  }, [code, searchParams]); // varmistetaan että hash-muutos myös triggaa tarvittaessa\n\n  const canSubmit =\n    hasSession && password.length >= 8 && password === confirm && !loading;\n\n  async function handleSubmit(e: React.FormEvent) {\n    e.preventDefault();\n    if (!hasSession) {\n      setError(\"Vahvista kirjautumislinkki ensin (pyydä uusi linkki).\");\n      return;\n  }\n    if (password.length < 8) {\n      setError(\"Salasanan tulee olla vähintään 8 merkkiä.\");\n      return;\n    }\n    if (password !== confirm) {\n      setError(\"Salasanat eivät täsmää.\");\n      return;\n    }\n\n    try {\n      setLoading(true);\n      setError(null);\n\n      const { error: updateErr } = await supabase.auth.updateUser({ password });\n      if (updateErr) throw updateErr;\n\n      setSuccess(true);\n      setTimeout(() => router.push(\"/\"), 1200);\n    } catch (e: any) {\n      console.error(\"[SetPassword]\", e);\n      setError(e?.message || \"Salasanan asettaminen epäonnistui.\");\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  return (\n    <div className=\"flex min-h-screen items-center justify-center bg-gray-50 p-4\">\n      <form\n        onSubmit={handleSubmit}\n        className=\"w-full max-w-md rounded-2xl bg-white p-6 shadow-lg space-y-3\"\n      >\n        <h1 className=\"text-xl font-semibold\">Aseta salasana</h1>\n\n        {!authReady || exchanging ? (\n          <div className=\"text-sm text-gray-600\">\n            Vahvistetaan kirjautumislinkkiä…\n          </div>\n        ) : !hasSession ? (\n          <div className=\"rounded bg-yellow-100 p-2 text-sm text-yellow-800\">\n            Linkkiä ei voitu vahvistaa. Avaa sähköpostin linkki uudelleen tai\n            pyydä uusi linkki adminilta.\n          </div>\n        ) : null}\n\n        {error && (\n          <div className=\"rounded bg-red-100 p-2 text-sm text-red-700\">\n            {error}\n    </div>\n        )}\n        {success && (\n          <div className=\"rounded bg-green-100 p-2 text-sm text-green-700\">\n            Salasana asetettu! Ohjataan sisään…\n          </div>\n        )}\n\n        <label className=\"block text-sm font-medium text-gray-700\">\n          Uusi salasana\n        </label>\n        <Input\n          type=\"password\"\n          value={password}\n          onChange={(e) => setPassword(e.target.value)}\n          required\n          minLength={8}\n        />\n\n        <label className=\"block text-sm font-medium text-gray-700\">\n          Vahvista salasana\n        </label>\n        <Input\n          type=\"password\"\n          value={confirm}\n          onChange={(e) => setConfirm(e.target.value)}\n          required\n          minLength={8}\n        />\n\n        <Button type=\"submit\" disabled={!canSubmit} className=\"w-full\">\n          {loading ? \"Tallennetaan…\" : \"Tallenna salasana\"}\n        </Button>\n      </form>\n    </div>\n  );\n}\n\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 191
        }
      ]
    },
    {
      "path": "src/app/types/index.ts",
      "size": 1747,
      "sha256": "2d71d7922173f049569e524540c9d716cd7ff87534303a8a435680349d8de389",
      "lang": "typescript",
      "lines": 80,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/types/index.ts",
      "chunks": [
        {
          "i": 0,
          "text": "export interface ShiftType {\n  type: 'normal' | 'locked' | 'absent' | 'holiday' | 'empty';\n  minutes?: number;\n  icon?: React.ReactNode;\n}\n\nexport interface Employee {\n  id: string;\n  name: string;\n  email: string;\n  department: string;\n  isActive: boolean;\n  shifts: ShiftType[];\n}\n\nexport interface AbsenceRequest {\n  id: string;\n  employeeId: string;\n  employeeName: string;\n  startDate: string;\n  endDate: string;\n  reason: string;\n  status: 'pending' | 'approved' | 'declined';\n  submittedAt: string;\n  message?: string;\n}\n\nexport interface DateInfo {\n  day: string;\n  date: string;\n  fullDate: Date; // lisätään tämä\n}\n\n\nexport interface EmployeeTimeOffRequest {\n  id: string;\n  employeeId: string;\n  startDate: string;\n  endDate: string;\n  reason: string;\n  status: 'pending' | 'approved' | 'declined';\n  submittedAt: string;\n  message?: string;\n}\n\nexport interface ShiftChangeRequest {\n  id: string;\n  employeeId: string;\n  employeeName: string;\n  currentDate: string;\n  currentShift: ShiftType;\n  requestedDate: string;\n  requestedShift?: ShiftType;\n  reason: string;\n  status: 'pending' | 'approved' | 'declined';\n  submittedAt: string;\n  message?: string;\n  targetEmployeeId?: string;\n  targetEmployeeName?: string;\n}\n\nexport interface EmployeeNotification {\n  id: string;\n  type: 'absence_approved' | 'absence_declined' | 'shift_approved' | 'shift_declined' | 'schedule_published' | 'schedule_updated' | 'reminder' | 'system';\n  title: string;\n  message: string;\n  created_at: string;\n  isRead: boolean;\n  priority: 'low' | 'medium' | 'high';\n}\n\nexport type TimePeriod = number;\n\nexport interface AppSettings {\n  general: {\n    weekStartDay: 'monday' | 'sunday';\n    dateFormat: 'dd.mm.yyyy' | 'mm/dd/yyyy' | 'yyyy-mm-dd';\n  };\n}\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 79
        }
      ]
    },
    {
      "path": "src/features/absences/notify.ts",
      "size": 2461,
      "sha256": "c45108597366304552a5dc4e65e5419f45e52978acbd4c5d550ff67359b38186",
      "lang": "typescript",
      "lines": 79,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/features/absences/notify.ts",
      "chunks": [
        {
          "i": 0,
          "text": "import { supabase } from \"@/lib/supaBaseClient\";\nimport { insertEmailQueue } from \"@/lib/insertEmailQueue\";\nimport { useSettingsStore } from \"@/store/useSettingsStore\";\n\nexport type AbsenceDecision = \"approved\" | \"declined\";\n\nexport async function notifyAbsenceDecision(args: {\n  employeeIds: string[];\n  status: AbsenceDecision;\n  startDate: string;\n  endDate?: string | null;\n  adminMessage?: string;\n}) {\n  const { employeeIds, status, startDate, endDate, adminMessage } = args;\n\n  const settings = useSettingsStore.getState().settings;\n  const emailEnabled = settings?.notifications?.emailNotifications ?? true;\n  if (!emailEnabled) return;\n\n  const { data: emps, error: empErr } = await supabase\n    .from(\"employees\")\n    .select(\"id, email, name\")\n    .in(\"id\", employeeIds);\n\n  if (empErr) {\n    console.warn(\"[notifyAbsenceDecision] employees fetch error\", empErr);\n    return;\n  }\n\n  const valid = (emps ?? []).filter(e => e.email);\n  if (valid.length === 0) {\n    console.warn(\"[notifyAbsenceDecision] no employees with email found\");\n    return;\n  }\n\n  const period = endDate && endDate !== startDate ? `${startDate}–${endDate}` : startDate;\n  const subject =\n    status === \"approved\"\n      ? `Poissaolopyyntösi on hyväksytty (${period})`\n      : `Poissaolopyyntösi on hylätty (${period})`;\n\n  const parts: string[] = [];\n  if (adminMessage?.trim()) {\n    parts.push(\n      status === \"approved\"\n        ? `Viestisi vastaus:\\n\\n${adminMessage.trim()}\\n\\n`\n        : `Perustelu:\\n\\n${adminMessage.trim()}\\n\\n`\n    );\n  }\n  parts.push(\n    `Hei,\\n\\nPoissaolopyyntösi on ${status === \"approved\" ? \"hyväksytty\" : \"hylätty\"}.\\nJakso: ${period}\\n`\n  );\n  if (status === \"declined\") parts.push(\"\\nJos tämä on virhe, ole yhteydessä esihenkilöön.\\n\");\n  parts.push(\"\\nTerveisin,\\nSoili\");\n\n  try {\n    await insertEmailQueue({\n      to: valid.map(e => e.email),\n      subject,\n      text: parts.join(\"\"),\n    });\n  } catch (e) {\n    console.error(\"[notifyAbsenceDecision] email send failed\", e);\n  }\n\n  try {\n    const rows = valid.map((e) => ({\n      type: status === \"approved\" ? \"absence_approved\" : \"absence_declined\",\n      title: status === \"approved\" ? \"Poissaolo hyväksytty\" : \"Poissaolo hylätty\",\n      message: `${e.name ?? \"\"} • ${period}`,\n    }));\n    if (rows.length > 0) {\n      await supabase.from(\"notifications\").insert(rows);\n    }\n  } catch (e) {\n    console.warn(\"[notifyAbsenceDecision] log insert failed\", e);\n  }\n}\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 78
        }
      ]
    },
    {
      "path": "src/app/api/employees/route.ts",
      "size": 3417,
      "sha256": "72f980d50e518e0158eedae85680e3a8b212e519502fac80a0e481656d3a6fcd",
      "lang": "typescript",
      "lines": 95,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/api/employees/route.ts",
      "chunks": [
        {
          "i": 0,
          "text": "import { NextResponse } from \"next/server\";\nimport { createClient } from \"@supabase/supabase-js\";\n\nexport async function POST(req: Request) {\n  try {\n    const { name, email, department, isActive } = await req.json();\n    if (!name?.trim() || !email?.trim() || !department?.trim()) {\n      return NextResponse.json({ error: \"Missing fields\" }, { status: 400 });\n    }\n\n    // Authorization header -pohjainen admin-check\n    const authHeader = req.headers.get(\"authorization\") ?? \"\";\n    if (!authHeader.toLowerCase().startsWith(\"bearer \")) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n\n    // Tämä client käyttää kutsujan access tokenia\n    const userSb = createClient(\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\n      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n      {\n        auth: { persistSession: false, autoRefreshToken: false },\n        global: { headers: { Authorization: authHeader } },\n      }\n    );\n\n    const { data: userRes, error: userErr } = await userSb.auth.getUser();\n    if (userErr || !userRes?.user) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n\n    const { data: me, error: roleErr } = await userSb\n      .from(\"employees\")\n      .select(\"role\")\n      .eq(\"auth_user_id\", userRes.user.id)\n      .maybeSingle();\n    if (roleErr || !me || me.role !== \"admin\") {\n      return NextResponse.json({ error: \"Forbidden\" }, { status: 403 });\n    }\n\n    // Admin-operaatiot service roolella\n    const adminSb = createClient(\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\n      process.env.SUPABASE_SERVICE_ROLE_KEY!,\n      { auth: { persistSession: false } }\n    );\n\n    const { data: created, error: createErr } = await adminSb.auth.admin.createUser({\n      email: email.trim(),\n      email_confirm: true,\n    });\n    if (createErr || !created?.user) {\n      return NextResponse.json({ error: createErr?.message ?? \"createUser failed\" }, { status: 400 });\n    }\n\n    const appUrl = process.env.APP_URL ?? \"http://localhost:3000\";\n    const { data: linkRes, error: linkErr } = await adminSb.auth.admin.generateLink({\n      type: \"recovery\",\n      email: email.trim(),\n      options: { redirectTo: `${appUrl}/set-password` },\n    });\n    if (linkErr || !linkRes?.properties?.action_link) {\n      return NextResponse.json({ error: linkErr?.message ?? \"generateLink failed\" }, { status: 400 });\n    }\n\n    const { data: employee, error: empErr } = await adminSb\n      .from(\"employees\")\n      .insert([{\n        name: name.trim(),\n        email: email.trim(),\n        department: department.trim(),\n        is_active: !!isActive,\n        auth_user_id: created.user.id,\n        role: \"employee\",\n      }])\n      .select(\"id, name, email, department, is_active, created_at\")\n      .single();\n\n    if (empErr) {\n      return NextResponse.json({ error: empErr.message }, { status: 400 });\n    }\n\n    const link = linkRes.properties.action_link as string;\n    await adminSb.from(\"email_queue\").insert({\n      recipient: email.trim(),\n      subject: \"Tervetuloa Soiliin – aseta salasanasi\",\n      body: `Hei ${name.trim()},\\n\\nTervetuloa Soiliin!\\nAseta salasanasi tästä linkistä:\\n${link}\\n\\nTerveisin,\\nSoili`,\n      status: \"queued\",\n    });\n\n    return NextResponse.json({ employee }, { status: 200 });\n  } catch (e: any) {\n    return NextResponse.json({ error: e?.message ?? \"Internal error\" }, { status: 500 });\n  }\n}",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 95
        }
      ]
    },
    {
      "path": "src/app/api/sendEmail/route.ts",
      "size": 1509,
      "sha256": "2eea2d84d2fc9b9dad0cec7e3f7a9bf8e3468e142978d9d202c57d55bd5659ed",
      "lang": "typescript",
      "lines": 54,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/api/sendEmail/route.ts",
      "chunks": [
        {
          "i": 0,
          "text": "\nimport { NextRequest, NextResponse } from \"next/server\";\n\ntype Body = {\n  to: string | string[];\n  subject: string;\n  text?: string;\n  html?: string;\n  replyTo?: string;\n};\n\nexport async function POST(req: NextRequest) {\n  try {\n    const { to, subject, text, html, replyTo } = (await req.json()) as Body;\n    if (!to || !subject) {\n      return NextResponse.json({ error: \"Missing 'to' or 'subject'\" }, { status: 400 });\n    }\n\n    const RESEND_API_KEY = process.env.RESEND_API_KEY;\n    if (!RESEND_API_KEY) {\n      return NextResponse.json({ error: \"RESEND_API_KEY missing\" }, { status: 500 });\n    }\n\n    const FROM = process.env.FROM_EMAIL || \"Soili <onboarding@resend.dev>\";\n    const resp = await fetch(\"https://api.resend.com/emails\", {\n      method: \"POST\",\n      headers: {\n        Authorization: `Bearer ${RESEND_API_KEY}`,\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify({\n        from: FROM,\n        to,\n        subject,\n        text,\n        html,\n        reply_to: replyTo,\n      }),\n    });\n\n    const data: Record<string, unknown> = await resp.json().catch(() => ({}));\n\n    if (!resp.ok) {\n      return NextResponse.json({ error: data || \"Resend error\" }, { status: resp.status });\n    }\n    return NextResponse.json({ ok: true, data }, { status: 200 });\n  } catch (e: unknown) {\n    const message =\n      e instanceof Error ? e.message : typeof e === \"string\" ? e : \"Internal error\";\n    return NextResponse.json({ error: message }, { status: 500 });\n  }\n}\n\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 53
        }
      ]
    },
    {
      "path": "src/app/api/timeoff/route.ts",
      "size": 2292,
      "sha256": "6c3a8c57f25a01b2d7972d14abdc0b89b8e8e29856ab3a3d08d8b98f7c890923",
      "lang": "typescript",
      "lines": 82,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/api/timeoff/route.ts",
      "chunks": [
        {
          "i": 0,
          "text": "import { NextResponse } from \"next/server\";\nimport { z } from \"zod\";\nimport { createClient } from \"@supabase/supabase-js\";\n\nconst schema = z.object({\n  startDate: z.string().min(1),\n  endDate: z.string().min(1),\n  reason: z.string().min(1),\n  message: z.string().optional(),\n});\n\nexport async function POST(req: Request) {\n  console.log(\"➡️ /api/timeoff hit\");\n  const body = await req.json();\n  console.log(\"➡️ Request body:\", body);\n  const parsed = schema.safeParse(body);\n\n  if (!parsed.success) {\n    return NextResponse.json({ error: \"Invalid body\", details: parsed.error.flatten() }, { status: 400 });\n  }\n\n  // 🟢 Ota käyttäjän token headersista\n  const token = req.headers.get(\"Authorization\")?.replace(\"Bearer \", \"\");\n  console.log(\"➡️ Authorization header:\", token);\n\n  if (!token) {\n    return NextResponse.json({ error: \"Missing auth token\" }, { status: 401 });\n  }\n\n  // 🟢 Luo uusi supabase-client tokenin kanssa\n  const supabase = createClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      global: {\n        headers: { Authorization: `Bearer ${token}` },\n      },\n    }\n  );\n\n  const { data: { user }, error: userError } = await supabase.auth.getUser();\n\n  if (userError || !user) {\n    return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n  }\n\n  const { startDate, endDate, reason, message } = parsed.data;\n\n// Hae työntekijän rivi auth.id:n perusteella\nconst { data: employee, error: empError } = await supabase\n  .from(\"employees\")\n  .select(\"id\")\n  .eq(\"auth_user_id\", user.id)\n  .single();\n\nif (empError || !employee) {\n  return NextResponse.json({ error: \"Employee not found for this user\" }, { status: 404 });\n}\n\n// Käytä employees.id foreign keynä\nconst { data, error } = await supabase\n  .from(\"time_off_requests\")\n  .insert({\n    employee_id: employee.id,   // ✅ oikea id employees-taulusta\n    start_date: startDate,\n    end_date: endDate,\n    reason,\n    message,\n    status: \"pending\",\n  })\n  .select()\n  .single();\n\n  if (error) {\n    console.error(\"❌ Insert error:\", error);\n    return NextResponse.json({ error: error.message }, { status: 500 });\n  }\n\n  console.log(\"✅ Inserted request:\", data);\n  return NextResponse.json({ ok: true, request: data });\n}\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 81
        }
      ]
    },
    {
      "path": "src/app/components/ui/NotificationsPopover.tsx",
      "size": 7845,
      "sha256": "0431e0d7cc17e25acc78a7e2a2761397e814c394e740353c8769ec239c5d3170",
      "lang": "tsx",
      "lines": 248,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/ui/NotificationsPopover.tsx",
      "chunks": [
        {
          "i": 0,
          "text": "\"use client\";\n\nimport React from \"react\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"./popover\";\nimport { Button } from \"./button\";\nimport { Badge } from \"./badge\";\nimport { Separator } from \"./separator\";\nimport { Bell, Check, Calendar, UserPlus, Wand2, AlertCircle } from \"lucide-react\";\nimport { supabase } from \"@/lib/supaBaseClient\";\nimport { toast } from \"sonner\";\nimport { requestPermissionAndSubscribe } from \"@/lib/pushClient\";\nimport { logError, logInfo } from \"@/lib/logger\";\n\n// NotificationsPopover.tsx, importtien jälkeen\n\n\n// korvaa koko enablePush\nasync function enablePush() {\n  try {\n    await requestPermissionAndSubscribe();\n    toast.success(\"Push-ilmoitukset käytössä\");\n  } catch (e) {\n    logError(\"notifications enablePush FAILED\", e);\n    toast.error(\"Pushin käyttöönotto epäonnistui\");\n  }\n}\n\n\nasync function disablePush() {\n  try {\n    // Poistetaan kaikki tämän SW-rekisterin tilaukset\n    const reg = await navigator.serviceWorker.getRegistration();\n    if (reg) {\n      const sub = await reg.pushManager.getSubscription();\n      if (sub) {\n        await supabase.from(\"push_subscriptions\").delete().eq(\"endpoint\", sub.endpoint);\n        await sub.unsubscribe();\n      }\n    }\n    toast.success(\"Push-ilmoitukset poistettu käytöstä\");\n  } catch (e) {\n    logError(\"notifications disablePush FAILED\", e);\n    toast.error(\"Pushin poisto epäonnistui\");\n  }\n}\n\n\ntype NotiType =\n  | \"absence_request\"\n  | \"absence_approved\"\n  | \"absence_declined\"\n  | \"employee_added\"\n  | \"shift_auto\";\n\ntype Noti = {\n  id: string;\n  created_at: string;\n  type: NotiType;\n  title: string;\n  message: string;\n  is_read: boolean;\n};\n\nfunction iconFor(type: Noti[\"type\"]) {\n  switch (type) {\n    case \"absence_request\":\n      return <AlertCircle className=\"w-4 h-4 text-amber-600\" />;\n    case \"absence_approved\":\n      return <Check className=\"w-4 h-4 text-green-600\" />;\n    case \"absence_declined\":\n      return <AlertCircle className=\"w-4 h-4 text-red-600\" />;\n    case \"employee_added\":\n      return <UserPlus className=\"w-4 h-4 text-blue-600\" />;\n    case \"shift_auto\":\n      return <Wand2 className=\"w-4 h-4 text-indigo-600\" />;\n    default:\n      return <Bell className=\"w-4 h-4\" />;\n  }\n}\n\n\nfunction timeAgo(iso: string) {\n  const diff = Math.max(0, Date.now() - new Date(iso).getTime());\n  const m = Math.floor(diff / 60000);\n  if (m < 1) return \"juuri äsken\";\n  if (m < 60) return `${m} min sitten`;\n  const h = Math.floor(m / 60);\n  if (h < 24) return `${h} h sitten`;\n  const d = Math.floor(h / 24);\n  return `${d} pv sitten`;\n}\n\nexport default function NotificationsPopover() {\n  const [open, setOpen] = React.useState(false);\n  const [items, setItems] = React.useState<Noti[]>([]);\n  const unread = items.filter((n) => !n.is_read).length;\n\n\nconst [canWrite, setCanWrite] = React.useState(false);\n\n  React.useEffect(() => {\n    (async () => {\n     const { data: sessionRes } = await supabase.auth.getSession();\n     setCanWrite(!!sessionRes.session); // vain kirjautuneena saa merkitä luetuksi\n      const { data, error } = await supabase\n        .from(\"notifications\")\n        .select(\"*\")\n        .order(\"created_at\", { ascending: false })\n        .limit(50);\n      if (error) {\n        logError(\"notifications initial fetch FAILED\", error);\n      } else {\n        logInfo(\"notifications initial fetch OK\");\n        setItems((data ?? []) as Noti[]);\n      }\n    })();\n  }, []);\n\n    React.useEffect(() => {\n    if (!open) return;\n    (async () => {\n      const { data, error } = await supabase\n        .from(\"notifications\")\n        .select(\"*\")\n        .order(\"created_at\", { ascending: false })\n        .limit(50);\n      if (!error) setItems((data ?? []) as Noti[]);\n    })();\n  }, [open]);\n\n\nReact.useEffect(() => {\n  const ch = supabase\n    .channel(\"notifications-rt\")\n    .on(\n      \"postgres_changes\",\n      { event: \"*\", schema: \"public\", table: \"notifications\" },\n(payload) => {\n  const newRow = payload.new as Noti | null;\n  if (!newRow) return;\n\n  if (payload.eventType === \"INSERT\") {\n    setItems((prev) => [newRow, ...prev].slice(0, 50));\n  } else if (payload.eventType === \"UPDATE\") {\n    setItems((prev) =>\n      prev.map((n) => (n.id === newRow.id ? newRow : n))\n    );\n  }\n}\n\n    )\n    .subscribe();\n  return () => void supabase.removeChannel(ch);\n}, []);\n\n\n  async function markAllRead() {\n    if (!canWrite) { toast.error(\"Kirjaudu sisään merkataksesi ilmoituksia luetuiksi\"); return; }\n    const { error } = await supabase\n      .from(\"notifications\")\n      .update({ is_read: true })\n      .eq(\"is_read\", false);\n    if (error) {\n      logError(\"notifications markAllRead FAILED\", error);\n      toast.error(\"Merkintä epäonnistui\");\n      return;\n    }\n    setItems((prev) => prev.map((n) => ({ ...n, is_read: true })));\n  }\n\n // markRead – tee optimistic päivitys vain jos klikattu\nasync function markRead(id: string) {\n  if (!canWrite) { toast.error(\"Kirjaudu sisään merkataksesi ilmoituksia luetuiksi\"); return; }\n  setItems((prev) => prev.map((n) => (n.id === id ? { ...n, is_read: true } : n)));\n  const { error } = await supabase.from(\"notifications\").update({ is_read: true }).eq(\"id\", id);\n  if (error) {\n    logError(\"notifications markRead FAILED\", error);\n    toast.error(\"Merkintä epäonnistui\");\n  }\n}\n\n\n  return (\n    <Popover open={open} onOpenChange={setOpen}>\n      <PopoverTrigger asChild>\n        <Button variant=\"ghost\" size=\"sm\" className=\"relative\">\n          <Bell className=\"w-4 h-4\" />\n          {unread > 0 && (\n            <Badge variant=\"destructive\" className=\"absolute -top-1 -right-1 h-5 min-w-[20px] px-1 justify-center\">\n              {unread}\n            </Badge>\n          )}\n        </Button>\n      </PopoverTrigger>\n\n      <PopoverContent className=\"w-[420px] p-0\" align=\"end\">\n        <div className=\"p-3 flex items-center justify-between\">\n          <div className=\"font-medium\">Ilmoitukset</div>\n          <div className=\"text-xs text-muted-foreground\">{unread} lukematonta</div>\n        </div>\n        <Separator />\n        {items.length === 0 ? (\n          <div className=\"p-6 text-sm text-muted-foreground flex flex-col items-center gap-2\">\n            <Calendar className=\"w-5 h-5 opacity-60\" />\n            Ei ilmoituksia\n          </div>\n        ) : (\n          <div className=\"max-h-[360px] overflow-auto\">\n            {items.map((n) => (\n              <button\n                key={n.id}\n                onClick={() => markRead(n.id)}\n                className={`w-full text-left px-3 py-2 flex gap-2 hover:bg-accent transition ${\n                  n.is_read ? \"opacity-75\" : \"\"\n                }`}\n              >\n                <div className=\"mt-0.5\">{iconFor(n.type)}</div>\n                <div className=\"flex-1\">\n                  <div className=\"flex items-center gap-2\">\n                    <div className=\"font-medium text-sm\">{n.title}</div>\n                    {!n.is_read && <span className=\"w-1.5 h-1.5 rounded-full bg-foreground inline-block\" />}\n                  </div>\n                  <div className=\"text-xs text-muted-foreground\">{n.message}</div>\n                  <div className=\"text-[10px] text-muted-foreground mt-0.5\">{timeAgo(n.created_at)}</div>\n                </div>\n              </button>\n            ))}\n          </div>\n        )}\n<Separator />\n<div className=\"p-2 flex flex-wrap items-center justify-between gap-2\">\n  <Button variant=\"ghost\" size=\"sm\" className=\"shrink-0\" onClick={markAllRead}>\n    Merkitse kaikki luetuiksi\n  </Button>\n  <div className=\"flex flex-wrap gap-2\">\n    <Button variant=\"outline\" size=\"sm\" className=\"shrink-0\" onClick={enablePush}>\n      Ota push käyttöön\n    </Button>\n    <Button variant=\"ghost\" size=\"sm\" className=\"shrink-0\" onClick={disablePush}>\n      Poista push\n    </Button>\n  </div>\n</div>\n      </PopoverContent>\n    </Popover>\n  );\n}\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 247
        }
      ]
    },
    {
      "path": "src/app/components/ui/avatar.tsx",
      "size": 1104,
      "sha256": "d40b1cbabe71c094c6bcf089ac5702ec77623dbc75c770ca9f86530e03d6fea1",
      "lang": "tsx",
      "lines": 54,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/ui/avatar.tsx",
      "chunks": [
        {
          "i": 0,
          "text": "\"use client\";\n\nimport * as React from \"react\";\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\";\n\nimport { cn } from \"./utils\";\n\nfunction Avatar({\n  className,\n  ...props\n}: React.ComponentProps<typeof AvatarPrimitive.Root>) {\n  return (\n    <AvatarPrimitive.Root\n      data-slot=\"avatar\"\n      className={cn(\n        \"relative flex size-10 shrink-0 overflow-hidden rounded-full\",\n        className,\n      )}\n      {...props}\n    />\n  );\n}\n\nfunction AvatarImage({\n  className,\n  ...props\n}: React.ComponentProps<typeof AvatarPrimitive.Image>) {\n  return (\n    <AvatarPrimitive.Image\n      data-slot=\"avatar-image\"\n      className={cn(\"aspect-square size-full\", className)}\n      {...props}\n    />\n  );\n}\n\nfunction AvatarFallback({\n  className,\n  ...props\n}: React.ComponentProps<typeof AvatarPrimitive.Fallback>) {\n  return (\n    <AvatarPrimitive.Fallback\n      data-slot=\"avatar-fallback\"\n      className={cn(\n        \"bg-muted flex size-full items-center justify-center rounded-full\",\n        className,\n      )}\n      {...props}\n    />\n  );\n}\n\nexport { Avatar, AvatarImage, AvatarFallback };\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 53
        }
      ]
    },
    {
      "path": "src/app/components/ui/badge.tsx",
      "size": 1636,
      "sha256": "8329a0b50f818665f1aca05ab93c16b103178b463f2949234ee4416bbc7d3fe2",
      "lang": "tsx",
      "lines": 47,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/ui/badge.tsx",
      "chunks": [
        {
          "i": 0,
          "text": "import * as React from \"react\";\nimport { Slot } from \"@radix-ui/react-slot\";\nimport { cva, type VariantProps } from \"class-variance-authority\";\n\nimport { cn } from \"./utils\";\n\nconst badgeVariants = cva(\n  \"inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90\",\n        secondary:\n          \"border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90\",\n        destructive:\n          \"border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60\",\n        outline:\n          \"text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  },\n);\n\nfunction Badge({\n  className,\n  variant,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"span\"> &\n  VariantProps<typeof badgeVariants> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"span\";\n\n  return (\n    <Comp\n      data-slot=\"badge\"\n      className={cn(badgeVariants({ variant }), className)}\n      {...props}\n    />\n  );\n}\n\nexport { Badge, badgeVariants };\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 46
        }
      ]
    },
    {
      "path": "src/app/components/ui/button.tsx",
      "size": 2106,
      "sha256": "a3f96150fdf0c929eec3759673cc34b2cf5538fc088b25a54c00e0a3ed1c3f60",
      "lang": "tsx",
      "lines": 59,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/ui/button.tsx",
      "chunks": [
        {
          "i": 0,
          "text": "import * as React from \"react\";\nimport { Slot } from \"@radix-ui/react-slot\";\nimport { cva, type VariantProps } from \"class-variance-authority\";\n\nimport { cn } from \"./utils\";\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-primary text-primary-foreground hover:bg-primary/90\",\n        destructive:\n          \"bg-destructive text-white hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60\",\n        outline:\n          \"border bg-background text-foreground hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50\",\n        secondary:\n          \"bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        ghost:\n          \"hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50\",\n        link: \"text-primary underline-offset-4 hover:underline\",\n      },\n      size: {\n        default: \"h-9 px-4 py-2 has-[>svg]:px-3\",\n        sm: \"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5\",\n        lg: \"h-10 rounded-md px-6 has-[>svg]:px-4\",\n        icon: \"size-9 rounded-md\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  },\n);\n\nfunction Button({\n  className,\n  variant,\n  size,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"button\"> &\n  VariantProps<typeof buttonVariants> & {\n    asChild?: boolean;\n  }) {\n  const Comp = asChild ? Slot : \"button\";\n\n  return (\n    <Comp\n      data-slot=\"button\"\n      className={cn(buttonVariants({ variant, size, className }))}\n      {...props}\n    />\n  );\n}\n\nexport { Button, buttonVariants };\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 58
        }
      ]
    },
    {
      "path": "src/app/components/ui/card.tsx",
      "size": 1988,
      "sha256": "afc99cfa090791e394e68766095a4a86f5f6140521546b32d4b298061d72473f",
      "lang": "tsx",
      "lines": 93,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/ui/card.tsx",
      "chunks": [
        {
          "i": 0,
          "text": "import * as React from \"react\";\n\nimport { cn } from \"./utils\";\n\nfunction Card({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"card\"\n      className={cn(\n        \"bg-card text-card-foreground flex flex-col gap-6 rounded-xl border\",\n        className,\n      )}\n      {...props}\n    />\n  );\n}\n\nfunction CardHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"card-header\"\n      className={cn(\n        \"@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-1.5 px-6 pt-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6\",\n        className,\n      )}\n      {...props}\n    />\n  );\n}\n\nfunction CardTitle({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <h4\n      data-slot=\"card-title\"\n      className={cn(\"leading-none\", className)}\n      {...props}\n    />\n  );\n}\n\nfunction CardDescription({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <p\n      data-slot=\"card-description\"\n      className={cn(\"text-muted-foreground\", className)}\n      {...props}\n    />\n  );\n}\n\nfunction CardAction({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"card-action\"\n      className={cn(\n        \"col-start-2 row-span-2 row-start-1 self-start justify-self-end\",\n        className,\n      )}\n      {...props}\n    />\n  );\n}\n\nfunction CardContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"card-content\"\n      className={cn(\"px-6 [&:last-child]:pb-6\", className)}\n      {...props}\n    />\n  );\n}\n\nfunction CardFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"card-footer\"\n      className={cn(\"flex items-center px-6 pb-6 [.border-t]:pt-6\", className)}\n      {...props}\n    />\n  );\n}\n\nexport {\n  Card,\n  CardHeader,\n  CardFooter,\n  CardTitle,\n  CardAction,\n  CardDescription,\n  CardContent,\n};\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 92
        }
      ]
    },
    {
      "path": "src/app/components/ui/checkbox.tsx",
      "size": 1244,
      "sha256": "894eb30992723a15e3ae75c46a3bf8808a526f5b3bff2c61c78f4d3e8d521cb8",
      "lang": "tsx",
      "lines": 33,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/ui/checkbox.tsx",
      "chunks": [
        {
          "i": 0,
          "text": "\"use client\";\n\nimport * as React from \"react\";\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\";\nimport { CheckIcon } from \"lucide-react\";\n\nimport { cn } from \"./utils\";\n\nfunction Checkbox({\n  className,\n  ...props\n}: React.ComponentProps<typeof CheckboxPrimitive.Root>) {\n  return (\n    <CheckboxPrimitive.Root\n      data-slot=\"checkbox\"\n      className={cn(\n        \"peer border bg-input-background dark:bg-input/30 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground dark:data-[state=checked]:bg-primary data-[state=checked]:border-primary focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive size-4 shrink-0 rounded-[4px] border shadow-xs transition-shadow outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50\",\n        className,\n      )}\n      {...props}\n    >\n      <CheckboxPrimitive.Indicator\n        data-slot=\"checkbox-indicator\"\n        className=\"flex items-center justify-center text-current transition-none\"\n      >\n        <CheckIcon className=\"size-3.5\" />\n      </CheckboxPrimitive.Indicator>\n    </CheckboxPrimitive.Root>\n  );\n}\n\nexport { Checkbox };\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 32
        }
      ]
    },
    {
      "path": "src/app/components/ui/dialog.tsx",
      "size": 3828,
      "sha256": "f4adc0065a7f795b5d99b8afe095a443d2d03b523cf5f958bc36ee7fbe0d3e45",
      "lang": "tsx",
      "lines": 136,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/ui/dialog.tsx",
      "chunks": [
        {
          "i": 0,
          "text": "\"use client\";\n\nimport * as React from \"react\";\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\";\nimport { XIcon } from \"lucide-react\";\n\nimport { cn } from \"./utils\";\n\nfunction Dialog({\n  ...props\n}: React.ComponentProps<typeof DialogPrimitive.Root>) {\n  return <DialogPrimitive.Root data-slot=\"dialog\" {...props} />;\n}\n\nfunction DialogTrigger({\n  ...props\n}: React.ComponentProps<typeof DialogPrimitive.Trigger>) {\n  return <DialogPrimitive.Trigger data-slot=\"dialog-trigger\" {...props} />;\n}\n\nfunction DialogPortal({\n  ...props\n}: React.ComponentProps<typeof DialogPrimitive.Portal>) {\n  return <DialogPrimitive.Portal data-slot=\"dialog-portal\" {...props} />;\n}\n\nfunction DialogClose({\n  ...props\n}: React.ComponentProps<typeof DialogPrimitive.Close>) {\n  return <DialogPrimitive.Close data-slot=\"dialog-close\" {...props} />;\n}\n\nfunction DialogOverlay({\n  className,\n  ...props\n}: React.ComponentProps<typeof DialogPrimitive.Overlay>) {\n  return (\n    <DialogPrimitive.Overlay\n      data-slot=\"dialog-overlay\"\n      className={cn(\n        \"data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50\",\n        className,\n      )}\n      {...props}\n    />\n  );\n}\n\nfunction DialogContent({\n  className,\n  children,\n  ...props\n}: React.ComponentProps<typeof DialogPrimitive.Content>) {\n  return (\n    <DialogPortal data-slot=\"dialog-portal\">\n      <DialogOverlay />\n      <DialogPrimitive.Content\n        data-slot=\"dialog-content\"\n        className={cn(\n          \"bg-background data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200 sm:max-w-lg\",\n          className,\n        )}\n        {...props}\n      >\n        {children}\n        <DialogPrimitive.Close className=\"ring-offset-background focus:ring-ring data-[state=open]:bg-accent data-[state=open]:text-muted-foreground absolute top-4 right-4 rounded-xs opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-hidden disabled:pointer-events-none [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4\">\n          <XIcon />\n          <span className=\"sr-only\">Close</span>\n        </DialogPrimitive.Close>\n      </DialogPrimitive.Content>\n    </DialogPortal>\n  );\n}\n\nfunction DialogHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"dialog-header\"\n      className={cn(\"flex flex-col gap-2 text-center sm:text-left\", className)}\n      {...props}\n    />\n  );\n}\n\nfunction DialogFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"dialog-footer\"\n      className={cn(\n        \"flex flex-col-reverse gap-2 sm:flex-row sm:justify-end\",\n        className,\n      )}\n      {...props}\n    />\n  );\n}\n\nfunction DialogTitle({\n  className,\n  ...props\n}: React.ComponentProps<typeof DialogPrimitive.Title>) {\n  return (\n    <DialogPrimitive.Title\n      data-slot=\"dialog-title\"\n      className={cn(\"text-lg leading-none font-semibold\", className)}\n      {...props}\n    />\n  );\n}\n\nfunction DialogDescription({\n  className,\n  ...props\n}: React.ComponentProps<typeof DialogPrimitive.Description>) {\n  return (\n    <DialogPrimitive.Description\n      data-slot=\"dialog-description\"\n      className={cn(\"text-muted-foreground text-sm\", className)}\n      {...props}\n    />\n  );\n}\n\nexport {\n  Dialog,\n  DialogClose,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogOverlay,\n  DialogPortal,\n  DialogTitle,\n  DialogTrigger,\n};\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 135
        }
      ]
    },
    {
      "path": "src/app/components/ui/input.tsx",
      "size": 963,
      "sha256": "cb82ffcd1a9accdf9b07edc8e976f43ad1c9cf91968ffd7639df5df14b7ad407",
      "lang": "tsx",
      "lines": 22,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/ui/input.tsx",
      "chunks": [
        {
          "i": 0,
          "text": "import * as React from \"react\";\n\nimport { cn } from \"./utils\";\n\nfunction Input({ className, type, ...props }: React.ComponentProps<\"input\">) {\n  return (\n    <input\n      type={type}\n      data-slot=\"input\"\n      className={cn(\n        \"file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input flex h-9 w-full min-w-0 rounded-md border px-3 py-1 text-base bg-input-background transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        \"focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]\",\n        \"aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive\",\n        className,\n      )}\n      {...props}\n    />\n  );\n}\n\nexport { Input };\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 21
        }
      ]
    },
    {
      "path": "src/app/components/ui/label.tsx",
      "size": 614,
      "sha256": "5ed157f039340cedaa59a888931db608667827170ae9538513a50ccf2ca65a9f",
      "lang": "tsx",
      "lines": 25,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/ui/label.tsx",
      "chunks": [
        {
          "i": 0,
          "text": "\"use client\";\n\nimport * as React from \"react\";\nimport * as LabelPrimitive from \"@radix-ui/react-label\";\n\nimport { cn } from \"./utils\";\n\nfunction Label({\n  className,\n  ...props\n}: React.ComponentProps<typeof LabelPrimitive.Root>) {\n  return (\n    <LabelPrimitive.Root\n      data-slot=\"label\"\n      className={cn(\n        \"flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50\",\n        className,\n      )}\n      {...props}\n    />\n  );\n}\n\nexport { Label };\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 24
        }
      ]
    },
    {
      "path": "src/app/components/ui/popover.tsx",
      "size": 1641,
      "sha256": "f14e16bebcfb1b605f6336d52153e43b76456c419930faea216d0ce2e3b1d3b7",
      "lang": "tsx",
      "lines": 49,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/ui/popover.tsx",
      "chunks": [
        {
          "i": 0,
          "text": "\"use client\";\n\nimport * as React from \"react\";\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\";\n\nimport { cn } from \"./utils\";\n\nfunction Popover({\n  ...props\n}: React.ComponentProps<typeof PopoverPrimitive.Root>) {\n  return <PopoverPrimitive.Root data-slot=\"popover\" {...props} />;\n}\n\nfunction PopoverTrigger({\n  ...props\n}: React.ComponentProps<typeof PopoverPrimitive.Trigger>) {\n  return <PopoverPrimitive.Trigger data-slot=\"popover-trigger\" {...props} />;\n}\n\nfunction PopoverContent({\n  className,\n  align = \"center\",\n  sideOffset = 4,\n  ...props\n}: React.ComponentProps<typeof PopoverPrimitive.Content>) {\n  return (\n    <PopoverPrimitive.Portal>\n      <PopoverPrimitive.Content\n        data-slot=\"popover-content\"\n        align={align}\n        sideOffset={sideOffset}\n        className={cn(\n          \"bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-72 origin-(--radix-popover-content-transform-origin) rounded-md border p-4 shadow-md outline-hidden\",\n          className,\n        )}\n        {...props}\n      />\n    </PopoverPrimitive.Portal>\n  );\n}\n\nfunction PopoverAnchor({\n  ...props\n}: React.ComponentProps<typeof PopoverPrimitive.Anchor>) {\n  return <PopoverPrimitive.Anchor data-slot=\"popover-anchor\" {...props} />;\n}\n\nexport { Popover, PopoverTrigger, PopoverContent, PopoverAnchor };\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 48
        }
      ]
    },
    {
      "path": "src/app/components/ui/scroll-area.tsx",
      "size": 1649,
      "sha256": "5bd9bb1d6909467b431283e96d2a9c83003bca1aa043d149dcfed8e81de51986",
      "lang": "tsx",
      "lines": 59,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/ui/scroll-area.tsx",
      "chunks": [
        {
          "i": 0,
          "text": "\"use client\";\n\nimport * as React from \"react\";\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\";\n\nimport { cn } from \"./utils\";\n\nfunction ScrollArea({\n  className,\n  children,\n  ...props\n}: React.ComponentProps<typeof ScrollAreaPrimitive.Root>) {\n  return (\n    <ScrollAreaPrimitive.Root\n      data-slot=\"scroll-area\"\n      className={cn(\"relative\", className)}\n      {...props}\n    >\n      <ScrollAreaPrimitive.Viewport\n        data-slot=\"scroll-area-viewport\"\n        className=\"focus-visible:ring-ring/50 size-full rounded-[inherit] transition-[color,box-shadow] outline-none focus-visible:ring-[3px] focus-visible:outline-1\"\n      >\n        {children}\n      </ScrollAreaPrimitive.Viewport>\n      <ScrollBar />\n      <ScrollAreaPrimitive.Corner />\n    </ScrollAreaPrimitive.Root>\n  );\n}\n\nfunction ScrollBar({\n  className,\n  orientation = \"vertical\",\n  ...props\n}: React.ComponentProps<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>) {\n  return (\n    <ScrollAreaPrimitive.ScrollAreaScrollbar\n      data-slot=\"scroll-area-scrollbar\"\n      orientation={orientation}\n      className={cn(\n        \"flex touch-none p-px transition-colors select-none\",\n        orientation === \"vertical\" &&\n          \"h-full w-2.5 border-l border-l-transparent\",\n        orientation === \"horizontal\" &&\n          \"h-2.5 flex-col border-t border-t-transparent\",\n        className,\n      )}\n      {...props}\n    >\n      <ScrollAreaPrimitive.ScrollAreaThumb\n        data-slot=\"scroll-area-thumb\"\n        className=\"bg-border relative flex-1 rounded-full\"\n      />\n    </ScrollAreaPrimitive.ScrollAreaScrollbar>\n  );\n}\n\nexport { ScrollArea, ScrollBar };\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 58
        }
      ]
    },
    {
      "path": "src/app/components/ui/select.tsx",
      "size": 6275,
      "sha256": "6aaf2111952394fbb8c64a505af02d08da28cc25726d61a991daebe400772480",
      "lang": "tsx",
      "lines": 190,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/ui/select.tsx",
      "chunks": [
        {
          "i": 0,
          "text": "\"use client\";\n\nimport * as React from \"react\";\nimport * as SelectPrimitive from \"@radix-ui/react-select\";\nimport {\n  CheckIcon,\n  ChevronDownIcon,\n  ChevronUpIcon,\n} from \"lucide-react\";\n\nimport { cn } from \"./utils\";\n\nfunction Select({\n  ...props\n}: React.ComponentProps<typeof SelectPrimitive.Root>) {\n  return <SelectPrimitive.Root data-slot=\"select\" {...props} />;\n}\n\nfunction SelectGroup({\n  ...props\n}: React.ComponentProps<typeof SelectPrimitive.Group>) {\n  return <SelectPrimitive.Group data-slot=\"select-group\" {...props} />;\n}\n\nfunction SelectValue({\n  ...props\n}: React.ComponentProps<typeof SelectPrimitive.Value>) {\n  return <SelectPrimitive.Value data-slot=\"select-value\" {...props} />;\n}\n\nfunction SelectTrigger({\n  className,\n  size = \"default\",\n  children,\n  ...props\n}: React.ComponentProps<typeof SelectPrimitive.Trigger> & {\n  size?: \"sm\" | \"default\";\n}) {\n  return (\n    <SelectPrimitive.Trigger\n      data-slot=\"select-trigger\"\n      data-size={size}\n      className={cn(\n        \"border-input data-[placeholder]:text-muted-foreground [&_svg:not([class*='text-'])]:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 dark:hover:bg-input/50 flex w-full items-center justify-between gap-2 rounded-md border bg-input-background px-3 py-2 text-sm whitespace-nowrap transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 data-[size=default]:h-9 data-[size=sm]:h-8 *:data-[slot=select-value]:line-clamp-1 *:data-[slot=select-value]:flex *:data-[slot=select-value]:items-center *:data-[slot=select-value]:gap-2 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4\",\n        className,\n      )}\n      {...props}\n    >\n      {children}\n      <SelectPrimitive.Icon asChild>\n        <ChevronDownIcon className=\"size-4 opacity-50\" />\n      </SelectPrimitive.Icon>\n    </SelectPrimitive.Trigger>\n  );\n}\n\nfunction SelectContent({\n  className,\n  children,\n  position = \"popper\",\n  ...props\n}: React.ComponentProps<typeof SelectPrimitive.Content>) {\n  return (\n    <SelectPrimitive.Portal>\n      <SelectPrimitive.Content\n        data-slot=\"select-content\"\n        className={cn(\n          \"bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 relative z-50 max-h-(--radix-select-content-available-height) min-w-[8rem] origin-(--radix-select-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border shadow-md\",\n          position === \"popper\" &&\n            \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n          className,\n        )}\n        position={position}\n        {...props}\n      >\n        <SelectScrollUpButton />\n        <SelectPrimitive.Viewport\n          className={cn(\n            \"p-1\",\n            position === \"popper\" &&\n              \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)] scroll-my-1\",\n          )}\n        >\n          {children}\n        </SelectPrimitive.Viewport>\n        <SelectScrollDownButton />\n      </SelectPrimitive.Content>\n    </SelectPrimitive.Portal>\n  );\n}\n\nfunction SelectLabel({\n  className,\n  ...props\n}: React.ComponentProps<typeof SelectPrimitive.Label>) {\n  return (\n    <SelectPrimitive.Label\n      data-slot=\"select-label\"\n      className={cn(\"text-muted-foreground px-2 py-1.5 text-xs\", className)}\n      {...props}\n    />\n  );\n}\n\nfunction SelectItem({\n  className,\n  children,\n  ...props\n}: React.ComponentProps<typeof SelectPrimitive.Item>) {\n  return (\n    <SelectPrimitive.Item\n      data-slot=\"select-item\"\n      className={cn(\n        \"focus:bg-accent focus:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground relative flex w-full cursor-default items-center gap-2 rounded-sm py-1.5 pr-8 pl-2 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4 *:[span]:last:flex *:[span]:last:items-center *:[span]:last:gap-2\",\n        className,\n      )}\n      {...props}\n    >\n      <span className=\"absolute right-2 flex size-3.5 items-center justify-center\">\n        <SelectPrimitive.ItemIndicator>\n          <CheckIcon className=\"size-4\" />\n        </SelectPrimitive.ItemIndicator>\n      </span>\n      <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n    </SelectPrimitive.Item>\n  );\n}\n\nfunction SelectSeparator({\n  className,\n  ...props\n}: React.ComponentProps<typeof SelectPrimitive.Separator>) {\n  return (\n    <SelectPrimitive.Separator\n      data-slot=\"select-separator\"\n      className={cn(\"bg-border pointer-events-none -mx-1 my-1 h-px\", className)}\n      {...props}\n    />\n  );\n}\n\nfunction SelectScrollUpButton({\n  className,\n  ...props\n}: React.ComponentProps<typeof SelectPrimitive.ScrollUpButton>) {\n  return (\n    <SelectPrimitive.ScrollUpButton\n      data-slot=\"select-scroll-up-button\"\n      className={cn(\n        \"flex cursor-default items-center justify-center py-1\",\n        className,\n      )}\n      {...props}\n    >\n      <ChevronUpIcon className=\"size-4\" />\n    </SelectPrimitive.ScrollUpButton>\n  );\n}\n\nfunction SelectScrollDownButton({\n  className,\n  ...props\n}: React.ComponentProps<typeof SelectPrimitive.ScrollDownButton>) {\n  return (\n    <SelectPrimitive.ScrollDownButton\n      data-slot=\"select-scroll-down-button\"\n      className={cn(\n        \"flex cursor-default items-center justify-center py-1\",\n        className,\n      )}\n      {...props}\n    >\n      <ChevronDownIcon className=\"size-4\" />\n    </SelectPrimitive.ScrollDownButton>\n  );\n}\n\nexport {\n  Select,\n  SelectContent,\n  SelectGroup,\n  SelectItem,\n  SelectLabel,\n  SelectScrollDownButton,\n  SelectScrollUpButton,\n  SelectSeparator,\n  SelectTrigger,\n  SelectValue,\n};\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 189
        }
      ]
    },
    {
      "path": "src/app/components/ui/separator.tsx",
      "size": 707,
      "sha256": "54cc34fc3ef7e445948c5bccf7307efbb2c8f9e63db0fc68dd3fa8ee54dc9812",
      "lang": "tsx",
      "lines": 29,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/ui/separator.tsx",
      "chunks": [
        {
          "i": 0,
          "text": "\"use client\";\n\nimport * as React from \"react\";\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\";\n\nimport { cn } from \"./utils\";\n\nfunction Separator({\n  className,\n  orientation = \"horizontal\",\n  decorative = true,\n  ...props\n}: React.ComponentProps<typeof SeparatorPrimitive.Root>) {\n  return (\n    <SeparatorPrimitive.Root\n      data-slot=\"separator-root\"\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"bg-border shrink-0 data-[orientation=horizontal]:h-px data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-px\",\n        className,\n      )}\n      {...props}\n    />\n  );\n}\n\nexport { Separator };\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 28
        }
      ]
    },
    {
      "path": "src/app/components/ui/slider.tsx",
      "size": 2006,
      "sha256": "19dd9d8b758f41fa61967d1a0540ea34ed989727258d23eef9a50cdebcab805b",
      "lang": "tsx",
      "lines": 64,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/ui/slider.tsx",
      "chunks": [
        {
          "i": 0,
          "text": "\"use client\";\n\nimport * as React from \"react\";\nimport * as SliderPrimitive from \"@radix-ui/react-slider\";\n\nimport { cn } from \"./utils\";\n\nfunction Slider({\n  className,\n  defaultValue,\n  value,\n  min = 0,\n  max = 100,\n  ...props\n}: React.ComponentProps<typeof SliderPrimitive.Root>) {\n  const _values = React.useMemo(\n    () =>\n      Array.isArray(value)\n        ? value\n        : Array.isArray(defaultValue)\n          ? defaultValue\n          : [min, max],\n    [value, defaultValue, min, max],\n  );\n\n  return (\n    <SliderPrimitive.Root\n      data-slot=\"slider\"\n      defaultValue={defaultValue}\n      value={value}\n      min={min}\n      max={max}\n      className={cn(\n        \"relative flex w-full touch-none items-center select-none data-[disabled]:opacity-50 data-[orientation=vertical]:h-full data-[orientation=vertical]:min-h-44 data-[orientation=vertical]:w-auto data-[orientation=vertical]:flex-col\",\n        className,\n      )}\n      {...props}\n    >\n      <SliderPrimitive.Track\n        data-slot=\"slider-track\"\n        className={cn(\n          \"bg-muted relative grow overflow-hidden rounded-full data-[orientation=horizontal]:h-4 data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-1.5\",\n        )}\n      >\n        <SliderPrimitive.Range\n          data-slot=\"slider-range\"\n          className={cn(\n            \"bg-primary absolute data-[orientation=horizontal]:h-full data-[orientation=vertical]:w-full\",\n          )}\n        />\n      </SliderPrimitive.Track>\n      {Array.from({ length: _values.length }, (_, index) => (\n        <SliderPrimitive.Thumb\n          data-slot=\"slider-thumb\"\n          key={index}\n          className=\"border-primary bg-background ring-ring/50 block size-4 shrink-0 rounded-full border shadow-sm transition-[color,box-shadow] hover:ring-4 focus-visible:ring-4 focus-visible:outline-hidden disabled:pointer-events-none disabled:opacity-50\"\n        />\n      ))}\n    </SliderPrimitive.Root>\n  );\n}\n\nexport { Slider };\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 63
        }
      ]
    },
    {
      "path": "src/app/components/ui/sonner.tsx",
      "size": 571,
      "sha256": "c5853f16cc11cb69e0115bab13eeabe7be5dad16fafd77b35cdfe4dbc64f0256",
      "lang": "tsx",
      "lines": 26,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/ui/sonner.tsx",
      "chunks": [
        {
          "i": 0,
          "text": "\"use client\";\n\nimport { useTheme } from \"next-themes\";\nimport { Toaster as Sonner, ToasterProps } from \"sonner\";\n\nconst Toaster = ({ ...props }: ToasterProps) => {\n  const { theme = \"system\" } = useTheme();\n\n  return (\n    <Sonner\n      theme={theme as ToasterProps[\"theme\"]}\n      className=\"toaster group\"\n      style={\n        {\n          \"--normal-bg\": \"var(--popover)\",\n          \"--normal-text\": \"var(--popover-foreground)\",\n          \"--normal-border\": \"var(--border)\",\n        } as React.CSSProperties\n      }\n      {...props}\n    />\n  );\n};\n\nexport { Toaster };\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 25
        }
      ]
    },
    {
      "path": "src/app/components/ui/switch.tsx",
      "size": 1182,
      "sha256": "d4c744131c6161300510909aafe2c2cb6d819f2c7a8c2aeb75d4317004c7eff7",
      "lang": "tsx",
      "lines": 32,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/ui/switch.tsx",
      "chunks": [
        {
          "i": 0,
          "text": "\"use client\";\n\nimport * as React from \"react\";\nimport * as SwitchPrimitive from \"@radix-ui/react-switch\";\n\nimport { cn } from \"./utils\";\n\nfunction Switch({\n  className,\n  ...props\n}: React.ComponentProps<typeof SwitchPrimitive.Root>) {\n  return (\n    <SwitchPrimitive.Root\n      data-slot=\"switch\"\n      className={cn(\n        \"peer data-[state=checked]:bg-primary data-[state=unchecked]:bg-switch-background focus-visible:border-ring focus-visible:ring-ring/50 dark:data-[state=unchecked]:bg-input/80 inline-flex h-[1.15rem] w-8 shrink-0 items-center rounded-full border border-transparent transition-all outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50\",\n        className,\n      )}\n      {...props}\n    >\n      <SwitchPrimitive.Thumb\n        data-slot=\"switch-thumb\"\n        className={cn(\n          \"bg-card dark:data-[state=unchecked]:bg-card-foreground dark:data-[state=checked]:bg-primary-foreground pointer-events-none block size-4 rounded-full ring-0 transition-transform data-[state=checked]:translate-x-[calc(100%-2px)] data-[state=unchecked]:translate-x-0\",\n        )}\n      />\n    </SwitchPrimitive.Root>\n  );\n}\n\nexport { Switch };\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 31
        }
      ]
    },
    {
      "path": "src/app/components/ui/tabs.tsx",
      "size": 1945,
      "sha256": "933b8f421bd84b21a22e3fd11cd62fbf4fd8b6fb7252f42ea706b9cd29255051",
      "lang": "tsx",
      "lines": 67,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/ui/tabs.tsx",
      "chunks": [
        {
          "i": 0,
          "text": "\"use client\";\n\nimport * as React from \"react\";\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\";\n\nimport { cn } from \"./utils\";\n\nfunction Tabs({\n  className,\n  ...props\n}: React.ComponentProps<typeof TabsPrimitive.Root>) {\n  return (\n    <TabsPrimitive.Root\n      data-slot=\"tabs\"\n      className={cn(\"flex flex-col gap-2\", className)}\n      {...props}\n    />\n  );\n}\n\nfunction TabsList({\n  className,\n  ...props\n}: React.ComponentProps<typeof TabsPrimitive.List>) {\n  return (\n    <TabsPrimitive.List\n      data-slot=\"tabs-list\"\n      className={cn(\n        \"bg-muted text-muted-foreground inline-flex h-9 w-fit items-center justify-center rounded-xl p-[3px] flex\",\n        className,\n      )}\n      {...props}\n    />\n  );\n}\n\nfunction TabsTrigger({\n  className,\n  ...props\n}: React.ComponentProps<typeof TabsPrimitive.Trigger>) {\n  return (\n    <TabsPrimitive.Trigger\n      data-slot=\"tabs-trigger\"\n      className={cn(\n        \"data-[state=active]:bg-card dark:data-[state=active]:text-foreground focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:outline-ring dark:data-[state=active]:border-input dark:data-[state=active]:bg-input/30 text-foreground dark:text-muted-foreground inline-flex h-[calc(100%-1px)] flex-1 items-center justify-center gap-1.5 rounded-xl border border-transparent px-2 py-1 text-sm font-medium whitespace-nowrap transition-[color,box-shadow] focus-visible:ring-[3px] focus-visible:outline-1 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4\",\n        className,\n      )}\n      {...props}\n    />\n  );\n}\n\nfunction TabsContent({\n  className,\n  ...props\n}: React.ComponentProps<typeof TabsPrimitive.Content>) {\n  return (\n    <TabsPrimitive.Content\n      data-slot=\"tabs-content\"\n      className={cn(\"flex-1 outline-none\", className)}\n      {...props}\n    />\n  );\n}\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent };\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 66
        }
      ]
    },
    {
      "path": "src/app/components/ui/textarea.tsx",
      "size": 767,
      "sha256": "6c3127c28ba1dda0428ba286a9e291c52ad95bfc8acd10518b262b71e470f3e7",
      "lang": "tsx",
      "lines": 19,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/ui/textarea.tsx",
      "chunks": [
        {
          "i": 0,
          "text": "import * as React from \"react\";\n\nimport { cn } from \"./utils\";\n\nfunction Textarea({ className, ...props }: React.ComponentProps<\"textarea\">) {\n  return (\n    <textarea\n      data-slot=\"textarea\"\n      className={cn(\n        \"resize-none border-input placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 flex field-sizing-content min-h-16 w-full rounded-md border bg-input-background px-3 py-2 text-base transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className,\n      )}\n      {...props}\n    />\n  );\n}\n\nexport { Textarea };\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 18
        }
      ]
    },
    {
      "path": "src/app/components/ui/tooltip.tsx",
      "size": 1897,
      "sha256": "2f3a8720fb4b75c6911450be73d0407e2a84bb5ea1ded28ccdbf955be62a0155",
      "lang": "tsx",
      "lines": 62,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/ui/tooltip.tsx",
      "chunks": [
        {
          "i": 0,
          "text": "\"use client\";\n\nimport * as React from \"react\";\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\";\n\nimport { cn } from \"./utils\";\n\nfunction TooltipProvider({\n  delayDuration = 0,\n  ...props\n}: React.ComponentProps<typeof TooltipPrimitive.Provider>) {\n  return (\n    <TooltipPrimitive.Provider\n      data-slot=\"tooltip-provider\"\n      delayDuration={delayDuration}\n      {...props}\n    />\n  );\n}\n\nfunction Tooltip({\n  ...props\n}: React.ComponentProps<typeof TooltipPrimitive.Root>) {\n  return (\n    <TooltipProvider>\n      <TooltipPrimitive.Root data-slot=\"tooltip\" {...props} />\n    </TooltipProvider>\n  );\n}\n\nfunction TooltipTrigger({\n  ...props\n}: React.ComponentProps<typeof TooltipPrimitive.Trigger>) {\n  return <TooltipPrimitive.Trigger data-slot=\"tooltip-trigger\" {...props} />;\n}\n\nfunction TooltipContent({\n  className,\n  sideOffset = 0,\n  children,\n  ...props\n}: React.ComponentProps<typeof TooltipPrimitive.Content>) {\n  return (\n    <TooltipPrimitive.Portal>\n      <TooltipPrimitive.Content\n        data-slot=\"tooltip-content\"\n        sideOffset={sideOffset}\n        className={cn(\n          \"bg-primary text-primary-foreground animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-fit origin-(--radix-tooltip-content-transform-origin) rounded-md px-3 py-1.5 text-xs text-balance\",\n          className,\n        )}\n        {...props}\n      >\n        {children}\n        <TooltipPrimitive.Arrow className=\"bg-primary fill-primary z-50 size-2.5 translate-y-[calc(-50%_-_2px)] rotate-45 rounded-[2px]\" />\n      </TooltipPrimitive.Content>\n    </TooltipPrimitive.Portal>\n  );\n}\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider };\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 61
        }
      ]
    },
    {
      "path": "src/app/components/ui/utils.ts",
      "size": 169,
      "sha256": "d1f1e0d62cb8d8d1e04c26e14de842d8a151f75812d81b046c65b5d1fe8e4b27",
      "lang": "typescript",
      "lines": 7,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/ui/utils.ts",
      "chunks": [
        {
          "i": 0,
          "text": "import { clsx, type ClassValue } from \"clsx\";\nimport { twMerge } from \"tailwind-merge\";\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs));\n}\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 6
        }
      ]
    },
    {
      "path": "src/app/api/employees/[id]/route.ts",
      "size": 4130,
      "sha256": "5768a820552fe2a89a46a2250c28b71257d7ced48135a36688fee818167a11d2",
      "lang": "typescript",
      "lines": 113,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/api/employees/[id]/route.ts",
      "chunks": [
        {
          "i": 0,
          "text": "import { NextResponse } from \"next/server\";\nimport { createClient } from \"@supabase/supabase-js\";\n\nexport async function PUT(\n  req: Request,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const { id } = await params; // Next 15: await params\n    const { name, email, department, isActive } = await req.json();\n\n    // Authorization header -pohjainen admin-check\n    const authHeader = req.headers.get(\"authorization\") ?? \"\";\n    if (!authHeader.toLowerCase().startsWith(\"bearer \")) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n\n    const userSb = createClient(\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\n      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n      {\n        auth: { persistSession: false, autoRefreshToken: false },\n        global: { headers: { Authorization: authHeader } },\n      }\n    );\n\n    const { data: userRes } = await userSb.auth.getUser();\n    if (!userRes?.user) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n\n    const { data: me, error: roleErr } = await userSb\n      .from(\"employees\")\n      .select(\"role\")\n      .eq(\"auth_user_id\", userRes.user.id)\n      .maybeSingle();\n    if (roleErr || !me || me.role !== \"admin\") {\n      return NextResponse.json({ error: \"Forbidden\" }, { status: 403 });\n    }\n\n    const adminSb = createClient(\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\n      process.env.SUPABASE_SERVICE_ROLE_KEY!,\n      { auth: { persistSession: false } }\n    );\n\n    const { data: current, error: curErr } = await adminSb\n      .from(\"employees\")\n      .select(\"id, name, email, department, is_active, auth_user_id\")\n      .eq(\"id\", id)\n      .maybeSingle();\n    if (curErr || !current) {\n      return NextResponse.json({ error: curErr?.message ?? \"Employee not found\" }, { status: 404 });\n    }\n\n    const updates: Record<string, any> = {};\n    if (name !== undefined) updates.name = String(name).trim();\n    if (department !== undefined) updates.department = String(department).trim();\n    if (isActive !== undefined) updates.is_active = !!isActive;\n\n    const newEmail = email !== undefined ? String(email).trim() : undefined;\n    const emailChanged = newEmail && newEmail !== current.email;\n\n    let recoveryLink: string | null = null;\n    if (emailChanged) {\n      const { error: updAuthErr } = await adminSb.auth.admin.updateUserById(current.auth_user_id, {\n        email: newEmail!,\n      });\n      if (updAuthErr) {\n        return NextResponse.json({ error: updAuthErr.message }, { status: 400 });\n      }\n\n      const appUrl = process.env.APP_URL ?? \"http://localhost:3000\";\n      const { data: linkRes, error: linkErr } = await adminSb.auth.admin.generateLink({\n        type: \"recovery\",\n        email: newEmail!,\n        options: { redirectTo: `${appUrl}/set-password` },\n      });\n      if (linkErr || !linkRes?.properties?.action_link) {\n        return NextResponse.json({ error: linkErr?.message ?? \"generateLink failed\" }, { status: 400 });\n      }\n      recoveryLink = linkRes.properties.action_link as string;\n      updates.email = newEmail;\n    }\n\n    let updated = current;\n    if (Object.keys(updates).length > 0) {\n      const { data: updRow, error: updErr } = await adminSb\n        .from(\"employees\")\n        .update(updates)\n        .eq(\"id\", id)\n        .select(\"id, name, email, department, is_active, auth_user_id\")\n        .single();\n      if (updErr) {\n        return NextResponse.json({ error: updErr.message }, { status: 400 });\n      }\n      updated = updRow!;\n    }\n\n    if (emailChanged && recoveryLink) {\n      await adminSb.from(\"email_queue\").insert({\n        recipient: newEmail!,\n        subject: \"Soili – päivitä salasanasi\",\n        body: `Hei ${updated.name},\\n\\nSähköpostisi on päivitetty. Aseta (tai päivitä) salasanasi tästä linkistä:\\n${recoveryLink}\\n\\nTerveisin,\\nSoili`,\n        status: \"queued\",\n      });\n    }\n\n    return NextResponse.json({ employee: updated, emailChanged: !!emailChanged }, { status: 200 });\n  } catch (e: any) {\n    return NextResponse.json({ error: e?.message ?? \"Internal error\" }, { status: 500 });\n  }\n}",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 113
        }
      ]
    },
    {
      "path": "supabase/functions/app_settings/index.ts",
      "size": 6743,
      "sha256": "e0dab0d5a7592314bcb6dd9929c03215f9d02d67bbb3f6821a5ff4a10cde7c0a",
      "lang": "typescript",
      "lines": 191,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/supabase/functions/app_settings/index.ts",
      "chunks": [
        {
          "i": 0,
          "text": "// supabase/functions/app_settings/index.ts\n// Täysin tuotantokelpoinen: CORS, auth-tarkistus, zod-validointi, GET/PUT\nimport { serve } from \"https://deno.land/std@0.224.0/http/server.ts\";\nimport { createClient } from \"https://esm.sh/@supabase/supabase-js@2.45.4\";\nimport { z } from \"https://deno.land/x/zod@v3.23.8/mod.ts\";\n\n// --- CORS + DEV bypass ---\nconst ALLOW_ORIGIN = (Deno.env.get(\"CORS_ORIGIN\") ?? \"*\").trim();\nconst DEV_ALLOW_NOAUTH =\n  (Deno.env.get(\"DEV_ALLOW_NOAUTH\") ?? \"false\").toLowerCase() === \"true\";\n\nfunction parseList(s: string) {\n  return s.split(\",\").map((x) => x.trim()).filter(Boolean);\n}\nconst ALLOWED_LIST = ALLOW_ORIGIN === \"*\" ? [] : parseList(ALLOW_ORIGIN);\n\nfunction pickOrigin(req: Request) {\n  const origin = req.headers.get(\"Origin\") ?? \"\";\n  if (ALLOW_ORIGIN === \"*\" || origin === \"\") return \"*\";\n  return ALLOWED_LIST.includes(origin) ? origin : \"null\";\n}\n\nfunction corsHeaders(origin: string) {\n  return {\n    \"Access-Control-Allow-Origin\": origin,\n    \"Access-Control-Allow-Methods\": \"GET,PUT,OPTIONS\",\n    \"Access-Control-Allow-Headers\":\n      \"authorization, content-type, x-client-info, apikey\",\n    Vary: \"Origin\",\n  };\n}\n\n// --- Admin-autentikointi (vain adminit saa kutsua) ---\n// Vähintään toinen näistä: (a) ADMIN_EMAILS env-listassa tai (b) userin profile.is_admin = true\nconst ADMIN_EMAILS = (Deno.env.get(\"ADMIN_EMAILS\") ?? \"\")\n  .split(\",\")\n  .map((s) => s.trim().toLowerCase())\n  .filter(Boolean);\n\n// Notification schema (synkassa settingsSchema.ts kanssa)\nconst NotifsSchema = z.object({\n  emailNotifications: z.boolean(),\n  adminNotificationEmails: z.array(z.string().email()).max(50),\n  absenceRequests: z.boolean(),\n  scheduleChanges: z.boolean(),\n  employeeUpdates: z.boolean(),\n  systemUpdates: z.boolean(),\n  dailyDigest: z.boolean(),\n  digestTime: z.string().regex(/^\\d{2}:\\d{2}$/),\n});\ntype Notifs = z.infer<typeof NotifsSchema>;\n\nasync function isAdmin(authClient: ReturnType<typeof createClient>) {\n  const {\n    data: { user },\n  } = await authClient.auth.getUser();\n  if (!user) return false;\n  const email = (user.email ?? \"\").toLowerCase();\n  if (ADMIN_EMAILS.includes(email)) return true;\n  const { data: prof } = await authClient\n    .from(\"profiles\")\n    .select(\"is_admin\")\n    .eq(\"id\", user.id)\n    .maybeSingle();\n  return !!prof?.is_admin;\n}\n\nserve(async (req) => {\n  // CORS\n  const origin = pickOrigin(req);\n  const base = corsHeaders(origin);\n  if (req.method === \"OPTIONS\") {\n    return new Response(null, { headers: base });\n  }\n\n   // 1) Admin-DB client (SERVICE ROLE) → käytä TÄTÄ kaikkiin DB-kirjoituksiin/lukuun\n  const supabaseAdmin = createClient(\n    Deno.env.get(\"SUPABASE_URL\")!,\n    Deno.env.get(\"SUPABASE_SERVICE_ROLE_KEY\")!\n  );\n\n  // 2) Auth client (ANON + request Authorization) → vain userin tarkistukseen\n  const supabaseAuth = createClient(\n    Deno.env.get(\"SUPABASE_URL\")!,\n    Deno.env.get(\"SUPABASE_ANON_KEY\")!,\n    { global: { headers: { Authorization: req.headers.get(\"Authorization\") ?? \"\" } } }\n  );\n\n  // DEV-bypass ennen admin-tarkistusta\n  const reqOrigin = req.headers.get(\"Origin\") ?? \"\";\n  const devBypassOk =\n    DEV_ALLOW_NOAUTH && (ALLOW_ORIGIN === \"*\" || ALLOWED_LIST.includes(reqOrigin));\n\n  if (!devBypassOk) {\n    const ok = await isAdmin(supabaseAuth);\n    if (!ok) {\n      return new Response(\n        JSON.stringify({ code: 401, message: \"Missing/invalid authorization\" }),\n        { status: 401, headers: { ...base, \"content-type\": \"application/json\" } }\n      );\n    }\n  }\n\n  try {\n    if (req.method === \"GET\") {\n      const { data, error } = await supabaseAdmin\n        .from(\"app_settings\")\n        .select(\n          \"email_notifications, admin_notification_emails, absence_requests, schedule_changes, employee_updates, system_updates, daily_digest, digest_time\"\n        )\n        .eq(\"id\", 1)\n        .maybeSingle();\n      if (error) throw error;\n\n      const notifs: Notifs = {\n        emailNotifications: data?.email_notifications ?? true,\n        adminNotificationEmails: data?.admin_notification_emails ?? [],\n        absenceRequests: data?.absence_requests ?? true,\n        scheduleChanges: data?.schedule_changes ?? true,\n        employeeUpdates: data?.employee_updates ?? false,\n        systemUpdates: data?.system_updates ?? false,\n        dailyDigest: data?.daily_digest ?? false,\n        digestTime: data?.digest_time ?? \"08:00\",\n      };\n      const parsed = NotifsSchema.safeParse(notifs);\n      const payload = parsed.success\n        ? parsed.data\n        : NotifsSchema.parse({\n            emailNotifications: true,\n            adminNotificationEmails: [],\n            absenceRequests: true,\n            scheduleChanges: true,\n            employeeUpdates: false,\n            systemUpdates: false,\n            dailyDigest: false,\n            digestTime: \"08:00\",\n          });\n      return new Response(\n        JSON.stringify({ notifications: payload }),\n        { headers: { ...base, \"content-type\": \"application/json\" } }\n      );\n    }\n\n    if (req.method === \"PUT\") {\n      const body = await req.json().catch(() => ({}));\n      const parsed = NotifsSchema.safeParse(body?.notifications);\n      if (!parsed.success) {\n        const msg = parsed.error.issues\n          .map((i) => `${i.path.join(\".\")}: ${i.message}`)\n          .join(\"; \");\n        return new Response(\n          JSON.stringify({ error: `Invalid notifications payload: ${msg}` }),\n          { status: 400, headers: { ...base, \"content-type\": \"application/json\" } }\n        );\n      }\n      const n = parsed.data;\n      const { error } = await supabaseAdmin\n        .from(\"app_settings\")\n        .upsert(\n          {\n            id: 1,\n            email_notifications: n.emailNotifications,\n            admin_notification_emails: n.adminNotificationEmails,\n            absence_requests: n.absenceRequests,\n            schedule_changes: n.scheduleChanges,\n            employee_updates: n.employeeUpdates,\n            system_updates: n.systemUpdates,\n            daily_digest: n.dailyDigest,\n            digest_time: n.digestTime,\n            updated_at: new Date().toISOString(),\n          },\n          { onConflict: \"id\" }\n        );\n      if (error) throw error;\n      return new Response(JSON.stringify({ ok: true }), {\n        headers: { ...base, \"content-type\": \"application/json\" },\n      });\n    }\n\n    return new Response(JSON.stringify({ error: \"Method Not Allowed\" }), {\n      status: 405,\n      headers: { ...base, \"content-type\": \"application/json\" },\n    });\n  } catch (e) {\n    console.error(\"[app_settings] error:\", e);\n    return new Response(\n      JSON.stringify({ error: e?.message ?? \"Unknown error\" }),\n      { status: 500, headers: { ...base, \"content-type\": \"application/json\" } }\n    );\n  }\n});",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 191
        }
      ]
    },
    {
      "path": "supabase/functions/mailer/index.ts",
      "size": 18303,
      "sha256": "76257e9dd657a79b43291772dee3d45c268a9737266f6e849298249eb43b7d8e",
      "lang": "typescript",
      "lines": 541,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/supabase/functions/mailer/index.ts",
      "chunks": [
        {
          "i": 0,
          "text": "// supabase/functions/mailer/index.ts\n// Prosessoi mailijonon: lähettää adminille mailin uusista poissaolopyynnöistä.\n// Ajastus: cronilla esim. joka minuutti.\n\nimport \"jsr:@supabase/functions-js/edge-runtime.d.ts\";\nimport { createClient } from \"https://esm.sh/@supabase/supabase-js@2\";\n\n// --- Types ---\ntype JobType = \"admin_new_absence\" | \"employee_shift_changed\" | \"employee_new_shift\" | \"employee_shift_deleted\" | string;\ntype ExtendedJobType = JobType | \"employee_new_shift\";\ntype EmployeeJobType = \"employee_shift_changed\" | \"employee_new_shift\" | \"employee_shift_deleted\";\nconst EMPLOYEE_JOB_TYPES: EmployeeJobType[] = [\"employee_shift_changed\",\"employee_new_shift\",\"employee_shift_deleted\"];\nconst MAIL_AGG_WINDOW_MIN = parseInt(Deno.env.get(\"MAIL_AGG_WINDOW_MIN\") ?? \"10\", 10);\n\ntype BaseJob = {\n  id: number;\n  type: ExtendedJobType;\n  payload: Record<string, unknown>;\n  status: \"queued\" | \"sent\" | \"failed\" | string;\n  attempt_count: number;\n  last_error?: string | null;\n  created_at: string;\n  processed_at?: string | null;\n};\n\n\ntype EmployeeShiftChangedPayload = {\n  shift_id: string;\n  employee_id: string;\n  work_date: string;\n  old_start?: string | null;\n  old_end?: string | null;\n  new_start?: string | null;\n  new_end?: string | null;\n};\n\ntype AppSettingsRow = {\n  email_notifications: boolean;\n  admin_notification_emails: string[];\n  absence_requests: boolean;\n  schedule_changes: boolean;\n  employee_updates: boolean;\n  system_updates: boolean;\n  daily_digest: boolean;\n  digest_time: string;\n};\n\ntype MailJobRow = BaseJob;\n\n// ---- ENV ----\nconst SUPABASE_URL = Deno.env.get(\"SUPABASE_URL\")!;\nconst SUPABASE_SERVICE_ROLE_KEY = Deno.env.get(\"SUPABASE_SERVICE_ROLE_KEY\")!;\nconst RESEND_API_KEY = Deno.env.get(\"RESEND_API_KEY\")!;\nconst FROM_EMAIL = Deno.env.get(\"FROM_EMAIL\") ?? \"Soili <onboarding@resend.dev>\";\n\nif (!SUPABASE_URL || !SUPABASE_SERVICE_ROLE_KEY) {\n  throw new Error(\"Missing SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY\");\n}\nif (!RESEND_API_KEY) {\n  throw new Error(\"Missing RESEND_API_KEY\");\n}\n\nconst sb = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY, {\n  auth: { persistSession: false },\n});\n\n// ---- Resend sender ----\nasync function sendEmail(to: string[] | string, subject: string, text: string) {\n  const resp = await fetch(\"https://api.resend.com/emails\", {\n    method: \"POST\",\n    headers: {\n      Authorization: `Bearer ${RESEND_API_KEY}`,\n      \"Content-Type\": \"application/json\",\n    },\n    body: JSON.stringify({\n      from: FROM_EMAIL,\n      to,\n      subject,\n      text,\n    }),\n  });\n\n  if (!resp.ok) {\n    const errText = await resp.text().catch(() => resp.statusText);\n    throw new Error(`Resend failed: ${resp.status} ${errText}`);\n  }\n}\n\n// ---- New: employee new shift ----\nasync function processEmployeeNewShift(job: BaseJob, settings: AppSettingsRow) {\n  if (!settings.email_notifications) return \"skipped: email_notifications=false\";\n  if (!settings.schedule_changes)    return \"skipped: schedule_changes=false\";\n\n  const p = job.payload;\n  const empId = String(p.employee_id ?? \"\");\n  if (!empId) return \"skipped: no employee_id\";\n\n  const { data: emp, error: empErr } = await sb\n    .from(\"employees\")\n    .select(\"email,name\")\n    .eq(\"id\", empId)\n    .maybeSingle();\n  if (empErr) throw empErr;\n  const to = emp?.email;\n  if (!to) return \"skipped: employee has no email\";\n\n  const date = String(p.work_date ?? \"\");\n  const s = p.start ? String(p.start) : \"\";\n  const e = p.end   ? String(p.end)   : \"\";\n\n  const subject = `Sinulle on lisätty uusi työvuoro (${date})`;\n  const lines = [\n    emp?.name ? `Hei ${emp.name},` : \"Hei,\",\n    \"\",\n    \"Sinulle on lisätty uusi työvuoro:\",\n    `Aika: ${s}${e ? ` – ${e}` : \"\"}`,\n    date ? `Päivä: ${date}` : null,\n    \"\",\n    \"Terveisin,\",\n    \"Soili\",\n  ].filter(Boolean).join(\"\\n\");\n\n  await sendEmail([to], subject, lines);\n  return \"sent\";\n}\n\n// ---- New: employee shift deleted ----\nasync function processEmployeeShiftDeleted(job: BaseJob, settings: AppSettingsRow) {\n  if (!settings.email_notifications) return \"skipped: email_notifications=false\";\n  if (!settings.schedule_changes)    return \"skipped: schedule_changes=false\";\n\n  const p = job.payload;\n  const empId = String(p.employee_id ?? \"\");\n  if (!empId) return \"skipped: no employee_id\";\n\n  const { data: emp, error: empErr } = await sb\n    .from(\"employees\")\n    .select(\"email,name\")\n    .eq(\"id\", empId)\n    .maybeSingle();\n  if (empErr) throw empErr;\n  const to = emp?.email;\n  if (!to) return \"skipped: employee has no email\";\n\n  const date = String(p.work_date ?? \"\");\n  const s = p.start ? String(p.start) : \"\";\n  const e = p.end   ? String(p.end)   : \"\";\n\n  const subject = `Vuorosi on peruttu (${date})`;\n  const lines = [\n    emp?.name ? `Hei ${emp.name},` : \"Hei,\",\n    \"\",\n    \"Sinulle merkitty työvuoro on poistettu.\",\n    (s || e) ? `Aika: ${s}${e ? ` – ${e}` : \"\"}` : null,\n    date ? `Päivä: ${date}` : null,\n    \"\",\n    \"Jos tämä on virhe, ole yhteydessä esihenkilöösi.\",\n    \"\",\n    \"Terveisin,\",\n    \"Soili\",\n  ].filter(Boolean).join(\"\\n\");\n\n  await sendEmail([to], subject, lines);\n  return \"sent\";\n}\n\n// ---- Process shift publication ----\nasync function processShiftPublication(job: BaseJob, settings: AppSettingsRow) {\n  if (!settings.email_notifications) return \"skipped: email_notifications=false\";\n  if (!settings.schedule_changes) return \"skipped: schedule_changes=false\";\n\n  const p = job.payload;\n  const empId = String(p.employee_id ?? \"\");\n  if (!empId) return \"skipped: no employee_id\";\n\n  // Hae työntekijän email\n  const { data: emp, error: empErr } = await sb\n    .from(\"employees\")\n    .select(\"email,name\")\n    .eq(\"id\", empId)\n    .maybeSingle();\n  if (empErr) throw empErr;\n  const to = emp?.email;\n  if (!to) return \"skipped: employee has no email\";\n\n  const date = String(p.work_date ?? \"\");\n  const hours = p.hours ? String(p.hours) : \"\";\n  const type = String(p.type ?? \"\");\n\n  const subject = `Vuorosi on julkaistu (${date})`;\n  const lines = [\n    emp?.name ? `Hei ${emp.name},` : \"Hei,\",\n    \"\",\n    \"Sinulle on julkaistu uusi työvuoro:\",\n    date ? `Päivä: ${date}` : null,\n    hours ? `Tunnit: ${hours}` : null,\n    type ? `Tyyppi: ${type}` : null,\n    \"\",\n    \"Terveisin,\",\n    \"Soili\",\n  ].filter(Boolean);\n\n  const text = lines.join(\"\\n\");\n\n  await sendEmail([to], subject, text);\n  return \"sent\";\n}\n\n\n// =============== BULK MELUNESTO: KOONTI 5–10 MIN IKKUNASSA ===============\n// Perusidea: kun törmätään yhteen employee_* jobiin, kerätään kaikki saman työntekijän\n// queued/tuoreet jobit viimeisten N minuuttien sisällä, merkitään ne 'processing',\n// lähetetään YKSI koontimaili ja merkataan kaikki 'sent'.\n\nfunction cutoffISO(min: number) {\n  return new Date(Date.now() - min * 60_000).toISOString();\n}\n\nfunction isEmployeeJob(t: string): t is EmployeeJobType {\n  return (EMPLOYEE_JOB_TYPES as string[]).includes(t);\n}\n\nasync function claimViaRpc(employeeId: string, sinceISO: string, limit = 200) {\n  const { data, error } = await sb.rpc(\"claim_employee_jobs\", {\n    p_employee_id: employeeId,\n    p_since: sinceISO,\n    p_types: EMPLOYEE_JOB_TYPES,\n    p_limit: limit,\n  });\n  if (error) throw error;\n  // supabase-js v2 palauttaa data: any[]; tyypitetään kevyesti\n  return (data ?? []) as BaseJob[];\n}\n\n\nfunction fmtTimeMaybe(s?: string | null) {\n  if (!s) return \"\";\n  return String(s);\n}\n\nfunction summarizeEmployeeJobs(jobs: MailJobRow[]) {\n  // Palauttaa rivit ja laskurit\n  const lines: string[] = [];\n  let added = 0, changed = 0, deleted = 0;\n  // Lajittele ajankohdan mukaan display-friendly\n  jobs.sort((a, b) => (a.created_at < b.created_at ? -1 : 1));\n  for (const j of jobs) {\n    const p = j.payload;\n    const date = String(p[\"work_date\"] ?? \"\");\n    if (j.type === \"employee_new_shift\") {\n      added++;\n      const s = fmtTimeMaybe(p[\"start\"] as string | undefined);\n      const e = fmtTimeMaybe(p[\"end\"] as string | undefined);\n      lines.push(`• Uusi vuoro ${date}${s || e ? ` (${s}${e ? `–${e}` : \"\"})` : \"\"}`);\n    } else if (j.type === \"employee_shift_changed\") {\n      changed++;\n      const os = fmtTimeMaybe(p[\"old_start\"] as string | undefined);\n      const oe = fmtTimeMaybe(p[\"old_end\"] as string | undefined);\n      const ns = fmtTimeMaybe(p[\"new_start\"] as string | undefined);\n      const ne = fmtTimeMaybe(p[\"new_end\"] as string | undefined);\n      lines.push(`• Vuoro päivitetty ${date}: ${os || oe ? `${os}–${oe} ⇒ ` : \"\"}${ns}–${ne}`);\n    } else if (j.type === \"employee_shift_deleted\") {\n      deleted++;\n      const s = fmtTimeMaybe(p[\"start\"] as string | undefined);\n      const e = fmtTimeMaybe(p[\"end\"] as string | undefined);\n      lines.push(`• Vuoro poistettu ${date}${s || e ? ` (${s}${e ? `–${e}` : \"\"})` : \"\"}`);\n    }\n  }\n  return { lines, added, changed, deleted };\n}\n\ntype AggregationResult =\n  | { kind: \"handled\"; claimedIds: number[]; count: number }\n  | { kind: \"failed\"; claimedIds: number[]; error: string }\n  | { kind: \"fallback\" };\n\nasync function processEmployeeJobsAggregated(anchorJob: BaseJob, settings: AppSettingsRow): Promise<AggregationResult> {\n  if (!settings.email_notifications || !settings.schedule_changes) return \"skipped: schedule notifications off\";\n  const empId = String(anchorJob.payload[\"employee_id\"] ?? \"\");\n  if (!empId) return \"skipped: no employee_id\";\n\n  // Hae vastaanottaja\n  const { data: emp, error: empErr } = await sb\n    .from(\"employees\")\n    .select(\"email,name\")\n    .eq(\"id\", empId)\n    .maybeSingle();\n  if (empErr) throw empErr;\n  const to = emp?.email;\n  if (!to) return \"skipped: employee has no email\";\n\n  const since = cutoffISO(MAIL_AGG_WINDOW_MIN);\n  const claimed = await claimViaRpc(empId, since);\n  if (!claimed.length) {\n    // Ei mitään koottavaa tämän ankkurin ympärille → anna kutsujan hoitaa fallback\n    return { kind: \"fallback\" };\n  }\n\n  const { lines, added, changed, deleted } = summarizeEmployeeJobs(claimed);\n  if (lines.length === 0) {\n    await sb.from(\"mail_jobs\")\n      .update({ status: \"sent\", processed_at: new Date().toISOString(), last_error: null })\n      .in(\"id\", claimed.map(j => j.id));\n    return { kind: \"handled\", claimedIds: claimed.map(j => j.id), count: 0 };\n  }\n\n  // subject esim: \"Työvuoripäivitykset (5 kpl) – <päivämäärä>\"\n  const total = added + changed + deleted;\n  const today = new Date().toISOString().slice(0,10);\n  const subject = `Työvuoripäivitykset (${total} kpl) – ${today}`;\n  const greeting = emp?.name ? `Hei ${emp.name},` : \"Hei,\";\n  const text = [\n    greeting, \"\", \n    \"Tässä viimeisimmät muutokset työvuoroihisi:\", \n    \"\", \n    ...lines, \n    \"\", \n    \"Terveisin,\", \n    \"Soili\"\n  ].join(\"\\n\");\n\n  try {\n    await sendEmail([to], subject, text);\n    // Merkkaa kaikki claimed sentiksi\n    await sb.from(\"mail_jobs\")\n      .update({ status: \"sent\", processed_at: new Date().toISOString(), last_error: null })\n      .in(\"id\", claimed.map(j => j.id));\n    return { kind: \"handled\", claimedIds: claimed.map(j => j.id), count: total };\n  } catch (e) {\n    const msg = e instanceof Error ? e.message : String(e);\n    await sb.from(\"mail_jobs\")\n      .update({ status: \"failed\", processed_at: new Date().toISOString(), last_error: msg.slice(0, 500) })\n      .in(\"id\", claimed.map(j => j.id));\n    return { kind: \"failed\", claimedIds: claimed.map(j => j.id), error: msg };\n  }\n}\n\n\n\n// ---- Load settings (DB is source of truth) ----\nasync function loadSettings(): Promise<AppSettingsRow> {\n  const { data, error } = await sb\n    .from(\"app_settings\")\n    .select(\"email_notifications, admin_notification_emails, absence_requests, schedule_changes, employee_updates, system_updates, daily_digest, digest_time\")\n    .eq(\"id\", 1)\n    .maybeSingle();\n  if (error) throw error;\n  return data ?? {\n    email_notifications: true,\n    admin_notification_emails: [],\n    absence_requests: true,\n    schedule_changes: true,\n    employee_updates: false,\n    system_updates: false,\n    daily_digest: false,\n    digest_time: \"08:00\",\n  };\n}\n\n// ---- Process one job ----\nasync function processAdminNewAbsence(job: BaseJob, settings: AppSettingsRow) {\n  if (!settings.email_notifications) return \"skipped: email_notifications=false\";\n  if (!settings.absence_requests) return \"skipped: absence_requests=false\";\n  const recipients = settings.admin_notification_emails ?? [];\n  if (!Array.isArray(recipients) || recipients.length === 0) return \"skipped: no recipients\";\n\n  // Hae nimi\n  const { data: emp, error: empErr } = await sb\n    .from(\"employees\")\n    .select(\"name\")\n    .eq(\"id\", String(job.payload.employee_id))\n    .maybeSingle();\n\n  if (empErr) throw empErr;\n\n  const employeeName = emp?.name ?? \"Tuntematon\";\n  const s = String(job.payload.start_date);\n  const e = (job.payload.end_date ?? job.payload.start_date) as string;\n\n  const subject = `Uusi poissaolopyyntö: ${employeeName} (${s}${e !== s ? `–${e}` : \"\"})`;\n  const lines = [\n    `Työntekijä: ${employeeName}`,\n    `Ajankohta: ${s}${e !== s ? ` – ${e}` : \"\"}`,\n    job.payload.reason ? `Syy: ${String(job.payload.reason)}` : null,\n    // Voit halutessa lisätä dashboard-linkin .env:iin, esim. DASHBOARD_URL\n    Deno.env.get(\"DASHBOARD_URL\") ? `Avaa hallinta: ${Deno.env.get(\"DASHBOARD_URL\")}` : null,\n  ].filter(Boolean);\n  const text = lines.join(\"\\n\");\n\n  await sendEmail(recipients, subject, text);\n  return \"sent\";\n}\n\n// ---- New: employee shift changed ----\nasync function processEmployeeShiftChanged(job: BaseJob, settings: AppSettingsRow) {\n  if (!settings.email_notifications) return \"skipped: email_notifications=false\";\n  if (!settings.schedule_changes)    return \"skipped: schedule_changes=false\";\n\n  const p = job.payload as EmployeeShiftChangedPayload;\n  const empId = String(p.employee_id ?? \"\");\n  if (!empId) return \"skipped: no employee_id\";\n\n  const { data: emp, error: empErr } = await sb\n    .from(\"employees\")\n    .select(\"email,name\")\n    .eq(\"id\", empId)\n    .maybeSingle();\n  if (empErr) throw empErr;\n  const to = emp?.email;\n  if (!to) return \"skipped: employee has no email\";\n\n  const date = String(p.work_date ?? \"\");\n  const oldS = p.old_start ? String(p.old_start) : \"\";\n  const oldE = p.old_end   ? String(p.old_end)   : \"\";\n  const newS = p.new_start ? String(p.new_start) : \"\";\n  const newE = p.new_end   ? String(p.new_end)   : \"\";\n\n  const subject = `Työvuorosi on muuttunut (${date})`;\n  const lines = [\n    emp?.name ? `Hei ${emp.name},` : \"Hei,\",\n    \"\",\n    \"Työvuoriasi on päivitetty:\",\n    (oldS || oldE) ? `Aiemmin: ${oldS} – ${oldE}` : null,\n    `Uusi:    ${newS} – ${newE}`,\n    date ? `Päivä:   ${date}` : null,\n    \"\",\n    \"Jos tämä ei käy, ole yhteydessä esihenkilöön.\",\n    \"\",\n    \"Terveisin,\",\n    \"Soili\",\n  ].filter(Boolean).join(\"\\n\");\n\n  await sendEmail([to], subject, lines);\n  return \"sent\";\n}\n\n\n// ---- Main queue loop ----\nasync function processQueue(limit = 25) {\n  const settings = await loadSettings();\n\n  const { data: jobs, error } = await sb\n    .from(\"mail_jobs\")\n    .select(\"*\")\n    .eq(\"status\", \"queued\")\n    .order(\"created_at\", { ascending: true })\n    .limit(limit);\n\n  if (error) throw error;\n  if (!jobs || jobs.length === 0) return { processed: 0 };\n\n  let success = 0;\n  let failed = 0;\n\n  // Koonti voi “nielaista” monta jobia kerralla. Pidetään kirjaa niistä, ettei\n  // samaa satsiä käsitellä uudestaan saman loopin myöhemmillä iteraatioilla.\n  const skipIds = new Set<number>();\n\n  for (const job of jobs as BaseJob[]) {\n    if (skipIds.has(job.id)) continue; // jo käsitelty osana koontia\n    try {\n      let outcome = \"skipped\";\n      if (job.type === \"admin_new_absence\") {\n        outcome = await processAdminNewAbsence(job, settings);\n      } else if (isEmployeeJob(job.type)) {\n        // UUSI: koonti viimeisen N minuutin ikkunassa\n        const agg = await processEmployeeJobsAggregated(job, settings);\n        if (agg.kind === \"handled\") {\n          agg.claimedIds.forEach(id => skipIds.add(id));\n          success++;\n          continue; // koonti hoiti statukset\n        }\n        if (agg.kind === \"failed\") {\n          agg.claimedIds.forEach(id => skipIds.add(id));\n          failed++;\n          continue; // koonti hoiti statukset failediksi\n        }\n        // agg.kind === \"fallback\" → käsitellään normaalisti yksittäisenä alla\n      } else if (job.type === \"employee_shift_changed\") {\n        // (varalle; normaalisti yllä oleva haaraa jo tämän)\n        outcome = await processEmployeeShiftChanged(job, settings);\n      } else if (job.type === \"employee_new_shift\") {\n        outcome = await processEmployeeNewShift(job, settings);\n      } else if (job.type === \"employee_shift_deleted\") {\n        outcome = await processEmployeeShiftDeleted(job, settings);\n      } else if (job.type === \"shift_publication\") {\n        outcome = await processShiftPublication(job, settings);\n      } else {\n        outcome = `skipped: unknown type ${job.type}`;\n      }\n\n      // Päivitä tila\n      await sb\n        .from(\"mail_jobs\")\n        .update({\n          status: outcome.startsWith(\"sent\")\n            ? \"sent\"\n            : outcome.startsWith(\"skipped\")\n            ? \"sent\"\n            : \"failed\",\n          attempt_count: job.attempt_count + 1,\n          last_error: outcome.startsWith(\"sent\") ? null : outcome,\n          processed_at: new Date().toISOString(),\n        })\n        .eq(\"id\", job.id);\n\n      if (outcome.startsWith(\"sent\")) success++;\n      else if (!outcome.startsWith(\"skipped\")) failed++;\n    } catch (e: unknown) {\n      failed++;\n      const msg = e instanceof Error ? e.message : String(e);\n      await sb\n        .from(\"mail_jobs\")\n        .update({\n          status: \"failed\",\n          attempt_count: job.attempt_count + 1,\n          last_error: msg.slice(0, 500),\n          processed_at: new Date().toISOString(),\n        })\n        .eq(\"id\", job.id);\n    }\n  }\n\n\n  return { processed: jobs.length, success, failed };\n}\n\n// ---- Edge entrypoint ----\nDeno.serve(async () => {\n  try {\n    const res = await processQueue(25);\n    return new Response(JSON.stringify(res), {\n      headers: { \"Content-Type\": \"application/json\" },\n    });\n  } catch (e: unknown) {\n    const msg = e instanceof Error ? e.message : String(e);\n    return new Response(JSON.stringify({ error: msg }), { status: 500 });\n  }\n});\n\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 540
        }
      ]
    },
    {
      "path": "supabase/functions/mailer_worker/index.ts",
      "size": 3432,
      "sha256": "87c4aeae0f55ae84595c75931769bc0a84894bb2355f356e24b36551248d1485",
      "lang": "typescript",
      "lines": 107,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/supabase/functions/mailer_worker/index.ts",
      "chunks": [
        {
          "i": 0,
          "text": "import \"jsr:@supabase/functions-js/edge-runtime.d.ts\";\nimport { createClient } from \"https://esm.sh/@supabase/supabase-js@2\";\n\nconst SUPABASE_URL = Deno.env.get(\"SUPABASE_URL\")!;\nconst SERVICE_KEY = Deno.env.get(\"SUPABASE_SERVICE_ROLE_KEY\")!;\nconst RESEND_API_KEY = Deno.env.get(\"RESEND_API_KEY\")!;\nconst FROM_EMAIL = Deno.env.get(\"FROM_EMAIL\") ?? \"Soili <no-reply@soiliapp.fi>\";\nconst BATCH_SIZE = parseInt(Deno.env.get(\"EMAIL_QUEUE_BATCH\") ?? \"5\", 10);\nconst RATE_MS = parseInt(Deno.env.get(\"EMAIL_QUEUE_RATE_MS\") ?? \"1000\", 10);\n\nconst sb = createClient(SUPABASE_URL, SERVICE_KEY, { auth: { persistSession: false } });\n\ntype EmailRow = {\n  id: number;\n  recipient: string;\n  subject: string;\n  body: string;\n};\n\nasync function delay(ms: number) {\n  return new Promise((res) => setTimeout(res, ms));\n}\n\nasync function sendWithResend(to: string, subject: string, text: string) {\n  const resp = await fetch(\"https://api.resend.com/emails\", {\n    method: \"POST\",\n    headers: {\n      Authorization: `Bearer ${RESEND_API_KEY}`,\n      \"Content-Type\": \"application/json\",\n    },\n    body: JSON.stringify({ from: FROM_EMAIL, to: [to], subject, text }),\n  });\n  if (!resp.ok) {\n    const errText = await resp.text().catch(() => resp.statusText);\n    throw new Error(`Resend failed: ${resp.status} ${errText}`);\n  }\n}\n\nasync function claimBatch(limit: number): Promise<EmailRow[]> {\n  // 1) Poimi queued-rivit\n  const { data: rows, error } = await sb\n    .from(\"email_queue\")\n    .select(\"id, recipient, subject, body\")\n    .eq(\"status\", \"queued\")\n    .order(\"created_at\", { ascending: true })\n    .limit(limit);\n  if (error) throw error;\n  if (!rows?.length) return [];\n\n  const ids = rows.map(r => r.id);\n\n  // 2) Yritä merkata processing-tilaan vain queued-riveille\n  const { error: updErr } = await sb\n    .from(\"email_queue\")\n    .update({ status: \"processing\" })\n    .in(\"id\", ids)\n    .eq(\"status\", \"queued\");\n  if (updErr) throw updErr;\n\n  // 3) Palauta vain todella claimatut\n  const { data: claimed, error: reErr } = await sb\n    .from(\"email_queue\")\n    .select(\"id, recipient, subject, body\")\n    .in(\"id\", ids)\n    .eq(\"status\", \"processing\");\n  if (reErr) throw reErr;\n\n  return (claimed ?? []) as EmailRow[];\n}\n\nasync function processBatch(limit = BATCH_SIZE) {\n  const batch = await claimBatch(limit);\n  if (batch.length === 0) return { picked: 0, sent: 0, failed: 0 };\n\n  let sent = 0, failed = 0;\n\n  for (let i = 0; i < batch.length; i++) {\n    const row = batch[i];\n    try {\n      await sendWithResend(row.recipient, row.subject, row.body);\n      await sb.from(\"email_queue\")\n        .update({ status: \"sent\", sent_at: new Date().toISOString(), error: null })\n        .eq(\"id\", row.id);\n      sent++;\n    } catch (e) {\n      const msg = e instanceof Error ? e.message : String(e);\n      await sb.from(\"email_queue\")\n        .update({ status: \"failed\", error: msg.slice(0, 500), sent_at: new Date().toISOString() })\n        .eq(\"id\", row.id);\n      failed++;\n    }\n    if (i < batch.length - 1) await delay(RATE_MS); // 2/s\n  }\n  return { picked: batch.length, sent, failed };\n}\n\nDeno.serve(async () => {\n  try {\n    const res = await processBatch(BATCH_SIZE);\n    return new Response(JSON.stringify(res), { headers: { \"Content-Type\": \"application/json\" } });\n  } catch (e) {\n    const msg = e instanceof Error ? e.message : String(e);\n    return new Response(JSON.stringify({ error: msg }), { status: 500 });\n  }\n});\n\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 106
        }
      ]
    },
    {
      "path": "supabase/functions/sendemail/index.ts",
      "size": 3495,
      "sha256": "468ae070ceb0b71ad678d9c93fd079c09ecd2dcd7ea7a5be2256da0fc8f16871",
      "lang": "typescript",
      "lines": 122,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/supabase/functions/sendemail/index.ts",
      "chunks": [
        {
          "i": 0,
          "text": "// supabase/functions/sendemail/index.ts\nimport \"jsr:@supabase/functions-js/edge-runtime.d.ts\";\nimport { Resend } from \"npm:resend@3\";\nimport { z } from \"npm:zod@3\";\n\nconst resend = new Resend(Deno.env.get(\"RESEND_API_KEY\") ?? \"\");\nconst FROM = Deno.env.get(\"FROM_EMAIL\") ?? \"Soili <no-reply@soiliwork.fi>\";\nconst ALLOWED_ORIGIN = Deno.env.get(\"ALLOWED_ORIGIN\") ?? \"*\";\n\nfunction corsHeaders(origin: string | null) {\n  const o = origin && ALLOWED_ORIGIN !== \"*\" ? ALLOWED_ORIGIN : \"*\";\n  return {\n    \"Access-Control-Allow-Origin\": o,\n    \"Access-Control-Allow-Methods\": \"POST, OPTIONS\",\n    \"Access-Control-Allow-Headers\":\n      \"authorization, x-client-info, apikey, content-type\",\n  };\n}\n\nconst BodySchema = z.object({\n  to: z.union([\n    z.string().email(),\n    z.array(z.string().email()).nonempty(),\n  ]),\n  subject: z.string().min(1),\n  text: z.string().optional(),\n  html: z.string().optional(),\n  replyTo: z.string().email().optional(),\n  _honey: z.string().optional(),\n});\n\nDeno.serve(async (req) => {\n  if (req.method === \"OPTIONS\") {\n    return new Response(\"ok\", { headers: corsHeaders(req.headers.get(\"Origin\")) });\n  }\n  if (req.method !== \"POST\") {\n    return new Response(\n      JSON.stringify({ error: \"Method Not Allowed\" }),\n      { status: 405, headers: { \"content-type\": \"application/json\", ...corsHeaders(req.headers.get(\"Origin\")) } },\n    );\n  }\n\n  try {\n    const raw = await req.clone().text();\n    let json: any = null;\n    try {\n      json = JSON.parse(raw);\n    } catch {\n      console.log(\"Body is not valid JSON\");\n    }\n\n    const origin = req.headers.get(\"Origin\");\n    const headers = { \"content-type\": \"application/json\", ...corsHeaders(origin) };\n\n    const auth = req.headers.get(\"authorization\") ?? \"\";\n    if (!auth.toLowerCase().startsWith(\"bearer \")) {\n      return new Response(JSON.stringify({ error: \"Missing Authorization Bearer token\" }), {\n        status: 401,\n        headers,\n      });\n    }\n\n    if (!json) {\n      return new Response(JSON.stringify({ error: \"Invalid JSON body\" }), {\n        status: 400,\n        headers,\n      });\n    }\n\n    const parsed = BodySchema.safeParse(json);\n    if (!parsed.success) {\n      return new Response(JSON.stringify({\n        error: \"Invalid body\",\n        details: parsed.error.flatten(),\n      }), { status: 400, headers });\n    }\n\n    const { to, subject, text, html, replyTo, _honey } = parsed.data;\n\n    if (_honey && _honey.trim() !== \"\") {\n      return new Response(JSON.stringify({ ok: true, dropped: true }), {\n        status: 200,\n        headers,\n      });\n    }\n\n    if (!text && !html) {\n      return new Response(JSON.stringify({ error: \"Provide 'text' or 'html'\" }), {\n        status: 400,\n        headers,\n      });\n    }\n\n    // ✅ Tämä on se yksinkertainen ja oikea tapa\n    const sendRes = await resend.emails.send({\n      from: FROM,\n      to: Array.isArray(to) ? to : [to],\n      subject,\n      text: text ?? undefined,\n      html: html ?? undefined,\n      reply_to: replyTo,\n    });\n\n    if (sendRes.error) {\n      return new Response(JSON.stringify({\n        error: sendRes.error,\n      }), { status: 400, headers });\n    }\n\n    return new Response(JSON.stringify({\n      ok: true,\n      data: sendRes,\n    }), { status: 200, headers });\n\n  } catch (e) {\n    return new Response(JSON.stringify({\n      error: \"Internal error\",\n      details: String(e),\n    }), { status: 500, headers: { \"content-type\": \"application/json\", ...corsHeaders(req.headers.get(\"Origin\")) } });\n  }\n});\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 121
        }
      ]
    },
    {
      "path": "supabase/functions/soili-code/index.ts",
      "size": 8908,
      "sha256": "86bd51844a4290c077cca29170e43ee01346557ba60464df03c2e4dcc3cb586e",
      "lang": "typescript",
      "lines": 232,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/supabase/functions/soili-code/index.ts",
      "chunks": [
        {
          "i": 0,
          "text": "// supabase/functions/soili-code/index.ts\n// Ei ulkoisia importteja → toimii myös ilman deno.landia.\n\n\n\ntype Manifest = { files: { path: string; size: number; binary?: boolean }[] };\n\nconst ACTIONS_TOKEN = Deno.env.get(\"ACTIONS_TOKEN\") || \"\"; // aseta supabase secretsiin\nconsole.log(\"CONFIG ACTIONS_TOKEN\", ACTIONS_TOKEN ? \"[set]\" : \"[missing]\");\n\nconst PROJECT_ORIGINS = (Deno.env.get(\"ALLOWED_ORIGINS\") || \"https://chatgpt.com\").split(\",\");\nconst RAW_BASE =\n  Deno.env.get(\"RAW_BASE\") ||\n  \"https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/\";\nconst MANIFEST_URL =\n  Deno.env.get(\"MANIFEST_URL\") ||\n  \"https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/code-index.json\";\nconst MAX_BYTES = parseInt(Deno.env.get(\"MAX_BYTES\") || \"65536\", 10); // 64 KiB max palautus kerralla\n\n\nfunction corsHeaders(origin: string | null) {\n  const allowed = origin && PROJECT_ORIGINS.includes(origin) ? origin : PROJECT_ORIGINS[0];\n  return {\n    \"Access-Control-Allow-Origin\": allowed,\n    \"Vary\": \"Origin\",\n    // pienaakkosin + supabasen yleiset: authorization, content-type, x-client-info, apikey\n    \"Access-Control-Allow-Headers\": \"authorization, content-type, x-client-info, apikey\",\n    \"Access-Control-Allow-Methods\": \"GET, OPTIONS\",\n  };\n}\nfunction json(data: unknown, origin: string | null, status = 200) {\n  // lisää automaattisesti approved:true kaikkiin vastauksiin\n  const payload =\n    typeof data === \"object\" && data !== null\n      ? { ...(data as Record<string, unknown>), approved: true }\n      : { value: data, approved: true };\n\n  return new Response(JSON.stringify(payload), {\n    status,\n    headers: { ...corsHeaders(origin), \"Content-Type\": \"application/json\" },\n  });\n}\nfunction unauthorized(origin: string | null, code = 401, msg = \"unauthorized\") {\n  return json({ error: msg }, origin, code);\n}\n\nasync function loadManifest(): Promise<Manifest> {\n  const r = await fetch(MANIFEST_URL, { cache: \"no-store\" });\n  if (!r.ok) throw new Error(`manifest fetch failed: ${r.status}`);\n  return (await r.json()) as Manifest;\n}\nasync function loadAllowlist(): Promise<Set<string>> {\n  const m = await loadManifest();\n  return new Set(m.files.filter(f => !f.binary && f.size > 0).map(f => f.path));\n}\n\nasync function fetchText(path: string): Promise<{ text: string; length: number }> {\n  const url = RAW_BASE + path;\n  const r = await fetch(url);\n  if (!r.ok) throw new Error(`fetch failed: ${r.status}`);\n  const buf = new Uint8Array(await r.arrayBuffer());\n  // Dekoodaa turvallisesti UTF-8:na. (OK kooditiedostoille.)\n  const text = new TextDecoder(\"utf-8\", { fatal: false }).decode(buf);\n  return { text, length: text.length };\n}\n\nDeno.serve(async (req: Request) => {\n  const url = new URL(req.url);\n  const origin = req.headers.get(\"Origin\");\n  const rawPath = url.pathname;\n  const path = rawPath.startsWith(\"/soili-code\")\n    ? rawPath.slice(\"/soili-code\".length) || \"/\"\n    : rawPath;\n  console.log(\"EDGE START\", req.method, rawPath, \"→\", path);\n  console.log(\"  query:\", url.searchParams.toString());\n  console.log(\"  auth header:\", req.headers.get(\"authorization\"));\n  console.log(\"  x-actions-[REDACTED]x-actions-token\"));\n \n\n  // CORS preflight\n  if (req.method === \"OPTIONS\") {\n    return new Response(\"\", { status: 204, headers: corsHeaders(origin) });\n  }\n\n  // Auth: hyväksy mikä tahansa näistä:\n  // 1) Authorization: Bearer <ACTIONS_TOKEN>\n  // 2) x-actions-token: <ACTIONS_TOKEN>\n  // 3) ?token=<ACTIONS_TOKEN> (helpottaa builderin Testiä jos se sekoilee)\n  const auth = req.headers.get(\"authorization\") || \"\";\n  const bearer = auth.toLowerCase().startsWith(\"bearer \") ? auth.slice(7).trim() : \"\";\n  const headerToken = (req.headers.get(\"x-actions-token\") || \"\").trim();\n  const queryToken = (url.searchParams.get(\"token\") || \"\").trim();\n  const presented = bearer || headerToken || queryToken;\n   if (!ACTIONS_TOKEN) {\n    return json({ error: \"server misconfigured: ACTIONS_TOKEN missing\" }, origin, 500);\n  }\n  // DEBUG: salli anonyymit pyynnöt ilman tokenia\n  if (!presented) {\n    console.log(\"DEBUG auth bypass for connector, no token presented\");\n  } else if (presented !== ACTIONS_TOKEN) {\n    console.log(\"Auth mismatch:\", presented, \"expected\", ACTIONS_TOKEN);\n    return unauthorized(origin, 403, \"forbidden\");\n  }\n\n  // ROUTES\n  // 1) Health\nif (req.method === \"GET\" && path === \"/health\") {\n  return new Response(JSON.stringify({ status: \"ok\" }), {\n    headers: { ...corsHeaders(origin), \"Content-Type\": \"application/json\" },\n  });\n}\n\n  // 2) Manifest (palautetaan sellaisenaan, jotta GPT voi selata)\n  if (req.method === \"GET\" && path === \"/repo/manifest\") {\n    try {\n      const m = await loadManifest();\n      return json(m, origin);\n    } catch (e) {\n      return json({ error: `manifest error: ${(e as Error).message}` }, origin, 502);\n    }\n  }\n\n  // 3) List files (dir + depth)\n  if (req.method === \"GET\" && path === \"/files/list\") {\n    const dir = (url.searchParams.get(\"dir\") || \"\").replace(/^\\/*/, \"\"); // poista johtavat kauttaviivat\n    const depth = Math.min(Math.max(parseInt(url.searchParams.get(\"depth\") || \"1\", 10), 0), 5);\n    try {\n      const m = await loadManifest();\n      const out: string[] = [];\n      for (const f of m.files) {\n        if (f.binary || f.size <= 0) continue;\n        if (dir && !f.path.startsWith(dir)) continue;\n        if (dir) {\n          const rel = f.path.slice(dir.length).replace(/^\\/*/, \"\");\n          const d = rel.split(\"/\").length - 1;\n          if (d > depth) continue;\n        }\n        out.push(f.path);\n      }\n      return json({ files: out }, origin);\n    } catch (e) {\n      return json({ error: `list error: ${(e as Error).message}` }, origin, 502);\n    }\n  }\n\n// 4) Get whole file → pakotetaan käyttämään getChunkia\nif (req.method === \"GET\" && (path === \"/files/get\" || path === \"/code/get\")) {\n  console.log(\"DEBUG blocking /files/get, please use getChunk instead\");\n  return json({ error: \"please use getChunk instead\" }, origin, 400);\n}\n\n// PROXY: /proxy/getChunk?path=...&offset=...&length=...\nif (req.method === \"GET\" && path === \"/proxy/getChunk\") {\n  const p = url.searchParams.get(\"path\") || \"\";\n  const offset = Math.max(parseInt(url.searchParams.get(\"offset\") || \"0\", 10), 0);\n  let requested = Math.max(parseInt(url.searchParams.get(\"length\") || \"2000\", 10), 1);\n  if (requested > 8000) requested = 8000;\n\n  try {\n    const { text, length: total } = await fetchText(p);\n    if (offset >= total) {\n      return new Response(\"\", { status: 200, headers: corsHeaders(origin) });\n    }\n    const end = Math.min(offset + requested, total);\n    const slice = text.slice(offset, end);\n    // Palautetaan vain raakasisältö\n    return new Response(slice, {\n      status: 200,\n      headers: { ...corsHeaders(origin), \"Content-Type\": \"text/plain\" },\n    });\n  } catch (e) {\n    return new Response(`fetch error: ${(e as Error).message}`, {\n      status: 502,\n      headers: corsHeaders(origin),\n    });\n  }\n}\n\n// GET /files/getChunk?path=...&offset=...&length=...\nif (req.method === \"GET\" && path === \"/files/getChunk\") {\n  const p = url.searchParams.get(\"path\") || \"\";\n  const offset = Math.max(parseInt(url.searchParams.get(\"offset\") || \"0\", 10), 0);\n  let requested = Math.max(parseInt(url.searchParams.get(\"length\") || String(MAX_BYTES), 10), 1);\n  if (requested > 8000) {\n    console.log(\"WARN getChunk length too big, capping\", { requested });\n    requested = 8000;\n  }\n  if (!p) return json({ error: \"missing path\" }, origin, 400);\n\n  try {\n    const list = await loadAllowlist();\n    if (!list.has(p)) return json({ error: \"path not allowed\" }, origin, 403);\n  } catch (e) {\n    return json({ error: `manifest error: ${(e as Error).message}` }, origin, 502);\n  }\n\n  try {\n    const { text, length: total } = await fetchText(p);\n    if (offset >= total) {\n      return json({ content: \"\", approved: true }, origin, 416);\n    }\n    const end = Math.min(offset + requested, total);\n    const slice = text.slice(offset, end);\n    console.log(\"RETURNING getChunk SIMPLIFIED\", { p, offset, requested, sliceLength: slice.length });\n    // Palautetaan vain content + approved\n    return json({ content: slice, approved: true }, origin);\n  } catch (e) {\n    return json({ content: \"\", approved: true, error: `fetch error: ${(e as Error).message}` }, origin, 502);\n  }\n}\n\n// PROXY: /proxy/get?path=...\nif (req.method === \"GET\" && path === \"/proxy/get\") {\n  const p = url.searchParams.get(\"path\") || \"\";\n  try {\n    const { text, length: total } = await fetchText(p);\n    return new Response(text, {\n      status: 200,\n      headers: { ...corsHeaders(origin), \"Content-Type\": \"text/plain\" },\n    });\n  } catch (e) {\n    return new Response(`fetch error: ${(e as Error).message}`, {\n      status: 502,\n      headers: corsHeaders(origin),\n    });\n  }\n}\n\n\n  // Fallback\n  return json({ error: \"not found\" }, origin, 404);\n});",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 231
        }
      ]
    },
    {
      "path": "supabase/migrations/20250911142604_remote_schema.sql",
      "size": 21800,
      "sha256": "46a54cfdab9e1d30a0afd1c508c619ece06a639d3ca2e1a53c4c4efc57623be7",
      "lang": "sql",
      "lines": 667,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/supabase/migrations/20250911142604_remote_schema.sql",
      "chunks": [
        {
          "i": 0,
          "text": "create sequence \"public\".\"debug_log_id_seq\";\n\ncreate sequence \"public\".\"email_queue_id_seq\";\n\ncreate sequence \"public\".\"email_send_log_id_seq\";\n\ndrop trigger if exists \"trg_absence_enqueue_job\" on \"public\".\"absences\";\n\ndrop trigger if exists \"trg_admin_new_absence\" on \"public\".\"absences\";\n\ndrop trigger if exists \"trg_employee_shift_deleted\" on \"public\".\"shifts\";\n\ndrop policy \"dev: employees select for anon\" on \"public\".\"employees\";\n\ndrop policy \"dev: notifications select for anon\" on \"public\".\"notifications\";\n\ndrop policy \"dev_read_notifications_anon\" on \"public\".\"notifications\";\n\ndrop policy \"allow anon insert shifts\" on \"public\".\"shifts\";\n\ndrop policy \"allow anon shifts access\" on \"public\".\"shifts\";\n\ndrop policy \"allow anon update shifts\" on \"public\".\"shifts\";\n\ndrop policy \"anon delete shifts\" on \"public\".\"shifts\";\n\ndrop policy \"anon insert shifts\" on \"public\".\"shifts\";\n\ndrop policy \"anon select shifts\" on \"public\".\"shifts\";\n\ndrop policy \"anon update shifts\" on \"public\".\"shifts\";\n\nrevoke delete on table \"public\".\"absences\" from \"anon\";\n\nrevoke insert on table \"public\".\"absences\" from \"anon\";\n\nrevoke references on table \"public\".\"absences\" from \"anon\";\n\nrevoke trigger on table \"public\".\"absences\" from \"anon\";\n\nrevoke truncate on table \"public\".\"absences\" from \"anon\";\n\nrevoke update on table \"public\".\"absences\" from \"anon\";\n\nrevoke delete on table \"public\".\"app_settings\" from \"anon\";\n\nrevoke insert on table \"public\".\"app_settings\" from \"anon\";\n\nrevoke references on table \"public\".\"app_settings\" from \"anon\";\n\nrevoke select on table \"public\".\"app_settings\" from \"anon\";\n\nrevoke trigger on table \"public\".\"app_settings\" from \"anon\";\n\nrevoke truncate on table \"public\".\"app_settings\" from \"anon\";\n\nrevoke update on table \"public\".\"app_settings\" from \"anon\";\n\nrevoke delete on table \"public\".\"app_settings\" from \"authenticated\";\n\nrevoke insert on table \"public\".\"app_settings\" from \"authenticated\";\n\nrevoke references on table \"public\".\"app_settings\" from \"authenticated\";\n\nrevoke select on table \"public\".\"app_settings\" from \"authenticated\";\n\nrevoke trigger on table \"public\".\"app_settings\" from \"authenticated\";\n\nrevoke truncate on table \"public\".\"app_settings\" from \"authenticated\";\n\nrevoke update on table \"public\".\"app_settings\" from \"authenticated\";\n\nrevoke delete on table \"public\".\"employees\" from \"anon\";\n\nrevoke insert on table \"public\".\"employees\" from \"anon\";\n\nrevoke references on table \"public\".\"employees\" from \"anon\";\n\nrevoke trigger on table \"public\".\"employees\" from \"anon\";\n\nrevoke truncate on table \"public\".\"employees\" from \"anon\";\n\nrevoke update on table \"public\".\"employees\" from \"anon\";\n\nrevoke delete on table \"public\".\"mail_jobs\" from \"anon\";\n\nrevoke insert on table \"public\".\"mail_jobs\" from \"anon\";\n\nrevoke references on table \"public\".\"mail_jobs\" from \"anon\";\n\nrevoke select on table \"public\".\"mail_jobs\" from \"anon\";\n\nrevoke trigger on table \"public\".\"mail_jobs\" from \"anon\";\n\nrevoke truncate on table \"public\".\"mail_jobs\" from \"anon\";\n\nrevoke update on table \"public\".\"mail_jobs\" from \"anon\";\n\nrevoke delete on table \"public\".\"mail_jobs\" from \"authenticated\";\n\nrevoke insert on table \"public\".\"mail_jobs\" from \"authenticated\";\n\nrevoke references on table \"public\".\"mail_jobs\" from \"authenticated\";\n\nrevoke select on table \"public\".\"mail_jobs\" from \"authenticated\";\n\nrevoke trigger on table \"public\".\"mail_jobs\" from \"authenticated\";\n\nrevoke truncate on table \"public\".\"mail_jobs\" from \"authenticated\";\n\nrevoke update on table \"public\".\"mail_jobs\" from \"authenticated\";\n\nrevoke delete on table \"public\".\"mail_jobs\" from \"service_role\";\n\nrevoke insert on table \"public\".\"mail_jobs\" from \"service_role\";\n\nrevoke references on table \"public\".\"mail_jobs\" from \"service_role\";\n\nrevoke select on table \"public\".\"mail_jobs\" from \"service_role\";\n\nrevoke trigger on table \"public\".\"mail_jobs\" from \"service_role\";\n\nrevoke truncate on table \"public\".\"mail_jobs\" from \"service_role\";\n\nrevoke update on table \"public\".\"mail_jobs\" from \"service_role\";\n\nrevoke delete on table \"public\".\"notifications\" from \"anon\";\n\nrevoke insert on table \"public\".\"notifications\" from \"anon\";\n\nrevoke references on table \"public\".\"notifications\" from \"anon\";\n\nrevoke trigger on table \"public\".\"notifications\" from \"anon\";\n\nrevoke truncate on table \"public\".\"notifications\" from \"anon\";\n\nrevoke update on table \"public\".\"notifications\" from \"anon\";\n\nrevoke delete on table \"public\".\"shifts\" from \"anon\";\n\nrevoke insert on table \"public\".\"shifts\" from \"anon\";\n\nrevoke references on table \"public\".\"shifts\" from \"anon\";\n\nrevoke trigger on table \"public\".\"shifts\" from \"anon\";\n\nrevoke truncate on table \"public\".\"shifts\" from \"anon\";\n\nrevoke update on table \"public\".\"shifts\" from \"anon\";\n\nalter table \"public\".\"mail_jobs\" drop constraint \"mail_jobs_job_key_unique\";\n\ndrop function if exists \"public\".\"claim_employee_jobs\"(p_employee_id text, p_since timestamp with time zone, p_types text[], p_limit integer);\n\ndrop function if exists \"public\".\"claim_employee_jobs\"(p_employee_id uuid, p_since timestamp with time zone, p_types text[], p_limit integer);\n\ndrop function if exists \"public\".\"enqueue_admin_new_absence\"();\n\ndrop function if exists \"public\".\"enqueue_employee_shift_deleted\"();\n\ndrop view if exists \"public\".\"latest_publications_overview\";\n\ndrop view if exists \"public\".\"publication_jobs_debug\";\n\ndrop function if exists \"public\".\"publish_shifts\"(_start_date date, _end_date date);\n\ndrop function if exists \"public\".\"trg_absence_enqueue_job\"();\n\ndrop function if exists \"public\".\"unpublish_shifts\"(_start_date date, _end_date date);\n\nalter table \"public\".\"mail_jobs\" drop constraint \"mail_jobs_pkey\";\n\ndrop index if exists \"public\".\"mail_jobs_emp_queued_idx\";\n\ndrop index if exists \"public\".\"mail_jobs_job_key_unique\";\n\ndrop index if exists \"public\".\"mail_jobs_pkey\";\n\ndrop index if exists \"public\".\"mail_jobs_queued_time_type_idx\";\n\ndrop index if exists \"public\".\"mail_jobs_status_idx\";\n\ndrop index if exists \"public\".\"mail_jobs_unique_key\";\n\ndrop table \"public\".\"mail_jobs\";\n\n\n  create table \"public\".\"debug_log\" (\n    \"id\" bigint not null default nextval('debug_log_id_seq'::regclass),\n    \"context\" text,\n    \"message\" text,\n    \"created_at\" timestamp with time zone default now()\n      );\n\n\n\n  create table \"public\".\"email_queue\" (\n    \"id\" bigint not null default nextval('email_queue_id_seq'::regclass),\n    \"recipient\" text not null,\n    \"subject\" text not null,\n    \"body\" text not null,\n    \"status\" text not null default 'queued'::text,\n    \"error\" text,\n    \"created_at\" timestamp with time zone not null default now(),\n    \"sent_at\" timestamp with time zone\n      );\n\n\n\n  create table \"public\".\"email_send_log\" (\n    \"id\" bigint not null default nextval('email_send_log_id_seq'::regclass),\n    \"pub_id\" uuid not null,\n    \"email\" text not null,\n    \"sent_at\" timestamp with time zone default now()\n      );\n\n\nalter table \"public\".\"shifts\" alter column \"minutes\" drop default;\n\nalter sequence \"public\".\"debug_log_id_seq\" owned by \"public\".\"debug_log\".\"id\";\n\nalter sequence \"public\".\"email_queue_id_seq\" owned by \"public\".\"email_queue\".\"id\";\n\nalter sequence \"public\".\"email_send_log_id_seq\" owned by \"public\".\"email_send_log\".\"id\";\n\nCREATE UNIQUE INDEX debug_log_pkey ON public.debug_log USING btree (id);\n\nCREATE UNIQUE INDEX email_queue_pkey ON public.email_queue USING btree (id);\n\nCREATE UNIQUE INDEX email_send_log_pkey ON public.email_send_log USING btree (id);\n\nCREATE INDEX idx_email_queue_status_created ON public.email_queue USING btree (status, created_at);\n\nalter table \"public\".\"debug_log\" add constraint \"debug_log_pkey\" PRIMARY KEY using index \"debug_log_pkey\";\n\nalter table \"public\".\"email_queue\" add constraint \"email_queue_pkey\" PRIMARY KEY using index \"email_queue_pkey\";\n\nalter table \"public\".\"email_send_log\" add constraint \"email_send_log_pkey\" PRIMARY KEY using index \"email_send_log_pkey\";\n\nalter table \"public\".\"shifts\" add constraint \"minutes_positive\" CHECK ((minutes > 0)) not valid;\n\nalter table \"public\".\"shifts\" validate constraint \"minutes_positive\";\n\nset check_function_bodies = off;\n\nCREATE OR REPLACE FUNCTION public.delete_shifts_bulk(_emp uuid, _dates date[])\n RETURNS void\n LANGUAGE sql\nAS $function$\n  DELETE FROM public.shifts\n  WHERE employee_id = _emp\n    AND work_date = ANY(_dates);\n$function$\n;\n\nCREATE OR REPLACE FUNCTION public.prevent_zero_minutes()\n RETURNS trigger\n LANGUAGE plpgsql\nAS $function$\nBEGIN\n  IF NEW.minutes IS NULL OR NEW.minutes <= 0 THEN\n    RAISE EXCEPTION 'Minutes must be > 0, got %', NEW.minutes;\n  END IF;\n  RETURN NEW;\nEND;\n$function$\n;\n\nCREATE OR REPLACE FUNCTION public.publish_shifts_debug(_start_date date, _end_date date)\n RETURNS jsonb\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\ndeclare\n  ts timestamp := now();\n  pub_id uuid;\n  emails text[];\n  result jsonb;\nbegin\n  -- Merkitse vuorot julkaistuiksi\n  update public.shifts\n  set published = true, published_at = ts\n  where work_date between _start_date and _end_date\n    and published = false;\n\n  -- Luo julkaisun merkintä\n  insert into public.shift_publications (start_date, end_date, status, published_at)\n  values (_start_date, _end_date, 'sent', ts)\n  returning id into pub_id;\n\n  -- Luo in-app ilmoitukset\n  insert into public.employee_notifications (employee_id, type, title, message, created_at, is_read, priority)\n  select distinct s.employee_id,\n         'schedule_published',\n         'Uusi aikataulu julkaistu',\n         'Tarkista uudet työvuorosi. Julkaisu: ' || pub_id,\n         ts, false, 'high'\n  from public.shifts s\n  where s.work_date between _start_date and _end_date\n    and s.published = true\n  group by s.employee_id;\n\n  -- Kerää emailit\n  select array_agg(distinct e.email)\n  into emails\n  from public.shifts s\n  join public.employees e on e.id = s.employee_id\n  where s.work_date between _start_date and _end_date\n    and s.published = true\n    and e.email is not null;\n\n  -- Lähetä emailit yhdellä POSTilla\n  if emails is not null and array_length(emails,1) > 0 then\n    select net.http_post(\n      url := 'https://musrmpblsazxcrhwthtc.functions.supabase.co/sendemail',\n      headers := jsonb_build_object(\n        'Authorization','Bearer ' || 'TÄHÄN_SERVICE_ROLE_KEY',\n        'Content-Type','application/json'\n      ),\n      body := jsonb_build_object(\n        'to', to_jsonb(emails),\n        'subject','Uudet vuorot julkaistu',\n        'text','Sinulle on julkaistu uusia vuoroja. Tarkista työvuorosi sovelluksesta.'\n      )\n    ) into result;\n\n    return jsonb_build_object('emails', emails, 'http_post', result);\n  else\n    return jsonb_build_object('emails','[]','error','no emails found');\n  end if;\nend;\n$function$\n;\n\nCREATE OR REPLACE FUNCTION public.publish_shifts_instant(_start_date date, _end_date date)\n RETURNS void\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\ndeclare\n  ts timestamp := now();\n  pub_id uuid;\n  emails text[];\nbegin\n  insert into debug_log (context, message)\n  values ('publish_shifts_instant', 'start ' || _start_date || ' - ' || _end_date);\n\n  -- Merkitse vuorot julkaistuiksi\n  update public.shifts\n  set published = true, published_at = ts\n  where work_date between _start_date and _end_date\n    and published = false;\n  insert into debug_log (context, message)\n  values ('publish_shifts_instant', 'shifts updated: ' || found);\n\n  -- Luo julkaisun merkintä\n  insert into public.shift_publications (start_date, end_date, status, published_at)\n  values (_start_date, _end_date, 'sent', ts)\n  returning id into pub_id;\n  insert into debug_log (context, message)\n  values ('publish_shifts_instant', 'publication id: ' || pub_id);\n\n  -- Luo in-app ilmoitukset\n  insert into public.employee_notifications (employee_id, type, title, message, created_at, is_read, priority)\n  select distinct s.employee_id,\n         'schedule_published',\n         'Uusi aikataulu julkaistu',\n         'Tarkista uudet työvuorosi. Julkaisu: ' || pub_id,\n         ts, false, 'high'\n  from public.shifts s\n  where s.work_date between _start_date and _end_date\n    and s.published = true;\n  insert into debug_log (context, message)\n  values ('publish_shifts_instant', 'notifications inserted: ' || found);\n\n  -- Kerää emailit\n  select array_agg(distinct e.email)\n  into emails\n  from public.shifts s\n  join public.employees e on e.id = s.employee_id\n  where s.work_date between _start_date and _end_date\n    and s.published = true\n    and e.email is not null;\n  insert into debug_log (context, message)\n  values ('publish_shifts_instant', 'emails collected: ' || coalesce(array_length(emails,1),0));\n\n  -- Lähetä kaikki kerralla arrayna\n  if emails is not null and array_length(emails,1) > 0 then\n    perform net.http_post(\n      url := 'https://musrmpblsazxcrhwthtc.functions.supabase.co/sendemail',\n      headers := jsonb_build_object(\n        'Authorization','Bearer ' || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.[REDACTED].IsmXis0LAg4lUTD9nSB1i9212C9f1JSet0bKYKW1s1w',\n        'Content-Type','application/json'\n      ),\n      body := jsonb_build_object(\n        'to', (select jsonb_agg(e) from unnest(emails) e),\n        'subject','Uudet vuorot julkaistu',\n        'text','Sinulle on julkaistu uusia vuoroja. Tarkista työvuorosi sovelluksesta.'\n      )\n    );\n    insert into debug_log (context, message)\n    values ('publish_shifts_instant', 'http_post executed, recipients: ' || array_to_string(emails, ', '));\n  else\n    insert into debug_log (context, message)\n    values ('publish_shifts_instant', 'no emails to send');\n  end if;\n\n  insert into debug_log (context, message)\n  values ('publish_shifts_instant', 'end');\nend;\n$function$\n;\n\nCREATE OR REPLACE FUNCTION public.publish_shifts_instant_debug(_start_date date, _end_date date)\n RETURNS jsonb\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\ndeclare\n  ts timestamp := now();\n  pub_id uuid;\n  emails text[];\n  sent_count int := 0;\nbegin\n  -- Merkitse vuorot julkaistuiksi\n  update public.shifts\n  set published = true, published_at = ts\n  where work_date between _start_date and _end_date\n    and published = false;\n\n  -- Luo julkaisun merkintä\n  insert into public.shift_publications (start_date, end_date, status, published_at)\n  values (_start_date, _end_date, 'sent', ts)\n  returning id into pub_id;\n\n  -- Luo in-app ilmoitukset\n  insert into public.employee_notifications (employee_id, type, title, message, created_at, is_read, priority)\n  select distinct s.employee_id,\n         'schedule_published',\n         'Uusi aikataulu julkaistu',\n         'Tarkista uudet työvuorosi. Julkaisu: ' || pub_id,\n         ts, false, 'high'\n  from public.shifts s\n  where s.work_date between _start_date and _end_date\n    and s.published = true\n  group by s.employee_id;\n\n  -- Kerää emailit\n  select array_agg(distinct e.email)\n  into emails\n  from public.shifts s\n  join public.employees e on e.id = s.employee_id\n  where s.work_date between _start_date and _end_date\n    and s.published = true\n    and e.email is not null;\n\n  -- Lähetä sähköpostit yksi kerrallaan\n  if emails is not null and array_length(emails,1) > 0 then\n    for i in 1 .. array_length(emails,1) loop\n      perform net.http_post(\n        url := 'https://musrmpblsazxcrhwthtc.functions.supabase.co/sendemail',\n        headers := jsonb_build_object(\n          'Authorization','Bearer ' || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.[REDACTED].IsmXis0LAg4lUTD9nSB1i9212C9f1JSet0bKYKW1s1w',\n          'Content-Type','application/json'\n        ),\n        body := jsonb_build_object(\n          'to', emails[i],\n          'subject','Uudet vuorot julkaistu',\n          'text','Sinulle on julkaistu uusia vuoroja. Tarkista työvuorosi sovelluksesta.'\n        )\n      );\n      sent_count := sent_count + 1;\n    end loop;\n\n    return jsonb_build_object('emails', emails, 'sent_count', sent_count);\n  else\n    return jsonb_build_object('emails','[]','sent_count',0,'error','no emails found');\n  end if;\nend;\n$function$\n;\n\nCREATE OR REPLACE FUNCTION public.save_shifts_bulk(_deletes jsonb, _upserts jsonb)\n RETURNS void\n LANGUAGE plpgsql\nAS $function$\nBEGIN\n  -- 1) Poistot\n  DELETE FROM public.shifts s\n  USING jsonb_to_recordset(_deletes) AS d(employee_id uuid, work_date date)\n  WHERE s.employee_id = d.employee_id\n    AND s.work_date = d.work_date;\n\n  -- 2) Upsertit\n  INSERT INTO public.shifts (employee_id, work_date, type, minutes)\n  SELECT employee_id, work_date, type, minutes\n  FROM jsonb_to_recordset(_upserts)\n       AS u(employee_id uuid, work_date date, type text, minutes int)\n  ON CONFLICT (employee_id, work_date)\n  DO UPDATE\n    SET type = EXCLUDED.type,\n        minutes = EXCLUDED.minutes,\n        updated_at = now();\nEND;\n$function$\n;\n\nCREATE OR REPLACE FUNCTION public.upsert_shifts_bulk(_rows jsonb)\n RETURNS void\n LANGUAGE plpgsql\nAS $function$\nBEGIN\n  INSERT INTO public.shifts (employee_id, work_date, type, minutes)\n  SELECT employee_id, work_date, type, minutes\n  FROM jsonb_to_recordset(_rows)\n       AS x(employee_id uuid, work_date date, type text, minutes integer)\n  WHERE minutes IS NOT NULL AND minutes > 0\n  ON CONFLICT (employee_id, work_date)\n  DO UPDATE\n    SET type = EXCLUDED.type,\n        minutes = EXCLUDED.minutes,\n        updated_at = now();\nEND;\n$function$\n;\n\ngrant delete on table \"public\".\"debug_log\" to \"anon\";\n\ngrant insert on table \"public\".\"debug_log\" to \"anon\";\n\ngrant references on table \"public\".\"debug_log\" to \"anon\";\n\ngrant select on table \"public\".\"debug_log\" to \"anon\";\n\ngrant trigger on table \"public\".\"debug_log\" to \"anon\";\n\ngrant truncate on table \"public\".\"debug_log\" to \"anon\";\n\ngrant update on table \"public\".\"debug_log\" to \"anon\";\n\ngrant delete on table \"public\".\"debug_log\" to \"authenticated\";\n\ngrant insert on table \"public\".\"debug_log\" to \"authenticated\";\n\ngrant references on table \"public\".\"debug_log\" to \"authenticated\";\n\ngrant select on table \"public\".\"debug_log\" to \"authenticated\";\n\ngrant trigger on table \"public\".\"debug_log\" to \"authenticated\";\n\ngrant truncate on table \"public\".\"debug_log\" to \"authenticated\";\n\ngrant update on table \"public\".\"debug_log\" to \"authenticated\";\n\ngrant delete on table \"public\".\"debug_log\" to \"service_role\";\n\ngrant insert on table \"public\".\"debug_log\" to \"service_role\";\n\ngrant references on table \"public\".\"debug_log\" to \"service_role\";\n\ngrant select on table \"public\".\"debug_log\" to \"service_role\";\n\ngrant trigger on table \"public\".\"debug_log\" to \"service_role\";\n\ngrant truncate on table \"public\".\"debug_log\" to \"service_role\";\n\ngrant update on table \"public\".\"debug_log\" to \"service_role\";\n\ngrant delete on table \"public\".\"email_queue\" to \"anon\";\n\ngrant insert on table \"public\".\"email_queue\" to \"anon\";\n\ngrant references on table \"public\".\"email_queue\" to \"anon\";\n\ngrant select on table \"public\".\"email_queue\" to \"anon\";\n\ngrant trigger on table \"public\".\"email_queue\" to \"anon\";\n\ngrant truncate on table \"public\".\"email_queue\" to \"anon\";\n\ngrant update on table \"public\".\"email_queue\" to \"anon\";\n\ngrant delete on table \"public\".\"email_queue\" to \"authenticated\";\n\ngrant insert on table \"public\".\"email_queue\" to \"authenticated\";\n\ngrant references on table \"public\".\"email_queue\" to \"authenticated\";\n\ngrant select on table \"public\".\"email_queue\" to \"authenticated\";\n\ngrant trigger on table \"public\".\"email_queue\" to \"authenticated\";\n\ngrant truncate on table \"public\".\"email_queue\" to \"authenticated\";\n\ngrant update on table \"public\".\"email_queue\" to \"authenticated\";\n\ngrant delete on table \"public\".\"email_queue\" to \"service_role\";\n\ngrant insert on table \"public\".\"email_queue\" to \"service_role\";\n\ngrant references on table \"public\".\"email_queue\" to \"service_role\";\n\ngrant select on table \"public\".\"email_queue\" to \"service_role\";\n\ngrant trigger on table \"public\".\"email_queue\" to \"service_role\";\n\ngrant truncate on table \"public\".\"email_queue\" to \"service_role\";\n\ngrant update on table \"public\".\"email_queue\" to \"service_role\";\n\ngrant delete on table \"public\".\"email_send_log\" to \"anon\";\n\ngrant insert on table \"public\".\"email_send_log\" to \"anon\";\n\ngrant references on table \"public\".\"email_send_log\" to \"anon\";\n\ngrant select on table \"public\".\"email_send_log\" to \"anon\";\n\ngrant trigger on table \"public\".\"email_send_log\" to \"anon\";\n\ngrant truncate on table \"public\".\"email_send_log\" to \"anon\";\n\ngrant update on table \"public\".\"email_send_log\" to \"anon\";\n\ngrant delete on table \"public\".\"email_send_log\" to \"authenticated\";\n\ngrant insert on table \"public\".\"email_send_log\" to \"authenticated\";\n\ngrant references on table \"public\".\"email_send_log\" to \"authenticated\";\n\ngrant select on table \"public\".\"email_send_log\" to \"authenticated\";\n\ngrant trigger on table \"public\".\"email_send_log\" to \"authenticated\";\n\ngrant truncate on table \"public\".\"email_send_log\" to \"authenticated\";\n\ngrant update on table \"public\".\"email_send_log\" to \"authenticated\";\n\ngrant delete on table \"public\".\"email_send_log\" to \"service_role\";\n\ngrant insert on table \"public\".\"email_send_log\" to \"service_role\";\n\ngrant references on table \"public\".\"email_send_log\" to \"service_role\";\n\ngrant select on table \"public\".\"email_send_log\" to \"service_role\";\n\ngrant trigger on table \"public\".\"email_send_log\" to \"service_role\";\n\ngrant truncate on table \"public\".\"email_send_log\" to \"service_role\";\n\ngrant update on table \"public\".\"email_send_log\" to \"service_role\";\n\n\n  create policy \"admin_delete_shifts\"\n  on \"public\".\"shifts\"\n  as permissive\n  for delete\n  to authenticated\nusing ((EXISTS ( SELECT 1\n   FROM employees e\n  WHERE ((e.auth_user_id = auth.uid()) AND (e.role = 'admin'::text)))));\n\n\nCREATE TRIGGER trg_prevent_zero_minutes BEFORE INSERT OR UPDATE ON public.shifts FOR EACH ROW EXECUTE FUNCTION prevent_zero_minutes();\n\n\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 659
        }
      ]
    },
    {
      "path": "supabase/schema.sql",
      "size": 107789,
      "sha256": "9ee55f14045c861fb57d58e33a768885fe73851933708158cdfd9bd1a1846c6f",
      "lang": "sql",
      "lines": 3623,
      "modifiedAt": "2025-09-13T14:35:23+03:00",
      "commitSha": "eb12fa527306529bd509484356bfd0c8611ad80d",
      "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/supabase/schema.sql",
      "chunks": [
        {
          "i": 0,
          "text": "\n\\restrict [REDACTED]\n\n-- Dumped from database version 17.4\n-- Dumped by pg_dump version 17.6 (Ubuntu 17.6-1.pgdg24.04+1)\n\nSET statement_timeout = 0;\nSET lock_timeout = 0;\nSET idle_in_transaction_session_timeout = 0;\nSET client_encoding = 'UTF8';\nSET standard_conforming_strings = on;\nSELECT pg_catalog.set_config('search_path', '', false);\nSET check_function_bodies = false;\nSET xmloption = content;\nSET client_min_messages = warning;\nSET row_security = off;\n\n\nCREATE SCHEMA IF NOT EXISTS \"auth\";\n\n\nALTER SCHEMA \"auth\" OWNER TO \"supabase_admin\";\n\n\nCREATE SCHEMA IF NOT EXISTS \"public\";\n\n\nALTER SCHEMA \"public\" OWNER TO \"pg_database_owner\";\n\n\nCOMMENT ON SCHEMA \"public\" IS 'standard public schema';\n\n\n\nCREATE SCHEMA IF NOT EXISTS \"storage\";\n\n\nALTER SCHEMA \"storage\" OWNER TO \"supabase_admin\";\n\n\nCREATE TYPE \"auth\".\"aal_level\" AS ENUM (\n    'aal1',\n    'aal2',\n    'aal3'\n);\n\n\nALTER TYPE \"auth\".\"aal_level\" OWNER TO \"supabase_auth_admin\";\n\n\nCREATE TYPE \"auth\".\"code_challenge_method\" AS ENUM (\n    's256',\n    'plain'\n);\n\n\nALTER TYPE \"auth\".\"code_challenge_method\" OWNER TO \"supabase_auth_admin\";\n\n\nCREATE TYPE \"auth\".\"factor_status\" AS ENUM (\n    'unverified',\n    'verified'\n);\n\n\nALTER TYPE \"auth\".\"factor_status\" OWNER TO \"supabase_auth_admin\";\n\n\nCREATE TYPE \"auth\".\"factor_type\" AS ENUM (\n    'totp',\n    'webauthn',\n    'phone'\n);\n\n\nALTER TYPE \"auth\".\"factor_type\" OWNER TO \"supabase_auth_admin\";\n\n\nCREATE TYPE \"auth\".\"oauth_registration_type\" AS ENUM (\n    'dynamic',\n    'manual'\n);\n\n\nALTER TYPE \"auth\".\"oauth_registration_type\" OWNER TO \"supabase_auth_admin\";\n\n\nCREATE TYPE \"auth\".\"one_time_token_type\" AS ENUM (\n    'confirmation_token',\n    'reauthentication_token',\n    'recovery_token',\n    'email_change_token_new',\n    'email_change_token_current',\n    'phone_change_token'\n);\n\n\nALTER TYPE \"auth\".\"one_time_token_type\" OWNER TO \"supabase_auth_admin\";\n\n\nCREATE OR REPLACE FUNCTION \"auth\".\"email\"() RETURNS \"text\"\n    LANGUAGE \"sql\" STABLE\n    AS $$\n  select \n  coalesce(\n    nullif(current_setting('request.jwt.claim.email', true), ''),\n    (nullif(current_setting('request.jwt.claims', true), '')::jsonb ->> 'email')\n  )::text\n$$;\n\n\nALTER FUNCTION \"auth\".\"email\"() OWNER TO \"supabase_auth_admin\";\n\n\nCOMMENT ON FUNCTION \"auth\".\"email\"() IS 'Deprecated. Use auth.jwt() -> ''email'' instead.';\n\n\n\nCREATE OR REPLACE FUNCTION \"auth\".\"jwt\"() RETURNS \"jsonb\"\n    LANGUAGE \"sql\" STABLE\n    AS $$\n  select \n    coalesce(\n        nullif(current_setting('request.jwt.claim', true), ''),\n        nullif(current_setting('request.jwt.claims', true), '')\n    )::jsonb\n$$;\n\n\nALTER FUNCTION \"auth\".\"jwt\"() OWNER TO \"supabase_auth_admin\";\n\n\nCREATE OR REPLACE FUNCTION \"auth\".\"role\"() RETURNS \"text\"\n    LANGUAGE \"sql\" STABLE\n    AS $$\n  select \n  coalesce(\n    nullif(current_setting('request.jwt.claim.role', true), ''),\n    (nullif(current_setting('request.jwt.claims', true), '')::jsonb ->> 'role')\n  )::text\n$$;\n\n\nALTER FUNCTION \"auth\".\"role\"() OWNER TO \"supabase_auth_admin\";\n\n\nCOMMENT ON FUNCTION \"auth\".\"role\"() IS 'Deprecated. Use auth.jwt() -> ''role'' instead.';\n\n\n\nCREATE OR REPLACE FUNCTION \"auth\".\"uid\"() RETURNS \"uuid\"\n    LANGUAGE \"sql\" STABLE\n    AS $$\n  select \n  coalesce(\n    nullif(current_setting('request.jwt.claim.sub', true), ''),\n    (nullif(current_setting('request.jwt.claims', true), '')::jsonb ->> 'sub')\n  )::uuid\n$$;\n\n\nALTER FUNCTION \"auth\".\"uid\"() OWNER TO \"supabase_auth_admin\";\n\n\nCOMMENT ON FUNCTION \"auth\".\"uid\"() IS 'Deprecated. Use auth.jwt() -> ''sub'' instead.';\n\n\n--\n-- Name: get_auth(text); Type: FUNCTION; Schema: pgbouncer; Owner: -\n--\n\nCREATE FUNCTION pgbouncer.get_auth(p_usename text) RETURNS TABLE(username text, password text)\n    LANGUAGE plpgsql SECURITY DEFINER\n    AS $_$\nbegin\n    raise debug 'PgBouncer auth request: %', p_usename;\n\n    return query\n    select \n        rolname::text, \n        case when rolvaliduntil < now() \n            then null \n            else rolpassword::text \n        end \n    from pg_authid \n    where rolname=$1 and rolcanlogin;\nend;\n$_$;\n\n\nSET default_tablespace = '';\n\nSET default_table_access_method = heap;\n\n--\n-- Name: mail_jobs; Type: TABLE; Schema: public; Owner: -\n--\n\nCREATE TABLE public.mail_jobs (\n    id bigint NOT NULL,\n    type text NOT NULL,\n    payload jsonb NOT NULL,\n    status text DEFAULT 'queued'::text NOT NULL,\n    attempt_count integer DEFAULT 0 NOT NULL,\n    last_error text,\n    created_at timestamp with time zone DEFAULT now() NOT NULL,\n    processed_at timestamp with time zone,\n    job_key text GENERATED ALWAYS AS (\nCASE\n    WHEN (type = 'admin_new_absence'::text) THEN (((((payload ->> 'employee_id'::text) || '|'::text) || (payload ->> 'start_date'::text)) || '|'::text) || COALESCE((payload ->> 'end_date'::text), ''::text))\n    ELSE NULL::text\nEND) STORED\n);\n\n\n--\n-- Name: claim_employee_jobs(text, timestamp with time zone, text[], integer); Type: FUNCTION; Schema: public; Owner: -\n--\n\nCREATE FUNCTION public.claim_employee_jobs(p_employee_id text, p_since timestamp with time zone, p_types text[], p_limit integer DEFAULT 200) RETURNS SETOF public.mail_jobs\n    LANGUAGE sql SECURITY DEFINER\n    SET search_path TO 'public'\n    AS $$\n  with candidate as (\n    select id\n    from public.mail_jobs\n    where status = 'queued'\n      and created_at >= p_since\n      and type = any(p_types)\n      and payload->>'employee_id' = p_employee_id\n    order by created_at asc\n    limit p_limit\n  ),\n  locked as (\n    update public.mail_jobs m\n      set status = 'processing',\n          processed_at = now(),\n          attempt_count = m.attempt_count + 1\n    where m.id in (select id from candidate)\n      and m.status = 'queued'\n    returning m.*\n  )\n  select * from locked;\n$$;\n\n\n--\n-- Name: claim_employee_jobs(uuid, timestamp with time zone, text[], integer); Type: FUNCTION; Schema: public; Owner: -\n--\n\nCREATE FUNCTION public.claim_employee_jobs(p_employee_id uuid, p_since timestamp with time zone, p_types text[], p_limit integer DEFAULT 200) RETURNS SETOF public.mail_jobs\n    LANGUAGE plpgsql SECURITY DEFINER\n    SET search_path TO 'public'\n    AS $$\nbegin\n  return query\n  with cte as (\n    select id\n    from mail_jobs\n    where status = 'queued'\n      and (payload->>'employee_id') = p_employee_id::text\n      and type = any(p_types)\n      and created_at >= p_since\n    order by created_at asc\n    limit p_limit\n    for update skip locked\n  )\n  update mail_jobs m\n  set status = 'processing'\n  from cte\n  where m.id = cte.id\n  returning m.*;\nend;\n$$;\n\n\n--\n-- Name: current_role(); Type: FUNCTION; Schema: public; Owner: -\n--\n\nCREATE FUNCTION public.\"current_role\"() RETURNS text\n    LANGUAGE sql STABLE\n    AS $$\n  select current_setting('role');\n$$;\n\n\n--\n-- Name: delete_shifts(uuid, date[]); Type: FUNCTION; Schema: public; Owner: -\n--\n\nCREATE FUNCTION public.delete_shifts(_employee_id uuid, _dates date[]) RETURNS void\n    LANGUAGE plpgsql SECURITY DEFINER\n    AS $$\nbegin\n  delete from public.shifts\n  where employee_id = _employee_id\n    and work_date = any(_dates);\nend;\n$$;\n\n\n--\n-- Name: enqueue_admin_new_absence(); Type: FUNCTION; Schema: public; Owner: -\n--\n\nCREATE FUNCTION public.enqueue_admin_new_absence() RETURNS trigger\n    LANGUAGE plpgsql SECURITY DEFINER\n    AS $$\nDECLARE\n  cfg RECORD;\n  _end_date date;\nBEGIN\n  SELECT email_notifications, absence_requests, admin_notification_emails\n    INTO cfg\n  FROM public.app_settings\n  WHERE id = 1;\n\n  IF COALESCE(cfg.email_notifications,false) IS NOT TRUE THEN RETURN NEW; END IF;\n  IF COALESCE(cfg.absence_requests,false)     IS NOT TRUE THEN RETURN NEW; END IF;\n  IF cfg.admin_notification_emails IS NULL\n     OR array_length(cfg.admin_notification_emails,1) < 1 THEN\n    RETURN NEW;\n  END IF;\n\n  -- normalisoi: jos end_date puuttuu → start_date\n  _end_date := COALESCE(NEW.end_date, NEW.start_date);\n\n  INSERT INTO public.mail_jobs (type, status, attempt_count, payload)\n  VALUES (\n    'admin_new_absence',\n    'queued',\n    0,\n    jsonb_build_object(\n      'employee_id', NEW.employee_id,\n      'start_date', NEW.start_date,\n      'end_date',   _end_date,\n      'reason',     NEW.reason\n    )\n  )\n  ON CONFLICT (job_key) DO NOTHING;  -- nyt toimii, koska on UNIQUE CONSTRAINT\n\n  -- älä kaada inserttiä vaikka HTTP failaa\n  BEGIN\n    PERFORM net.http_post(\n      url     := 'https://musrmpblsazxcrhwthtc.functions.supabase.co/mailer',\n      headers := jsonb_build_object('Authorization','Bearer '||'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.[REDACTED].k6zU1Eiif-06XVvlHMugfxsL-ZFnXiTuf5Qg28r5x8A'),\n      body    := '{}'::jsonb\n    );\n  EXCEPTION WHEN OTHERS THEN\n    NULL;\n  END;\n\n  RETURN NEW;\nEND;\n$$;\n\n\n--\n-- Name: enqueue_employee_new_shift(); Type: FUNCTION; Schema: public; Owner: -\n--\n\nCREATE FUNCTION public.enqueue_employee_new_shift() RETURNS trigger\n    LANGUAGE plpgsql\n    AS $$\nBEGIN\n  RETURN NEW;\nEND;\n$$;\n\n\nALTER FUNCTION \"public\".\"enqueue_employee_new_shift\"() OWNER TO \"postgres\";\n\n\nCREATE OR REPLACE FUNCTION \"public\".\"enqueue_employee_shift_changed\"() RETURNS \"trigger\"\n    LANGUAGE \"plpgsql\"\n    AS $$\nbegin\n  if new.published is distinct from old.published\n     and new.work_date  is not distinct from old.work_date\n     and new.start_time is not distinct from old.start_time\n     and new.end_time   is not distinct from old.end_time\n     and new.type       is not distinct from old.type\n     and new.minutes    is not distinct from old.minutes then\n    return new;\n  end if;\n\n  if (new.work_date  is distinct from old.work_date\n      or new.start_time is distinct from old.start_time\n      or new.end_time   is distinct from old.end_time\n      or new.type       is distinct from old.type\n      or new.minutes    is distinct from old.minutes) then\n    insert into public.employee_notifications (employee_id, type, title, message, created_at, is_read, priority)\n    values (new.employee_id,\n            'schedule_updated',\n            'Työvuorosi on muuttunut',\n            'Päivämäärä: ' || new.work_date::text,\n            now(), false, 'medium')\n    on conflict do nothing;\n  end if;\n\n  return new;\nend;\n$$;\n\n\n--\n-- Name: enqueue_employee_shift_deleted(); Type: FUNCTION; Schema: public; Owner: -\n--\n\nCREATE FUNCTION public.enqueue_employee_shift_deleted() RETURNS trigger\n    LANGUAGE plpgsql\n    AS $$\nBEGIN\n  IF OLD.published IS TRUE THEN\n    -- sähköposti\n    INSERT INTO public.mail_jobs(type, payload)\n    VALUES ('employee_shift_deleted', jsonb_build_object(\n      'employee_id', OLD.employee_id,\n      'work_date',   OLD.work_date::text,\n      'start',       OLD.start_time::text,\n      'end',         OLD.end_time::text\n    ));\n\n    -- notifikaatio\n    INSERT INTO public.employee_notifications (employee_id, type, title, message, created_at, is_read, priority)\n    VALUES (\n      OLD.employee_id,\n      'shift_declined',\n      'Vuorosi on peruttu',\n      'Päivämäärä: ' || OLD.work_date::text,\n      now(),\n      FALSE,\n      'medium'\n    );\n  END IF;\n  RETURN OLD;\nEND;\n$$;\n\n\n--\n-- Name: enqueue_on_publish_flip(); Type: FUNCTION; Schema: public; Owner: -\n--\n\nCREATE FUNCTION public.enqueue_on_publish_flip() RETURNS trigger\n    LANGUAGE plpgsql\n    AS $$\nBEGIN\n  RETURN NEW;\nEND;\n$$;\n\n\nALTER FUNCTION \"public\".\"enqueue_on_publish_flip\"() OWNER TO \"postgres\";\n\n\nCREATE OR REPLACE FUNCTION \"public\".\"enqueue_shift_publication_jobs\"() RETURNS \"trigger\"\n    LANGUAGE \"plpgsql\"\n    AS $$\nBEGIN\n  RETURN NULL;\nEND;\n$$;\n\n\nALTER FUNCTION \"public\".\"enqueue_shift_publication_jobs\"() OWNER TO \"postgres\";\n\n\nCREATE OR REPLACE FUNCTION \"public\".\"notify_absence_insert\"() RETURNS \"trigger\"\n    LANGUAGE \"plpgsql\" SECURITY DEFINER\n    SET \"search_path\" TO 'public'\n    AS $$\nbegin\n  insert into public.notifications(type, title, message)\n  values (\n    'absence_request',\n    'Uusi poissaolopyyntö',\n    'Työntekijä ' || coalesce((select name from public.employees e where e.id = new.employee_id), 'Tuntematon')\n      || ' on jättänyt poissaolopyynnön ' || new.start_date::text\n      || coalesce(' – ' || new.end_date::text, '')\n  );\n  return new;\nend $$;\n\n\nALTER FUNCTION \"public\".\"notify_absence_insert\"() OWNER TO \"postgres\";\n\n\nCREATE OR REPLACE FUNCTION \"public\".\"notify_absence_status_update\"() RETURNS \"trigger\"\n    LANGUAGE \"plpgsql\" SECURITY DEFINER\n    SET \"search_path\" TO 'public'\n    AS $$\nbegin\n  if new.status is distinct from old.status then\n    if new.status = 'approved' then\n      insert into public.notifications(type, title, message)\n      values (\n        'absence_approved',\n        'Poissaolo hyväksytty',\n        'Poissaolo ('|| new.start_date::text || coalesce(' – '||new.end_date::text,'') || ') hyväksyttiin.'\n      );\n    elsif new.status = 'declined' then\n      insert into public.notifications(type, title, message)\n      values (\n        'absence_declined',\n        'Poissaolo hylätty',\n        'Poissaolopyyntö hylättiin.'\n      );\n    end if;\n  end if;\n  return new;\nend $$;\n\n\nALTER FUNCTION \"public\".\"notify_absence_status_update\"() OWNER TO \"postgres\";\n\n\nCREATE OR REPLACE FUNCTION \"public\".\"notify_employee_added\"() RETURNS \"trigger\"\n    LANGUAGE \"plpgsql\" SECURITY DEFINER\n    SET \"search_path\" TO 'public'\n    AS $$\nbegin\n  insert into public.notifications(type, title, message)\n  values (\n    'employee_added',\n    'Uusi työntekijä',\n    coalesce(new.name,'Tuntematon') || ' on lisätty järjestelmään.'\n  );\n  return new;\nend $$;\n\n\n--\n-- Name: publish_shifts(date, date); Type: FUNCTION; Schema: public; Owner: -\n--\n\nCREATE FUNCTION public.publish_shifts(_start_date date, _end_date date) RETURNS void\n    LANGUAGE plpgsql\n    AS $$\nBEGIN\n  IF NEW.minutes IS NULL OR NEW.minutes <= 0 THEN\n    RAISE EXCEPTION 'Minutes must be > 0, got %', NEW.minutes;\n  END IF;\n  RETURN NEW;\nEND;\n$$;\n\n\n--\n-- Name: set_updated_at(); Type: FUNCTION; Schema: public; Owner: -\n--\n\nCREATE FUNCTION public.set_updated_at() RETURNS trigger\n    LANGUAGE plpgsql\n    AS $$\nbegin\n  new.updated_at = now();\n  return new;\nend; $$;\n\n\n--\n-- Name: trg_absence_enqueue_job(); Type: FUNCTION; Schema: public; Owner: -\n--\n\nCREATE FUNCTION public.trg_absence_enqueue_job() RETURNS trigger\n    LANGUAGE plpgsql\n    AS $$\nbegin\n  insert into mail_jobs (type, payload)\n  values (\n    'admin_new_absence',\n    jsonb_build_object(\n      'absence_id', new.id,\n      'employee_id', new.employee_id,\n      'start_date', new.start_date,\n      'end_date', new.end_date,\n      'reason', new.reason\n    )\n  );\n  return new;\nend;\n$$;\n\n\n--\n-- Name: unpublish_shifts(date, date); Type: FUNCTION; Schema: public; Owner: -\n--\n\nCREATE FUNCTION public.unpublish_shifts(_start_date date, _end_date date) RETURNS void\n    LANGUAGE plpgsql SECURITY DEFINER\n    AS $$\nbegin\n  update public.shifts\n  set published = true, published_at = ts\n  where work_date between _start_date and _end_date\n    and published = false;\n\n  update public.shift_publications\n  set status = 'canceled'\n  where start_date = _start_date\n    and end_date = _end_date;\nend;\n$$;\n\n\n--\n-- Name: upsert_shifts(uuid, date, text, integer); Type: FUNCTION; Schema: public; Owner: -\n--\n\nCREATE FUNCTION public.upsert_shifts(_employee_id uuid, _work_date date, _type text, _minutes integer) RETURNS void\n    LANGUAGE plpgsql\n    AS $$\nbegin\n  insert into public.shifts (employee_id, work_date, type, minutes)\n  values (_employee_id, _work_date, _type, _minutes)\n  on conflict (employee_id, work_date)\n  do update set\n    type = excluded.type,\n    minutes = excluded.minutes;\nend;\n$$;\n\n\n--\n-- Name: upsert_shifts_bulk(jsonb); Type: FUNCTION; Schema: public; Owner: -\n--\n\nCREATE FUNCTION public.upsert_shifts_bulk(_rows jsonb) RETURNS void\n    LANGUAGE plpgsql\n    AS $$\nbegin\n  insert into shifts (employee_id, work_date, type, minutes)\n  select (r->>'employee_id')::uuid,\n         (r->>'work_date')::date,\n         r->>'type',\n         (r->>'minutes')::int\n  from jsonb_array_elements(_rows) as r\n  on conflict (employee_id, work_date)\n  do update set type = excluded.type,\n                minutes = excluded.minutes;\nend;\n$$;\n\n\nALTER FUNCTION \"public\".\"publish_shifts_debug\"(\"_start_date\" \"date\", \"_end_date\" \"date\") OWNER TO \"postgres\";\n\n\nCREATE OR REPLACE FUNCTION \"public\".\"publish_shifts_instant\"(\"_start_date\" \"date\", \"_end_date\" \"date\") RETURNS \"void\"\n    LANGUAGE \"plpgsql\" SECURITY DEFINER\n    AS $$\ndeclare\n  ts timestamp := now();\n  pub_id uuid;\n  emails text[];\nbegin\n  insert into debug_log (context, message)\n  values ('publish_shifts_instant', 'start ' || _start_date || ' - ' || _end_date);\n\n  -- Merkitse vuorot julkaistuiksi\n  update public.shifts\n  set published = true, published_at = ts\n  where work_date between _start_date and _end_date\n    and published = false;\n  insert into debug_log (context, message)\n  values ('publish_shifts_instant', 'shifts updated: ' || found);\n\n  -- Luo julkaisun merkintä\n  insert into public.shift_publications (start_date, end_date, status, published_at)\n  values (_start_date, _end_date, 'sent', ts)\n  returning id into pub_id;\n  insert into debug_log (context, message)\n  values ('publish_shifts_instant', 'publication id: ' || pub_id);\n\n  -- Luo in-app ilmoitukset\n  insert into public.employee_notifications (employee_id, type, title, message, created_at, is_read, priority)\n  select distinct s.employee_id,\n         'schedule_published',\n         'Uusi aikataulu julkaistu',\n         'Tarkista uudet työvuorosi. Julkaisu: ' || pub_id,\n         ts, false, 'high'\n  from public.shifts s\n  where s.work_date between _start_date and _end_date\n    and s.published = true;\n  insert into debug_log (context, message)\n  values ('publish_shifts_instant', 'notifications inserted: ' || found);\n\n  -- Kerää emailit\n  select array_agg(distinct e.email)\n  into emails\n  from public.shifts s\n  join public.employees e on e.id = s.employee_id\n  where s.work_date between _start_date and _end_date\n    and s.published = true\n    and e.email is not null;\n  insert into debug_log (context, message)\n  values ('publish_shifts_instant', 'emails collected: ' || coalesce(array_length(emails,1),0));\n\n  -- Lähetä kaikki kerralla arrayna\n  if emails is not null and array_length(emails,1) > 0 then\n    perform net.http_post(\n      url := 'https://musrmpblsazxcrhwthtc.functions.supabase.co/sendemail',\n      headers := jsonb_build_object(\n        'Authorization','Bearer ' || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.[REDACTED].IsmXis0LAg4lUTD9nSB1i9212C9f1JSet0bKYKW1s1w',\n        'Content-Type','application/json'\n      ),\n      body := jsonb_build_object(\n        'to', (select jsonb_agg(e) from unnest(emails) e),\n        'subject','Uudet vuorot julkaistu',\n        'text','Sinulle on julkaistu uusia vuoroja. Tarkista työvuorosi sovelluksesta.'\n      )\n    );\n    insert into debug_log (context, message)\n    values ('publish_shifts_instant', 'http_post executed, recipients: ' || array_to_string(emails, ', '));\n  else\n    insert into debug_log (context, message)\n    values ('publish_shifts_instant', 'no emails to send');\n  end if;\n\n  insert into debug_log (context, message)\n  values ('publish_shifts_instant', 'end');\nend;\n$$;\n\n\nALTER FUNCTION \"public\".\"publish_shifts_instant\"(\"_start_date\" \"date\", \"_end_date\" \"date\") OWNER TO \"postgres\";\n\n\nCREATE OR REPLACE FUNCTION \"public\".\"publish_shifts_instant_debug\"(\"_start_date\" \"date\", \"_end_date\" \"date\") RETURNS \"jsonb\"\n    LANGUAGE \"plpgsql\" SECURITY DEFINER\n    AS $$\ndeclare\n  ts timestamp := now();\n  pub_id uuid;\n  emails text[];\n  sent_count int := 0;\nbegin\n  -- Merkitse vuorot julkaistuiksi\n  update public.shifts\n  set published = true, published_at = ts\n  where work_date between _start_date and _end_date\n    and published = false;\n\n  -- Luo julkaisun merkintä\n  insert into public.shift_publications (start_date, end_date, status, published_at)\n  values (_start_date, _end_date, 'sent', ts)\n  returning id into pub_id;\n\n  -- Luo in-app ilmoitukset\n  insert into public.employee_notifications (employee_id, type, title, message, created_at, is_read, priority)\n  select distinct s.employee_id,\n         'schedule_published',\n         'Uusi aikataulu julkaistu',\n         'Tarkista uudet työvuorosi. Julkaisu: ' || pub_id,\n         ts, false, 'high'\n  from public.shifts s\n  where s.work_date between _start_date and _end_date\n    and s.published = true\n  group by s.employee_id;\n\n  -- Kerää emailit\n  select array_agg(distinct e.email)\n  into emails\n  from public.shifts s\n  join public.employees e on e.id = s.employee_id\n  where s.work_date between _start_date and _end_date\n    and s.published = true\n    and e.email is not null;\n\n  -- Lähetä sähköpostit yksi kerrallaan\n  if emails is not null and array_length(emails,1) > 0 then\n    for i in 1 .. array_length(emails,1) loop\n      perform net.http_post(\n        url := 'https://musrmpblsazxcrhwthtc.functions.supabase.co/sendemail',\n        headers := jsonb_build_object(\n          'Authorization','Bearer ' || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.[REDACTED].IsmXis0LAg4lUTD9nSB1i9212C9f1JSet0bKYKW1s1w',\n          'Content-Type','application/json'\n        ),\n        body := jsonb_build_object(\n          'to', emails[i],\n          'subject','Uudet vuorot julkaistu',\n          'text','Sinulle on julkaistu uusia vuoroja. Tarkista työvuorosi sovelluksesta.'\n        )\n      );\n      sent_count := sent_count + 1;\n    end loop;\n\n    return jsonb_build_object('emails', emails, 'sent_count', sent_count);\n  else\n    return jsonb_build_object('emails','[]','sent_count',0,'error','no emails found');\n  end if;\nend;\n$$;\n\n\nALTER FUNCTION \"public\".\"publish_shifts_instant_debug\"(\"_start_date\" \"date\", \"_end_date\" \"date\") OWNER TO \"postgres\";\n\n\nCREATE OR REPLACE FUNCTION \"public\".\"save_shifts_bulk\"(\"_deletes\" \"jsonb\", \"_upserts\" \"jsonb\") RETURNS \"void\"\n    LANGUAGE \"plpgsql\"\n    AS $$\nBEGIN\n  -- 1) Poistot\n  DELETE FROM public.shifts s\n  USING jsonb_to_recordset(_deletes) AS d(employee_id uuid, work_date date)\n  WHERE s.employee_id = d.employee_id\n    AND s.work_date = d.work_date;\n\n  -- 2) Upsertit\n  INSERT INTO public.shifts (employee_id, work_date, type, minutes)\n  SELECT employee_id, work_date, type, minutes\n  FROM jsonb_to_recordset(_upserts)\n       AS u(employee_id uuid, work_date date, type text, minutes int)\n  ON CONFLICT (employee_id, work_date)\n  DO UPDATE\n    SET type = EXCLUDED.type,\n        minutes = EXCLUDED.minutes,\n        updated_at = now();\nEND;\n$$;\n\n\nALTER FUNCTION \"public\".\"save_shifts_bulk\"(\"_deletes\" \"jsonb\", \"_upserts\" \"jsonb\") OWNER TO \"postgres\";\n\n\nCREATE OR REPLACE FUNCTION \"public\".\"set_updated_at\"() RETURNS \"trigger\"\n    LANGUAGE \"plpgsql\"\n    AS $$\nbegin\n  new.updated_at = now();\n  return new;\nend; $$;\n\n\nALTER FUNCTION \"public\".\"set_updated_at\"() OWNER TO \"postgres\";\n\n\nCREATE OR REPLACE FUNCTION \"public\".\"upsert_shifts\"(\"_employee_id\" \"uuid\", \"_work_date\" \"date\", \"_type\" \"text\", \"_minutes\" integer) RETURNS \"void\"\n    LANGUAGE \"plpgsql\"\n    AS $$\nbegin\n  insert into public.shifts (employee_id, work_date, type, minutes)\n  values (_employee_id, _work_date, _type, _minutes)\n  on conflict (employee_id, work_date)\n  do update set\n    type = excluded.type,\n    minutes = excluded.minutes;\nend;\n$$;\n\n\nALTER FUNCTION \"public\".\"upsert_shifts\"(\"_employee_id\" \"uuid\", \"_work_date\" \"date\", \"_type\" \"text\", \"_minutes\" integer) OWNER TO \"postgres\";\n\n\nCREATE OR REPLACE FUNCTION \"public\".\"upsert_shifts_bulk\"(\"_rows\" \"jsonb\") RETURNS \"void\"\n    LANGUAGE \"plpgsql\"\n    AS $$\nBEGIN\n  INSERT INTO public.shifts (employee_id, work_date, type, minutes)\n  SELECT employee_id, work_date, type, minutes\n  FROM jsonb_to_recordset(_rows)\n       AS x(employee_id uuid, work_date date, type text, minutes integer)\n  WHERE minutes IS NOT NULL AND minutes > 0\n  ON CONFLICT (employee_id, work_date)\n  DO UPDATE\n    SET type = EXCLUDED.type,\n        minutes = EXCLUDED.minutes,\n        updated_at = now();\nEND;\n$$;\n\n\nALTER FUNCTION \"public\".\"upsert_shifts_bulk\"(\"_rows\" \"jsonb\") OWNER TO \"postgres\";\n\n\nCREATE OR REPLACE FUNCTION \"storage\".\"can_insert_object\"(\"bucketid\" \"text\", \"name\" \"text\", \"owner\" \"uuid\", \"metadata\" \"jsonb\") RETURNS \"void\"\n    LANGUAGE \"plpgsql\"\n    AS $$\nBEGIN\n  INSERT INTO \"storage\".\"objects\" (\"bucket_id\", \"name\", \"owner\", \"metadata\") VALUES (bucketid, name, owner, metadata);\n  -- hack to rollback the successful insert\n  RAISE sqlstate 'PT200' using\n  message = 'ROLLBACK',\n  detail = 'rollback successful insert';\nEND\n$$;\n\n\nALTER FUNCTION \"storage\".\"can_insert_object\"(\"bucketid\" \"text\", \"name\" \"text\", \"owner\" \"uuid\", \"metadata\" \"jsonb\") OWNER TO \"supabase_storage_admin\";\n\n\nCREATE OR REPLACE FUNCTION \"storage\".\"extension\"(\"name\" \"text\") RETURNS \"text\"\n    LANGUAGE \"plpgsql\"\n    AS $$\nDECLARE\n_parts text[];\n_filename text;\nBEGIN\n\tselect string_to_array(name, '/') into _parts;\n\tselect _parts[array_length(_parts,1)] into _filename;\n\t-- @todo return the last part instead of 2\n\treturn reverse(split_part(reverse(_filename), '.', 1));\nEND\n$$;\n\n\nALTER FUNCTION \"storage\".\"extension\"(\"name\" \"text\") OWNER TO \"supabase_storage_admin\";\n\n\nCREATE OR REPLACE FUNCTION \"storage\".\"filename\"(\"name\" \"text\") RETURNS \"text\"\n    LANGUAGE \"plpgsql\"\n    AS $$\nDECLARE\n_parts text[];\nBEGIN\n\tselect string_to_array(name, '/') into _parts;\n\treturn _parts[array_length(_parts,1)];\nEND\n$$;\n\n\nALTER FUNCTION \"storage\".\"filename\"(\"name\" \"text\") OWNER TO \"supabase_storage_admin\";\n\n\nCREATE OR REPLACE FUNCTION \"storage\".\"foldername\"(\"name\" \"text\") RETURNS \"text\"[]\n    LANGUAGE \"plpgsql\"\n    AS $$\nDECLARE\n_parts text[];\nBEGIN\n\tselect string_to_array(name, '/') into _parts;\n\treturn _parts[1:array_length(_parts,1)-1];\nEND\n$$;\n\n\nALTER FUNCTION \"storage\".\"foldername\"(\"name\" \"text\") OWNER TO \"supabase_storage_admin\";\n\n\nCREATE OR REPLACE FUNCTION \"storage\".\"get_size_by_bucket\"() RETURNS TABLE(\"size\" bigint, \"bucket_id\" \"text\")\n    LANGUAGE \"plpgsql\"\n    AS $$\nBEGIN\n    return query\n        select sum((metadata->>'size')::int) as size, obj.bucket_id\n        from \"storage\".objects as obj\n        group by obj.bucket_id;\nEND\n$$;\n\n\nALTER FUNCTION \"storage\".\"get_size_by_bucket\"() OWNER TO \"supabase_storage_admin\";\n\n\nCREATE OR REPLACE FUNCTION \"storage\".\"list_multipart_uploads_with_delimiter\"(\"bucket_id\" \"text\", \"prefix_param\" \"text\", \"delimiter_param\" \"text\", \"max_keys\" integer DEFAULT 100, \"next_key_token\" \"text\" DEFAULT ''::\"text\", \"next_upload_token\" \"text\" DEFAULT ''::\"text\") RETURNS TABLE(\"key\" \"text\", \"id\" \"text\", \"created_at\" timestamp with time zone)\n    LANGUAGE \"plpgsql\"\n    AS $_$\nBEGIN\n    RETURN QUERY EXECUTE\n        'SELECT DISTINCT ON(key COLLATE \"C\") * from (\n            SELECT\n                CASE\n                    WHEN position($2 IN substring(key from length($1) + 1)) > 0 THEN\n                        substring(key from 1 for length($1) + position($2 IN substring(key from length($1) + 1)))\n                    ELSE\n                        key\n                END AS key, id, created_at\n            FROM\n                storage.s3_multipart_uploads\n            WHERE\n                bucket_id = $5 AND\n                key ILIKE $1 || ''%'' AND\n                CASE\n                    WHEN $4 != '''' AND $6 = '''' THEN\n                        CASE\n                            WHEN position($2 IN substring(key from length($1) + 1)) > 0 THEN\n                                substring(key from 1 for length($1) + position($2 IN substring(key from length($1) + 1))) COLLATE \"C\" > $4\n                            ELSE\n                                key COLLATE \"C\" > $4\n                            END\n                    ELSE\n                        true\n                END AND\n                CASE\n                    WHEN $6 != '''' THEN\n                        id COLLATE \"C\" > $6\n                    ELSE\n                        true\n                    END\n            ORDER BY\n                key COLLATE \"C\" ASC, created_at ASC) as e order by key COLLATE \"C\" LIMIT $3'\n        USING prefix_param, delimiter_param, max_keys, next_key_token, bucket_id, next_upload_token;\nEND;\n$_$;\n\n\nALTER FUNCTION \"storage\".\"list_multipart_uploads_with_delimiter\"(\"bucket_id\" \"text\", \"prefix_param\" \"text\", \"delimiter_param\" \"text\", \"max_keys\" integer, \"next_key_token\" \"text\", \"next_upload_token\" \"text\") OWNER TO \"supabase_storage_admin\";\n\n\nCREATE OR REPLACE FUNCTION \"storage\".\"list_objects_with_delimiter\"(\"bucket_id\" \"text\", \"prefix_param\" \"text\", \"delimiter_param\" \"text\", \"max_keys\" integer DEFAULT 100, \"start_after\" \"text\" DEFAULT ''::\"text\", \"next_token\" \"text\" DEFAULT ''::\"text\") RETURNS TABLE(\"name\" \"text\", \"id\" \"uuid\", \"metadata\" \"jsonb\", \"updated_at\" timestamp with time zone)\n    LANGUAGE \"plpgsql\"\n    AS $_$\nBEGIN\n    RETURN QUERY EXECUTE\n        'SELECT DISTINCT ON(name COLLATE \"C\") * from (\n            SELECT\n                CASE\n                    WHEN position($2 IN substring(name from length($1) + 1)) > 0 THEN\n                        substring(name from 1 for length($1) + position($2 IN substring(name from length($1) + 1)))\n                    ELSE\n                        name\n                END AS name, id, metadata, updated_at\n            FROM\n                storage.objects\n            WHERE\n                bucket_id = $5 AND\n                name ILIKE $1 || ''%'' AND\n                CASE\n                    WHEN $6 != '''' THEN\n                    name COLLATE \"C\" > $6\n                ELSE true END\n                AND CASE\n                    WHEN $4 != '''' THEN\n                        CASE\n                            WHEN position($2 IN substring(name from length($1) + 1)) > 0 THEN\n                                substring(name from 1 for length($1) + position($2 IN substring(name from length($1) + 1))) COLLATE \"C\" > $4\n                            ELSE\n                                name COLLATE \"C\" > $4\n                            END\n                    ELSE\n                        true\n                END\n            ORDER BY\n                name COLLATE \"C\" ASC) as e order by name COLLATE \"C\" LIMIT $3'\n        USING prefix_param, delimiter_param, max_keys, next_token, bucket_id, start_after;\nEND;\n$_$;\n\n\nALTER FUNCTION \"storage\".\"list_objects_with_delimiter\"(\"bucket_id\" \"text\", \"prefix_param\" \"text\", \"delimiter_param\" \"text\", \"max_keys\" integer, \"start_after\" \"text\", \"next_token\" \"text\") OWNER TO \"supabase_storage_admin\";\n\n\nCREATE OR REPLACE FUNCTION \"storage\".\"operation\"() RETURNS \"text\"\n    LANGUAGE \"plpgsql\" STABLE\n    AS $$\nBEGIN\n    RETURN current_setting('storage.operation', true);\nEND;\n$$;\n\n\nALTER FUNCTION \"storage\".\"operation\"() OWNER TO \"supabase_storage_admin\";\n\n\nCREATE OR REPLACE FUNCTION \"storage\".\"search\"(\"prefix\" \"text\", \"bucketname\" \"text\", \"limits\" integer DEFAULT 100, \"levels\" integer DEFAULT 1, \"offsets\" integer DEFAULT 0, \"search\" \"text\" DEFAULT ''::\"text\", \"sortcolumn\" \"text\" DEFAULT 'name'::\"text\", \"sortorder\" \"text\" DEFAULT 'asc'::\"text\") RETURNS TABLE(\"name\" \"text\", \"id\" \"uuid\", \"updated_at\" timestamp with time zone, \"created_at\" timestamp with time zone, \"last_accessed_at\" timestamp with time zone, \"metadata\" \"jsonb\")\n    LANGUAGE \"plpgsql\" STABLE\n    AS $_$\ndeclare\n  v_order_by text;\n  v_sort_order text;\nbegin\n  case\n    when sortcolumn = 'name' then\n      v_order_by = 'name';\n    when sortcolumn = 'updated_at' then\n      v_order_by = 'updated_at';\n    when sortcolumn = 'created_at' then\n      v_order_by = 'created_at';\n    when sortcolumn = 'last_accessed_at' then\n      v_order_by = 'last_accessed_at';\n    else\n      v_order_by = 'name';\n  end case;\n\n  case\n    when sortorder = 'asc' then\n      v_sort_order = 'asc';\n    when sortorder = 'desc' then\n      v_sort_order = 'desc';\n    else\n      v_sort_order = 'asc';\n  end case;\n\n  v_order_by = v_order_by || ' ' || v_sort_order;\n\n  return query execute\n    'with folders as (\n       select path_tokens[$1] as folder\n       from storage.objects\n         where objects.name ilike $2 || $3 || ''%''\n           and bucket_id = $4\n           and array_length(objects.path_tokens, 1) <> $1\n       group by folder\n       order by folder ' || v_sort_order || '\n     )\n     (select folder as \"name\",\n            null as id,\n            null as updated_at,\n            null as created_at,\n            null as last_accessed_at,\n            null as metadata from folders)\n     union all\n     (select path_tokens[$1] as \"name\",\n            id,\n            updated_at,\n            created_at,\n            last_accessed_at,\n            metadata\n     from storage.objects\n     where objects.name ilike $2 || $3 || ''%''\n       and bucket_id = $4\n       and array_length(objects.path_tokens, 1) = $1\n     order by ' || v_order_by || ')\n     limit $5\n     offset $6' using levels, prefix, search, bucketname, limits, offsets;\nend;\n$_$;\n\n\nALTER FUNCTION \"storage\".\"search\"(\"prefix\" \"text\", \"bucketname\" \"text\", \"limits\" integer, \"levels\" integer, \"offsets\" integer, \"search\" \"text\", \"sortcolumn\" \"text\", \"sortorder\" \"text\") OWNER TO \"supabase_storage_admin\";\n\n\nCREATE OR REPLACE FUNCTION \"storage\".\"update_updated_at_column\"() RETURNS \"trigger\"\n    LANGUAGE \"plpgsql\"\n    AS $$\nBEGIN\n    NEW.updated_at = now();\n    RETURN NEW; \nEND;\n$$;\n\n\nSET default_tablespace = '';\n\nSET default_table_access_method = heap;\n\nALTER FUNCTION \"storage\".\"update_updated_at_column\"() OWNER TO \"supabase_storage_admin\";\n\nSET default_tablespace = '';\n\nSET default_table_access_method = \"heap\";\n\n\nCREATE TABLE IF NOT EXISTS \"auth\".\"audit_log_entries\" (\n    \"instance_id\" \"uuid\",\n    \"id\" \"uuid\" NOT NULL,\n    \"payload\" json,\n    \"created_at\" timestamp with time zone,\n    \"ip_address\" character varying(64) DEFAULT ''::character varying NOT NULL\n);\n\n\nALTER TABLE \"auth\".\"audit_log_entries\" OWNER TO \"supabase_auth_admin\";\n\n\nCOMMENT ON TABLE \"auth\".\"audit_log_entries\" IS 'Auth: Audit trail for user actions.';\n\n\n\nCREATE TABLE IF NOT EXISTS \"auth\".\"flow_state\" (\n    \"id\" \"uuid\" NOT NULL,\n    \"user_id\" \"uuid\",\n    \"auth_code\" \"text\" NOT NULL,\n    \"code_challenge_method\" \"auth\".\"code_challenge_method\" NOT NULL,\n    \"code_challenge\" \"text\" NOT NULL,\n    \"provider_type\" \"text\" NOT NULL,\n    \"provider_access_token\" \"text\",\n    \"provider_refresh_token\" \"text\",\n    \"created_at\" timestamp with time zone,\n    \"updated_at\" timestamp with time zone,\n    \"authentication_method\" \"text\" NOT NULL,\n    \"auth_code_issued_at\" timestamp with time zone\n);\n\n\nALTER TABLE \"auth\".\"flow_state\" OWNER TO \"supabase_auth_admin\";\n\n\nCOMMENT ON TABLE \"auth\".\"flow_state\" IS 'stores metadata for pkce logins';\n\n\n\nCREATE TABLE IF NOT EXISTS \"auth\".\"identities\" (\n    \"provider_id\" \"text\" NOT NULL,\n    \"user_id\" \"uuid\" NOT NULL,\n    \"identity_data\" \"jsonb\" NOT NULL,\n    \"provider\" \"text\" NOT NULL,\n    \"last_sign_in_at\" timestamp with time zone,\n    \"created_at\" timestamp with time zone,\n    \"updated_at\" timestamp with time zone,\n    \"email\" \"text\" GENERATED ALWAYS AS (\"lower\"((\"identity_data\" ->> 'email'::\"text\"))) STORED,\n    \"id\" \"uuid\" DEFAULT \"gen_random_uuid\"() NOT NULL\n);\n\n\nALTER TABLE \"auth\".\"identities\" OWNER TO \"supabase_auth_admin\";\n\n\nCOMMENT ON TABLE \"auth\".\"identities\" IS 'Auth: Stores identities associated to a user.';\n\n\n\nCOMMENT ON COLUMN \"auth\".\"identities\".\"email\" IS 'Auth: Email is a generated column that references the optional email property in the identity_data';\n\n\n\nCREATE TABLE IF NOT EXISTS \"auth\".\"instances\" (\n    \"id\" \"uuid\" NOT NULL,\n    \"uuid\" \"uuid\",\n    \"raw_base_config\" \"text\",\n    \"created_at\" timestamp with time zone,\n    \"updated_at\" timestamp with time zone\n);\n\n\nALTER TABLE \"auth\".\"instances\" OWNER TO \"supabase_auth_admin\";\n\n\nCOMMENT ON TABLE \"auth\".\"instances\" IS 'Auth: Manages users across multiple sites.';\n\n\n\nCREATE TABLE IF NOT EXISTS \"auth\".\"mfa_amr_claims\" (\n    \"session_id\" \"uuid\" NOT NULL,\n    \"created_at\" timestamp with time zone NOT NULL,\n    \"updated_at\" timestamp with time zone NOT NULL,\n    \"authentication_method\" \"text\" NOT NULL,\n    \"id\" \"uuid\" NOT NULL\n);\n\n\nALTER TABLE \"auth\".\"mfa_amr_claims\" OWNER TO \"supabase_auth_admin\";\n\n\nCOMMENT ON TABLE \"auth\".\"mfa_amr_claims\" IS 'auth: stores authenticator method reference claims for multi factor authentication';\n\n\n\nCREATE TABLE IF NOT EXISTS \"auth\".\"mfa_challenges\" (\n    \"id\" \"uuid\" NOT NULL,\n    \"factor_id\" \"uuid\" NOT NULL,\n    \"created_at\" timestamp with time zone NOT NULL,\n    \"verified_at\" timestamp with time zone,\n    \"ip_address\" \"inet\" NOT NULL,\n    \"otp_code\" \"text\",\n    \"web_authn_session_data\" \"jsonb\"\n);\n\n\nALTER TABLE \"auth\".\"mfa_challenges\" OWNER TO \"supabase_auth_admin\";\n\n\nCOMMENT ON TABLE \"auth\".\"mfa_challenges\" IS 'auth: stores metadata about challenge requests made';\n\n\n\nCREATE TABLE IF NOT EXISTS \"auth\".\"mfa_factors\" (\n    \"id\" \"uuid\" NOT NULL,\n    \"user_id\" \"uuid\" NOT NULL,\n    \"friendly_name\" \"text\",\n    \"factor_type\" \"auth\".\"factor_type\" NOT NULL,\n    \"status\" \"auth\".\"factor_status\" NOT NULL,\n    \"created_at\" timestamp with time zone NOT NULL,\n    \"updated_at\" timestamp with time zone NOT NULL,\n    \"secret\" \"text\",\n    \"phone\" \"text\",\n    \"last_challenged_at\" timestamp with time zone,\n    \"web_authn_credential\" \"jsonb\",\n    \"web_authn_aaguid\" \"uuid\"\n);\n\n\nALTER TABLE \"auth\".\"mfa_factors\" OWNER TO \"supabase_auth_admin\";\n\n\nCOMMENT ON TABLE \"auth\".\"mfa_factors\" IS 'auth: stores metadata about factors';\n\n\n\nCREATE TABLE IF NOT EXISTS \"auth\".\"oauth_clients\" (\n    \"id\" \"uuid\" NOT NULL,\n    \"client_id\" \"text\" NOT NULL,\n    \"client_secret_hash\" \"text\" NOT NULL,\n    \"registration_type\" \"auth\".\"oauth_registration_type\" NOT NULL,\n    \"redirect_uris\" \"text\" NOT NULL,\n    \"grant_types\" \"text\" NOT NULL,\n    \"client_name\" \"text\",\n    \"client_uri\" \"text\",\n    \"logo_uri\" \"text\",\n    \"created_at\" timestamp with time zone DEFAULT \"now\"() NOT NULL,\n    \"updated_at\" timestamp with time zone DEFAULT \"now\"() NOT NULL,\n    \"deleted_at\" timestamp with time zone,\n    CONSTRAINT \"oauth_clients_client_name_length\" CHECK ((\"char_length\"(\"client_name\") <= 1024)),\n    CONSTRAINT \"oauth_clients_client_uri_length\" CHECK ((\"char_length\"(\"client_uri\") <= 2048)),\n    CONSTRAINT \"oauth_clients_logo_uri_length\" CHECK ((\"char_length\"(\"logo_uri\") <= 2048))\n);\n\n\nALTER TABLE \"auth\".\"oauth_clients\" OWNER TO \"supabase_auth_admin\";\n\n\nCREATE TABLE IF NOT EXISTS \"auth\".\"one_time_tokens\" (\n    \"id\" \"uuid\" NOT NULL,\n    \"user_id\" \"uuid\" NOT NULL,\n    \"token_type\" \"auth\".\"one_time_token_type\" NOT NULL,\n    \"token_hash\" \"text\" NOT NULL,\n    \"relates_to\" \"text\" NOT NULL,\n    \"created_at\" timestamp without time zone DEFAULT \"now\"() NOT NULL,\n    \"updated_at\" timestamp without time zone DEFAULT \"now\"() NOT NULL,\n    CONSTRAINT \"one_time_tokens_token_hash_check\" CHECK ((\"char_length\"(\"token_hash\") > 0))\n);\n\n\nALTER TABLE \"auth\".\"one_time_tokens\" OWNER TO \"supabase_auth_admin\";\n\n\nCREATE TABLE IF NOT EXISTS \"auth\".\"refresh_tokens\" (\n    \"instance_id\" \"uuid\",\n    \"id\" bigint NOT NULL,\n    \"token\" character varying(255),\n    \"user_id\" character varying(255),\n    \"revoked\" boolean,\n    \"created_at\" timestamp with time zone,\n    \"updated_at\" timestamp with time zone,\n    \"parent\" character varying(255),\n    \"session_id\" \"uuid\"\n);\n\n\nALTER TABLE \"auth\".\"refresh_tokens\" OWNER TO \"supabase_auth_admin\";\n\n\nCOMMENT ON TABLE \"auth\".\"refresh_tokens\" IS 'Auth: Store of tokens used to refresh JWT tokens once they expire.';\n\n\n\nCREATE SEQUENCE IF NOT EXISTS \"auth\".\"refresh_tokens_id_seq\"\n    START WITH 1\n    INCREMENT BY 1\n    NO MINVALUE\n    NO MAXVALUE\n    CACHE 1;\n\n\nALTER SEQUENCE \"auth\".\"refresh_tokens_id_seq\" OWNER TO \"supabase_auth_admin\";\n\n\nALTER SEQUENCE \"auth\".\"refresh_tokens_id_seq\" OWNED BY \"auth\".\"refresh_tokens\".\"id\";\n\n\n\nCREATE TABLE IF NOT EXISTS \"auth\".\"saml_providers\" (\n    \"id\" \"uuid\" NOT NULL,\n    \"sso_provider_id\" \"uuid\" NOT NULL,\n    \"entity_id\" \"text\" NOT NULL,\n    \"metadata_xml\" \"text\" NOT NULL,\n    \"metadata_url\" \"text\",\n    \"attribute_mapping\" \"jsonb\",\n    \"created_at\" timestamp with time zone,\n    \"updated_at\" timestamp with time zone,\n    \"name_id_format\" \"text\",\n    CONSTRAINT \"entity_id not empty\" CHECK ((\"char_length\"(\"entity_id\") > 0)),\n    CONSTRAINT \"metadata_url not empty\" CHECK (((\"metadata_url\" = NULL::\"text\") OR (\"char_length\"(\"metadata_url\") > 0))),\n    CONSTRAINT \"metadata_xml not empty\" CHECK ((\"char_length\"(\"metadata_xml\") > 0))\n);\n\n\nALTER TABLE \"auth\".\"saml_providers\" OWNER TO \"supabase_auth_admin\";\n\n\nCOMMENT ON TABLE \"auth\".\"saml_providers\" IS 'Auth: Manages SAML Identity Provider connections.';\n\n\n\nCREATE TABLE IF NOT EXISTS \"auth\".\"saml_relay_states\" (\n    \"id\" \"uuid\" NOT NULL,\n    \"sso_provider_id\" \"uuid\" NOT NULL,\n    \"request_id\" \"text\" NOT NULL,\n    \"for_email\" \"text\",\n    \"redirect_to\" \"text\",\n    \"created_at\" timestamp with time zone,\n    \"updated_at\" timestamp with time zone,\n    \"flow_state_id\" \"uuid\",\n    CONSTRAINT \"request_id not empty\" CHECK ((\"char_length\"(\"request_id\") > 0))\n);\n\n\nALTER TABLE \"auth\".\"saml_relay_states\" OWNER TO \"supabase_auth_admin\";\n\n\nCOMMENT ON TABLE \"auth\".\"saml_relay_states\" IS 'Auth: Contains SAML Relay State information for each Service Provider initiated login.';\n\n\n\nCREATE TABLE IF NOT EXISTS \"auth\".\"schema_migrations\" (\n    \"version\" character varying(255) NOT NULL\n);\n\n\nALTER TABLE \"auth\".\"schema_migrations\" OWNER TO \"supabase_auth_admin\";\n\n\nCOMMENT ON TABLE \"auth\".\"schema_migrations\" IS 'Auth: Manages updates to the auth system.';\n\n\n\nCREATE TABLE IF NOT EXISTS \"auth\".\"sessions\" (\n    \"id\" \"uuid\" NOT NULL,\n    \"user_id\" \"uuid\" NOT NULL,\n    \"created_at\" timestamp with time zone,\n    \"updated_at\" timestamp with time zone,\n    \"factor_id\" \"uuid\",\n    \"aal\" \"auth\".\"aal_level\",\n    \"not_after\" timestamp with time zone,\n    \"refreshed_at\" timestamp without time zone,\n    \"user_agent\" \"text\",\n    \"ip\" \"inet\",\n    \"tag\" \"text\"\n);\n\n\nALTER TABLE \"auth\".\"sessions\" OWNER TO \"supabase_auth_admin\";\n\n\nCOMMENT ON TABLE \"auth\".\"sessions\" IS 'Auth: Stores session data associated to a user.';\n\n\n\nCOMMENT ON COLUMN \"auth\".\"sessions\".\"not_after\" IS 'Auth: Not after is a nullable column that contains a timestamp after which the session should be regarded as expired.';\n\n\n\nCREATE TABLE IF NOT EXISTS \"auth\".\"sso_domains\" (\n    \"id\" \"uuid\" NOT NULL,\n    \"sso_provider_id\" \"uuid\" NOT NULL,\n    \"domain\" \"text\" NOT NULL,\n    \"created_at\" timestamp with time zone,\n    \"updated_at\" timestamp with time zone,\n    CONSTRAINT \"domain not empty\" CHECK ((\"char_length\"(\"domain\") > 0))\n);\n\n\nALTER TABLE \"auth\".\"sso_domains\" OWNER TO \"supabase_auth_admin\";\n\n\nCOMMENT ON TABLE \"auth\".\"sso_domains\" IS 'Auth: Manages SSO email address domain mapping to an SSO Identity Provider.';\n\n\n\nCREATE TABLE IF NOT EXISTS \"auth\".\"sso_providers\" (\n    \"id\" \"uuid\" NOT NULL,\n    \"resource_id\" \"text\",\n    \"created_at\" timestamp with time zone,\n    \"updated_at\" timestamp with time zone,\n    \"disabled\" boolean,\n    CONSTRAINT \"resource_id not empty\" CHECK (((\"resource_id\" = NULL::\"text\") OR (\"char_length\"(\"resource_id\") > 0)))\n);\n\n\nALTER TABLE \"auth\".\"sso_providers\" OWNER TO \"supabase_auth_admin\";\n\n\nCOMMENT ON TABLE \"auth\".\"sso_providers\" IS 'Auth: Manages SSO identity provider information; see saml_providers for SAML.';\n\n\n\nCOMMENT ON COLUMN \"auth\".\"sso_providers\".\"resource_id\" IS 'Auth: Uniquely identifies a SSO provider according to a user-chosen resource ID (case insensitive), useful in infrastructure as code.';\n\n\n\nCREATE TABLE IF NOT EXISTS \"auth\".\"users\" (\n    \"instance_id\" \"uuid\",\n    \"id\" \"uuid\" NOT NULL,\n    \"aud\" character varying(255),\n    \"role\" character varying(255),\n    \"email\" character varying(255),\n    \"encrypted_password\" character varying(255),\n    \"email_confirmed_at\" timestamp with time zone,\n    \"invited_at\" timestamp with time zone,\n    \"confirmation_token\" character varying(255),\n    \"confirmation_sent_at\" timestamp with time zone,\n    \"recovery_token\" character varying(255),\n    \"recovery_sent_at\" timestamp with time zone,\n    \"email_change_token_new\" character varying(255),\n    \"email_change\" character varying(255),\n    \"email_change_sent_at\" timestamp with time zone,\n    \"last_sign_in_at\" timestamp with time zone,\n    \"raw_app_meta_data\" \"jsonb\",\n    \"raw_user_meta_data\" \"jsonb\",\n    \"is_super_admin\" boolean,\n    \"created_at\" timestamp with time zone,\n    \"updated_at\" timestamp with time zone,\n    \"phone\" \"text\" DEFAULT NULL::character varying,\n    \"phone_confirmed_at\" timestamp with time zone,\n    \"phone_change\" \"text\" DEFAULT ''::character varying,\n    \"phone_change_token\" character varying(255) DEFAULT ''::character varying,\n    \"phone_change_sent_at\" timestamp with time zone,\n    \"confirmed_at\" timestamp with time zone GENERATED ALWAYS AS (LEAST(\"email_confirmed_at\", \"phone_confirmed_at\")) STORED,\n    \"email_change_token_current\" character varying(255) DEFAULT ''::character varying,\n    \"email_change_confirm_status\" smallint DEFAULT 0,\n    \"banned_until\" timestamp with time zone,\n    \"reauthentication_token\" character varying(255) DEFAULT ''::character varying,\n    \"reauthentication_sent_at\" timestamp with time zone,\n    \"is_sso_user\" boolean DEFAULT false NOT NULL,\n    \"deleted_at\" timestamp with time zone,\n    \"is_anonymous\" boolean DEFAULT false NOT NULL,\n    CONSTRAINT \"users_email_change_confirm_status_check\" CHECK (((\"email_change_confirm_status\" >= 0) AND (\"email_change_confirm_status\" <= 2)))\n);\n\n\nALTER TABLE \"auth\".\"users\" OWNER TO \"supabase_auth_admin\";\n\n\nCOMMENT ON TABLE \"auth\".\"users\" IS 'Auth: Stores user login data within a secure schema.';\n\n\n\nCOMMENT ON COLUMN \"auth\".\"users\".\"is_sso_user\" IS 'Auth: Set this column to true when the account comes from SSO. These accounts can have duplicate emails.';\n\n\n\nCREATE TABLE IF NOT EXISTS \"public\".\"absences\" (\n    \"id\" \"uuid\" DEFAULT \"gen_random_uuid\"() NOT NULL,\n    \"employee_id\" \"uuid\" NOT NULL,\n    \"start_date\" \"date\" NOT NULL,\n    \"end_date\" \"date\",\n    \"reason\" \"text\",\n    \"message\" \"text\",\n    \"status\" \"text\" DEFAULT 'pending'::\"text\" NOT NULL,\n    \"submitted_at\" timestamp with time zone DEFAULT \"now\"(),\n    CONSTRAINT \"absences_status_valid_check\" CHECK ((\"status\" = ANY (ARRAY['pending'::\"text\", 'approved'::\"text\", 'declined'::\"text\"])))\n);\n\n\nALTER TABLE \"public\".\"absences\" OWNER TO \"postgres\";\n\n\nCREATE TABLE IF NOT EXISTS \"public\".\"app_settings\" (\n    \"id\" integer NOT NULL,\n    \"email_notifications\" boolean DEFAULT true NOT NULL,\n    \"admin_notification_emails\" \"text\"[] DEFAULT '{}'::\"text\"[] NOT NULL,\n    \"absence_requests\" boolean DEFAULT true NOT NULL,\n    \"schedule_changes\" boolean DEFAULT true NOT NULL,\n    \"employee_updates\" boolean DEFAULT false NOT NULL,\n    \"system_updates\" boolean DEFAULT false NOT NULL,\n    \"daily_digest\" boolean DEFAULT false NOT NULL,\n    \"digest_time\" \"text\" DEFAULT '08:00'::\"text\" NOT NULL,\n    \"updated_at\" timestamp with time zone DEFAULT \"now\"() NOT NULL,\n    CONSTRAINT \"app_settings_id_check\" CHECK ((\"id\" = 1))\n);\n\n\n--\n-- Name: employee_notifications; Type: TABLE; Schema: public; Owner: -\n--\n\nCREATE TABLE public.employee_notifications (\n    id uuid DEFAULT gen_random_uuid() NOT NULL,\n    employee_id uuid,\n    type text NOT NULL,\n    title text NOT NULL,\n    message text NOT NULL,\n    priority text DEFAULT 'low'::text NOT NULL,\n    is_read boolean DEFAULT false NOT NULL,\n    created_at timestamp with time zone DEFAULT now() NOT NULL\n);\n\n\n--\n-- Name: employees; Type: TABLE; Schema: public; Owner: -\n--\n\nCREATE TABLE public.employees (\n    id uuid DEFAULT gen_random_uuid() NOT NULL,\n    name text NOT NULL,\n    email text,\n    department text,\n    is_active boolean DEFAULT true NOT NULL,\n    created_at timestamp without time zone DEFAULT now(),\n    auth_user_id uuid,\n    role text DEFAULT 'employee'::text,\n    CONSTRAINT employees_role_check CHECK ((role = ANY (ARRAY['admin'::text, 'employee'::text])))\n);\n\n\n--\n-- Name: shift_publications; Type: TABLE; Schema: public; Owner: -\n--\n\nCREATE TABLE public.shift_publications (\n    id uuid DEFAULT gen_random_uuid() NOT NULL,\n    start_date date NOT NULL,\n    end_date date NOT NULL,\n    published_at timestamp with time zone DEFAULT now() NOT NULL,\n    status text DEFAULT 'pending'::text NOT NULL\n);\n\n\n--\n-- Name: TABLE shift_publications; Type: COMMENT; Schema: public; Owner: -\n--\n\nCOMMENT ON TABLE public.shift_publications IS 'Tallentaa vuorojen julkaisun ja sen tilan (pending/sent/canceled).';\n\n\n--\n-- Name: latest_publications_overview; Type: VIEW; Schema: public; Owner: -\n--\n\nCREATE VIEW public.latest_publications_overview AS\n SELECT sp.id AS publication_id,\n    sp.start_date,\n    sp.end_date,\n    sp.status AS publication_status,\n    count(j.*) FILTER (WHERE (j.status = 'queued'::text)) AS jobs_queued,\n    count(j.*) FILTER (WHERE (j.status = 'processing'::text)) AS jobs_processing,\n    count(j.*) FILTER (WHERE (j.status = 'sent'::text)) AS jobs_sent\n   FROM (public.shift_publications sp\n     LEFT JOIN public.mail_jobs j ON ((((((j.payload ->> 'work_date'::text))::date >= sp.start_date) AND (((j.payload ->> 'work_date'::text))::date <= sp.end_date)) AND (j.type = 'shift_publication'::text))))\n  GROUP BY sp.id, sp.start_date, sp.end_date, sp.status\n  ORDER BY sp.start_date DESC;\n\n\n--\n-- Name: mail_jobs_id_seq; Type: SEQUENCE; Schema: public; Owner: -\n--\n\nALTER TABLE public.mail_jobs ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY (\n    SEQUENCE NAME public.mail_jobs_id_seq\n    START WITH 1\n    INCREMENT BY 1\n    NO MINVALUE\n    NO MAXVALUE\n    CACHE 1\n);\n\n\n--\n-- Name: notifications; Type: TABLE; Schema: public; Owner: -\n--\n\nCREATE TABLE public.notifications (\n    id uuid DEFAULT gen_random_uuid() NOT NULL,\n    type text NOT NULL,\n    title text NOT NULL,\n    message text NOT NULL,\n    created_at timestamp with time zone DEFAULT now() NOT NULL,\n    is_read boolean DEFAULT false NOT NULL,\n    CONSTRAINT notifications_type_check CHECK ((type = ANY (ARRAY['absence_request'::text, 'absence_approved'::text, 'absence_declined'::text, 'employee_added'::text, 'shift_auto'::text])))\n);\n\n\n--\n-- Name: profiles; Type: TABLE; Schema: public; Owner: -\n--\n\nCREATE TABLE public.profiles (\n    id uuid NOT NULL,\n    email text,\n    is_admin boolean DEFAULT false NOT NULL,\n    created_at timestamp with time zone DEFAULT now() NOT NULL\n);\n\n\n--\n-- Name: publication_jobs_debug; Type: VIEW; Schema: public; Owner: -\n--\n\nCREATE VIEW public.publication_jobs_debug AS\n SELECT sp.id AS publication_id,\n    sp.start_date,\n    sp.end_date,\n    sp.status AS publication_status,\n    j.id AS job_id,\n    j.status AS job_status,\n    j.created_at AS job_created,\n    j.processed_at AS job_processed,\n    (j.payload ->> 'employee_id'::text) AS employee_id,\n    (j.payload ->> 'work_date'::text) AS work_date\n   FROM (public.shift_publications sp\n     LEFT JOIN public.mail_jobs j ON ((((((j.payload ->> 'work_date'::text))::date >= sp.start_date) AND (((j.payload ->> 'work_date'::text))::date <= sp.end_date)) AND (j.type = 'shift_publication'::text))))\n  ORDER BY sp.start_date DESC, j.created_at DESC;\n\n\n--\n-- Name: shift_change_requests; Type: TABLE; Schema: public; Owner: -\n--\n\nCREATE TABLE public.shift_change_requests (\n    id uuid DEFAULT gen_random_uuid() NOT NULL,\n    employee_id uuid,\n    target_employee_id uuid,\n    current_shift_date date NOT NULL,\n    requested_shift_date date NOT NULL,\n    reason text,\n    message text,\n    status text DEFAULT 'pending'::text NOT NULL,\n    submitted_at timestamp with time zone DEFAULT now() NOT NULL\n);\n\n\n--\n-- Name: shifts; Type: TABLE; Schema: public; Owner: -\n--\n\nCREATE TABLE public.shifts (\n    id uuid DEFAULT gen_random_uuid() NOT NULL,\n    employee_id uuid NOT NULL,\n    work_date date NOT NULL,\n    start_time time without time zone,\n    end_time time without time zone,\n    type text DEFAULT 'normal'::text NOT NULL,\n    is_locked boolean DEFAULT false NOT NULL,\n    note text,\n    created_at timestamp with time zone DEFAULT now() NOT NULL,\n    updated_at timestamp with time zone DEFAULT now() NOT NULL,\n    published boolean DEFAULT false NOT NULL,\n    published_at timestamp with time zone,\n    minutes integer DEFAULT 0 NOT NULL,\n    CONSTRAINT shifts_time_order_chk CHECK (((start_time IS NULL) OR (end_time IS NULL) OR (start_time < end_time))),\n    CONSTRAINT shifts_type_allowed_chk CHECK ((type = ANY (ARRAY['normal'::text, 'locked'::text, 'absent'::text, 'holiday'::text]))),\n    CONSTRAINT shifts_type_check CHECK ((type = ANY (ARRAY['normal'::text, 'locked'::text, 'absent'::text, 'holiday'::text])))\n);\n\n\n--\n-- Name: time_off_requests; Type: TABLE; Schema: public; Owner: -\n--\n\nCREATE TABLE public.time_off_requests (\n    id uuid DEFAULT gen_random_uuid() NOT NULL,\n    employee_id uuid,\n    start_date date NOT NULL,\n    end_date date NOT NULL,\n    reason text,\n    message text,\n    status text DEFAULT 'pending'::text NOT NULL,\n    submitted_at timestamp with time zone DEFAULT now() NOT NULL\n);\n\n\nALTER TABLE \"public\".\"shift_change_requests\" OWNER TO \"postgres\";\n\n\nCREATE TABLE public.time_periods (\n    id uuid DEFAULT gen_random_uuid() NOT NULL,\n    name text NOT NULL,\n    start_date date NOT NULL,\n    end_date date NOT NULL,\n    created_at timestamp with time zone DEFAULT now()\n);\n\n\n--\n-- Name: messages; Type: TABLE; Schema: realtime; Owner: -\n--\n\nCREATE TABLE realtime.messages (\n    topic text NOT NULL,\n    extension text NOT NULL,\n    payload jsonb,\n    event text,\n    private boolean DEFAULT false,\n    updated_at timestamp without time zone DEFAULT now() NOT NULL,\n    inserted_at timestamp without time zone DEFAULT now() NOT NULL,\n    id uuid DEFAULT gen_random_uuid() NOT NULL\n)\nPARTITION BY RANGE (inserted_at);\n\n\n--\n-- Name: messages_2025_09_06; Type: TABLE; Schema: realtime; Owner: -\n--\n\nCREATE TABLE realtime.messages_2025_09_06 (\n    topic text NOT NULL,\n    extension text NOT NULL,\n    payload jsonb,\n    event text,\n    private boolean DEFAULT false,\n    updated_at timestamp without time zone DEFAULT now() NOT NULL,\n    inserted_at timestamp without time zone DEFAULT now() NOT NULL,\n    id uuid DEFAULT gen_random_uuid() NOT NULL\n);\n\n\n--\n-- Name: messages_2025_09_07; Type: TABLE; Schema: realtime; Owner: -\n--\n\nCREATE TABLE realtime.messages_2025_09_07 (\n    topic text NOT NULL,\n    extension text NOT NULL,\n    payload jsonb,\n    event text,\n    private boolean DEFAULT false,\n    updated_at timestamp without time zone DEFAULT now() NOT NULL,\n    inserted_at timestamp without time zone DEFAULT now() NOT NULL,\n    id uuid DEFAULT gen_random_uuid() NOT NULL\n);\n\n\n--\n-- Name: messages_2025_09_08; Type: TABLE; Schema: realtime; Owner: -\n--\n\nCREATE TABLE realtime.messages_2025_09_08 (\n    topic text NOT NULL,\n    extension text NOT NULL,\n    payload jsonb,\n    event text,\n    private boolean DEFAULT false,\n    updated_at timestamp without time zone DEFAULT now() NOT NULL,\n    inserted_at timestamp without time zone DEFAULT now() NOT NULL,\n    id uuid DEFAULT gen_random_uuid() NOT NULL\n);\n\n\n--\n-- Name: messages_2025_09_09; Type: TABLE; Schema: realtime; Owner: -\n--\n\nCREATE TABLE realtime.messages_2025_09_09 (\n    topic text NOT NULL,\n    extension text NOT NULL,\n    payload jsonb,\n    event text,\n    private boolean DEFAULT false,\n    updated_at timestamp without time zone DEFAULT now() NOT NULL,\n    inserted_at timestamp without time zone DEFAULT now() NOT NULL,\n    id uuid DEFAULT gen_random_uuid() NOT NULL\n);\n\n\n--\n-- Name: messages_2025_09_10; Type: TABLE; Schema: realtime; Owner: -\n--\n\nCREATE TABLE realtime.messages_2025_09_10 (\n    topic text NOT NULL,\n    extension text NOT NULL,\n    payload jsonb,\n    event text,\n    private boolean DEFAULT false,\n    updated_at timestamp without time zone DEFAULT now() NOT NULL,\n    inserted_at timestamp without time zone DEFAULT now() NOT NULL,\n    id uuid DEFAULT gen_random_uuid() NOT NULL\n);\n\n\n--\n-- Name: messages_2025_09_11; Type: TABLE; Schema: realtime; Owner: -\n--\n\nCREATE TABLE realtime.messages_2025_09_11 (\n    topic text NOT NULL,\n    extension text NOT NULL,\n    payload jsonb,\n    event text,\n    private boolean DEFAULT false,\n    updated_at timestamp without time zone DEFAULT now() NOT NULL,\n    inserted_at timestamp without time zone DEFAULT now() NOT NULL,\n    id uuid DEFAULT gen_random_uuid() NOT NULL\n);\n\n\n--\n-- Name: messages_2025_09_12; Type: TABLE; Schema: realtime; Owner: -\n--\n\nCREATE TABLE realtime.messages_2025_09_12 (\n    topic text NOT NULL,\n    extension text NOT NULL,\n    payload jsonb,\n    event text,\n    private boolean DEFAULT false,\n    updated_at timestamp without time zone DEFAULT now() NOT NULL,\n    inserted_at timestamp without time zone DEFAULT now() NOT NULL,\n    id uuid DEFAULT gen_random_uuid() NOT NULL\n);\n\n\n--\n-- Name: schema_migrations; Type: TABLE; Schema: realtime; Owner: -\n--\n\nCREATE TABLE realtime.schema_migrations (\n    version bigint NOT NULL,\n    inserted_at timestamp(0) without time zone\n);\n\n\n--\n-- Name: subscription; Type: TABLE; Schema: realtime; Owner: -\n--\n\nCREATE TABLE realtime.subscription (\n    id bigint NOT NULL,\n    subscription_id uuid NOT NULL,\n    entity regclass NOT NULL,\n    filters realtime.user_defined_filter[] DEFAULT '{}'::realtime.user_defined_filter[] NOT NULL,\n    claims jsonb NOT NULL,\n    claims_role regrole GENERATED ALWAYS AS (realtime.to_regrole((claims ->> 'role'::text))) STORED NOT NULL,\n    created_at timestamp without time zone DEFAULT timezone('utc'::text, now()) NOT NULL\n);\n\n\n--\n-- Name: subscription_id_seq; Type: SEQUENCE; Schema: realtime; Owner: -\n--\n\nALTER TABLE realtime.subscription ALTER COLUMN id ADD GENERATED ALWAYS AS IDENTITY (\n    SEQUENCE NAME realtime.subscription_id_seq\n    START WITH 1\n    INCREMENT BY 1\n    NO MINVALUE\n    NO MAXVALUE\n    CACHE 1\n);\n\n\n--\n-- Name: buckets; Type: TABLE; Schema: storage; Owner: -\n--\n\nCREATE TABLE storage.buckets (\n    id text NOT NULL,\n    name text NOT NULL,\n    owner uuid,\n    created_at timestamp with time zone DEFAULT now(),\n    updated_at timestamp with time zone DEFAULT now(),\n    public boolean DEFAULT false,\n    avif_autodetection boolean DEFAULT false,\n    file_size_limit bigint,\n    allowed_mime_types text[],\n    owner_id text\n);\n\n\nALTER TABLE \"storage\".\"buckets\" OWNER TO \"supabase_storage_admin\";\n\n\nCOMMENT ON COLUMN \"storage\".\"buckets\".\"owner\" IS 'Field is deprecated, use owner_id instead';\n\n\n\nCREATE TABLE IF NOT EXISTS \"storage\".\"migrations\" (\n    \"id\" integer NOT NULL,\n    \"name\" character varying(100) NOT NULL,\n    \"hash\" character varying(40) NOT NULL,\n    \"executed_at\" timestamp without time zone DEFAULT CURRENT_TIMESTAMP\n);\n\n\nALTER TABLE \"storage\".\"migrations\" OWNER TO \"supabase_storage_admin\";\n\n\nCREATE TABLE IF NOT EXISTS \"storage\".\"objects\" (\n    \"id\" \"uuid\" DEFAULT \"gen_random_uuid\"() NOT NULL,\n    \"bucket_id\" \"text\",\n    \"name\" \"text\",\n    \"owner\" \"uuid\",\n    \"created_at\" timestamp with time zone DEFAULT \"now\"(),\n    \"updated_at\" timestamp with time zone DEFAULT \"now\"(),\n    \"last_accessed_at\" timestamp with time zone DEFAULT \"now\"(),\n    \"metadata\" \"jsonb\",\n    \"path_tokens\" \"text\"[] GENERATED ALWAYS AS (\"string_to_array\"(\"name\", '/'::\"text\")) STORED,\n    \"version\" \"text\",\n    \"owner_id\" \"text\",\n    \"user_metadata\" \"jsonb\"\n);\n\n\nALTER TABLE \"storage\".\"objects\" OWNER TO \"supabase_storage_admin\";\n\n\nCOMMENT ON COLUMN \"storage\".\"objects\".\"owner\" IS 'Field is deprecated, use owner_id instead';\n\n\n\nCREATE TABLE IF NOT EXISTS \"storage\".\"s3_multipart_uploads\" (\n    \"id\" \"text\" NOT NULL,\n    \"in_progress_size\" bigint DEFAULT 0 NOT NULL,\n    \"upload_signature\" \"text\" NOT NULL,\n    \"bucket_id\" \"text\" NOT NULL,\n    \"key\" \"text\" NOT NULL COLLATE \"pg_catalog\".\"C\",\n    \"version\" \"text\" NOT NULL,\n    \"owner_id\" \"text\",\n    \"created_at\" timestamp with time zone DEFAULT \"now\"() NOT NULL,\n    \"user_metadata\" \"jsonb\"\n);\n\n\nALTER TABLE \"storage\".\"s3_multipart_uploads\" OWNER TO \"supabase_storage_admin\";\n\n\nCREATE TABLE IF NOT EXISTS \"storage\".\"s3_multipart_uploads_parts\" (\n    \"id\" \"uuid\" DEFAULT \"gen_random_uuid\"() NOT NULL,\n    \"upload_id\" \"text\" NOT NULL,\n    \"size\" bigint DEFAULT 0 NOT NULL,\n    \"part_number\" integer NOT NULL,\n    \"bucket_id\" \"text\" NOT NULL,\n    \"key\" \"text\" NOT NULL COLLATE \"pg_catalog\".\"C\",\n    \"etag\" \"text\" NOT NULL,\n    \"owner_id\" \"text\",\n    \"version\" \"text\" NOT NULL,\n    \"created_at\" timestamp with time zone DEFAULT \"now\"() NOT NULL\n);\n\n\n--\n-- Name: schema_migrations; Type: TABLE; Schema: supabase_migrations; Owner: -\n--\n\nCREATE TABLE supabase_migrations.schema_migrations (\n    version text NOT NULL,\n    statements text[],\n    name text\n);\n\n\n--\n-- Name: seed_files; Type: TABLE; Schema: supabase_migrations; Owner: -\n--\n\nCREATE TABLE supabase_migrations.seed_files (\n    path text NOT NULL,\n    hash text NOT NULL\n);\n\n\n--\n-- Name: messages_2025_09_06; Type: TABLE ATTACH; Schema: realtime; Owner: -\n--\n\nALTER TABLE ONLY realtime.messages ATTACH PARTITION realtime.messages_2025_09_06 FOR VALUES FROM ('2025-09-06 00:00:00') TO ('2025-09-07 00:00:00');\n\n\n--\n-- Name: messages_2025_09_07; Type: TABLE ATTACH; Schema: realtime; Owner: -\n--\n\nALTER TABLE ONLY realtime.messages ATTACH PARTITION realtime.messages_2025_09_07 FOR VALUES FROM ('2025-09-07 00:00:00') TO ('2025-09-08 00:00:00');\n\n\n--\n-- Name: messages_2025_09_08; Type: TABLE ATTACH; Schema: realtime; Owner: -\n--\n\nALTER TABLE ONLY realtime.messages ATTACH PARTITION realtime.messages_2025_09_08 FOR VALUES FROM ('2025-09-08 00:00:00') TO ('2025-09-09 00:00:00');\n\n\n--\n-- Name: messages_2025_09_09; Type: TABLE ATTACH; Schema: realtime; Owner: -\n--\n\nALTER TABLE ONLY realtime.messages ATTACH PARTITION realtime.messages_2025_09_09 FOR VALUES FROM ('2025-09-09 00:00:00') TO ('2025-09-10 00:00:00');\n\n\n--\n-- Name: messages_2025_09_10; Type: TABLE ATTACH; Schema: realtime; Owner: -\n--\n\nALTER TABLE ONLY realtime.messages ATTACH PARTITION realtime.messages_2025_09_10 FOR VALUES FROM ('2025-09-10 00:00:00') TO ('2025-09-11 00:00:00');\n\n\n--\n-- Name: messages_2025_09_11; Type: TABLE ATTACH; Schema: realtime; Owner: -\n--\n\nALTER TABLE ONLY realtime.messages ATTACH PARTITION realtime.messages_2025_09_11 FOR VALUES FROM ('2025-09-11 00:00:00') TO ('2025-09-12 00:00:00');\n\n\n--\n-- Name: messages_2025_09_12; Type: TABLE ATTACH; Schema: realtime; Owner: -\n--\n\nALTER TABLE ONLY realtime.messages ATTACH PARTITION realtime.messages_2025_09_12 FOR VALUES FROM ('2025-09-12 00:00:00') TO ('2025-09-13 00:00:00');\n\n\n--\n-- Name: refresh_tokens id; Type: DEFAULT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.refresh_tokens ALTER COLUMN id SET DEFAULT nextval('auth.refresh_tokens_id_seq'::regclass);\n\n\n--\n-- Name: mfa_amr_claims amr_id_pk; Type: CONSTRAINT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.mfa_amr_claims\n    ADD CONSTRAINT amr_id_pk PRIMARY KEY (id);\n\n\n--\n-- Name: audit_log_entries audit_log_entries_pkey; Type: CONSTRAINT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.audit_log_entries\n    ADD CONSTRAINT audit_log_entries_pkey PRIMARY KEY (id);\n\n\n\nALTER TABLE ONLY \"auth\".\"flow_state\"\n    ADD CONSTRAINT \"flow_state_pkey\" PRIMARY KEY (\"id\");\n\n\n\nALTER TABLE ONLY \"auth\".\"identities\"\n    ADD CONSTRAINT \"identities_pkey\" PRIMARY KEY (\"id\");\n\n\n\nALTER TABLE ONLY \"auth\".\"identities\"\n    ADD CONSTRAINT \"identities_provider_id_provider_unique\" UNIQUE (\"provider_id\", \"provider\");\n\n\n\nALTER TABLE ONLY \"auth\".\"instances\"\n    ADD CONSTRAINT \"instances_pkey\" PRIMARY KEY (\"id\");\n\n\n\nALTER TABLE ONLY \"auth\".\"mfa_amr_claims\"\n    ADD CONSTRAINT \"[REDACTED]\" UNIQUE (\"session_id\", \"authentication_method\");\n\n\n\nALTER TABLE ONLY \"auth\".\"mfa_challenges\"\n    ADD CONSTRAINT \"mfa_challenges_pkey\" PRIMARY KEY (\"id\");\n\n\n\nALTER TABLE ONLY \"auth\".\"mfa_factors\"\n    ADD CONSTRAINT \"mfa_factors_last_challenged_at_key\" UNIQUE (\"last_challenged_at\");\n\n\n\nALTER TABLE ONLY \"auth\".\"mfa_factors\"\n    ADD CONSTRAINT \"mfa_factors_pkey\" PRIMARY KEY (\"id\");\n\n\n\nALTER TABLE ONLY \"auth\".\"oauth_clients\"\n    ADD CONSTRAINT \"oauth_clients_client_id_key\" UNIQUE (\"client_id\");\n\n\n\nALTER TABLE ONLY \"auth\".\"oauth_clients\"\n    ADD CONSTRAINT \"oauth_clients_pkey\" PRIMARY KEY (\"id\");\n\n\n\nALTER TABLE ONLY \"auth\".\"one_time_tokens\"\n    ADD CONSTRAINT \"one_time_tokens_pkey\" PRIMARY KEY (\"id\");\n\n\n\nALTER TABLE ONLY \"auth\".\"refresh_tokens\"\n    ADD CONSTRAINT \"refresh_tokens_pkey\" PRIMARY KEY (\"id\");\n\n\n\nALTER TABLE ONLY \"auth\".\"refresh_tokens\"\n    ADD CONSTRAINT \"refresh_tokens_token_unique\" UNIQUE (\"token\");\n\n\n\nALTER TABLE ONLY \"auth\".\"saml_providers\"\n    ADD CONSTRAINT \"saml_providers_entity_id_key\" UNIQUE (\"entity_id\");\n\n\n\nALTER TABLE ONLY \"auth\".\"saml_providers\"\n    ADD CONSTRAINT \"saml_providers_pkey\" PRIMARY KEY (\"id\");\n\n\n\nALTER TABLE ONLY \"auth\".\"saml_relay_states\"\n    ADD CONSTRAINT \"saml_relay_states_pkey\" PRIMARY KEY (\"id\");\n\n\n\nALTER TABLE ONLY \"auth\".\"schema_migrations\"\n    ADD CONSTRAINT \"schema_migrations_pkey\" PRIMARY KEY (\"version\");\n\n\n\nALTER TABLE ONLY \"auth\".\"sessions\"\n    ADD CONSTRAINT \"sessions_pkey\" PRIMARY KEY (\"id\");\n\n\n\nALTER TABLE ONLY \"auth\".\"sso_domains\"\n    ADD CONSTRAINT \"sso_domains_pkey\" PRIMARY KEY (\"id\");\n\n\n\nALTER TABLE ONLY \"auth\".\"sso_providers\"\n    ADD CONSTRAINT \"sso_providers_pkey\" PRIMARY KEY (\"id\");\n\n\n\nALTER TABLE ONLY \"auth\".\"users\"\n    ADD CONSTRAINT \"users_phone_key\" UNIQUE (\"phone\");\n\n\n\nALTER TABLE ONLY \"auth\".\"users\"\n    ADD CONSTRAINT \"users_pkey\" PRIMARY KEY (\"id\");\n\n\n\nALTER TABLE ONLY \"public\".\"absences\"\n    ADD CONSTRAINT \"absences_pkey\" PRIMARY KEY (\"id\");\n\n\n\nALTER TABLE ONLY \"public\".\"app_settings\"\n    ADD CONSTRAINT \"app_settings_pkey\" PRIMARY KEY (\"id\");\n\n\n--\n-- Name: debug_log debug_log_pkey; Type: CONSTRAINT; Schema: public; Owner: -\n--\n\nALTER TABLE ONLY public.debug_log\n    ADD CONSTRAINT debug_log_pkey PRIMARY KEY (id);\n\n\n--\n-- Name: email_send_log email_send_log_pkey; Type: CONSTRAINT; Schema: public; Owner: -\n--\n\nALTER TABLE ONLY public.email_send_log\n    ADD CONSTRAINT email_send_log_pkey PRIMARY KEY (id);\n\n\n--\n-- Name: employee_notifications employee_notifications_pkey; Type: CONSTRAINT; Schema: public; Owner: -\n--\n\nALTER TABLE ONLY public.employee_notifications\n    ADD CONSTRAINT employee_notifications_pkey PRIMARY KEY (id);\n\n\n--\n-- Name: employees employees_email_unique; Type: CONSTRAINT; Schema: public; Owner: -\n--\n\nALTER TABLE ONLY public.employees\n    ADD CONSTRAINT employees_email_unique UNIQUE (email);\n\n\n--\n-- Name: employees employees_pkey; Type: CONSTRAINT; Schema: public; Owner: -\n--\n\nALTER TABLE ONLY public.employees\n    ADD CONSTRAINT employees_pkey PRIMARY KEY (id);\n\n\n--\n-- Name: employees employees_user_id_unique; Type: CONSTRAINT; Schema: public; Owner: -\n--\n\nALTER TABLE ONLY public.employees\n    ADD CONSTRAINT employees_user_id_unique UNIQUE (auth_user_id);\n\n\n--\n-- Name: mail_jobs mail_jobs_job_key_unique; Type: CONSTRAINT; Schema: public; Owner: -\n--\n\nALTER TABLE ONLY public.mail_jobs\n    ADD CONSTRAINT mail_jobs_job_key_unique UNIQUE (job_key);\n\n\n--\n-- Name: mail_jobs mail_jobs_pkey; Type: CONSTRAINT; Schema: public; Owner: -\n--\n\nALTER TABLE ONLY public.mail_jobs\n    ADD CONSTRAINT mail_jobs_pkey PRIMARY KEY (id);\n\n\n--\n-- Name: notifications notifications_pkey; Type: CONSTRAINT; Schema: public; Owner: -\n--\n\nALTER TABLE ONLY public.notifications\n    ADD CONSTRAINT notifications_pkey PRIMARY KEY (id);\n\n\n--\n-- Name: profiles profiles_email_key; Type: CONSTRAINT; Schema: public; Owner: -\n--\n\nALTER TABLE ONLY public.profiles\n    ADD CONSTRAINT profiles_email_key UNIQUE (email);\n\n\n--\n-- Name: profiles profiles_pkey; Type: CONSTRAINT; Schema: public; Owner: -\n--\n\nALTER TABLE ONLY public.profiles\n    ADD CONSTRAINT profiles_pkey PRIMARY KEY (id);\n\n\n--\n-- Name: shift_change_requests shift_change_requests_pkey; Type: CONSTRAINT; Schema: public; Owner: -\n--\n\nALTER TABLE ONLY public.shift_change_requests\n    ADD CONSTRAINT shift_change_requests_pkey PRIMARY KEY (id);\n\n\n\nALTER TABLE ONLY \"public\".\"shift_publications\"\n    ADD CONSTRAINT \"shift_publications_pkey\" PRIMARY KEY (\"id\");\n\n\n\nALTER TABLE ONLY \"public\".\"shifts\"\n    ADD CONSTRAINT \"shifts_employee_id_work_date_key\" UNIQUE (\"employee_id\", \"work_date\");\n\n\n\nALTER TABLE ONLY \"public\".\"shifts\"\n    ADD CONSTRAINT \"shifts_pkey\" PRIMARY KEY (\"id\");\n\n\n\nALTER TABLE ONLY \"public\".\"time_off_requests\"\n    ADD CONSTRAINT \"time_off_requests_pkey\" PRIMARY KEY (\"id\");\n\n\n\nALTER TABLE ONLY \"public\".\"time_periods\"\n    ADD CONSTRAINT \"time_periods_pkey\" PRIMARY KEY (\"id\");\n\n\n\nALTER TABLE ONLY public.employee_notifications\n    ADD CONSTRAINT uniq_emp_date_update UNIQUE (employee_id, type, message);\n\n\n--\n-- Name: messages messages_pkey; Type: CONSTRAINT; Schema: realtime; Owner: -\n--\n\nALTER TABLE ONLY realtime.messages\n    ADD CONSTRAINT messages_pkey PRIMARY KEY (id, inserted_at);\n\n\n--\n-- Name: messages_2025_09_06 messages_2025_09_06_pkey; Type: CONSTRAINT; Schema: realtime; Owner: -\n--\n\nALTER TABLE ONLY realtime.messages_2025_09_06\n    ADD CONSTRAINT messages_2025_09_06_pkey PRIMARY KEY (id, inserted_at);\n\n\n--\n-- Name: messages_2025_09_07 messages_2025_09_07_pkey; Type: CONSTRAINT; Schema: realtime; Owner: -\n--\n\nALTER TABLE ONLY realtime.messages_2025_09_07\n    ADD CONSTRAINT messages_2025_09_07_pkey PRIMARY KEY (id, inserted_at);\n\n\n--\n-- Name: messages_2025_09_08 messages_2025_09_08_pkey; Type: CONSTRAINT; Schema: realtime; Owner: -\n--\n\nALTER TABLE ONLY realtime.messages_2025_09_08\n    ADD CONSTRAINT messages_2025_09_08_pkey PRIMARY KEY (id, inserted_at);\n\n\n--\n-- Name: messages_2025_09_09 messages_2025_09_09_pkey; Type: CONSTRAINT; Schema: realtime; Owner: -\n--\n\nALTER TABLE ONLY realtime.messages_2025_09_09\n    ADD CONSTRAINT messages_2025_09_09_pkey PRIMARY KEY (id, inserted_at);\n\n\n--\n-- Name: messages_2025_09_10 messages_2025_09_10_pkey; Type: CONSTRAINT; Schema: realtime; Owner: -\n--\n\nALTER TABLE ONLY realtime.messages_2025_09_10\n    ADD CONSTRAINT messages_2025_09_10_pkey PRIMARY KEY (id, inserted_at);\n\n\n--\n-- Name: messages_2025_09_11 messages_2025_09_11_pkey; Type: CONSTRAINT; Schema: realtime; Owner: -\n--\n\nALTER TABLE ONLY realtime.messages_2025_09_11\n    ADD CONSTRAINT messages_2025_09_11_pkey PRIMARY KEY (id, inserted_at);\n\n\n--\n-- Name: messages_2025_09_12 messages_2025_09_12_pkey; Type: CONSTRAINT; Schema: realtime; Owner: -\n--\n\nALTER TABLE ONLY realtime.messages_2025_09_12\n    ADD CONSTRAINT messages_2025_09_12_pkey PRIMARY KEY (id, inserted_at);\n\n\n--\n-- Name: subscription pk_subscription; Type: CONSTRAINT; Schema: realtime; Owner: -\n--\n\nALTER TABLE ONLY realtime.subscription\n    ADD CONSTRAINT pk_subscription PRIMARY KEY (id);\n\n\n--\n-- Name: schema_migrations schema_migrations_pkey; Type: CONSTRAINT; Schema: realtime; Owner: -\n--\n\nALTER TABLE ONLY realtime.schema_migrations\n    ADD CONSTRAINT schema_migrations_pkey PRIMARY KEY (version);\n\n\n--\n-- Name: buckets buckets_pkey; Type: CONSTRAINT; Schema: storage; Owner: -\n--\n\nALTER TABLE ONLY storage.buckets\n    ADD CONSTRAINT buckets_pkey PRIMARY KEY (id);\n\n\n--\n-- Name: migrations migrations_name_key; Type: CONSTRAINT; Schema: storage; Owner: -\n--\n\nALTER TABLE ONLY storage.migrations\n    ADD CONSTRAINT migrations_name_key UNIQUE (name);\n\n\n--\n-- Name: migrations migrations_pkey; Type: CONSTRAINT; Schema: storage; Owner: -\n--\n\nALTER TABLE ONLY storage.migrations\n    ADD CONSTRAINT migrations_pkey PRIMARY KEY (id);\n\n\n--\n-- Name: objects objects_pkey; Type: CONSTRAINT; Schema: storage; Owner: -\n--\n\nALTER TABLE ONLY storage.objects\n    ADD CONSTRAINT objects_pkey PRIMARY KEY (id);\n\n\n--\n-- Name: s3_multipart_uploads_parts s3_multipart_uploads_parts_pkey; Type: CONSTRAINT; Schema: storage; Owner: -\n--\n\nALTER TABLE ONLY storage.s3_multipart_uploads_parts\n    ADD CONSTRAINT s3_multipart_uploads_parts_pkey PRIMARY KEY (id);\n\n\n\nALTER TABLE ONLY \"storage\".\"s3_multipart_uploads\"\n    ADD CONSTRAINT \"s3_multipart_uploads_pkey\" PRIMARY KEY (\"id\");\n\n\n\nCREATE INDEX \"audit_logs_instance_id_idx\" ON \"auth\".\"audit_log_entries\" USING \"btree\" (\"instance_id\");\n\n\n\nCREATE UNIQUE INDEX \"confirmation_token_idx\" ON \"auth\".\"users\" USING \"btree\" (\"confirmation_token\") WHERE ((\"confirmation_token\")::\"text\" !~ '^[0-9 ]*$'::\"text\");\n\n\n\nCREATE UNIQUE INDEX \"email_change_token_current_idx\" ON \"auth\".\"users\" USING \"btree\" (\"email_change_token_current\") WHERE ((\"email_change_token_current\")::\"text\" !~ '^[0-9 ]*$'::\"text\");\n\n\n\nCREATE UNIQUE INDEX \"email_change_token_new_idx\" ON \"auth\".\"users\" USING \"btree\" (\"email_change_token_new\") WHERE ((\"email_change_token_new\")::\"text\" !~ '^[0-9 ]*$'::\"text\");\n\n\n\nCREATE INDEX \"factor_id_created_at_idx\" ON \"auth\".\"mfa_factors\" USING \"btree\" (\"user_id\", \"created_at\");\n\n\n\nCREATE INDEX \"flow_state_created_at_idx\" ON \"auth\".\"flow_state\" USING \"btree\" (\"created_at\" DESC);\n\n\n\nCREATE INDEX \"identities_email_idx\" ON \"auth\".\"identities\" USING \"btree\" (\"email\" \"text_pattern_ops\");\n\n\n\nCOMMENT ON INDEX \"auth\".\"identities_email_idx\" IS 'Auth: Ensures indexed queries on the email column';\n\n\n\nCREATE INDEX \"identities_user_id_idx\" ON \"auth\".\"identities\" USING \"btree\" (\"user_id\");\n\n\n\nCREATE INDEX \"idx_auth_code\" ON \"auth\".\"flow_state\" USING \"btree\" (\"auth_code\");\n\n\n\nCREATE INDEX \"idx_user_id_auth_method\" ON \"auth\".\"flow_state\" USING \"btree\" (\"user_id\", \"authentication_method\");\n\n\n\nCREATE INDEX \"mfa_challenge_created_at_idx\" ON \"auth\".\"mfa_challenges\" USING \"btree\" (\"created_at\" DESC);\n\n\n\nCREATE UNIQUE INDEX \"mfa_factors_user_friendly_name_unique\" ON \"auth\".\"mfa_factors\" USING \"btree\" (\"friendly_name\", \"user_id\") WHERE (TRIM(BOTH FROM \"friendly_name\") <> ''::\"text\");\n\n\n\nCREATE INDEX \"mfa_factors_user_id_idx\" ON \"auth\".\"mfa_factors\" USING \"btree\" (\"user_id\");\n\n\n\nCREATE INDEX \"oauth_clients_client_id_idx\" ON \"auth\".\"oauth_clients\" USING \"btree\" (\"client_id\");\n\n\n\nCREATE INDEX \"oauth_clients_deleted_at_idx\" ON \"auth\".\"oauth_clients\" USING \"btree\" (\"deleted_at\");\n\n\n\nCREATE INDEX \"one_time_tokens_relates_to_hash_idx\" ON \"auth\".\"one_time_tokens\" USING \"hash\" (\"relates_to\");\n\n\n\nCREATE INDEX \"one_time_tokens_token_hash_hash_idx\" ON \"auth\".\"one_time_tokens\" USING \"hash\" (\"token_hash\");\n\n\n\nCREATE UNIQUE INDEX \"one_time_tokens_user_id_token_type_key\" ON \"auth\".\"one_time_tokens\" USING \"btree\" (\"user_id\", \"token_type\");\n\n\n\nCREATE UNIQUE INDEX \"reauthentication_token_idx\" ON \"auth\".\"users\" USING \"btree\" (\"reauthentication_token\") WHERE ((\"reauthentication_token\")::\"text\" !~ '^[0-9 ]*$'::\"text\");\n\n\n\nCREATE UNIQUE INDEX \"recovery_token_idx\" ON \"auth\".\"users\" USING \"btree\" (\"recovery_token\") WHERE ((\"recovery_token\")::\"text\" !~ '^[0-9 ]*$'::\"text\");\n\n\n\nCREATE INDEX \"refresh_tokens_instance_id_idx\" ON \"auth\".\"refresh_tokens\" USING \"btree\" (\"instance_id\");\n\n\n\nCREATE INDEX \"refresh_tokens_instance_id_user_id_idx\" ON \"auth\".\"refresh_tokens\" USING \"btree\" (\"instance_id\", \"user_id\");\n\n\n\nCREATE INDEX \"refresh_tokens_parent_idx\" ON \"auth\".\"refresh_tokens\" USING \"btree\" (\"parent\");\n\n\n\nCREATE INDEX \"refresh_tokens_session_id_revoked_idx\" ON \"auth\".\"refresh_tokens\" USING \"btree\" (\"session_id\", \"revoked\");\n\n\n\nCREATE INDEX \"refresh_tokens_updated_at_idx\" ON \"auth\".\"refresh_tokens\" USING \"btree\" (\"updated_at\" DESC);\n\n\n\nCREATE INDEX \"saml_providers_sso_provider_id_idx\" ON \"auth\".\"saml_providers\" USING \"btree\" (\"sso_provider_id\");\n\n\n\nCREATE INDEX \"saml_relay_states_created_at_idx\" ON \"auth\".\"saml_relay_states\" USING \"btree\" (\"created_at\" DESC);\n\n\n\nCREATE INDEX \"saml_relay_states_for_email_idx\" ON \"auth\".\"saml_relay_states\" USING \"btree\" (\"for_email\");\n\n\n\nCREATE INDEX \"saml_relay_states_sso_provider_id_idx\" ON \"auth\".\"saml_relay_states\" USING \"btree\" (\"sso_provider_id\");\n\n\n\nCREATE INDEX \"sessions_not_after_idx\" ON \"auth\".\"sessions\" USING \"btree\" (\"not_after\" DESC);\n\n\n\nCREATE INDEX \"sessions_user_id_idx\" ON \"auth\".\"sessions\" USING \"btree\" (\"user_id\");\n\n\n\nCREATE UNIQUE INDEX \"sso_domains_domain_idx\" ON \"auth\".\"sso_domains\" USING \"btree\" (\"lower\"(\"domain\"));\n\n\n\nCREATE INDEX \"sso_domains_sso_provider_id_idx\" ON \"auth\".\"sso_domains\" USING \"btree\" (\"sso_provider_id\");\n\n\n\nCREATE UNIQUE INDEX \"sso_providers_resource_id_idx\" ON \"auth\".\"sso_providers\" USING \"btree\" (\"lower\"(\"resource_id\"));\n\n\n\nCREATE INDEX \"sso_providers_resource_id_pattern_idx\" ON \"auth\".\"sso_providers\" USING \"btree\" (\"resource_id\" \"text_pattern_ops\");\n\n\n\nCREATE UNIQUE INDEX \"unique_phone_factor_per_user\" ON \"auth\".\"mfa_factors\" USING \"btree\" (\"user_id\", \"phone\");\n\n\n\nCREATE INDEX \"user_id_created_at_idx\" ON \"auth\".\"sessions\" USING \"btree\" (\"user_id\", \"created_at\");\n\n\n\nCREATE UNIQUE INDEX \"users_email_partial_key\" ON \"auth\".\"users\" USING \"btree\" (\"email\") WHERE (\"is_sso_user\" = false);\n\n\n\nCOMMENT ON INDEX \"auth\".\"users_email_partial_key\" IS 'Auth: A partial unique index that applies only when is_sso_user is false';\n\n\n\nCREATE INDEX \"users_instance_id_email_idx\" ON \"auth\".\"users\" USING \"btree\" (\"instance_id\", \"lower\"((\"email\")::\"text\"));\n\n\n\nCREATE INDEX \"users_instance_id_idx\" ON \"auth\".\"users\" USING \"btree\" (\"instance_id\");\n\n\n\nCREATE INDEX \"users_is_anonymous_idx\" ON \"auth\".\"users\" USING \"btree\" (\"is_anonymous\");\n\n\n\nCREATE UNIQUE INDEX \"employees_email_lower_uq\" ON \"public\".\"employees\" USING \"btree\" (\"lower\"(\"email\")) WHERE (\"email\" IS NOT NULL);\n\n\n\nCREATE INDEX \"idx_absences_emp_dates\" ON \"public\".\"absences\" USING \"btree\" (\"employee_id\", \"start_date\", \"end_date\");\n\n\n\nCREATE INDEX \"idx_notifications_created_at\" ON \"public\".\"notifications\" USING \"btree\" (\"created_at\" DESC);\n\n\n\nCREATE INDEX \"idx_notifications_is_read\" ON \"public\".\"notifications\" USING \"btree\" (\"is_read\");\n\n\n\nCREATE INDEX \"idx_shifts_emp_date_pub\" ON \"public\".\"shifts\" USING \"btree\" (\"employee_id\", \"work_date\", \"published\");\n\n\n\nCREATE INDEX \"idx_shifts_employee_id\" ON \"public\".\"shifts\" USING \"btree\" (\"employee_id\");\n\n\n\nCREATE INDEX idx_shifts_published ON public.shifts USING btree (published);\n\n\n--\n-- Name: idx_shifts_work_date; Type: INDEX; Schema: public; Owner: -\n--\n\nCREATE INDEX idx_shifts_work_date ON public.shifts USING btree (work_date);\n\n\n--\n-- Name: mail_jobs_emp_queued_idx; Type: INDEX; Schema: public; Owner: -\n--\n\nCREATE INDEX mail_jobs_emp_queued_idx ON public.mail_jobs USING btree (((payload ->> 'employee_id'::text))) WHERE (status = 'queued'::text);\n\n\n--\n-- Name: mail_jobs_queued_time_type_idx; Type: INDEX; Schema: public; Owner: -\n--\n\nCREATE INDEX mail_jobs_queued_time_type_idx ON public.mail_jobs USING btree (created_at, type) WHERE (status = 'queued'::text);\n\n\n--\n-- Name: mail_jobs_status_idx; Type: INDEX; Schema: public; Owner: -\n--\n\nCREATE INDEX mail_jobs_status_idx ON public.mail_jobs USING btree (status) WHERE (status = 'queued'::text);\n\n\n--\n-- Name: mail_jobs_unique_key; Type: INDEX; Schema: public; Owner: -\n--\n\nCREATE UNIQUE INDEX mail_jobs_unique_key ON public.mail_jobs USING btree (job_key) WHERE (type = 'admin_new_absence'::text);\n\n\n--\n-- Name: ix_realtime_subscription_entity; Type: INDEX; Schema: realtime; Owner: -\n--\n\nCREATE INDEX ix_realtime_subscription_entity ON realtime.subscription USING btree (entity);\n\n\n--\n-- Name: subscription_subscription_id_entity_filters_key; Type: INDEX; Schema: realtime; Owner: -\n--\n\nCREATE UNIQUE INDEX subscription_subscription_id_entity_filters_key ON realtime.subscription USING btree (subscription_id, entity, filters);\n\n\n--\n-- Name: bname; Type: INDEX; Schema: storage; Owner: -\n--\n\nCREATE UNIQUE INDEX bname ON storage.buckets USING btree (name);\n\n\n--\n-- Name: bucketid_objname; Type: INDEX; Schema: storage; Owner: -\n--\n\nCREATE UNIQUE INDEX bucketid_objname ON storage.objects USING btree (bucket_id, name);\n\n\n--\n-- Name: idx_multipart_uploads_list; Type: INDEX; Schema: storage; Owner: -\n--\n\nCREATE INDEX idx_multipart_uploads_list ON storage.s3_multipart_uploads USING btree (bucket_id, key, created_at);\n\n\n\nCREATE INDEX idx_objects_bucket_id_name ON storage.objects USING btree (bucket_id, name COLLATE \"C\");\n\n\n--\n-- Name: name_prefix_search; Type: INDEX; Schema: storage; Owner: -\n--\n\nCREATE INDEX name_prefix_search ON storage.objects USING btree (name text_pattern_ops);\n\n\n--\n-- Name: messages_2025_09_06_pkey; Type: INDEX ATTACH; Schema: realtime; Owner: -\n--\n\nALTER INDEX realtime.messages_pkey ATTACH PARTITION realtime.messages_2025_09_06_pkey;\n\n\n--\n-- Name: messages_2025_09_07_pkey; Type: INDEX ATTACH; Schema: realtime; Owner: -\n--\n\nALTER INDEX realtime.messages_pkey ATTACH PARTITION realtime.messages_2025_09_07_pkey;\n\n\n--\n-- Name: messages_2025_09_08_pkey; Type: INDEX ATTACH; Schema: realtime; Owner: -\n--\n\nALTER INDEX realtime.messages_pkey ATTACH PARTITION realtime.messages_2025_09_08_pkey;\n\n\n--\n-- Name: messages_2025_09_09_pkey; Type: INDEX ATTACH; Schema: realtime; Owner: -\n--\n\nALTER INDEX realtime.messages_pkey ATTACH PARTITION realtime.messages_2025_09_09_pkey;\n\n\n--\n-- Name: messages_2025_09_10_pkey; Type: INDEX ATTACH; Schema: realtime; Owner: -\n--\n\nALTER INDEX realtime.messages_pkey ATTACH PARTITION realtime.messages_2025_09_10_pkey;\n\n\n--\n-- Name: messages_2025_09_11_pkey; Type: INDEX ATTACH; Schema: realtime; Owner: -\n--\n\nALTER INDEX realtime.messages_pkey ATTACH PARTITION realtime.messages_2025_09_11_pkey;\n\n\n--\n-- Name: messages_2025_09_12_pkey; Type: INDEX ATTACH; Schema: realtime; Owner: -\n--\n\nALTER INDEX realtime.messages_pkey ATTACH PARTITION realtime.messages_2025_09_12_pkey;\n\n\n--\n-- Name: absences trg_absence_enqueue_job; Type: TRIGGER; Schema: public; Owner: -\n--\n\nCREATE TRIGGER trg_absence_enqueue_job AFTER INSERT ON public.absences FOR EACH ROW EXECUTE FUNCTION public.trg_absence_enqueue_job();\n\n\n--\n-- Name: absences trg_admin_new_absence; Type: TRIGGER; Schema: public; Owner: -\n--\n\nCREATE TRIGGER trg_admin_new_absence AFTER INSERT ON public.absences FOR EACH ROW EXECUTE FUNCTION public.enqueue_admin_new_absence();\n\n\n--\n-- Name: shifts trg_employee_shift_changed; Type: TRIGGER; Schema: public; Owner: -\n--\n\nCREATE TRIGGER trg_employee_shift_changed AFTER UPDATE ON public.shifts FOR EACH ROW WHEN ((new.employee_id IS NOT NULL)) EXECUTE FUNCTION public.enqueue_employee_shift_changed();\n\n\n--\n-- Name: shifts trg_employee_shift_deleted; Type: TRIGGER; Schema: public; Owner: -\n--\n\nCREATE TRIGGER trg_employee_shift_deleted AFTER DELETE ON public.shifts FOR EACH ROW EXECUTE FUNCTION public.enqueue_employee_shift_deleted();\n\n\n--\n-- Name: absences trg_notify_absence_insert; Type: TRIGGER; Schema: public; Owner: -\n--\n\nCREATE TRIGGER trg_notify_absence_insert AFTER INSERT ON public.absences FOR EACH ROW EXECUTE FUNCTION public.notify_absence_insert();\n\n\n--\n-- Name: absences trg_notify_absence_update; Type: TRIGGER; Schema: public; Owner: -\n--\n\nCREATE TRIGGER trg_notify_absence_update AFTER UPDATE ON public.absences FOR EACH ROW EXECUTE FUNCTION public.notify_absence_status_update();\n\n\n--\n-- Name: employees trg_notify_employee_added; Type: TRIGGER; Schema: public; Owner: -\n--\n\nCREATE TRIGGER trg_notify_employee_added AFTER INSERT ON public.employees FOR EACH ROW EXECUTE FUNCTION public.notify_employee_added();\n\n\n--\n-- Name: shifts trg_shifts_updated_at; Type: TRIGGER; Schema: public; Owner: -\n--\n\nCREATE TRIGGER trg_shifts_updated_at BEFORE UPDATE ON public.shifts FOR EACH ROW EXECUTE FUNCTION public.set_updated_at();\n\n\n--\n-- Name: subscription tr_check_filters; Type: TRIGGER; Schema: realtime; Owner: -\n--\n\nCREATE TRIGGER tr_check_filters BEFORE INSERT OR UPDATE ON realtime.subscription FOR EACH ROW EXECUTE FUNCTION realtime.subscription_check_filters();\n\n\n--\n-- Name: objects update_objects_updated_at; Type: TRIGGER; Schema: storage; Owner: -\n--\n\nCREATE TRIGGER update_objects_updated_at BEFORE UPDATE ON storage.objects FOR EACH ROW EXECUTE FUNCTION storage.update_updated_at_column();\n\n\n\nALTER TABLE ONLY \"auth\".\"identities\"\n    ADD CONSTRAINT \"identities_user_id_fkey\" FOREIGN KEY (\"user_id\") REFERENCES \"auth\".\"users\"(\"id\") ON DELETE CASCADE;\n\n\n\nALTER TABLE ONLY \"auth\".\"mfa_amr_claims\"\n    ADD CONSTRAINT \"mfa_amr_claims_session_id_fkey\" FOREIGN KEY (\"session_id\") REFERENCES \"auth\".\"sessions\"(\"id\") ON DELETE CASCADE;\n\n\n\nALTER TABLE ONLY \"auth\".\"mfa_challenges\"\n    ADD CONSTRAINT \"mfa_challenges_auth_factor_id_fkey\" FOREIGN KEY (\"factor_id\") REFERENCES \"auth\".\"mfa_factors\"(\"id\") ON DELETE CASCADE;\n\n\n\nALTER TABLE ONLY \"auth\".\"mfa_factors\"\n    ADD CONSTRAINT \"mfa_factors_user_id_fkey\" FOREIGN KEY (\"user_id\") REFERENCES \"auth\".\"users\"(\"id\") ON DELETE CASCADE;\n\n\n\nALTER TABLE ONLY \"auth\".\"one_time_tokens\"\n    ADD CONSTRAINT \"one_time_tokens_user_id_fkey\" FOREIGN KEY (\"user_id\") REFERENCES \"auth\".\"users\"(\"id\") ON DELETE CASCADE;\n\n\n\nALTER TABLE ONLY \"auth\".\"refresh_tokens\"\n    ADD CONSTRAINT \"refresh_tokens_session_id_fkey\" FOREIGN KEY (\"session_id\") REFERENCES \"auth\".\"sessions\"(\"id\") ON DELETE CASCADE;\n\n\n\nALTER TABLE ONLY \"auth\".\"saml_providers\"\n    ADD CONSTRAINT \"saml_providers_sso_provider_id_fkey\" FOREIGN KEY (\"sso_provider_id\") REFERENCES \"auth\".\"sso_providers\"(\"id\") ON DELETE CASCADE;\n\n\n\nALTER TABLE ONLY \"auth\".\"saml_relay_states\"\n    ADD CONSTRAINT \"saml_relay_states_flow_state_id_fkey\" FOREIGN KEY (\"flow_state_id\") REFERENCES \"auth\".\"flow_state\"(\"id\") ON DELETE CASCADE;\n\n\n\nALTER TABLE ONLY \"auth\".\"saml_relay_states\"\n    ADD CONSTRAINT \"saml_relay_states_sso_provider_id_fkey\" FOREIGN KEY (\"sso_provider_id\") REFERENCES \"auth\".\"sso_providers\"(\"id\") ON DELETE CASCADE;\n\n\n\nALTER TABLE ONLY \"auth\".\"sessions\"\n    ADD CONSTRAINT \"sessions_user_id_fkey\" FOREIGN KEY (\"user_id\") REFERENCES \"auth\".\"users\"(\"id\") ON DELETE CASCADE;\n\n\n\nALTER TABLE ONLY \"auth\".\"sso_domains\"\n    ADD CONSTRAINT \"sso_domains_sso_provider_id_fkey\" FOREIGN KEY (\"sso_provider_id\") REFERENCES \"auth\".\"sso_providers\"(\"id\") ON DELETE CASCADE;\n\n\n\nALTER TABLE ONLY \"public\".\"absences\"\n    ADD CONSTRAINT \"absences_employee_id_fkey\" FOREIGN KEY (\"employee_id\") REFERENCES \"public\".\"employees\"(\"id\") ON DELETE CASCADE;\n\n\n\nALTER TABLE ONLY \"public\".\"employee_notifications\"\n    ADD CONSTRAINT \"employee_notifications_employee_id_fkey\" FOREIGN KEY (\"employee_id\") REFERENCES \"public\".\"employees\"(\"id\") ON DELETE CASCADE;\n\n\n\nALTER TABLE ONLY \"public\".\"employees\"\n    ADD CONSTRAINT \"employees_user_id_fkey\" FOREIGN KEY (\"auth_user_id\") REFERENCES \"auth\".\"users\"(\"id\") ON DELETE SET NULL;\n\n\n\nALTER TABLE ONLY \"public\".\"employees\"\n    ADD CONSTRAINT \"fk_employees_auth\" FOREIGN KEY (\"auth_user_id\") REFERENCES \"auth\".\"users\"(\"id\") ON DELETE SET NULL;\n\n\n\nALTER TABLE ONLY \"public\".\"shift_change_requests\"\n    ADD CONSTRAINT \"shift_change_requests_employee_id_fkey\" FOREIGN KEY (\"employee_id\") REFERENCES \"public\".\"employees\"(\"id\") ON DELETE CASCADE;\n\n\n\nALTER TABLE ONLY \"public\".\"shift_change_requests\"\n    ADD CONSTRAINT \"shift_change_requests_target_employee_id_fkey\" FOREIGN KEY (\"target_employee_id\") REFERENCES \"public\".\"employees\"(\"id\");\n\n\n\nALTER TABLE ONLY \"public\".\"shifts\"\n    ADD CONSTRAINT \"shifts_employee_id_fkey\" FOREIGN KEY (\"employee_id\") REFERENCES \"public\".\"employees\"(\"id\") ON DELETE CASCADE;\n\n\n\nALTER TABLE ONLY \"public\".\"time_off_requests\"\n    ADD CONSTRAINT \"time_off_requests_employee_id_fkey\" FOREIGN KEY (\"employee_id\") REFERENCES \"public\".\"employees\"(\"id\") ON DELETE CASCADE;\n\n\n\nALTER TABLE ONLY \"storage\".\"objects\"\n    ADD CONSTRAINT \"objects_bucketId_fkey\" FOREIGN KEY (\"bucket_id\") REFERENCES \"storage\".\"buckets\"(\"id\");\n\n\n\nALTER TABLE ONLY \"storage\".\"s3_multipart_uploads\"\n    ADD CONSTRAINT \"s3_multipart_uploads_bucket_id_fkey\" FOREIGN KEY (\"bucket_id\") REFERENCES \"storage\".\"buckets\"(\"id\");\n\n\n\nALTER TABLE ONLY \"storage\".\"s3_multipart_uploads_parts\"\n    ADD CONSTRAINT \"s3_multipart_uploads_parts_bucket_id_fkey\" FOREIGN KEY (\"bucket_id\") REFERENCES \"storage\".\"buckets\"(\"id\");\n\n\n\nALTER TABLE ONLY \"storage\".\"s3_multipart_uploads_parts\"\n    ADD CONSTRAINT \"s3_multipart_uploads_parts_upload_id_fkey\" FOREIGN KEY (\"upload_id\") REFERENCES \"storage\".\"s3_multipart_uploads\"(\"id\") ON DELETE CASCADE;\n\n\n\nALTER TABLE \"auth\".\"audit_log_entries\" ENABLE ROW LEVEL SECURITY;\n\n\nALTER TABLE \"auth\".\"flow_state\" ENABLE ROW LEVEL SECURITY;\n\n\nALTER TABLE \"auth\".\"identities\" ENABLE ROW LEVEL SECURITY;\n\n\nALTER TABLE \"auth\".\"instances\" ENABLE ROW LEVEL SECURITY;\n\n\nALTER TABLE \"auth\".\"mfa_amr_claims\" ENABLE ROW LEVEL SECURITY;\n\n\nALTER TABLE \"auth\".\"mfa_challenges\" ENABLE ROW LEVEL SECURITY;\n\n\nALTER TABLE \"auth\".\"mfa_factors\" ENABLE ROW LEVEL SECURITY;\n\n\nALTER TABLE \"auth\".\"one_time_tokens\" ENABLE ROW LEVEL SECURITY;\n\n\nALTER TABLE \"auth\".\"refresh_tokens\" ENABLE ROW LEVEL SECURITY;\n\n\nALTER TABLE \"auth\".\"saml_providers\" ENABLE ROW LEVEL SECURITY;\n\n\nALTER TABLE \"auth\".\"saml_relay_states\" ENABLE ROW LEVEL SECURITY;\n\n\nALTER TABLE \"auth\".\"schema_migrations\" ENABLE ROW LEVEL SECURITY;\n\n\nALTER TABLE \"auth\".\"sessions\" ENABLE ROW LEVEL SECURITY;\n\n\nALTER TABLE \"auth\".\"sso_domains\" ENABLE ROW LEVEL SECURITY;\n\n\nALTER TABLE \"auth\".\"sso_providers\" ENABLE ROW LEVEL SECURITY;\n\n\nALTER TABLE \"auth\".\"users\" ENABLE ROW LEVEL SECURITY;\n\n\nCREATE POLICY \"Employees manage their own shift change requests\" ON \"public\".\"shift_change_requests\" USING ((\"auth\".\"uid\"() = \"employee_id\")) WITH CHECK ((\"auth\".\"uid\"() = \"employee_id\"));\n\n\n\nCREATE POLICY \"Employees manage their own time off requests\" ON \"public\".\"time_off_requests\" USING ((\"auth\".\"uid\"() = \"employee_id\")) WITH CHECK ((\"auth\".\"uid\"() = \"employee_id\"));\n\n\n\nCREATE POLICY \"Employees view their own notifications\" ON \"public\".\"employee_notifications\" FOR SELECT USING ((\"auth\".\"uid\"() = \"employee_id\"));\n\n\n\nALTER TABLE public.absences ENABLE ROW LEVEL SECURITY;\n\n\nCREATE POLICY \"admin_delete_shifts\" ON \"public\".\"shifts\" FOR DELETE TO \"authenticated\" USING ((EXISTS ( SELECT 1\n   FROM \"public\".\"employees\" \"e\"\n  WHERE ((\"e\".\"auth_user_id\" = \"auth\".\"uid\"()) AND (\"e\".\"role\" = 'admin'::\"text\")))));\n\n\n\nCREATE POLICY \"admin_insert_absences\" ON \"public\".\"absences\" FOR INSERT TO \"authenticated\" WITH CHECK ((EXISTS ( SELECT 1\n   FROM \"public\".\"employees\" \"e\"\n  WHERE ((\"e\".\"auth_user_id\" = \"auth\".\"uid\"()) AND (\"e\".\"role\" = 'admin'::\"text\")))));\n\n\n\nCREATE POLICY \"admin_insert_app_settings\" ON \"public\".\"app_settings\" FOR INSERT TO \"authenticated\" WITH CHECK ((EXISTS ( SELECT 1\n   FROM \"public\".\"employees\" \"e\"\n  WHERE ((\"e\".\"auth_user_id\" = \"auth\".\"uid\"()) AND (\"e\".\"role\" = 'admin'::\"text\")))));\n\n\n\nCREATE POLICY \"admin_insert_employees\" ON \"public\".\"employees\" FOR INSERT TO \"authenticated\" WITH CHECK (((\"role\" = 'admin'::\"text\") AND (\"auth_user_id\" = \"auth\".\"uid\"())));\n\n\n\nCREATE POLICY \"admin_insert_notifications\" ON \"public\".\"employee_notifications\" FOR INSERT TO \"authenticated\" WITH CHECK ((EXISTS ( SELECT 1\n   FROM \"public\".\"employees\" \"e\"\n  WHERE ((\"e\".\"auth_user_id\" = \"auth\".\"uid\"()) AND (\"e\".\"role\" = 'admin'::\"text\")))));\n\n\n\nCREATE POLICY \"admin_insert_shift_changes\" ON \"public\".\"shift_change_requests\" FOR INSERT TO \"authenticated\" WITH CHECK ((EXISTS ( SELECT 1\n   FROM \"public\".\"employees\" \"e\"\n  WHERE ((\"e\".\"auth_user_id\" = \"auth\".\"uid\"()) AND (\"e\".\"role\" = 'admin'::\"text\")))));\n\n\n\nCREATE POLICY \"admin_insert_shifts\" ON \"public\".\"shifts\" FOR INSERT TO \"authenticated\" WITH CHECK ((EXISTS ( SELECT 1\n   FROM \"public\".\"employees\" \"e\"\n  WHERE ((\"e\".\"auth_user_id\" = \"auth\".\"uid\"()) AND (\"e\".\"role\" = 'admin'::\"text\")))));\n\n\n\nCREATE POLICY \"admin_insert_time_off\" ON \"public\".\"time_off_requests\" FOR INSERT TO \"authenticated\" WITH CHECK ((EXISTS ( SELECT 1\n   FROM \"public\".\"employees\" \"e\"\n  WHERE ((\"e\".\"auth_user_id\" = \"auth\".\"uid\"()) AND (\"e\".\"role\" = 'admin'::\"text\")))));\n\n\n\nCREATE POLICY \"admin_insert_time_periods\" ON \"public\".\"time_periods\" FOR INSERT TO \"authenticated\" WITH CHECK ((EXISTS ( SELECT 1\n   FROM \"public\".\"employees\" \"e\"\n  WHERE ((\"e\".\"auth_user_id\" = \"auth\".\"uid\"()) AND (\"e\".\"role\" = 'admin'::\"text\")))));\n\n\n\nCREATE POLICY \"admin_select_all_absences\" ON \"public\".\"absences\" FOR SELECT TO \"authenticated\" USING ((EXISTS ( SELECT 1\n   FROM \"public\".\"employees\" \"e\"\n  WHERE ((\"e\".\"auth_user_id\" = \"auth\".\"uid\"()) AND (\"e\".\"role\" = 'admin'::\"text\")))));\n\n\n\nCREATE POLICY \"admin_select_all_employees\" ON \"public\".\"employees\" FOR SELECT TO \"authenticated\" USING (((\"role\" = 'admin'::\"text\") AND (\"auth_user_id\" = \"auth\".\"uid\"())));\n\n\n\nCREATE POLICY \"admin_select_all_notifications\" ON \"public\".\"employee_notifications\" FOR SELECT TO \"authenticated\" USING ((EXISTS ( SELECT 1\n   FROM \"public\".\"employees\" \"e\"\n  WHERE ((\"e\".\"auth_user_id\" = \"auth\".\"uid\"()) AND (\"e\".\"role\" = 'admin'::\"text\")))));\n\n\n\nCREATE POLICY \"admin_select_all_shift_changes\" ON \"public\".\"shift_change_requests\" FOR SELECT TO \"authenticated\" USING ((EXISTS ( SELECT 1\n   FROM \"public\".\"employees\" \"e\"\n  WHERE ((\"e\".\"auth_user_id\" = \"auth\".\"uid\"()) AND (\"e\".\"role\" = 'admin'::\"text\")))));\n\n\n\nCREATE POLICY \"admin_select_all_shifts\" ON \"public\".\"shifts\" FOR SELECT TO \"authenticated\" USING ((EXISTS ( SELECT 1\n   FROM \"public\".\"employees\" \"e\"\n  WHERE ((\"e\".\"auth_user_id\" = \"auth\".\"uid\"()) AND (\"e\".\"role\" = 'admin'::\"text\")))));\n\n\n\nCREATE POLICY \"admin_select_all_time_off\" ON \"public\".\"time_off_requests\" FOR SELECT TO \"authenticated\" USING ((EXISTS ( SELECT 1\n   FROM \"public\".\"employees\" \"e\"\n  WHERE ((\"e\".\"auth_user_id\" = \"auth\".\"uid\"()) AND (\"e\".\"role\" = 'admin'::\"text\")))));\n\n\n\nCREATE POLICY \"admin_update_absences\" ON \"public\".\"absences\" FOR UPDATE TO \"authenticated\" USING ((EXISTS ( SELECT 1\n   FROM \"public\".\"employees\" \"e\"\n  WHERE ((\"e\".\"auth_user_id\" = \"auth\".\"uid\"()) AND (\"e\".\"role\" = 'admin'::\"text\"))))) WITH CHECK ((EXISTS ( SELECT 1\n   FROM \"public\".\"employees\" \"e\"\n  WHERE ((\"e\".\"auth_user_id\" = \"auth\".\"uid\"()) AND (\"e\".\"role\" = 'admin'::\"text\")))));\n\n\n\nCREATE POLICY \"admin_update_app_settings\" ON \"public\".\"app_settings\" FOR UPDATE TO \"authenticated\" USING ((EXISTS ( SELECT 1\n   FROM \"public\".\"employees\" \"e\"\n  WHERE ((\"e\".\"auth_user_id\" = \"auth\".\"uid\"()) AND (\"e\".\"role\" = 'admin'::\"text\"))))) WITH CHECK ((EXISTS ( SELECT 1\n   FROM \"public\".\"employees\" \"e\"\n  WHERE ((\"e\".\"auth_user_id\" = \"auth\".\"uid\"()) AND (\"e\".\"role\" = 'admin'::\"text\")))));\n\n\n\nCREATE POLICY \"admin_update_employees\" ON \"public\".\"employees\" FOR UPDATE TO \"authenticated\" USING (((\"role\" = 'admin'::\"text\") AND (\"auth_user_id\" = \"auth\".\"uid\"()))) WITH CHECK (((\"role\" = 'admin'::\"text\") AND (\"auth_user_id\" = \"auth\".\"uid\"())));\n\n\n\nCREATE POLICY \"admin_update_notifications\" ON \"public\".\"employee_notifications\" FOR UPDATE TO \"authenticated\" USING ((EXISTS ( SELECT 1\n   FROM \"public\".\"employees\" \"e\"\n  WHERE ((\"e\".\"auth_user_id\" = \"auth\".\"uid\"()) AND (\"e\".\"role\" = 'admin'::\"text\"))))) WITH CHECK ((EXISTS ( SELECT 1\n   FROM \"public\".\"employees\" \"e\"\n  WHERE ((\"e\".\"auth_user_id\" = \"auth\".\"uid\"()) AND (\"e\".\"role\" = 'admin'::\"text\")))));\n\n\n\nCREATE POLICY \"admin_update_shift_changes\" ON \"public\".\"shift_change_requests\" FOR UPDATE TO \"authenticated\" USING ((EXISTS ( SELECT 1\n   FROM \"public\".\"employees\" \"e\"\n  WHERE ((\"e\".\"auth_user_id\" = \"auth\".\"uid\"()) AND (\"e\".\"role\" = 'admin'::\"text\"))))) WITH CHECK ((EXISTS ( SELECT 1\n   FROM \"public\".\"employees\" \"e\"\n  WHERE ((\"e\".\"auth_user_id\" = \"auth\".\"uid\"()) AND (\"e\".\"role\" = 'admin'::\"text\")))));\n\n\n\nCREATE POLICY \"admin_update_shifts\" ON \"public\".\"shifts\" FOR UPDATE TO \"authenticated\" USING ((EXISTS ( SELECT 1\n   FROM \"public\".\"employees\" \"e\"\n  WHERE ((\"e\".\"auth_user_id\" = \"auth\".\"uid\"()) AND (\"e\".\"role\" = 'admin'::\"text\"))))) WITH CHECK ((EXISTS ( SELECT 1\n   FROM \"public\".\"employees\" \"e\"\n  WHERE ((\"e\".\"auth_user_id\" = \"auth\".\"uid\"()) AND (\"e\".\"role\" = 'admin'::\"text\")))));\n\n\n\nCREATE POLICY \"admin_update_time_off\" ON \"public\".\"time_off_requests\" FOR UPDATE TO \"authenticated\" USING ((EXISTS ( SELECT 1\n   FROM \"public\".\"employees\" \"e\"\n  WHERE ((\"e\".\"auth_user_id\" = \"auth\".\"uid\"()) AND (\"e\".\"role\" = 'admin'::\"text\"))))) WITH CHECK ((EXISTS ( SELECT 1\n   FROM \"public\".\"employees\" \"e\"\n  WHERE ((\"e\".\"auth_user_id\" = \"auth\".\"uid\"()) AND (\"e\".\"role\" = 'admin'::\"text\")))));\n\n\n\nCREATE POLICY admin_update_time_periods ON public.time_periods FOR UPDATE TO authenticated USING ((EXISTS ( SELECT 1\n   FROM public.employees e\n  WHERE ((e.auth_user_id = auth.uid()) AND (e.role = 'admin'::text))))) WITH CHECK ((EXISTS ( SELECT 1\n   FROM public.employees e\n  WHERE ((e.auth_user_id = auth.uid()) AND (e.role = 'admin'::text)))));\n\n\n--\n-- Name: shifts allow anon insert shifts; Type: POLICY; Schema: public; Owner: -\n--\n\nCREATE POLICY \"allow anon insert shifts\" ON public.shifts FOR INSERT TO anon WITH CHECK (true);\n\n\n--\n-- Name: shifts allow anon shifts access; Type: POLICY; Schema: public; Owner: -\n--\n\nCREATE POLICY \"allow anon shifts access\" ON public.shifts TO anon USING (true) WITH CHECK (true);\n\n\n--\n-- Name: shifts allow anon update shifts; Type: POLICY; Schema: public; Owner: -\n--\n\nCREATE POLICY \"allow anon update shifts\" ON public.shifts FOR UPDATE TO anon USING (true) WITH CHECK (true);\n\n\n--\n-- Name: shifts anon delete shifts; Type: POLICY; Schema: public; Owner: -\n--\n\nCREATE POLICY \"anon delete shifts\" ON public.shifts FOR DELETE TO anon USING (true);\n\n\n--\n-- Name: shifts anon insert shifts; Type: POLICY; Schema: public; Owner: -\n--\n\nCREATE POLICY \"anon insert shifts\" ON public.shifts FOR INSERT TO anon WITH CHECK (true);\n\n\n--\n-- Name: shifts anon select shifts; Type: POLICY; Schema: public; Owner: -\n--\n\nCREATE POLICY \"anon select shifts\" ON public.shifts FOR SELECT TO anon USING (true);\n\n\n--\n-- Name: shifts anon update shifts; Type: POLICY; Schema: public; Owner: -\n--\n\nCREATE POLICY \"anon update shifts\" ON public.shifts FOR UPDATE TO anon USING (true) WITH CHECK (true);\n\n\n--\n-- Name: app_settings; Type: ROW SECURITY; Schema: public; Owner: -\n--\n\nALTER TABLE public.app_settings ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: employees dev: employees select for anon; Type: POLICY; Schema: public; Owner: -\n--\n\nCREATE POLICY \"dev: employees select for anon\" ON public.employees FOR SELECT TO anon USING (true);\n\n\n--\n-- Name: notifications dev: notifications select for anon; Type: POLICY; Schema: public; Owner: -\n--\n\nCREATE POLICY \"dev: notifications select for anon\" ON public.notifications FOR SELECT TO anon USING (true);\n\n\n--\n-- Name: notifications dev_read_notifications_anon; Type: POLICY; Schema: public; Owner: -\n--\n\nCREATE POLICY dev_read_notifications_anon ON public.notifications FOR SELECT TO anon USING (true);\n\n\n--\n-- Name: absences employee_insert_own_absences; Type: POLICY; Schema: public; Owner: -\n--\n\nCREATE POLICY employee_insert_own_absences ON public.absences FOR INSERT TO authenticated WITH CHECK ((employee_id IN ( SELECT e.id\n   FROM public.employees e\n  WHERE (e.auth_user_id = auth.uid()))));\n\n\n\nCREATE POLICY \"employee_insert_own_shift_change\" ON \"public\".\"shift_change_requests\" FOR INSERT TO \"authenticated\" WITH CHECK ((\"employee_id\" IN ( SELECT \"e\".\"id\"\n   FROM \"public\".\"employees\" \"e\"\n  WHERE (\"e\".\"auth_user_id\" = \"auth\".\"uid\"()))));\n\n\n\nCREATE POLICY \"employee_insert_own_time_off\" ON \"public\".\"time_off_requests\" FOR INSERT TO \"authenticated\" WITH CHECK ((\"employee_id\" IN ( SELECT \"e\".\"id\"\n   FROM \"public\".\"employees\" \"e\"\n  WHERE (\"e\".\"auth_user_id\" = \"auth\".\"uid\"()))));\n\n\n\nALTER TABLE \"public\".\"employee_notifications\" ENABLE ROW LEVEL SECURITY;\n\n\nCREATE POLICY \"employee_select_employees\" ON \"public\".\"employees\" FOR SELECT TO \"authenticated\" USING (true);\n\n\n\nCREATE POLICY \"employee_select_own_absences\" ON \"public\".\"absences\" FOR SELECT TO \"authenticated\" USING ((\"employee_id\" IN ( SELECT \"e\".\"id\"\n   FROM \"public\".\"employees\" \"e\"\n  WHERE (\"e\".\"auth_user_id\" = \"auth\".\"uid\"()))));\n\n\n\nCREATE POLICY \"employee_select_own_notifications\" ON \"public\".\"employee_notifications\" FOR SELECT TO \"authenticated\" USING ((\"employee_id\" IN ( SELECT \"e\".\"id\"\n   FROM \"public\".\"employees\" \"e\"\n  WHERE (\"e\".\"auth_user_id\" = \"auth\".\"uid\"()))));\n\n\n\nCREATE POLICY \"employee_select_own_shift_changes\" ON \"public\".\"shift_change_requests\" FOR SELECT TO \"authenticated\" USING (((\"employee_id\" IN ( SELECT \"e\".\"id\"\n   FROM \"public\".\"employees\" \"e\"\n  WHERE (\"e\".\"auth_user_id\" = \"auth\".\"uid\"()))) OR (\"target_employee_id\" IN ( SELECT \"e\".\"id\"\n   FROM \"public\".\"employees\" \"e\"\n  WHERE (\"e\".\"auth_user_id\" = \"auth\".\"uid\"())))));\n\n\n\nCREATE POLICY \"employee_select_own_shifts\" ON \"public\".\"shifts\" FOR SELECT TO \"authenticated\" USING ((\"employee_id\" IN ( SELECT \"e\".\"id\"\n   FROM \"public\".\"employees\" \"e\"\n  WHERE (\"e\".\"auth_user_id\" = \"auth\".\"uid\"()))));\n\n\n\nCREATE POLICY \"employee_select_own_time_off\" ON \"public\".\"time_off_requests\" FOR SELECT TO \"authenticated\" USING ((\"employee_id\" IN ( SELECT \"e\".\"id\"\n   FROM \"public\".\"employees\" \"e\"\n  WHERE (\"e\".\"auth_user_id\" = \"auth\".\"uid\"()))));\n\n\n\nCREATE POLICY \"employee_select_self\" ON \"public\".\"employees\" FOR SELECT TO \"authenticated\" USING ((\"auth_user_id\" = \"auth\".\"uid\"()));\n\n\n\nCREATE POLICY \"employee_update_own_absences\" ON \"public\".\"absences\" FOR UPDATE TO \"authenticated\" USING ((\"employee_id\" IN ( SELECT \"e\".\"id\"\n   FROM \"public\".\"employees\" \"e\"\n  WHERE (\"e\".\"auth_user_id\" = \"auth\".\"uid\"())))) WITH CHECK ((\"employee_id\" IN ( SELECT \"e\".\"id\"\n   FROM \"public\".\"employees\" \"e\"\n  WHERE (\"e\".\"auth_user_id\" = \"auth\".\"uid\"()))));\n\n\n\nCREATE POLICY \"employee_update_own_notifications\" ON \"public\".\"employee_notifications\" FOR UPDATE TO \"authenticated\" USING ((\"employee_id\" IN ( SELECT \"e\".\"id\"\n   FROM \"public\".\"employees\" \"e\"\n  WHERE (\"e\".\"auth_user_id\" = \"auth\".\"uid\"())))) WITH CHECK ((\"employee_id\" IN ( SELECT \"e\".\"id\"\n   FROM \"public\".\"employees\" \"e\"\n  WHERE (\"e\".\"auth_user_id\" = \"auth\".\"uid\"()))));\n\n\n\nCREATE POLICY \"employee_update_own_shift_change\" ON \"public\".\"shift_change_requests\" FOR UPDATE TO \"authenticated\" USING ((\"employee_id\" IN ( SELECT \"e\".\"id\"\n   FROM \"public\".\"employees\" \"e\"\n  WHERE (\"e\".\"auth_user_id\" = \"auth\".\"uid\"())))) WITH CHECK ((\"employee_id\" IN ( SELECT \"e\".\"id\"\n   FROM \"public\".\"employees\" \"e\"\n  WHERE (\"e\".\"auth_user_id\" = \"auth\".\"uid\"()))));\n\n\n\nCREATE POLICY \"employee_update_own_time_off\" ON \"public\".\"time_off_requests\" FOR UPDATE TO \"authenticated\" USING ((\"employee_id\" IN ( SELECT \"e\".\"id\"\n   FROM \"public\".\"employees\" \"e\"\n  WHERE (\"e\".\"auth_user_id\" = \"auth\".\"uid\"())))) WITH CHECK ((\"employee_id\" IN ( SELECT \"e\".\"id\"\n   FROM \"public\".\"employees\" \"e\"\n  WHERE (\"e\".\"auth_user_id\" = \"auth\".\"uid\"()))));\n\n\n\nCREATE POLICY \"employee_update_self\" ON \"public\".\"employees\" FOR UPDATE TO \"authenticated\" USING ((\"auth_user_id\" = \"auth\".\"uid\"())) WITH CHECK ((\"auth_user_id\" = \"auth\".\"uid\"()));\n\n\n\nALTER TABLE \"public\".\"employees\" ENABLE ROW LEVEL SECURITY;\n\n\nCREATE POLICY \"employees delete\" ON \"public\".\"employees\" FOR DELETE TO \"authenticated\" USING (true);\n\n\n\nCREATE POLICY \"employees_select_auth\" ON \"public\".\"employees\" FOR SELECT TO \"authenticated\" USING (true);\n\n\n\nALTER TABLE \"public\".\"notifications\" ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: employees employees delete; Type: POLICY; Schema: public; Owner: -\n--\n\nCREATE POLICY \"employees delete\" ON public.employees FOR DELETE TO authenticated USING (true);\n\n\n--\n-- Name: employees employees_select_auth; Type: POLICY; Schema: public; Owner: -\n--\n\nCREATE POLICY employees_select_auth ON public.employees FOR SELECT TO authenticated USING (true);\n\n\n--\n-- Name: mail_jobs; Type: ROW SECURITY; Schema: public; Owner: -\n--\n\nALTER TABLE public.mail_jobs ENABLE ROW LEVEL SECURITY;\n\n\nALTER TABLE \"public\".\"time_periods\" ENABLE ROW LEVEL SECURITY;\n\n\nALTER TABLE \"storage\".\"buckets\" ENABLE ROW LEVEL SECURITY;\n\n\nALTER TABLE \"storage\".\"migrations\" ENABLE ROW LEVEL SECURITY;\n\n\nALTER TABLE \"storage\".\"objects\" ENABLE ROW LEVEL SECURITY;\n\n\nALTER TABLE \"storage\".\"s3_multipart_uploads\" ENABLE ROW LEVEL SECURITY;\n\n\nALTER TABLE \"storage\".\"s3_multipart_uploads_parts\" ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: notifications notifications insert; Type: POLICY; Schema: public; Owner: -\n--\n\nCREATE POLICY \"notifications insert\" ON public.notifications FOR INSERT TO authenticated WITH CHECK (true);\n\n\n--\n-- Name: notifications notifications select; Type: POLICY; Schema: public; Owner: -\n--\n\nCREATE POLICY \"notifications select\" ON public.notifications FOR SELECT TO authenticated USING (true);\n\n\n--\n-- Name: notifications notifications update; Type: POLICY; Schema: public; Owner: -\n--\n\nCREATE POLICY \"notifications update\" ON public.notifications FOR UPDATE TO authenticated USING (true) WITH CHECK (true);\n\n\n--\n-- Name: notifications notifications_select_auth; Type: POLICY; Schema: public; Owner: -\n--\n\nCREATE POLICY notifications_select_auth ON public.notifications FOR SELECT TO authenticated USING (true);\n\n\n--\n-- Name: app_settings select_app_settings_all; Type: POLICY; Schema: public; Owner: -\n--\n\nCREATE POLICY select_app_settings_all ON public.app_settings FOR SELECT TO authenticated USING (true);\n\n\n--\n-- Name: time_periods select_time_periods_all; Type: POLICY; Schema: public; Owner: -\n--\n\nCREATE POLICY select_time_periods_all ON public.time_periods FOR SELECT TO authenticated USING (true);\n\n\n--\n-- Name: shift_change_requests; Type: ROW SECURITY; Schema: public; Owner: -\n--\n\nALTER TABLE public.shift_change_requests ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: shifts; Type: ROW SECURITY; Schema: public; Owner: -\n--\n\nALTER TABLE public.shifts ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: shifts shifts_select_auth; Type: POLICY; Schema: public; Owner: -\n--\n\nCREATE POLICY shifts_select_auth ON public.shifts FOR SELECT TO authenticated USING (true);\n\n\n--\n-- Name: time_off_requests; Type: ROW SECURITY; Schema: public; Owner: -\n--\n\nALTER TABLE public.time_off_requests ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: time_periods; Type: ROW SECURITY; Schema: public; Owner: -\n--\n\nALTER TABLE public.time_periods ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: messages; Type: ROW SECURITY; Schema: realtime; Owner: -\n--\n\nALTER TABLE realtime.messages ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: buckets; Type: ROW SECURITY; Schema: storage; Owner: -\n--\n\nALTER TABLE storage.buckets ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: migrations; Type: ROW SECURITY; Schema: storage; Owner: -\n--\n\nALTER TABLE storage.migrations ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: objects; Type: ROW SECURITY; Schema: storage; Owner: -\n--\n\nALTER TABLE storage.objects ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: s3_multipart_uploads; Type: ROW SECURITY; Schema: storage; Owner: -\n--\n\nALTER TABLE storage.s3_multipart_uploads ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: s3_multipart_uploads_parts; Type: ROW SECURITY; Schema: storage; Owner: -\n--\n\nALTER TABLE storage.s3_multipart_uploads_parts ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: supabase_realtime; Type: PUBLICATION; Schema: -; Owner: -\n--\n\nCREATE PUBLICATION supabase_realtime WITH (publish = 'insert, update, delete, truncate');\n\n\n--\n-- Name: supabase_realtime_messages_publication; Type: PUBLICATION; Schema: -; Owner: -\n--\n\nCREATE PUBLICATION supabase_realtime_messages_publication WITH (publish = 'insert, update, delete, truncate');\n\n\n--\n-- Name: supabase_realtime shifts; Type: PUBLICATION TABLE; Schema: public; Owner: -\n--\n\nALTER PUBLICATION supabase_realtime ADD TABLE ONLY public.shifts;\n\n\n--\n-- Name: supabase_realtime_messages_publication messages; Type: PUBLICATION TABLE; Schema: realtime; Owner: -\n--\n\nALTER PUBLICATION supabase_realtime_messages_publication ADD TABLE ONLY realtime.messages;\n\n\n--\n-- Name: issue_graphql_placeholder; Type: EVENT TRIGGER; Schema: -; Owner: -\n--\n\nCREATE EVENT TRIGGER issue_graphql_placeholder ON sql_drop\n         WHEN TAG IN ('DROP EXTENSION')\n   EXECUTE FUNCTION extensions.set_graphql_placeholder();\n\n\n--\n-- Name: issue_pg_cron_access; Type: EVENT TRIGGER; Schema: -; Owner: -\n--\n\nCREATE EVENT TRIGGER issue_pg_cron_access ON ddl_command_end\n         WHEN TAG IN ('CREATE EXTENSION')\n   EXECUTE FUNCTION extensions.grant_pg_cron_access();\n\n\n--\n-- Name: issue_pg_graphql_access; Type: EVENT TRIGGER; Schema: -; Owner: -\n--\n\nCREATE EVENT TRIGGER issue_pg_graphql_access ON ddl_command_end\n         WHEN TAG IN ('CREATE FUNCTION')\n   EXECUTE FUNCTION extensions.grant_pg_graphql_access();\n\n\n--\n-- Name: issue_pg_net_access; Type: EVENT TRIGGER; Schema: -; Owner: -\n--\n\nCREATE EVENT TRIGGER issue_pg_net_access ON ddl_command_end\n         WHEN TAG IN ('CREATE EXTENSION')\n   EXECUTE FUNCTION extensions.grant_pg_net_access();\n\n\n--\n-- Name: pgrst_ddl_watch; Type: EVENT TRIGGER; Schema: -; Owner: -\n--\n\nCREATE EVENT TRIGGER pgrst_ddl_watch ON ddl_command_end\n   EXECUTE FUNCTION extensions.pgrst_ddl_watch();\n\n\n--\n-- Name: pgrst_drop_watch; Type: EVENT TRIGGER; Schema: -; Owner: -\n--\n\nCREATE EVENT TRIGGER pgrst_drop_watch ON sql_drop\n   EXECUTE FUNCTION extensions.pgrst_drop_watch();\n\n\n--\n-- PostgreSQL database dump complete\n--\n\n\\unrestrict [REDACTED]\n\n",
          "byteOffset": 0,
          "totalChunks": 1,
          "hasMore": false,
          "startLine": 1,
          "endLine": 3598
        }
      ]
    }
  ],
  "index": {
    "byPath": [
      "src/app/ClientLayout.tsx",
      "src/app/ServiceWorkerRegister.tsx",
      "src/app/globals.css",
      "src/app/layout.tsx",
      "src/app/page.tsx",
      "src/lib/dateUtils.ts",
      "src/lib/insertEmailQueue.ts",
      "src/lib/logger.ts",
      "src/lib/pushClient.ts",
      "src/lib/sendEmail.ts",
      "src/lib/settingsDb.ts",
      "src/lib/settingsSchema.ts",
      "src/lib/supaBaseClient.ts",
      "src/lib/theme.ts",
      "src/lib/timeUtils.ts",
      "src/store/useScheduleStore.ts",
      "src/store/useSettingsStore.ts",
      "src/app/components/AbsenceControlPanel.tsx",
      "src/app/components/AdminView.tsx",
      "src/app/components/EmployeeDashboard.tsx",
      "src/app/components/EmployeeList.tsx",
      "src/app/components/EmployeeNotificationCenter.tsx",
      "src/app/components/EmployeeScheduleControls.tsx",
      "src/app/components/EmployeeScheduleView.tsx",
      "src/app/components/Login.tsx",
      "src/app/components/ScheduleTable.tsx",
      "src/app/components/SettingsDialog.tsx",
      "src/app/components/ShiftChangeRequestForm.tsx",
      "src/app/components/TimeOffRequestForm.tsx",
      "src/app/components/Toolbar.tsx",
      "src/app/set-password/page.tsx",
      "src/app/types/index.ts",
      "src/features/absences/notify.ts",
      "src/app/api/employees/route.ts",
      "src/app/api/sendEmail/route.ts",
      "src/app/api/timeoff/route.ts",
      "src/app/components/ui/NotificationsPopover.tsx",
      "src/app/components/ui/avatar.tsx",
      "src/app/components/ui/badge.tsx",
      "src/app/components/ui/button.tsx",
      "src/app/components/ui/card.tsx",
      "src/app/components/ui/checkbox.tsx",
      "src/app/components/ui/dialog.tsx",
      "src/app/components/ui/input.tsx",
      "src/app/components/ui/label.tsx",
      "src/app/components/ui/popover.tsx",
      "src/app/components/ui/scroll-area.tsx",
      "src/app/components/ui/select.tsx",
      "src/app/components/ui/separator.tsx",
      "src/app/components/ui/slider.tsx",
      "src/app/components/ui/sonner.tsx",
      "src/app/components/ui/switch.tsx",
      "src/app/components/ui/tabs.tsx",
      "src/app/components/ui/textarea.tsx",
      "src/app/components/ui/tooltip.tsx",
      "src/app/components/ui/utils.ts",
      "src/app/api/employees/[id]/route.ts",
      "supabase/functions/app_settings/index.ts",
      "supabase/functions/mailer/index.ts",
      "supabase/functions/mailer_worker/index.ts",
      "supabase/functions/sendemail/index.ts",
      "supabase/functions/soili-code/index.ts",
      "supabase/migrations/20250911142604_remote_schema.sql",
      "supabase/schema.sql"
    ],
    "byLang": {
      "tsx": [
        "src/app/ClientLayout.tsx",
        "src/app/ServiceWorkerRegister.tsx",
        "src/app/layout.tsx",
        "src/app/page.tsx",
        "src/app/components/AbsenceControlPanel.tsx",
        "src/app/components/AdminView.tsx",
        "src/app/components/EmployeeDashboard.tsx",
        "src/app/components/EmployeeList.tsx",
        "src/app/components/EmployeeNotificationCenter.tsx",
        "src/app/components/EmployeeScheduleControls.tsx",
        "src/app/components/EmployeeScheduleView.tsx",
        "src/app/components/Login.tsx",
        "src/app/components/ScheduleTable.tsx",
        "src/app/components/SettingsDialog.tsx",
        "src/app/components/ShiftChangeRequestForm.tsx",
        "src/app/components/TimeOffRequestForm.tsx",
        "src/app/components/Toolbar.tsx",
        "src/app/set-password/page.tsx",
        "src/app/components/ui/NotificationsPopover.tsx",
        "src/app/components/ui/avatar.tsx",
        "src/app/components/ui/badge.tsx",
        "src/app/components/ui/button.tsx",
        "src/app/components/ui/card.tsx",
        "src/app/components/ui/checkbox.tsx",
        "src/app/components/ui/dialog.tsx",
        "src/app/components/ui/input.tsx",
        "src/app/components/ui/label.tsx",
        "src/app/components/ui/popover.tsx",
        "src/app/components/ui/scroll-area.tsx",
        "src/app/components/ui/select.tsx",
        "src/app/components/ui/separator.tsx",
        "src/app/components/ui/slider.tsx",
        "src/app/components/ui/sonner.tsx",
        "src/app/components/ui/switch.tsx",
        "src/app/components/ui/tabs.tsx",
        "src/app/components/ui/textarea.tsx",
        "src/app/components/ui/tooltip.tsx"
      ],
      "css": [
        "src/app/globals.css"
      ],
      "typescript": [
        "src/lib/dateUtils.ts",
        "src/lib/insertEmailQueue.ts",
        "src/lib/logger.ts",
        "src/lib/pushClient.ts",
        "src/lib/sendEmail.ts",
        "src/lib/settingsDb.ts",
        "src/lib/settingsSchema.ts",
        "src/lib/supaBaseClient.ts",
        "src/lib/theme.ts",
        "src/lib/timeUtils.ts",
        "src/store/useScheduleStore.ts",
        "src/store/useSettingsStore.ts",
        "src/app/types/index.ts",
        "src/features/absences/notify.ts",
        "src/app/api/employees/route.ts",
        "src/app/api/sendEmail/route.ts",
        "src/app/api/timeoff/route.ts",
        "src/app/components/ui/utils.ts",
        "src/app/api/employees/[id]/route.ts",
        "supabase/functions/app_settings/index.ts",
        "supabase/functions/mailer/index.ts",
        "supabase/functions/mailer_worker/index.ts",
        "supabase/functions/sendemail/index.ts",
        "supabase/functions/soili-code/index.ts"
      ],
      "sql": [
        "supabase/migrations/20250911142604_remote_schema.sql",
        "supabase/schema.sql"
      ]
    }
  }
}